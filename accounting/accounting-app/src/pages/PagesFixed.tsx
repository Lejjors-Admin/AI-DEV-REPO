import { useState, useEffect, useMemo } from "react";
import { useRoute } from "wouter";
import { useQuery, useMutation } from "@tanstack/react-query";
import CalendarPage from "./CalendarNew";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Checkbox } from "@/components/ui/checkbox";
import { Switch } from "@/components/ui/switch";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { toast, useToast } from "@/hooks/use-toast";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useWebSocket } from "@/hooks/use-websocket";
import {
  Users,
  Calendar,
  Clock,
  MessageSquare,
  TrendingUp,
  DollarSign,
  Target,
  Mail,
  Phone,
  Building,
  CheckCircle,
  AlertCircle,
  Plus,
  Filter,
  Search,
  MoreHorizontal,
  Bot,
  Briefcase,
  FileText,
  PieChart,
  Settings,
  Activity,
  CheckCircle2,
  CheckSquare,
  Eye,
  Edit3,
  Download,
  Bell,
  X,
  Check,
  ChevronLeft,
  ChevronRight,
  Timer,
  Play,
  Pause,
  Square,
  CalendarDays,
  Grid3X3,
  List,
  Move,
  Video,
  MapPin,
  User,
  RefreshCw,
  Link,
  ExternalLink,
  Send,
  BarChart3,
  CreditCard,
  Smartphone,
  Zap,
  Star,
  Megaphone,
  Database,
  AlertTriangle,
  UserCheck,
  UserPlus,
  Trash2,
  ChevronUp,
  ChevronDown,
  Columns,
  FileSpreadsheet,
  FileText as FileTextIcon,
  Printer,
  Folder,
  Building2,
  Receipt,
  Save,
  Image,
  Upload
} from "lucide-react";
import { queryClient, apiRequest } from "@/lib/queryClient";
import { format, addDays, isToday, isTomorrow, startOfMonth, endOfMonth } from "date-fns";
import * as XLSX from 'xlsx';
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import EnhancedClientCreation from "@/components/EnhancedClientCreation";
import EditClientFormDialog from "@/components/EditClientFormDialog";
import CommunicationHubModern from "@/components/communications/CommunicationHubModern";
import { useAuth } from "@/hooks/use-auth";
import PagesSidebar from "@/components/PagesSidebar";
import ClientDetailView from "@/components/ClientDetailView";
import { ContactPersonManagement } from "@/components/ContactPersonManagement";
import TeamManagement from "@/components/team/TeamManagement";
import PerfexImport from "./PerfexImport";
import IntegrationSettings from "./IntegrationSettings";
import ReportLineChart from "@/components/reports/ReportLineChart";
import ReportBarChart from "@/components/reports/ReportBarChart";
import ReportPieChart from "@/components/reports/ReportPieChart";
import ReportAreaChart from "@/components/reports/ReportAreaChart";
import { exportReportToPDF, addHeaderToPDF, addTableToPDF, addFooterToPDF, FirmInfo, DateRange } from "@/lib/pdf-export";
import { exportReportToExcel, TableData } from "@/lib/excel-export";
import { SmartTimer } from "@/components/SmartTimer";
import { TimeEntryForm } from "@/components/TimeEntryForm";
import { TimeApprovalQueue } from "@/components/TimeApprovalQueue";
import { ActiveTimerIndicator } from "@/components/ActiveTimerIndicator";
import { TaskModal } from "@/components/TaskModal";
import ProjectModal from "@/components/ProjectModal";
import { apiConfig } from "@/lib/api-config";

// Client Logo Component with error handling
function ClientLogo({ logoUrl, clientName, clientId }: { logoUrl: string; clientName: string; clientId?: number }) {
  const [imageError, setImageError] = useState(false);
  const [imageSrc, setImageSrc] = useState<string>('');

  // Determine the image source URL
  useEffect(() => {
    if (clientId && logoUrl) {
      // Use API endpoint if we have clientId (more reliable through reverse proxy)
      const apiUrl = apiConfig.buildUrl(`/api/clients/${clientId}/logo`);
      setImageSrc(apiUrl);
      console.log(`üñºÔ∏è Loading logo for ${clientName} via API: ${apiUrl}`);
    } else if (logoUrl) {
      // Fallback to direct URL
      const assetUrl = apiConfig.buildAssetUrl(logoUrl);
      setImageSrc(assetUrl);
      console.log(`üñºÔ∏è Loading logo for ${clientName} via asset URL: ${assetUrl}`);
    }
  }, [logoUrl, clientName, clientId]);

  if (imageError || !imageSrc) {
    if (imageError) {
      console.log(`‚ùå Logo failed to load for ${clientName}: ${imageSrc || logoUrl}`);
    }
    return (
      <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
        <Building className="w-4 h-4 text-blue-600" />
      </div>
    );
  }

  return (
    <div className="w-8 h-8 rounded-full overflow-hidden border border-gray-200 flex items-center justify-center bg-white flex-shrink-0">
      <img
        src={imageSrc}
        alt={`${clientName} logo`}
        className="w-full h-full object-cover"
        onError={(e) => {
          console.error(`‚ùå Image load error for ${clientName}:`, imageSrc, e);
          setImageError(true);
        }}
        onLoad={() => {
          console.log(`‚úÖ Logo loaded successfully for ${clientName}`);
        }}
      />
    </div>
  );
}

// Notification Bell Component for Client Approvals
function NotificationBell() {
  const [showNotifications, setShowNotifications] = useState(false);

  // Query for pending client approvals
  const { data: pendingApprovals } = useQuery({
    queryKey: ["/api/pending-client-approvals"],
    queryFn: async () => {
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');

      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const response = await fetch(apiConfig.buildUrl('/api/pending-client-approvals'), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch pending approvals');
      return response.json();
    },
    refetchInterval: 10000, // Refresh every 10 seconds
  });

  const approveClientMutation = useMutation({
    mutationFn: async ({ approvalId, action }: { approvalId: number; action: 'approve' | 'reject' }) => {
      const response = await apiRequest('POST', `/api/pending-client-approvals/${approvalId}/${action}`, {});
      if (!response.ok) {
        throw new Error('Failed to process approval');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/pending-client-approvals"] });
      queryClient.invalidateQueries({ queryKey: ["/api/clients"] });
      queryClient.invalidateQueries({ queryKey: ["/api/projects"] });
      queryClient.invalidateQueries({ queryKey: ["/api/tasks"] });
      toast({
        title: "Success",
        description: "Client approval processed successfully!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const timeEntryApprovalMutation = useMutation({
    mutationFn: async ({ entryId, action }: { entryId: number; action: 'approve' | 'reject' }) => {
      const response = await apiRequest('POST', `/api/pending-approvals/time-entries/${entryId}/${action}`, {});
      if (!response.ok) {
        throw new Error(`Failed to ${action} time entry`);
      }
      return response.json();
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ["/api/pending-client-approvals"] });
      queryClient.invalidateQueries({ queryKey: ["/api/team/time-entries"] });
      toast({
        title: "Success",
        description: `Time entry ${variables.action}d successfully!`,
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const clientCount = pendingApprovals?.clientApprovals?.length || 0;
  const timeEntryCount = pendingApprovals?.timeEntryApprovals?.length || 0;
  const pendingCount = clientCount + timeEntryCount;

  return (
    <div className="relative">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowNotifications(!showNotifications)}
        className="relative"
      >
        <Bell className="h-5 w-5" />
        {pendingCount > 0 && (
          <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
            {pendingCount}
          </span>
        )}
      </Button>

      {showNotifications && (
        <div className="absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border z-50 max-h-96 overflow-y-auto">
          <div className="p-4 border-b">
            <h3 className="font-semibold">Pending Approvals</h3>
            {pendingCount === 0 && (
              <p className="text-sm text-gray-500 mt-1">No pending approvals</p>
            )}
            {pendingCount > 0 && (
              <p className="text-sm text-gray-500 mt-1">
                {clientCount} client{clientCount !== 1 ? 's' : ''}, {timeEntryCount} time {timeEntryCount !== 1 ? 'entries' : 'entry'}
              </p>
            )}
          </div>

          {pendingApprovals?.clientApprovals?.map((approval: any) => (
            <div key={`client-${approval.id}`} className="p-4 border-b">
              <div className="space-y-2">
                <div className="flex justify-between items-start">
                  <div>
                    <Badge variant="secondary" className="mb-2">Client</Badge>
                    <h4 className="font-medium">{approval.clientName}</h4>
                    <p className="text-sm text-gray-600">{approval.industry}</p>
                    <p className="text-sm text-gray-500">Work Type: {approval.workType}</p>
                    <p className="text-sm text-gray-500">
                      Projects: {approval.proposedProjects?.length || 0} | Tasks: {approval.proposedTasks?.length || 0}
                    </p>
                  </div>
                </div>

                <div className="flex gap-2 mt-3">
                  <Button
                    size="sm"
                    onClick={() => approveClientMutation.mutate({ approvalId: approval.id, action: 'approve' })}
                    disabled={approveClientMutation.isPending}
                    className="flex items-center gap-1"
                  >
                    <Check className="h-3 w-3" />
                    Approve
                  </Button>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => approveClientMutation.mutate({ approvalId: approval.id, action: 'reject' })}
                    disabled={approveClientMutation.isPending}
                    className="flex items-center gap-1"
                  >
                    <X className="h-3 w-3" />
                    Reject
                  </Button>
                </div>
              </div>
            </div>
          ))}

          {pendingApprovals?.timeEntryApprovals?.map((entry: any) => (
            <div key={`time-${entry.id}`} className="p-4 border-b">
              <div className="space-y-2">
                <Badge variant="default" className="mb-2">Time Entry</Badge>
                <h4 className="font-medium">{entry.userName}</h4>
                <p className="text-sm text-gray-600">{entry.projectName || "No Project"}</p>
                <p className="text-sm text-gray-500">
                  Duration: {(Number(entry.duration) / 3600).toFixed(2)}h
                  {entry.isBillable && <Badge variant="outline" className="ml-2 text-xs">Billable</Badge>}
                </p>
                {entry.description && (
                  <p className="text-sm text-gray-500 truncate">{entry.description}</p>
                )}

                <div className="flex gap-2 mt-3">
                  <Button
                    size="sm"
                    onClick={() => timeEntryApprovalMutation.mutate({ entryId: entry.id, action: 'approve' })}
                    disabled={timeEntryApprovalMutation.isPending}
                    className="flex items-center gap-1"
                  >
                    <Check className="h-3 w-3" />
                    Approve
                  </Button>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => timeEntryApprovalMutation.mutate({ entryId: entry.id, action: 'reject' })}
                    disabled={timeEntryApprovalMutation.isPending}
                    className="flex items-center gap-1"
                  >
                    <X className="h-3 w-3" />
                    Reject
                  </Button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// Notification Center Component - Real-time notifications
function NotificationCenter() {
  const [showDropdown, setShowDropdown] = useState(false);
  const { socket, isConnected } = useWebSocket();
  const { toast } = useToast();

  // Fetch notifications
  const { data: notificationsData, refetch } = useQuery({
    queryKey: ["/api/notifications"],
    queryFn: async () => {
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');

      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const response = await fetch(apiConfig.buildUrl('/api/notifications?limit=20'), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch notifications');
      return response.json();
    },
    refetchInterval: 30000, // Refresh every 30 seconds
  });

  // Fetch unread count
  const { data: unreadData } = useQuery({
    queryKey: ["/api/notifications/unread-count"],
    queryFn: async () => {
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');

      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const response = await fetch(apiConfig.buildUrl('/api/notifications/unread-count'), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch unread count');
      return response.json();
    },
    refetchInterval: 10000, // Refresh every 10 seconds
  });

  const unreadCount = unreadData?.count || notificationsData?.unreadCount || 0;
  const notifications = notificationsData?.notifications || [];

  // Listen for real-time notifications via WebSocket
  useEffect(() => {
    if (!socket || !isConnected) return;

    const handleNotification = (notification: any) => {
      console.log('Received real-time notification:', notification);

      // Show toast
      toast({
        title: notification.title,
        description: notification.message,
      });

      // Refetch notifications to update the list
      refetch();
      queryClient.invalidateQueries({ queryKey: ["/api/notifications/unread-count"] });
    };

    socket.on('notification', handleNotification);

    return () => {
      socket.off('notification', handleNotification);
    };
  }, [socket, isConnected, refetch, toast]);

  // Mark as read mutation
  const markAsReadMutation = useMutation({
    mutationFn: async (notificationId: number) => {
      const response = await apiRequest('PATCH', `/api/notifications/${notificationId}/read`, {});
      if (!response.ok) throw new Error('Failed to mark as read');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/notifications"] });
      queryClient.invalidateQueries({ queryKey: ["/api/notifications/unread-count"] });
    },
  });

  // Mark all as read mutation
  const markAllAsReadMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('PATCH', '/api/notifications/mark-all-read', {});
      if (!response.ok) throw new Error('Failed to mark all as read');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/notifications"] });
      queryClient.invalidateQueries({ queryKey: ["/api/notifications/unread-count"] });
      toast({
        title: "Success",
        description: "All notifications marked as read",
      });
    },
  });

  const handleNotificationClick = (notification: any) => {
    if (!notification.isRead) {
      markAsReadMutation.mutate(notification.id);
    }
    if (notification.actionUrl) {
      window.location.href = notification.actionUrl;
    }
    setShowDropdown(false);
  };

  const getNotificationIcon = (type: string) => {
    switch (type) {
      case 'task_assigned':
      case 'task_completed':
      case 'task_overdue':
        return <CheckCircle className="h-4 w-4 text-blue-500" />;
      case 'invoice_sent':
      case 'invoice_paid':
      case 'payment_received':
        return <DollarSign className="h-4 w-4 text-green-500" />;
      case 'new_message':
      case 'message_reply':
        return <MessageSquare className="h-4 w-4 text-purple-500" />;
      case 'deadline_approaching':
      case 'invoice_overdue':
        return <AlertCircle className="h-4 w-4 text-orange-500" />;
      default:
        return <Bell className="h-4 w-4 text-gray-500" />;
    }
  };

  const formatTimeAgo = (date: string) => {
    const now = new Date();
    const then = new Date(date);
    const seconds = Math.floor((now.getTime() - then.getTime()) / 1000);

    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return format(then, 'MMM d');
  };

  return (
    <div className="relative">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowDropdown(!showDropdown)}
        className="relative"
        data-testid="notification-bell"
      >
        <Bell className="h-5 w-5" />
        {unreadCount > 0 && (
          <span
            className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
            data-testid="notification-badge"
          >
            {unreadCount > 99 ? '99+' : unreadCount}
          </span>
        )}
      </Button>

      {showDropdown && (
        <div className="absolute top-full right-0 mt-2 w-96 bg-white rounded-lg shadow-lg border z-50 max-h-[600px] flex flex-col">
          <div className="p-4 border-b flex items-center justify-between">
            <h3 className="font-semibold">Notifications</h3>
            <div className="flex items-center gap-2">
              {unreadCount > 0 && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => markAllAsReadMutation.mutate()}
                  disabled={markAllAsReadMutation.isPending}
                  className="text-xs"
                >
                  Mark all read
                </Button>
              )}
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setShowDropdown(false)}
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </div>

          <div className="overflow-y-auto flex-1">
            {notifications.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                <Bell className="h-12 w-12 mx-auto mb-2 text-gray-300" />
                <p>No notifications</p>
              </div>
            ) : (
              notifications.map((notification: any) => (
                <div
                  key={notification.id}
                  className={`p-4 border-b hover:bg-gray-50 cursor-pointer transition-colors ${!notification.isRead ? 'bg-blue-50' : ''
                    }`}
                  onClick={() => handleNotificationClick(notification)}
                >
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 mt-1">
                      {getNotificationIcon(notification.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2">
                        <p className="font-medium text-sm">{notification.title}</p>
                        {!notification.isRead && (
                          <div className="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>
                        )}
                      </div>
                      <p className="text-sm text-gray-600 mt-1">{notification.message}</p>
                      <p className="text-xs text-gray-400 mt-1">
                        {formatTimeAgo(notification.createdAt)}
                      </p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>

          <div className="p-3 border-t">
            <Button
              variant="outline"
              size="sm"
              className="w-full"
              onClick={() => {
                setShowDropdown(false);
                // Navigate to notifications tab - will be implemented
                window.location.hash = '#notifications';
              }}
            >
              View All Notifications
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// Notification History Page Component
function NotificationHistory() {
  const [currentPage, setCurrentPage] = useState(1);
  const [unreadOnly, setUnreadOnly] = useState(false);
  const [selectedType, setSelectedType] = useState<string>('all');
  const { toast } = useToast();

  const notificationsPerPage = 20;

  // Fetch notifications with pagination
  const { data, isLoading, refetch } = useQuery({
    queryKey: ["/api/notifications", currentPage, unreadOnly, selectedType],
    queryFn: async () => {
      const offset = (currentPage - 1) * notificationsPerPage;
      const params = new URLSearchParams({
        limit: notificationsPerPage.toString(),
        offset: offset.toString(),
        ...(unreadOnly && { unreadOnly: 'true' }),
        ...(selectedType !== 'all' && { type: selectedType })
      });
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');

      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }
      const response = await fetch(apiConfig.buildUrl(`/api/notifications?${params}`), {
        credentials: 'include',
        headers
      });
      if (!response.ok) throw new Error('Failed to fetch notifications');
      return await response.json();
    },
    retry: false
  });

  const notifications = data?.notifications || [];
  const total = data?.total || 0;
  const unreadCount = data?.unreadCount || 0;
  const totalPages = Math.ceil(total / notificationsPerPage);

  // Mark all as read mutation
  const markAllAsReadMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('PATCH', '/api/notifications/mark-all-read', {});
      if (!response.ok) throw new Error('Failed to mark all as read');
      return response.json();
    },
    onSuccess: () => {
      refetch();
      queryClient.invalidateQueries({ queryKey: ["/api/notifications/unread-count"] });
      toast({
        title: "Success",
        description: "All notifications marked as read",
      });
    },
  });

  // Delete notification mutation
  const deleteNotificationMutation = useMutation({
    mutationFn: async (notificationId: number) => {
      const response = await apiRequest('DELETE', `/api/notifications/${notificationId}`, {});
      if (!response.ok) throw new Error('Failed to delete notification');
      return response.json();
    },
    onSuccess: () => {
      refetch();
      toast({
        title: "Success",
        description: "Notification deleted",
      });
    },
  });

  // Mark as read mutation
  const markAsReadMutation = useMutation({
    mutationFn: async (notificationId: number) => {
      const response = await apiRequest('PATCH', `/api/notifications/${notificationId}/read`, {});
      if (!response.ok) throw new Error('Failed to mark as read');
      return response.json();
    },
    onSuccess: () => {
      refetch();
    },
  });

  const handleNotificationClick = (notification: any) => {
    if (!notification.isRead) {
      markAsReadMutation.mutate(notification.id);
    }
    if (notification.actionUrl) {
      window.location.href = notification.actionUrl;
    }
  };

  const getNotificationIcon = (type: string) => {
    switch (type) {
      case 'task_assigned':
      case 'task_completed':
      case 'task_overdue':
        return <CheckCircle className="h-5 w-5 text-blue-500" />;
      case 'invoice_sent':
      case 'invoice_paid':
      case 'payment_received':
        return <DollarSign className="h-5 w-5 text-green-500" />;
      case 'new_message':
      case 'message_reply':
        return <MessageSquare className="h-5 w-5 text-purple-500" />;
      case 'deadline_approaching':
      case 'invoice_overdue':
        return <AlertCircle className="h-5 w-5 text-orange-500" />;
      default:
        return <Bell className="h-5 w-5 text-gray-500" />;
    }
  };

  const formatTimeAgo = (date: string) => {
    const now = new Date();
    const then = new Date(date);
    const seconds = Math.floor((now.getTime() - then.getTime()) / 1000);

    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return format(then, 'MMM d, yyyy');
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Notification History</h2>
          <p className="text-gray-500 mt-1">
            {total} total notifications, {unreadCount} unread
          </p>
        </div>
        <div className="flex items-center gap-2">
          {unreadCount > 0 && (
            <Button
              onClick={() => markAllAsReadMutation.mutate()}
              disabled={markAllAsReadMutation.isPending}
            >
              Mark All as Read
            </Button>
          )}
        </div>
      </div>

      {/* Filters */}
      <Card>
        <CardHeader>
          <CardTitle>Filters</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-4">
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium">Show:</label>
              <Select
                value={unreadOnly ? 'unread' : 'all'}
                onValueChange={(value) => {
                  setUnreadOnly(value === 'unread');
                  setCurrentPage(1);
                }}
              >
                <SelectTrigger className="w-40">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All</SelectItem>
                  <SelectItem value="unread">Unread Only</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="flex items-center gap-2">
              <label className="text-sm font-medium">Type:</label>
              <Select
                value={selectedType}
                onValueChange={(value) => {
                  setSelectedType(value);
                  setCurrentPage(1);
                }}
              >
                <SelectTrigger className="w-48">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Types</SelectItem>
                  <SelectItem value="task_assigned">Task Assigned</SelectItem>
                  <SelectItem value="task_completed">Task Completed</SelectItem>
                  <SelectItem value="task_overdue">Task Overdue</SelectItem>
                  <SelectItem value="invoice_sent">Invoice Sent</SelectItem>
                  <SelectItem value="invoice_paid">Invoice Paid</SelectItem>
                  <SelectItem value="payment_received">Payment Received</SelectItem>
                  <SelectItem value="new_message">New Message</SelectItem>
                  <SelectItem value="deadline_approaching">Deadline Approaching</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Notifications List */}
      <Card>
        <CardContent className="p-0">
          {isLoading ? (
            <div className="p-12 text-center text-gray-500">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
              <p>Loading notifications...</p>
            </div>
          ) : notifications.length === 0 ? (
            <div className="p-12 text-center text-gray-500">
              <Bell className="h-16 w-16 mx-auto mb-4 text-gray-300" />
              <p className="text-lg font-medium">No notifications</p>
              <p className="text-sm">You're all caught up!</p>
            </div>
          ) : (
            <div className="divide-y">
              {notifications.map((notification: any) => (
                <div
                  key={notification.id}
                  className={`p-4 hover:bg-gray-50 transition-colors ${!notification.isRead ? 'bg-blue-50' : ''
                    }`}
                >
                  <div className="flex items-start gap-4">
                    <div className="flex-shrink-0 mt-1">
                      {getNotificationIcon(notification.type)}
                    </div>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <p className="font-medium">{notification.title}</p>
                            {!notification.isRead && (
                              <Badge variant="default" className="text-xs">Unread</Badge>
                            )}
                          </div>
                          <p className="text-sm text-gray-600 mt-1">{notification.message}</p>
                          <p className="text-xs text-gray-400 mt-2">
                            {formatTimeAgo(notification.createdAt)}
                          </p>
                        </div>

                        <div className="flex items-center gap-2">
                          {notification.actionUrl && (
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => handleNotificationClick(notification)}
                            >
                              View
                            </Button>
                          )}
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => deleteNotificationMutation.mutate(notification.id)}
                            disabled={deleteNotificationMutation.isPending}
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex items-center justify-between">
          <p className="text-sm text-gray-500">
            Showing {((currentPage - 1) * notificationsPerPage) + 1} to{' '}
            {Math.min(currentPage * notificationsPerPage, total)} of {total}
          </p>
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
              disabled={currentPage === 1}
            >
              <ChevronLeft className="h-4 w-4" />
              Previous
            </Button>
            <span className="text-sm">
              Page {currentPage} of {totalPages}
            </span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
              disabled={currentPage === totalPages}
            >
              Next
              <ChevronRight className="h-4 w-4" />
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// Tars AI Chat Component (simplified)
function TarsAIChat() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      {/* Floating Tars Button */}
      <div className="fixed bottom-6 right-6 z-50">
        <Button
          onClick={() => setIsOpen(!isOpen)}
          className="h-12 w-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 shadow-lg"
        >
          <Bot className="h-6 w-6" />
        </Button>
      </div>

      {/* Chat Dialog */}
      {isOpen && (
        <div className="fixed bottom-20 right-6 z-50 w-96 h-96 bg-white rounded-lg shadow-2xl border">
          <div className="flex items-center justify-between p-4 border-b">
            <h3 className="font-semibold">Tars AI Assistant</h3>
            <Button variant="ghost" size="sm" onClick={() => setIsOpen(false)}>√ó</Button>
          </div>
          <div className="p-4 h-80 flex items-center justify-center text-gray-500">
            Ask me anything about your practice!
          </div>
        </div>
      )}
    </>
  );
}

// TimeExpensesView Component
function TimeExpensesView() {
  const [timeTab, setTimeTab] = useState('my-time'); // my-time, approvals, rates, reports
  const [showTimeEntryDialog, setShowTimeEntryDialog] = useState(false);
  const [editingEntry, setEditingEntry] = useState<any>(null);
  const [timeFilters, setTimeFilters] = useState({
    startDate: format(new Date(new Date().getFullYear(), new Date().getMonth(), 1), 'yyyy-MM-dd'),
    endDate: format(new Date(), 'yyyy-MM-dd'),
    clientId: '',
    projectId: '',
    type: '',
    status: ''
  });

  // Fetch time entries with filters - properly serialize query params
  const timeEntriesQueryKey = [
    '/api/time-tracking/entries',
    timeFilters.startDate,
    timeFilters.endDate,
    timeFilters.clientId,
    timeFilters.projectId,
    timeFilters.type,
    timeFilters.status
  ];

  const { data: timeEntriesData, isLoading: isLoadingEntries } = useQuery({
    queryKey: timeEntriesQueryKey,
    queryFn: async () => {
      const params = new URLSearchParams();
      if (timeFilters.startDate) params.append('startDate', timeFilters.startDate);
      if (timeFilters.endDate) params.append('endDate', timeFilters.endDate);
      if (timeFilters.clientId) params.append('clientId', timeFilters.clientId);
      if (timeFilters.projectId) params.append('projectId', timeFilters.projectId);
      if (timeFilters.type) params.append('type', timeFilters.type);
      if (timeFilters.status) params.append('status', timeFilters.status);
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');

      const headers: HeadersInit = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const url = `/api/time-tracking/entries${params.toString() ? `?${params.toString()}` : ''}`;
      const response = await fetch(apiConfig.buildUrl(url), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch time entries');
      return response.json();
    }
  });

  // Fetch clients for filters
  const { data: clientsData } = useQuery({
    queryKey: ['/api/clients'],
  });

  // Fetch projects for filters
  const { data: projectsData } = useQuery({
    queryKey: ['/api/projects'],
  });

  // Delete time entry mutation
  const deleteEntryMutation = useMutation({
    mutationFn: async (entryId: number) => {
      const response = await apiRequest('DELETE', `/api/time-tracking/entries/${entryId}`, {});
      if (!response.ok) throw new Error('Failed to delete entry');
      return response.json();
    },
    onSuccess: () => {
      toast({ title: 'Time entry deleted successfully' });
      queryClient.invalidateQueries({ queryKey: ['/api/time-tracking/entries'] });
    },
    onError: () => {
      toast({ title: 'Failed to delete entry', variant: 'destructive' });
    }
  });

  const timeEntries = timeEntriesData?.data || [];
  const clients = clientsData?.data || [];
  const projects = projectsData?.projects || projectsData?.data || [];

  // Pages invoicing queries
  const { data: pagesInvoicesData } = useQuery({
    queryKey: ['/api/pages/billing/invoices'],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/pages/billing/invoices');
      if (!response.ok) throw new Error('Failed to fetch Pages invoices');
      return response.json();
    }
  });

  // Mutation for creating invoice from time entries
  const createInvoiceFromTimeMutation = useMutation({
    mutationFn: async ({ clientId, timeEntryIds, dueDate, notes }: { clientId: number; timeEntryIds: number[]; dueDate?: string; notes?: string }) => {
      const response = await apiRequest('POST', '/api/pages/billing/invoices/from-time', {
        clientId,
        timeEntryIds,
        dueDate,
        notes
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to create invoice');
      }
      return response.json();
    },
    onSuccess: () => {
      toast({ title: 'Success', description: 'Invoice created successfully from time entries' });
      queryClient.invalidateQueries({ queryKey: ['/api/pages/billing/invoices'] });
      queryClient.invalidateQueries({ queryKey: ['/api/time-tracking/entries'] });
    },
    onError: (error: Error) => {
      toast({ title: 'Error', description: error.message || 'Failed to create invoice', variant: 'destructive' });
    }
  });

  // Calculate totals
  const totalHours = timeEntries.reduce((sum: number, entry: any) => sum + (parseFloat(entry.duration || '0')) / 3600, 0);
  const billableHours = timeEntries.filter((e: any) => e.type === 'billable').reduce((sum: number, entry: any) => sum + (parseFloat(entry.duration || '0')) / 3600, 0);
  const unbilledEntries = timeEntries.filter((e: any) => e.status === 'approved' && !e.invoiceLineItemId);
  const pendingEntries = timeEntries.filter((e: any) => e.status === 'pending');

  const formatDuration = (seconds: number) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${minutes}m`;
  };

  return (
    <div className="space-y-6 w-full max-w-full">
      {/* Header */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div className="flex-1 min-w-0">
          <h2 className="text-2xl font-bold">Time & Expenses</h2>
          <p className="text-gray-600 text-sm sm:text-base">Track time, manage approvals, and bill clients accurately</p>
        </div>
        <div className="flex items-center gap-3 w-full sm:w-auto">
          <SmartTimer />
          <Button
            onClick={() => {
              setEditingEntry(null);
              setShowTimeEntryDialog(true);
            }}
            className="flex-1 sm:flex-initial"
            data-testid="button-add-time-entry"
          >
            <Plus className="w-4 h-4 mr-2" />
            Add Time Entry
          </Button>
        </div>
      </div>

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Hours</CardTitle>
            <Clock className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{totalHours.toFixed(2)}h</div>
            <p className="text-xs text-muted-foreground">This period</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Billable Hours</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{billableHours.toFixed(2)}h</div>
            <p className="text-xs text-muted-foreground">{totalHours > 0 ? Math.round((billableHours / totalHours) * 100) : 0}% utilization</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Unbilled Entries</CardTitle>
            <AlertCircle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{unbilledEntries.length}</div>
            <p className="text-xs text-muted-foreground">Ready to invoice</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Pending Approval</CardTitle>
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{pendingEntries.length}</div>
            <p className="text-xs text-muted-foreground">Awaiting review</p>
          </CardContent>
        </Card>
      </div>

      {/* Sub-Tabs */}
      <Card>
        <CardHeader className="border-b">
          <div className="flex items-center gap-4">
            <Button
              variant={timeTab === 'my-time' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setTimeTab('my-time')}
              data-testid="tab-my-time"
            >
              <List className="w-4 h-4 mr-2" />
              My Time
            </Button>
            <Button
              variant={timeTab === 'approvals' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setTimeTab('approvals')}
              data-testid="tab-approvals"
            >
              <CheckCircle className="w-4 h-4 mr-2" />
              Approvals
            </Button>
            <Button
              variant={timeTab === 'rates' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setTimeTab('rates')}
              data-testid="tab-rates"
            >
              <DollarSign className="w-4 h-4 mr-2" />
              Rates
            </Button>
            <Button
              variant={timeTab === 'reports' ? 'default' : 'ghost'}
              size="sm"
              onClick={() => setTimeTab('reports')}
              data-testid="tab-reports"
            >
              <BarChart3 className="w-4 h-4 mr-2" />
              Reports
            </Button>
          </div>
        </CardHeader>

        <CardContent className="p-6">
          {/* My Time Tab */}
          {timeTab === 'my-time' && (
            <div className="space-y-4">
              {/* Filters */}
              <div className="flex flex-col sm:flex-row gap-3 w-full">
                <div className="flex-1 min-w-0" style={{ flexBasis: 0 }}>
                  <label className="text-sm font-medium mb-1 block">Start Date</label>
                  <Input
                    type="date"
                    value={timeFilters.startDate}
                    onChange={(e) => setTimeFilters({ ...timeFilters, startDate: e.target.value })}
                    className="w-full"
                    data-testid="filter-start-date"
                  />
                </div>
                <div className="flex-1 min-w-0" style={{ flexBasis: 0 }}>
                  <label className="text-sm font-medium mb-1 block">End Date</label>
                  <Input
                    type="date"
                    value={timeFilters.endDate}
                    onChange={(e) => setTimeFilters({ ...timeFilters, endDate: e.target.value })}
                    className="w-full"
                    data-testid="filter-end-date"
                  />
                </div>
                <div className="flex-1 min-w-0" style={{ flexBasis: 0 }}>
                  <label className="text-sm font-medium mb-1 block">Client</label>
                  <select
                    className="w-full h-10 px-3 rounded-md border border-gray-300"
                    value={timeFilters.clientId}
                    onChange={(e) => setTimeFilters({ ...timeFilters, clientId: e.target.value })}
                    data-testid="filter-client"
                  >
                    <option value="">All Clients</option>
                    {(clients || []).map((client: any) => (
                      <option key={client.id} value={client.id}>{client.name}</option>
                    ))}
                  </select>
                </div>
                <div className="flex-1 min-w-0" style={{ flexBasis: 0 }}>
                  <label className="text-sm font-medium mb-1 block">Project</label>
                  <select
                    className="w-full h-10 px-3 rounded-md border border-gray-300"
                    value={timeFilters.projectId}
                    onChange={(e) => setTimeFilters({ ...timeFilters, projectId: e.target.value })}
                    data-testid="filter-project"
                  >
                    <option value="">All Projects</option>
                    {projects.map((project: any) => (
                      <option key={project.id} value={project.id}>{project.name}</option>
                    ))}
                  </select>
                </div>
                <div className="flex-1 min-w-0" style={{ flexBasis: 0 }}>
                  <label className="text-sm font-medium mb-1 block">Type</label>
                  <select
                    className="w-full h-10 px-3 rounded-md border border-gray-300"
                    value={timeFilters.type}
                    onChange={(e) => setTimeFilters({ ...timeFilters, type: e.target.value })}
                    data-testid="filter-type"
                  >
                    <option value="">All Types</option>
                    <option value="billable">Billable</option>
                    <option value="non_billable">Non-Billable</option>
                    <option value="internal">Internal</option>
                  </select>
                </div>
              </div>

              {/* Time Entries List */}
              {isLoadingEntries ? (
                <div className="text-center py-8 text-gray-500">Loading time entries...</div>
              ) : timeEntries.length === 0 ? (
                <div className="text-center py-12">
                  <Clock className="h-12 w-12 mx-auto text-gray-400 mb-4" />
                  <h3 className="text-lg font-semibold mb-2">No time entries yet</h3>
                  <p className="text-gray-600 mb-4">Start tracking time or add manual entries</p>
                  <Button onClick={() => setShowTimeEntryDialog(true)}>
                    <Plus className="w-4 h-4 mr-2" />
                    Add First Entry
                  </Button>
                </div>
              ) : (
                <div className="overflow-x-auto w-full">
                  <Table className="w-full">
                    <TableHeader>
                      <TableRow>
                        <TableHead>Date</TableHead>
                        <TableHead>Client</TableHead>
                        <TableHead>Project</TableHead>
                        <TableHead>Description</TableHead>
                        <TableHead>Duration</TableHead>
                        <TableHead>Type</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead className="text-right">Actions</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {timeEntries.map((entry: any) => (
                        <TableRow key={entry.id}>
                          <TableCell>{entry.date ? format(new Date(entry.date), 'MMM dd, yyyy') : 'N/A'}</TableCell>
                          <TableCell>{entry.client?.name || `Client #${entry.clientId}`}</TableCell>
                          <TableCell>{entry.project?.name || `Project #${entry.projectId || 'N/A'}`}</TableCell>
                          <TableCell className="max-w-xs truncate">{entry.description}</TableCell>
                          <TableCell>{formatDuration(entry.duration || 0)}</TableCell>
                          <TableCell>
                            <Badge variant={entry.type === 'billable' ? 'default' : 'secondary'}>
                              {entry.type}
                            </Badge>
                          </TableCell>
                          <TableCell>
                            <Badge variant={
                              entry.status === 'approved' ? 'default' :
                                entry.status === 'pending' ? 'secondary' :
                                  'destructive'
                            }>
                              {entry.status || 'draft'}
                            </Badge>
                          </TableCell>
                          <TableCell className="text-right">
                            <div className="flex justify-end gap-1">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => {
                                  setEditingEntry({
                                    ...entry,
                                    startTime: entry.startTime || new Date().toISOString().slice(0, 16),
                                    endTime: entry.endTime || new Date().toISOString().slice(0, 16)
                                  });
                                  setShowTimeEntryDialog(true);
                                }}
                                data-testid={`edit-entry-${entry.id}`}
                              >
                                <Edit3 className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => {
                                  if (confirm('Delete this time entry?')) {
                                    deleteEntryMutation.mutate(entry.id);
                                  }
                                }}
                                data-testid={`delete-entry-${entry.id}`}
                              >
                                <Trash2 className="h-4 w-4 text-red-600" />
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              )}
            </div>
          )}

          {/* Approvals Tab */}
          {timeTab === 'approvals' && (
            <div>
              <TimeApprovalQueue />
            </div>
          )}

          {/* Rates Tab */}
          {timeTab === 'rates' && (
            <div className="text-center py-12">
              <DollarSign className="h-12 w-12 mx-auto text-gray-400 mb-4" />
              <h3 className="text-lg font-semibold mb-2">Rate Management</h3>
              <p className="text-gray-600">Configure staff rates, client rates, and task type overrides</p>
              <p className="text-sm text-gray-500 mt-4">Coming soon in next update</p>
            </div>
          )}

          {/* Reports Tab */}
          {timeTab === 'reports' && (
            <div className="space-y-6" data-testid="time-reports">
              {/* Summary Cards */}
              <div className="grid gap-4 md:grid-cols-4">
                <Card>
                  <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Unbilled Time</CardTitle>
                    <Clock className="h-4 w-4 text-muted-foreground" />
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {((timeEntries?.filter((e: any) => e.status === 'approved' && !e.invoiceLineItemId).reduce((sum: number, e: any) => sum + (Number(e.duration) || 0), 0) || 0) / 3600).toFixed(1)}h
                    </div>
                    <p className="text-xs text-muted-foreground">
                      Approved & not invoiced
                    </p>
                  </CardContent>
                </Card>
                <Card>
                  <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Billable Hours</CardTitle>
                    <DollarSign className="h-4 w-4 text-muted-foreground" />
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {((timeEntries?.filter((e: any) => e.isBillable === true).reduce((sum: number, e: any) => sum + (Number(e.duration) || 0), 0) || 0) / 3600).toFixed(1)}h
                    </div>
                    <p className="text-xs text-muted-foreground">
                      All billable time entries
                    </p>
                  </CardContent>
                </Card>
                <Card>
                  <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Non-Billable Hours</CardTitle>
                    <Clock className="h-4 w-4 text-muted-foreground" />
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {((timeEntries?.filter((e: any) => e.isBillable === false).reduce((sum: number, e: any) => sum + (Number(e.duration) || 0), 0) || 0) / 3600).toFixed(1)}h
                    </div>
                    <p className="text-xs text-muted-foreground">
                      All non-billable time
                    </p>
                  </CardContent>
                </Card>
                <Card>
                  <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Total Entries</CardTitle>
                    <BarChart3 className="h-4 w-4 text-muted-foreground" />
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">{timeEntries?.length || 0}</div>
                    <p className="text-xs text-muted-foreground">
                      Time entries recorded
                    </p>
                  </CardContent>
                </Card>
              </div>

              {/* Unbilled Time Entries */}
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0">
                  <div>
                    <CardTitle>Unbilled Time Entries</CardTitle>
                    <CardDescription>
                      Approved time entries ready to be invoiced
                    </CardDescription>
                  </div>
                  {timeEntries?.filter((e: any) => e.status === 'approved' && !e.invoiceLineItemId).length > 0 && (
                    <Button
                      onClick={() => {
                        const unbilledEntries = timeEntries?.filter((e: any) => e.status === 'approved' && !e.invoiceLineItemId) || [];
                        if (unbilledEntries.length === 0) {
                          toast({ title: 'No unbilled entries', description: 'All approved entries are already billed', variant: 'destructive' });
                          return;
                        }
                        // Group by client
                        const entriesByClient = unbilledEntries.reduce((acc: any, entry: any) => {
                          const clientId = entry.clientId;
                          if (!acc[clientId]) acc[clientId] = [];
                          acc[clientId].push(entry);
                          return acc;
                        }, {});
                        const clientIds = Object.keys(entriesByClient);
                        if (clientIds.length === 0) {
                          toast({ title: 'No client found', description: 'Time entries must have a client assigned', variant: 'destructive' });
                          return;
                        }
                        if (clientIds.length > 1) {
                          toast({ title: 'Multiple clients', description: 'Please select entries from a single client. Creating invoice for first client.', variant: 'default' });
                        }
                        const selectedClientId = parseInt(clientIds[0]);
                        const selectedEntries = entriesByClient[selectedClientId];
                        const timeEntryIds = selectedEntries.map((e: any) => e.id);
                        const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        createInvoiceFromTimeMutation.mutate({
                          clientId: selectedClientId,
                          timeEntryIds,
                          dueDate,
                          notes: `Invoice created from ${selectedEntries.length} time entries`
                        });
                      }}
                      data-testid="generate-invoice-from-time-button"
                      disabled={createInvoiceFromTimeMutation.isPending}
                    >
                      <FileText className="w-4 h-4 mr-2" />
                      {createInvoiceFromTimeMutation.isPending ? 'Creating Invoice...' : 'Generate Invoice from Time'}
                    </Button>
                  )}
                </CardHeader>
                <CardContent>
                  {(() => {
                    const unbilledEntries = timeEntries?.filter((e: any) => e.status === 'approved' && !e.invoiceLineItemId) || [];
                    if (unbilledEntries.length === 0) {
                      return (
                        <div className="text-center py-8 text-gray-500">
                          No unbilled time entries
                        </div>
                      );
                    }
                    return (
                      <div className="overflow-x-auto w-full">
                        <Table className="w-full">
                          <TableHeader>
                            <TableRow>
                              <TableHead>Date</TableHead>
                              <TableHead>Client</TableHead>
                              <TableHead>Project</TableHead>
                              <TableHead>Description</TableHead>
                              <TableHead>Staff</TableHead>
                              <TableHead className="text-right">Duration</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {unbilledEntries.map((entry: any) => {
                              const entryClient = clients.find((c: any) => c.id === entry.clientId);
                              const entryProject = projects.find((p: any) => p.id === entry.projectId);
                              const entryUser = users?.find((u: any) => u.id === entry.userId);
                              return (
                                <TableRow key={entry.id}>
                                  <TableCell>
                                    {entry.startTime ? new Date(entry.startTime).toLocaleDateString() : 'N/A'}
                                  </TableCell>
                                  <TableCell>{entryClient?.name || 'N/A'}</TableCell>
                                  <TableCell>{entryProject?.name || 'N/A'}</TableCell>
                                  <TableCell className="max-w-xs truncate">{entry.description}</TableCell>
                                  <TableCell>{entryUser?.name || 'N/A'}</TableCell>
                                  <TableCell className="text-right">
                                    {((Number(entry.duration) || 0) / 3600).toFixed(1)}h
                                  </TableCell>
                                </TableRow>
                              );
                            })}
                          </TableBody>
                        </Table>
                      </div>
                    );
                  })()}
                </CardContent>
              </Card>

              {/* Time Breakdown Charts */}
              <div className="grid gap-4 md:grid-cols-2">
                <Card>
                  <CardHeader>
                    <CardTitle>Time by Client</CardTitle>
                    <CardDescription>Total hours per client</CardDescription>
                  </CardHeader>
                  <CardContent>
                    {(() => {
                      const clientTime = (timeEntries || []).reduce((acc: any, entry: any) => {
                        const client = clients.find((c: any) => c.id === entry.clientId);
                        const clientName = client?.name || 'Unassigned';
                        acc[clientName] = (acc[clientName] || 0) + (Number(entry.duration) || 0);
                        return acc;
                      }, {});
                      const data = Object.entries(clientTime).map(([name, seconds]: [string, any]) => ({
                        name,
                        hours: (seconds / 3600).toFixed(1)
                      })).sort((a, b) => parseFloat(b.hours) - parseFloat(a.hours));

                      if (data.length === 0) {
                        return <div className="text-center py-8 text-gray-500">No time entries</div>;
                      }

                      return (
                        <div className="space-y-2">
                          {data.slice(0, 10).map((item, i) => (
                            <div key={i} className="flex items-center">
                              <div className="w-24 truncate text-sm">{item.name}</div>
                              <div className="flex-1 ml-2">
                                <div className="bg-blue-100 h-6 rounded" style={{ width: `${(parseFloat(item.hours) / parseFloat(data[0].hours)) * 100}%` }}>
                                  <div className="px-2 text-xs font-medium text-blue-900 flex items-center h-full">
                                    {item.hours}h
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle>Billable vs Non-Billable</CardTitle>
                    <CardDescription>Time distribution by type</CardDescription>
                  </CardHeader>
                  <CardContent>
                    {(() => {
                      const billable = (timeEntries?.filter((e: any) => e.isBillable === true).reduce((sum: number, e: any) => sum + (Number(e.duration) || 0), 0) || 0) / 3600;
                      const nonBillable = (timeEntries?.filter((e: any) => e.isBillable === false).reduce((sum: number, e: any) => sum + (Number(e.duration) || 0), 0) || 0) / 3600;
                      const total = billable + nonBillable;

                      if (total === 0) {
                        return <div className="text-center py-8 text-gray-500">No time entries</div>;
                      }

                      const billablePercent = ((billable / total) * 100).toFixed(1);
                      const nonBillablePercent = ((nonBillable / total) * 100).toFixed(1);

                      return (
                        <div className="space-y-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <div className="w-4 h-4 bg-green-500 rounded"></div>
                              <span className="text-sm">Billable</span>
                            </div>
                            <div className="text-sm font-medium">{billable.toFixed(1)}h ({billablePercent}%)</div>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-8">
                            <div className="bg-green-500 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" style={{ width: `${billablePercent}%` }}>
                              {parseFloat(billablePercent) > 20 && `${billablePercent}%`}
                            </div>
                          </div>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <div className="w-4 h-4 bg-gray-400 rounded"></div>
                              <span className="text-sm">Non-Billable</span>
                            </div>
                            <div className="text-sm font-medium">{nonBillable.toFixed(1)}h ({nonBillablePercent}%)</div>
                          </div>
                        </div>
                      );
                    })()}
                  </CardContent>
                </Card>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Time Entry Dialog */}
      <Dialog open={showTimeEntryDialog} onOpenChange={setShowTimeEntryDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>{editingEntry ? 'Edit Time Entry' : 'Add Time Entry'}</DialogTitle>
            <DialogDescription>
              {editingEntry ? 'Update the details of this time entry' : 'Create a new time entry manually'}
            </DialogDescription>
          </DialogHeader>
          <TimeEntryForm
            initialData={editingEntry}
            timeEntryId={editingEntry?.id}
            onSuccess={() => {
              setShowTimeEntryDialog(false);
              setEditingEntry(null);
            }}
            onCancel={() => {
              setShowTimeEntryDialog(false);
              setEditingEntry(null);
            }}
          />
        </DialogContent>
      </Dialog>
    </div>
  );
}

// TasksView Component
// GanttChartView Component
interface GanttChartViewProps {
  tasks: any[];
  projects: any[];
  users: any[];
}

function GanttChartView({ tasks, projects, users }: GanttChartViewProps) {
  const [zoomLevel, setZoomLevel] = useState<'day' | 'week' | 'month'>('week');
  const [selectedProject, setSelectedProject] = useState<string>('all');
  const [hoveredTask, setHoveredTask] = useState<number | null>(null);
  const [isDragging, setIsDragging] = useState<number | null>(null);
  const [dragOffset, setDragOffset] = useState(0);
  const [dragStartX, setDragStartX] = useState(0);
  const [draggedTaskPosition, setDraggedTaskPosition] = useState<{ left: number; width: number } | null>(null);

  // Dynamic timeline configuration based on zoom level
  const today = new Date();
  const { timelineStart, timelineEnd, totalDays } = (() => {
    switch (zoomLevel) {
      case 'day':
        // 7 days: ¬±3 days from today
        return {
          timelineStart: addDays(today, -3),
          timelineEnd: addDays(today, 3),
          totalDays: 7
        };
      case 'week':
        // 4 weeks: ¬±2 weeks from today
        return {
          timelineStart: addDays(today, -14),
          timelineEnd: addDays(today, 14),
          totalDays: 28
        };
      case 'month':
        // 12 weeks: ¬±6 weeks from today
        return {
          timelineStart: addDays(today, -42),
          timelineEnd: addDays(today, 42),
          totalDays: 84
        };
      default:
        return {
          timelineStart: addDays(today, -14),
          timelineEnd: addDays(today, 14),
          totalDays: 28
        };
    }
  })();

  // Filter and sort tasks
  const filteredTasks = tasks
    .filter((task: any) => selectedProject === 'all' || task.projectId === parseInt(selectedProject))
    .filter((task: any) => task.startDate && task.dueDate)
    .sort((a: any, b: any) => {
      const projectCompare = a.projectId - b.projectId;
      if (projectCompare !== 0) return projectCompare;
      return new Date(a.startDate).getTime() - new Date(b.startDate).getTime();
    });

  // Group tasks by project
  const tasksByProject = filteredTasks.reduce((acc: any, task: any) => {
    const projectId = task.projectId;
    if (!acc[projectId]) {
      acc[projectId] = [];
    }
    acc[projectId].push(task);
    return acc;
  }, {});

  // Calculate task position and width
  const getTaskMetrics = (task: any) => {
    const taskStart = new Date(task.startDate);
    const taskEnd = new Date(task.dueDate);

    const daysFromStart = Math.max(0, (taskStart.getTime() - timelineStart.getTime()) / (1000 * 60 * 60 * 24));
    const taskDuration = (taskEnd.getTime() - taskStart.getTime()) / (1000 * 60 * 60 * 24);

    const left = (daysFromStart / totalDays) * 100;
    const width = Math.max(1, (taskDuration / totalDays) * 100);

    return { left, width, duration: taskDuration };
  };

  // Get status color
  const getStatusColor = (status: string) => {
    switch (status?.toLowerCase()) {
      case 'completed':
        return 'bg-green-500';
      case 'in-progress':
      case 'in progress':
        return 'bg-blue-500';
      case 'todo':
      case 'open':
        return 'bg-yellow-500';
      case 'blocked':
        return 'bg-red-500';
      default:
        return 'bg-gray-400';
    }
  };

  // Update task dates mutation
  const updateTaskMutation = useMutation({
    mutationFn: async ({ taskId, updates }: { taskId: number; updates: any }) => {
      const response = await apiRequest('PATCH', `/api/tasks/${taskId}`, updates);
      if (!response.ok) throw new Error('Failed to update task');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
      toast({
        title: "Success",
        description: "Task dates updated successfully",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Enhanced drag handlers with proper mouse move tracking
  const handleTaskDragStart = (taskId: number, task: any, e: React.MouseEvent) => {
    e.stopPropagation();
    setIsDragging(taskId);
    setDragStartX(e.clientX);

    // Calculate and store the initial task position
    const metrics = getTaskMetrics(task);
    setDraggedTaskPosition({ left: metrics.left, width: metrics.width });
  };

  const handleTaskDrag = (e: React.MouseEvent) => {
    if (!isDragging || !draggedTaskPosition) return;
    e.preventDefault();
    e.stopPropagation();

    // Calculate the container element and its width
    const container = (e.currentTarget as HTMLElement).closest('.gantt-timeline');
    if (!container) return;

    const rect = container.getBoundingClientRect();
    const containerWidth = rect.width;

    // Calculate pixel delta from drag start
    const pixelDelta = e.clientX - dragStartX;

    // Convert pixel delta to percentage
    const percentageDelta = (pixelDelta / containerWidth) * 100;

    // Update the dragged task position for visual feedback
    setDraggedTaskPosition({
      left: draggedTaskPosition.left + percentageDelta,
      width: draggedTaskPosition.width
    });
  };

  const handleTaskDragEnd = (task: any, e: React.MouseEvent) => {
    if (!isDragging || !draggedTaskPosition) {
      setIsDragging(null);
      setDraggedTaskPosition(null);
      return;
    }

    e.stopPropagation();

    const container = (e.currentTarget as HTMLElement).closest('.gantt-timeline');
    if (!container) {
      setIsDragging(null);
      setDraggedTaskPosition(null);
      return;
    }

    const rect = container.getBoundingClientRect();
    const containerWidth = rect.width;

    // Calculate pixel delta
    const pixelDelta = e.clientX - dragStartX;

    // Calculate dayWidth: containerWidth / totalDays
    const dayWidth = containerWidth / totalDays;

    // Convert pixel delta to days
    const daysDelta = Math.round(pixelDelta / dayWidth);

    // If no movement, just clean up
    if (daysDelta === 0) {
      setIsDragging(null);
      setDraggedTaskPosition(null);
      return;
    }

    // Calculate new dates
    const originalStartDate = new Date(task.startDate);
    const originalDueDate = new Date(task.dueDate);

    const newStartDate = addDays(originalStartDate, daysDelta);
    const newDueDate = addDays(originalDueDate, daysDelta);

    // Update via mutation
    updateTaskMutation.mutate({
      taskId: task.id,
      updates: {
        startDate: format(newStartDate, 'yyyy-MM-dd'),
        dueDate: format(newDueDate, 'yyyy-MM-dd'),
      },
    });

    setIsDragging(null);
    setDraggedTaskPosition(null);
    setDragStartX(0);
  };

  // Render date axis
  const renderDateAxis = () => {
    const dates = [];
    for (let i = 0; i < totalDays; i++) {
      const date = addDays(timelineStart, i);
      dates.push(date);
    }

    if (zoomLevel === 'day') {
      return (
        <div className="flex border-b">
          {dates.map((date, i) => (
            <div
              key={i}
              className={`flex-1 text-xs text-center py-2 border-r ${isToday(date) ? 'bg-blue-50 font-bold' : ''}`}
              data-testid={`gantt-date-${format(date, 'yyyy-MM-dd')}`}
            >
              <div>{format(date, 'MMM d')}</div>
              <div className="text-gray-500">{format(date, 'EEE')}</div>
            </div>
          ))}
        </div>
      );
    } else if (zoomLevel === 'week') {
      const weeks = [];
      for (let i = 0; i < totalDays; i += 7) {
        weeks.push(addDays(timelineStart, i));
      }
      return (
        <div className="flex border-b">
          {weeks.map((date, i) => (
            <div
              key={i}
              className="flex-1 text-xs text-center py-2 border-r"
              data-testid={`gantt-week-${i}`}
            >
              <div>{format(date, 'MMM d')} - {format(addDays(date, 6), 'MMM d')}</div>
            </div>
          ))}
        </div>
      );
    } else {
      return (
        <div className="flex border-b">
          <div className="flex-1 text-xs text-center py-2">
            <div>{format(timelineStart, 'MMM yyyy')} - {format(timelineEnd, 'MMM yyyy')}</div>
          </div>
        </div>
      );
    }
  };

  // Render dependency lines
  const renderDependencyLines = (task: any, taskIndex: number, projectTasks: any[]) => {
    if (!task.dependsOn || task.dependsOn.length === 0) return null;

    return task.dependsOn.map((depId: number) => {
      const depTask = projectTasks.find((t: any) => t.id === depId);
      if (!depTask) return null;

      const depIndex = projectTasks.indexOf(depTask);
      const { left: depLeft, width: depWidth } = getTaskMetrics(depTask);
      const { left: taskLeft } = getTaskMetrics(task);

      const x1 = depLeft + depWidth;
      const y1 = depIndex * 40 + 20;
      const x2 = taskLeft;
      const y2 = taskIndex * 40 + 20;

      return (
        <line
          key={depId}
          x1={`${x1}%`}
          y1={y1}
          x2={`${x2}%`}
          y2={y2}
          stroke="#94a3b8"
          strokeWidth="2"
          strokeDasharray="4"
          markerEnd="url(#arrowhead)"
        />
      );
    });
  };

  return (
    <Card className="w-full" data-testid="gantt-chart-view">
      <CardHeader>
        <div className="flex justify-between items-center">
          <div>
            <CardTitle className="flex items-center gap-2">
              <BarChart3 className="h-5 w-5" />
              Project Timeline - Gantt Chart
            </CardTitle>
            <CardDescription>
              Visual timeline of project tasks with dependencies
            </CardDescription>
          </div>

          <div className="flex gap-2" data-testid="gantt-controls">
            {/* Project Filter */}
            <Select value={selectedProject} onValueChange={setSelectedProject}>
              <SelectTrigger className="w-48" data-testid="gantt-project-filter">
                <SelectValue placeholder="Filter by project" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Projects</SelectItem>
                {projects.map((project: any) => (
                  <SelectItem key={project.id} value={project.id.toString()}>
                    {project.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>

            {/* Zoom Controls */}
            <div className="flex gap-1 border rounded-md">
              <Button
                size="sm"
                variant={zoomLevel === 'day' ? 'default' : 'ghost'}
                onClick={() => setZoomLevel('day')}
                data-testid="zoom-day"
              >
                Day
              </Button>
              <Button
                size="sm"
                variant={zoomLevel === 'week' ? 'default' : 'ghost'}
                onClick={() => setZoomLevel('week')}
                data-testid="zoom-week"
              >
                Week
              </Button>
              <Button
                size="sm"
                variant={zoomLevel === 'month' ? 'default' : 'ghost'}
                onClick={() => setZoomLevel('month')}
                data-testid="zoom-month"
              >
                Month
              </Button>
            </div>
          </div>
        </div>
      </CardHeader>

      <CardContent>
        {filteredTasks.length === 0 ? (
          <div className="text-center py-12 text-gray-500" data-testid="no-tasks-message">
            <BarChart3 className="h-12 w-12 mx-auto mb-4 opacity-50" />
            <p>No tasks with dates found. Add start and due dates to tasks to see them in the Gantt chart.</p>
          </div>
        ) : (
          <div className="space-y-6">
            {/* Date Axis */}
            <div className="bg-gray-50 rounded-t-lg sticky top-0 z-10">
              {renderDateAxis()}
            </div>

            {/* Tasks by Project */}
            {Object.entries(tasksByProject).map(([projectId, projectTasks]: [string, any]) => {
              const project = projects.find((p: any) => p.id === parseInt(projectId));

              return (
                <div key={projectId} className="border rounded-lg" data-testid={`project-group-${projectId}`}>
                  <div className="bg-gray-100 px-4 py-2 font-semibold flex items-center gap-2">
                    <Folder className="h-4 w-4" />
                    {project?.name || 'Unknown Project'}
                    <Badge variant="secondary">{projectTasks.length} tasks</Badge>
                  </div>

                  <div className="relative gantt-timeline" style={{ minHeight: `${projectTasks.length * 40}px` }}>
                    {/* Grid lines */}
                    <div className="absolute inset-0 flex">
                      {Array.from({ length: totalDays }).map((_, i) => (
                        <div
                          key={i}
                          className={`flex-1 border-r ${i === Math.floor(totalDays / 2) ? 'border-blue-300 bg-blue-50/30' : ''}`}
                        />
                      ))}
                    </div>

                    {/* SVG for dependency arrows */}
                    <svg className="absolute inset-0 pointer-events-none" style={{ zIndex: 1 }}>
                      <defs>
                        <marker
                          id="arrowhead"
                          markerWidth="10"
                          markerHeight="10"
                          refX="5"
                          refY="5"
                          orient="auto"
                        >
                          <polygon points="0 0, 10 5, 0 10" fill="#94a3b8" />
                        </marker>
                      </defs>
                      {projectTasks.map((task: any, index: number) =>
                        renderDependencyLines(task, index, projectTasks)
                      )}
                    </svg>

                    {/* Task bars */}
                    {projectTasks.map((task: any, index: number) => {
                      const { left, width, duration } = getTaskMetrics(task);
                      const assignedUser = users?.find((u: any) => u.id === task.assignedTo);

                      // If this task is being dragged, use the dragged position
                      const isCurrentlyDragging = isDragging === task.id;
                      const displayLeft = isCurrentlyDragging && draggedTaskPosition ? draggedTaskPosition.left : left;
                      const displayWidth = isCurrentlyDragging && draggedTaskPosition ? draggedTaskPosition.width : width;

                      return (
                        <div
                          key={task.id}
                          className={`absolute h-8 transition-all ${isCurrentlyDragging ? 'opacity-70 scale-105 z-50' : 'z-10'}`}
                          style={{
                            top: `${index * 40 + 6}px`,
                            left: `${displayLeft}%`,
                            width: `${displayWidth}%`,
                          }}
                          onMouseDown={(e) => handleTaskDragStart(task.id, task, e)}
                          onMouseMove={handleTaskDrag}
                          onMouseUp={(e) => handleTaskDragEnd(task, e)}
                          onMouseEnter={() => setHoveredTask(task.id)}
                          onMouseLeave={() => setHoveredTask(null)}
                          data-testid={`task-bar-${task.id}`}
                        >
                          <div
                            className={`h-full rounded px-2 flex items-center justify-between cursor-move ${getStatusColor(task.status)} text-white text-xs font-medium shadow-md hover:shadow-lg transition-shadow relative`}
                          >
                            <span className="truncate">{task.title}</span>
                            {task.assignedTo && (
                              <User className="h-3 w-3 ml-1 flex-shrink-0" />
                            )}
                          </div>

                          {/* Task tooltip */}
                          {hoveredTask === task.id && (
                            <div
                              className="absolute bottom-full mb-2 left-0 bg-black text-white p-3 rounded shadow-lg z-50 w-64 text-xs"
                              data-testid={`task-tooltip-${task.id}`}
                            >
                              <div className="font-semibold mb-2">{task.title}</div>
                              <div className="space-y-1">
                                <div>Status: <Badge variant="secondary" className="ml-1">{task.status}</Badge></div>
                                <div>Duration: {Math.round(duration)} days</div>
                                <div>Start: {format(new Date(task.startDate), 'MMM d, yyyy')}</div>
                                <div>Due: {format(new Date(task.dueDate), 'MMM d, yyyy')}</div>
                                {assignedUser && <div>Assigned: {assignedUser.username || assignedUser.email}</div>}
                                {task.estimatedHours && <div>Est. Hours: {task.estimatedHours}h</div>}
                                {task.dependsOn && task.dependsOn.length > 0 && (
                                  <div>Dependencies: {task.dependsOn.length} task(s)</div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

interface TasksViewProps {
  tasks: any;
  taskStatuses: any[];
  clients: any;
  projects: any;
  users: any;
  updateTaskStatusMutation: any;
  setShowNewTaskDialog: (show: boolean) => void;
}

function TasksView({ 
  tasks, 
  taskStatuses, 
  clients, 
  projects, 
  users, 
  updateTaskStatusMutation, 
  setShowNewTaskDialog,
  activeTimer,
  startTimerForTaskMutation,
  stopTimerMutation,
  showStopTimerDialog,
  setShowStopTimerDialog,
  stopTimerNotes,
  setStopTimerNotes
}: TasksViewProps & {
  activeTimer?: any;
  startTimerForTaskMutation?: any;
  stopTimerMutation?: any;
  showStopTimerDialog?: boolean;
  setShowStopTimerDialog?: (show: boolean) => void;
  stopTimerNotes?: string;
  setStopTimerNotes?: (notes: string) => void;
}) {
  // Helper function to safely extract data arrays
  const safeArray = (data: any) => data?.data || data || [];

  // Enhanced filter state with multi-select support
  const [taskFilters, setTaskFilters] = useState({
    clientId: '',
    projectId: '',
    assignedUserId: '',
    search: '',
    dateFrom: '',
    dateTo: '',
    statusIds: [] as string[],
    priorities: [] as string[],
    tags: [] as string[],
    assigneeIds: [] as string[],
  });

  // View mode removed - list view only
  const [selectedTask, setSelectedTask] = useState<any>(null);

  // Part 1: Sorting state
  const [sortBy, setSortBy] = useState<string>('dueDate');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');

  // Part 2: Bulk selection state
  const [selectedTaskIds, setSelectedTaskIds] = useState<Set<number>>(new Set());
  const [showBulkDeleteConfirm, setShowBulkDeleteConfirm] = useState(false);

  // Note: activeTimer, startTimerForTaskMutation, stopTimerMutation, showStopTimerDialog, 
  // setShowStopTimerDialog, stopTimerNotes, setStopTimerNotes are passed as props from parent
  // Use the props directly, don't redeclare them here

  // Bulk delete mutation
  const bulkDeleteMutation = useMutation({
    mutationFn: async (taskIds: number[]) => {
      const results = await Promise.all(
        taskIds.map(id =>
          apiRequest('DELETE', `/api/tasks/${id}`, {})
            .then(res => ({ id, success: res.ok }))
            .catch(() => ({ id, success: false }))
        )
      );
      return results;
    },
    onSuccess: (results) => {
      const successCount = results.filter(r => r.success).length;
      toast({
        title: 'Bulk delete completed',
        description: `${successCount} of ${results.length} tasks deleted successfully`
      });
      setSelectedTaskIds(new Set());
      setShowBulkDeleteConfirm(false);
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
    },
    onError: () => {
      toast({ title: 'Bulk delete failed', variant: 'destructive' });
    }
  });

  // Bulk status change mutation
  const bulkStatusChangeMutation = useMutation({
    mutationFn: async ({ taskIds, statusId }: { taskIds: number[]; statusId: number }) => {
      const results = await Promise.all(
        taskIds.map(id =>
          apiRequest('PATCH', `/api/tasks/${id}`, { statusId })
            .then(res => ({ id, success: res.ok }))
            .catch(() => ({ id, success: false }))
        )
      );
      return results;
    },
    onSuccess: (results) => {
      const successCount = results.filter(r => r.success).length;
      toast({
        title: 'Bulk status change completed',
        description: `${successCount} of ${results.length} tasks updated successfully`
      });
      setSelectedTaskIds(new Set());
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
    },
    onError: () => {
      toast({ title: 'Bulk status change failed', variant: 'destructive' });
    }
  });

  // Bulk assign mutation
  const bulkAssignMutation = useMutation({
    mutationFn: async ({ taskIds, assignedTo }: { taskIds: number[]; assignedTo: number }) => {
      const results = await Promise.all(
        taskIds.map(id =>
          apiRequest('PATCH', `/api/tasks/${id}`, { assignedTo })
            .then(res => ({ id, success: res.ok }))
            .catch(() => ({ id, success: false }))
        )
      );
      return results;
    },
    onSuccess: (results) => {
      const successCount = results.filter(r => r.success).length;
      toast({
        title: 'Bulk assign completed',
        description: `${successCount} of ${results.length} tasks assigned successfully`
      });
      setSelectedTaskIds(new Set());
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
    },
    onError: () => {
      toast({ title: 'Bulk assign failed', variant: 'destructive' });
    }
  });

  // Debug: Log what we're receiving
  console.log('üîç TasksView received tasks:', tasks, 'Type:', Array.isArray(tasks), 'Length:', tasks?.length);

  // Since tasks is already an array from parent, use it directly
  const allTasks = Array.isArray(tasks) ? tasks : [];

  // Apply filters with multi-select support
  const filteredTasks = allTasks.filter((task: any) => {
    if (taskFilters.clientId && task.clientId !== parseInt(taskFilters.clientId)) return false;
    if (taskFilters.projectId && task.projectId !== parseInt(taskFilters.projectId)) return false;
    if (taskFilters.assignedUserId && task.assignedTo !== parseInt(taskFilters.assignedUserId)) return false;

    // Multi-select filters
    if (taskFilters.statusIds.length > 0 && !taskFilters.statusIds.includes(String(task.statusId))) return false;
    if (taskFilters.priorities.length > 0 && !taskFilters.priorities.includes(task.priority)) return false;
    if (taskFilters.assigneeIds.length > 0 && !taskFilters.assigneeIds.includes(String(task.assignedTo))) return false;

    if (taskFilters.search) {
      const searchLower = taskFilters.search.toLowerCase();
      const titleMatch = task.title?.toLowerCase().includes(searchLower);
      const descMatch = task.description?.toLowerCase().includes(searchLower);
      if (!titleMatch && !descMatch) return false;
    }
    if (taskFilters.dateFrom && task.dueDate) {
      if (new Date(task.dueDate) < new Date(taskFilters.dateFrom)) return false;
    }
    if (taskFilters.dateTo && task.dueDate) {
      if (new Date(task.dueDate) > new Date(taskFilters.dateTo)) return false;
    }
    return true;
  });

  // Apply sorting
  const sortedTasks = [...filteredTasks].sort((a, b) => {
    let aVal, bVal;

    switch (sortBy) {
      case 'title':
        aVal = a.title || '';
        bVal = b.title || '';
        break;
      case 'status':
        aVal = taskStatuses.find((s: any) => s.id === a.statusId)?.name || '';
        bVal = taskStatuses.find((s: any) => s.id === b.statusId)?.name || '';
        break;
      case 'priority':
        const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
        aVal = priorityOrder[a.priority as keyof typeof priorityOrder] || 0;
        bVal = priorityOrder[b.priority as keyof typeof priorityOrder] || 0;
        break;
      case 'dueDate':
        aVal = a.dueDate ? new Date(a.dueDate).getTime() : 0;
        bVal = b.dueDate ? new Date(b.dueDate).getTime() : 0;
        break;
      case 'assignee':
        aVal = safeArray(users).find((u: any) => u.id === a.assignedTo)?.name || '';
        bVal = safeArray(users).find((u: any) => u.id === b.assignedTo)?.name || '';
        break;
      case 'estimatedHours':
        aVal = a.estimatedHours || 0;
        bVal = b.estimatedHours || 0;
        break;
      default:
        return 0;
    }

    if (sortOrder === 'asc') {
      return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
    } else {
      return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
    }
  });

  // Handle column header click for sorting
  const handleSort = (column: string) => {
    if (sortBy === column) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(column);
      setSortOrder('asc');
    }
  };

  // Render sort indicator
  const renderSortIndicator = (column: string) => {
    if (sortBy !== column) return null;
    return sortOrder === 'asc' ? <ChevronUp className="w-4 h-4 inline ml-1" /> : <ChevronDown className="w-4 h-4 inline ml-1" />;
  };

  // Handle select all checkbox
  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      setSelectedTaskIds(new Set(sortedTasks.map(t => t.id)));
    } else {
      setSelectedTaskIds(new Set());
    }
  };

  // Handle individual checkbox
  const handleSelectTask = (taskId: number, checked: boolean) => {
    const newSet = new Set(selectedTaskIds);
    if (checked) {
      newSet.add(taskId);
    } else {
      newSet.delete(taskId);
    }
    setSelectedTaskIds(newSet);
  };

  const clearFilters = () => {
    setTaskFilters({
      clientId: '',
      projectId: '',
      assignedUserId: '',
      search: '',
      dateFrom: '',
      dateTo: '',
      statusIds: [],
      priorities: [],
      tags: [],
      assigneeIds: [],
    });
  };

  // Check if any filters are active
  const hasActiveFilters = () => {
    return taskFilters.clientId || taskFilters.projectId || taskFilters.assignedUserId ||
      taskFilters.search || taskFilters.dateFrom || taskFilters.dateTo ||
      taskFilters.statusIds.length > 0 || taskFilters.priorities.length > 0 ||
      taskFilters.assigneeIds.length > 0;
  };

  // Remove individual filter
  const removeFilter = (filterKey: string, value?: string) => {
    if (filterKey === 'statusIds' || filterKey === 'priorities' || filterKey === 'assigneeIds') {
      setTaskFilters(prev => ({
        ...prev,
        [filterKey]: prev[filterKey].filter(v => v !== value)
      }));
    } else {
      setTaskFilters(prev => ({ ...prev, [filterKey]: '' }));
    }
  };

  const handleTaskDragEnd = (result: any) => {
    if (!result.destination) return;

    const { draggableId, destination } = result;
    const taskId = parseInt(draggableId.replace('task-', ''));
    const newStatusId = parseInt(destination.droppableId.replace('status-', ''));

    updateTaskStatusMutation.mutate({ taskId, statusId: newStatusId });
  };

  // Part 4: Export functions
  const exportToExcel = () => {
    const exportData = sortedTasks.map((task: any) => ({
      'Title': task.title,
      'Status': taskStatuses.find((s: any) => s.id === task.statusId)?.name || '',
      'Priority': task.priority || '',
      'Due Date': task.dueDate ? format(new Date(task.dueDate), 'yyyy-MM-dd') : '',
      'Assigned To': safeArray(users).find((u: any) => u.id === task.assignedTo)?.name || '',
      'Estimated Hours': task.estimatedHours || 0,
      'Tags': task.tags?.join(', ') || '',
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Tasks");
    XLSX.writeFile(wb, `tasks-export-${format(new Date(), 'yyyy-MM-dd')}.xlsx`);
    toast({ title: 'Tasks exported to Excel successfully' });
  };

  const exportToCSV = () => {
    const exportData = sortedTasks.map((task: any) => ({
      'Title': task.title,
      'Status': taskStatuses.find((s: any) => s.id === task.statusId)?.name || '',
      'Priority': task.priority || '',
      'Due Date': task.dueDate ? format(new Date(task.dueDate), 'yyyy-MM-dd') : '',
      'Assigned To': safeArray(users).find((u: any) => u.id === task.assignedTo)?.name || '',
      'Estimated Hours': task.estimatedHours || 0,
      'Tags': task.tags?.join(', ') || '',
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Tasks");
    XLSX.writeFile(wb, `tasks-export-${format(new Date(), 'yyyy-MM-dd')}.csv`, { bookType: 'csv' });
    toast({ title: 'Tasks exported to CSV successfully' });
  };

  const exportToPDF = () => {
    const doc = new jsPDF();

    const tableData = sortedTasks.map((task: any) => [
      task.title,
      taskStatuses.find((s: any) => s.id === task.statusId)?.name || '',
      task.priority || '',
      task.dueDate ? format(new Date(task.dueDate), 'yyyy-MM-dd') : '',
      safeArray(users).find((u: any) => u.id === task.assignedTo)?.name || '',
      task.estimatedHours || 0,
      task.tags?.join(', ') || '',
    ]);

    (doc as any).autoTable({
      head: [['Title', 'Status', 'Priority', 'Due Date', 'Assigned To', 'Est. Hours', 'Tags']],
      body: tableData,
      startY: 20,
      headStyles: { fillColor: [66, 139, 202] },
      margin: { top: 20 },
      didDrawPage: function (data: any) {
        doc.text('Task List Export', 14, 15);
      }
    });

    doc.save(`tasks-export-${format(new Date(), 'yyyy-MM-dd')}.pdf`);
    toast({ title: 'Tasks exported to PDF successfully' });
  };

  // Date calculations
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const weekFromNow = new Date(today);
  weekFromNow.setDate(weekFromNow.getDate() + 7);

  return (
    <div className="space-y-6 w-full max-w-full">
      {/* Active Timer Banner */}
      {activeTimer && (
        <Card className="bg-green-50 border-green-200">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <div>
                  <p className="font-medium text-green-900">
                    Timer Running: {activeTimer.description || 'Active timer'}
                  </p>
                  <p className="text-sm text-green-700">
                    {(() => {
                      const startTime = new Date(activeTimer.startTime || activeTimer.start_time);
                      const now = new Date();
                      const elapsedMs = now.getTime() - startTime.getTime();
                      const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
                      const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
                      const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
                      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    })()}
                    {' - '}
                    {tasks?.find((t: any) => t.id === activeTimer.taskId)?.title || 'Task'}
                    {activeTimer.projectId && ` (${projects?.find((p: any) => p.id === activeTimer.projectId)?.name || 'Project'})`}
                  </p>
                </div>
              </div>
              <Button
                variant="destructive"
                size="sm"
                onClick={() => setShowStopTimerDialog?.(true)}
              >
                <Square className="w-4 h-4 mr-2" />
                Stop Timer
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Filters */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Filter className="w-5 h-5" />
            Task Filters
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 w-full max-w-full">
            {/* Search */}
            <div className="w-full min-w-0">
              <label className="text-sm font-medium mb-1 block">Search</label>
              <div className="relative w-full">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                <Input
                  placeholder="Search tasks..."
                  value={taskFilters.search}
                  onChange={(e) => setTaskFilters({ ...taskFilters, search: e.target.value })}
                  className="pl-10 w-full"
                  data-testid="input-search-tasks"
                />
              </div>
            </div>

            {/* Client filter */}
            <div className="w-full min-w-0">
              <label className="text-sm font-medium mb-1 block">Client</label>
              <Select
                value={taskFilters.clientId}
                onValueChange={(value) => setTaskFilters({ ...taskFilters, clientId: value })}
              >
                <SelectTrigger className="w-full" data-testid="select-filter-client">
                  <SelectValue placeholder="All clients" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="">All clients</SelectItem>
                  {safeArray(clients).map((client: any) => (
                    <SelectItem key={client.id} value={String(client.id)}>
                      {client.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Project filter */}
            <div className="w-full min-w-0">
              <label className="text-sm font-medium mb-1 block">Project</label>
              <Select
                value={taskFilters.projectId}
                onValueChange={(value) => setTaskFilters({ ...taskFilters, projectId: value })}
              >
                <SelectTrigger className="w-full" data-testid="select-filter-project">
                  <SelectValue placeholder="All projects" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="">All projects</SelectItem>
                  {safeArray(projects).map((project: any) => (
                    <SelectItem key={project.id} value={String(project.id)}>
                      {project.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Date From */}
            <div className="w-full min-w-0">
              <label className="text-sm font-medium mb-1 block">Due Date From</label>
              <Input
                type="date"
                value={taskFilters.dateFrom}
                onChange={(e) => setTaskFilters({ ...taskFilters, dateFrom: e.target.value })}
                className="w-full"
                data-testid="input-date-from"
              />
            </div>

            {/* Date To */}
            <div className="w-full min-w-0">
              <label className="text-sm font-medium mb-1 block">Due Date To</label>
              <Input
                type="date"
                value={taskFilters.dateTo}
                onChange={(e) => setTaskFilters({ ...taskFilters, dateTo: e.target.value })}
                className="w-full"
                data-testid="input-date-to"
              />
            </div>
          </div>

          {/* Active filter chips */}
          {hasActiveFilters() && (
            <div className="mt-4 flex flex-wrap items-center gap-2">
              <span className="text-sm font-medium">Active Filters:</span>

              {taskFilters.search && (
                <Badge variant="secondary" className="flex items-center gap-1">
                  Search: {taskFilters.search}
                  <X className="w-3 h-3 cursor-pointer" onClick={() => removeFilter('search')} />
                </Badge>
              )}

              {taskFilters.clientId && (
                <Badge variant="secondary" className="flex items-center gap-1">
                  Client: {safeArray(clients).find((c: any) => c.id === parseInt(taskFilters.clientId))?.name}
                  <X className="w-3 h-3 cursor-pointer" onClick={() => removeFilter('clientId')} />
                </Badge>
              )}

              {taskFilters.projectId && (
                <Badge variant="secondary" className="flex items-center gap-1">
                  Project: {safeArray(projects).find((p: any) => p.id === parseInt(taskFilters.projectId))?.name}
                  <X className="w-3 h-3 cursor-pointer" onClick={() => removeFilter('projectId')} />
                </Badge>
              )}

              {taskFilters.dateFrom && (
                <Badge variant="secondary" className="flex items-center gap-1">
                  From: {taskFilters.dateFrom}
                  <X className="w-3 h-3 cursor-pointer" onClick={() => removeFilter('dateFrom')} />
                </Badge>
              )}

              {taskFilters.dateTo && (
                <Badge variant="secondary" className="flex items-center gap-1">
                  To: {taskFilters.dateTo}
                  <X className="w-3 h-3 cursor-pointer" onClick={() => removeFilter('dateTo')} />
                </Badge>
              )}

              <Button
                variant="ghost"
                size="sm"
                onClick={clearFilters}
                data-testid="button-clear-all-filters"
              >
                Clear All
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Actions toolbar */}
      <div className="flex items-center justify-end gap-2">
        {/* Export dropdown */}
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" size="sm" data-testid="button-export">
              <Download className="w-4 h-4 mr-2" />
              Export
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem onClick={exportToPDF} data-testid="option-export-pdf">
              <FileTextIcon className="w-4 h-4 mr-2" />
              Export to PDF
            </DropdownMenuItem>
            <DropdownMenuItem onClick={exportToExcel} data-testid="option-export-excel">
              <FileSpreadsheet className="w-4 h-4 mr-2" />
              Export to Excel
            </DropdownMenuItem>
            <DropdownMenuItem onClick={exportToCSV} data-testid="option-export-csv">
              <Columns className="w-4 h-4 mr-2" />
              Export to CSV
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>

        <Button onClick={() => setShowNewTaskDialog(true)} size="sm" data-testid="button-new-task">
          <Plus className="w-4 h-4 mr-2" />
          New Task
        </Button>
      </div>

      {/* Bulk Actions Toolbar */}
      {selectedTaskIds.size > 0 && (
        <Card className="border-blue-500">
          <CardContent className="py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="font-medium">{selectedTaskIds.size} task{selectedTaskIds.size !== 1 ? 's' : ''} selected</span>

                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="outline" size="sm">
                      Change Status
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    {taskStatuses.filter((s: any) => s.isActive).map((status: any) => (
                      <DropdownMenuItem
                        key={status.id}
                        onClick={() => bulkStatusChangeMutation.mutate({
                          taskIds: Array.from(selectedTaskIds),
                          statusId: status.id
                        })}
                      >
                        <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: status.color }} />
                        {status.name}
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>

                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="outline" size="sm">
                      Assign To
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    {safeArray(users).map((user: any) => (
                      <DropdownMenuItem
                        key={user.id}
                        onClick={() => bulkAssignMutation.mutate({
                          taskIds: Array.from(selectedTaskIds),
                          assignedTo: user.id
                        })}
                      >
                        {user.name}
                      </DropdownMenuItem>
                    ))}
                  </DropdownMenuContent>
                </DropdownMenu>

                <Button
                  variant="destructive"
                  size="sm"
                  onClick={() => setShowBulkDeleteConfirm(true)}
                  data-testid="button-bulk-delete"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete Selected
                </Button>
              </div>

              <Button
                variant="ghost"
                size="sm"
                onClick={() => setSelectedTaskIds(new Set())}
                data-testid="button-clear-selection"
              >
                Clear Selection
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Dynamic Task Columns - Kanban Board with Drag & Drop */}
      <Card>
        <CardContent className="p-0">
          <div className="overflow-x-auto w-full">
            <Table className="w-full min-w-[800px]">
              <TableHeader>
                <TableRow>
                  <TableHead className="w-12">
                    <Checkbox
                      checked={sortedTasks.length > 0 && selectedTaskIds.size === sortedTasks.length}
                      onCheckedChange={handleSelectAll}
                      data-testid="checkbox-select-all"
                    />
                  </TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('title')}
                  >
                    Title {renderSortIndicator('title')}
                  </TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('status')}
                  >
                    Status {renderSortIndicator('status')}
                  </TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('priority')}
                  >
                    Priority {renderSortIndicator('priority')}
                  </TableHead>
                  <TableHead>Project</TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('assignee')}
                  >
                    Assigned To {renderSortIndicator('assignee')}
                  </TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('dueDate')}
                  >
                    Due Date {renderSortIndicator('dueDate')}
                  </TableHead>
                  <TableHead
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => handleSort('estimatedHours')}
                  >
                    Est. Hours {renderSortIndicator('estimatedHours')}
                  </TableHead>
                  <TableHead>Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sortedTasks.length > 0 ? (
                  sortedTasks.map((task: any) => {
                    // Try to find status by statusId first, then fall back to status string
                    let taskStatus = null;
                    if (task.statusId) {
                      taskStatus = taskStatuses.find((s: any) => s.id === task.statusId);
                    }
                    // If no status found by ID, try to find by status string name
                    if (!taskStatus && task.status) {
                      taskStatus = taskStatuses.find((s: any) => s.name?.toLowerCase() === task.status?.toLowerCase());
                    }
                    // If still no status, create a default one from the status string
                    if (!taskStatus && task.status) {
                      taskStatus = {
                        name: task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' '),
                        color: '#black'
                      };
                    }
                    const assignedUser = safeArray(users).find((u: any) => u.id === task.assignedTo);
                    const taskProject = safeArray(projects).find((p: any) => p.id === task.projectId);

                    return (
                      <TableRow
                        key={task.id}
                        data-testid={`task-row-${task.id}`}
                        className={`cursor-pointer hover:bg-muted/50 ${selectedTaskIds.has(task.id) ? 'bg-blue-50' : ''}`}
                      >
                        <TableCell onClick={(e) => e.stopPropagation()}>
                          <Checkbox
                            checked={selectedTaskIds.has(task.id)}
                            onCheckedChange={(checked) => handleSelectTask(task.id, checked as boolean)}
                            data-testid={`checkbox-task-${task.id}`}
                          />
                        </TableCell>
                        <TableCell className="font-medium" onClick={() => setSelectedTask(task)}>
                          {task.title}
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          {taskStatus ? (
                            <Badge
                              variant="outline"
                              style={{
                                backgroundColor: taskStatus.color || '#6b7280',
                                color: taskStatus.color ? '#fff' : '#000',
                                borderColor: taskStatus.color || '#6b7280'
                              }}
                            >
                              {taskStatus.name}
                            </Badge>
                          ) : (
                            <Badge variant="outline" style={{ backgroundColor: '#e5e7eb', color: '#374151' }}>
                              No Status
                            </Badge>
                          )}
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          <Badge variant={
                            task.priority === 'urgent' ? 'destructive' :
                              task.priority === 'high' ? 'default' :
                                task.priority === 'medium' ? 'secondary' :
                                  'outline'
                          }>
                            {task.priority || 'Low'}
                          </Badge>
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          {taskProject?.name || 'N/A'}
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          {assignedUser?.name || 'Unassigned'}
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'}
                        </TableCell>
                        <TableCell onClick={() => setSelectedTask(task)}>
                          {task.estimatedHours || 0}h
                        </TableCell>
                        <TableCell>
                          <div className="flex gap-2">
                            {activeTimer && activeTimer.taskId === task.id ? (
                              <Button
                                variant="default"
                                size="sm"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setShowStopTimerDialog?.(true);
                                }}
                                disabled={stopTimerMutation?.isPending}
                                className="bg-green-600 hover:bg-green-700"
                                data-testid={`button-stop-timer-${task.id}`}
                                title={`Timer running: ${(() => {
                                  const startTime = new Date(activeTimer.startTime || activeTimer.start_time);
                                  const now = new Date();
                                  const elapsedMs = now.getTime() - startTime.getTime();
                                  const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
                                  const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
                                  return `${hours}h ${minutes}m`;
                                })()}`}
                              >
                                <Square className="w-4 h-4 mr-1" />
                                Stop {(() => {
                                  const startTime = new Date(activeTimer.startTime || activeTimer.start_time);
                                  const now = new Date();
                                  const elapsedMs = now.getTime() - startTime.getTime();
                                  const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
                                  const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
                                  return `(${hours}h ${minutes}m)`;
                                })()}
                              </Button>
                            ) : (
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (activeTimer) {
                                    toast({
                                      title: 'Timer already running',
                                      description: `Please stop the current timer for "${activeTimer.description || 'another task'}" first.`,
                                      variant: 'destructive'
                                    });
                                  } else {
                                    startTimerForTaskMutation?.mutate(task);
                                  }
                                }}
                                disabled={startTimerForTaskMutation?.isPending || !!activeTimer}
                                data-testid={`button-start-timer-${task.id}`}
                                title={activeTimer ? 'Stop current timer first' : 'Start timer'}
                              >
                                <Timer className="w-4 h-4" />
                              </Button>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })
                ) : (
                  <TableRow>
                    <TableCell colSpan={9} className="text-center py-8 text-gray-500">
                      No tasks found
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>

      {/* Stop Timer Dialog */}
      {showStopTimerDialog && (
        <Dialog open={showStopTimerDialog} onOpenChange={(open) => setShowStopTimerDialog?.(open)}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Stop Timer</DialogTitle>
              <DialogDescription>
                {activeTimer && (() => {
                  const startTime = new Date(activeTimer.startTime || activeTimer.start_time);
                  const now = new Date();
                  const elapsedMs = now.getTime() - startTime.getTime();
                  const elapsedHours = (elapsedMs / (1000 * 60 * 60)).toFixed(2);
                  return `Timer has been running for ${elapsedHours} hours. Add any notes before stopping.`;
                })()}
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div>
                <Label htmlFor="stop-timer-notes">Notes (Optional)</Label>
                <Textarea
                  id="stop-timer-notes"
                  placeholder="Add notes about what was accomplished..."
                  value={stopTimerNotes || ''}
                  onChange={(e) => setStopTimerNotes?.(e.target.value)}
                  rows={3}
                />
              </div>
              {activeTimer && (
                <div className="text-sm text-muted-foreground">
                  <p><strong>Task:</strong> {tasks?.find((t: any) => t.id === activeTimer.taskId)?.title || activeTimer.description || 'N/A'}</p>
                  <p><strong>Project:</strong> {projects?.find((p: any) => p.id === activeTimer.projectId)?.name || 'N/A'}</p>
                </div>
              )}
            </div>
            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => {
                  setShowStopTimerDialog?.(false);
                  setStopTimerNotes?.('');
                }}
              >
                Cancel
              </Button>
              <Button
                onClick={() => {
                  stopTimerMutation?.mutate({ notes: stopTimerNotes });
                }}
                disabled={stopTimerMutation?.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {stopTimerMutation?.isPending ? 'Stopping...' : 'Stop Timer'}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}

      {/* Bulk Delete Confirmation Dialog */}
      <Dialog open={showBulkDeleteConfirm} onOpenChange={setShowBulkDeleteConfirm}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Confirm Bulk Delete</DialogTitle>
            <DialogDescription>
              Are you sure you want to delete {selectedTaskIds.size} selected task{selectedTaskIds.size !== 1 ? 's' : ''}? This action cannot be undone.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => setShowBulkDeleteConfirm(false)}
              disabled={bulkDeleteMutation.isPending}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={() => bulkDeleteMutation.mutate(Array.from(selectedTaskIds))}
              disabled={bulkDeleteMutation.isPending}
            >
              {bulkDeleteMutation.isPending ? 'Deleting...' : 'Delete Tasks'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {selectedTask && (
        <TaskModal
          task={selectedTask}
          open={!!selectedTask}
          onClose={() => setSelectedTask(null)}
        />
      )}
    </div>
  );
}


// Task creation schema

// Task creation schema
const taskSchema = z.object({
  title: z.string().min(1, "Title is required"),
  description: z.string().optional(),
  projectId: z.string().min(1, "Project is required"),
  statusId: z.string().optional(),
  priority: z.enum(["low", "medium", "high"]),
  startDate: z.string().optional(),
  dueDate: z.string().optional(),
  estimatedHours: z.string().optional(),
  parentTaskId: z.string().optional(),
  assignedUserId: z.string().optional(),
  isRecurring: z.boolean().optional(),
  recurrenceFrequency: z.enum(["daily", "weekly", "monthly", "yearly"]).optional(),
  recurrenceEndCondition: z.enum(["never", "after", "on_date"]).optional(),
  recurrenceEndDate: z.string().optional(),
  recurrenceTotalOccurrences: z.string().optional(),
});

type TaskFormData = z.infer<typeof taskSchema>;

// Pending Approval Detail Card Component
interface PendingApprovalDetailCardProps {
  approval: any;
  onApprove: (approvalId: number, updatedData: any) => void;
  onReject: (approvalId: number) => void;
  isProcessing: boolean;
}

function PendingApprovalDetailCard({ approval, onApprove, onReject, isProcessing }: PendingApprovalDetailCardProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [editedProjects, setEditedProjects] = useState(
    (approval.proposedProjects || []).map((p: any) => ({ ...p, approvalStatus: 'pending' }))
  );
  const [editedTasks, setEditedTasks] = useState(
    (approval.proposedTasks || []).map((t: any) => ({ ...t, approvalStatus: 'pending' }))
  );

  const handleProjectChange = (index: number, field: string, value: string) => {
    const updated = [...editedProjects];
    updated[index] = { ...updated[index], [field]: value };
    setEditedProjects(updated);
  };

  const handleTaskChange = (index: number, field: string, value: string) => {
    const updated = [...editedTasks];
    updated[index] = { ...updated[index], [field]: value };
    setEditedTasks(updated);
  };

  const handleProjectApproval = (index: number, status: 'approved' | 'rejected') => {
    const updated = [...editedProjects];
    updated[index] = { ...updated[index], approvalStatus: status };
    setEditedProjects(updated);
  };

  const handleTaskApproval = (index: number, status: 'approved' | 'rejected') => {
    const updated = [...editedTasks];
    updated[index] = { ...updated[index], approvalStatus: status };
    setEditedTasks(updated);
  };

  const addProject = () => {
    setEditedProjects([...editedProjects, {
      name: "",
      description: "",
      status: "pending",
      approvalStatus: "pending"
    }]);
  };

  const addTask = () => {
    setEditedTasks([...editedTasks, {
      title: "",
      description: "",
      priority: "medium",
      approvalStatus: "pending"
    }]);
  };

  const removeProject = (index: number) => {
    setEditedProjects(editedProjects.filter((_, i) => i !== index));
  };

  const removeTask = (index: number) => {
    setEditedTasks(editedTasks.filter((_, i) => i !== index));
  };

  const handleApprove = () => {
    // Only send approved items
    const approvedProjects = editedProjects.filter((p: any) => p.approvalStatus === 'approved');
    const approvedTasks = editedTasks.filter((t: any) => t.approvalStatus === 'approved');

    onApprove(approval.id, {
      proposedProjects: approvedProjects,
      proposedTasks: approvedTasks
    });
  };

  const approvedProjectCount = editedProjects.filter((p: any) => p.approvalStatus === 'approved').length;
  const approvedTaskCount = editedTasks.filter((t: any) => t.approvalStatus === 'approved').length;

  return (
    <Card className="border-l-4 border-l-blue-500">
      <CardHeader>
        <div className="flex justify-between items-start">
          <div>
            <CardTitle className="text-xl">{approval.clientName}</CardTitle>
            <CardDescription className="mt-1">
              {approval.industry} ‚Ä¢ {approval.workType}
            </CardDescription>
          </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsEditing(!isEditing)}
              className="flex items-center gap-1"
            >
              <Edit3 className="h-3 w-3" />
              {isEditing ? 'View Mode' : 'Edit Mode'}
            </Button>
          </div>
        </div>
      </CardHeader>

      <CardContent className="space-y-6">
        {/* Projects Section */}
        <div>
          <div className="flex items-center justify-between mb-4">
            <h4 className="text-lg font-semibold">Proposed Projects ({editedProjects.length})</h4>
            {isEditing && (
              <Button size="sm" onClick={addProject} className="flex items-center gap-1">
                <Plus className="h-3 w-3" />
                Add Project
              </Button>
            )}
          </div>

          <div className="space-y-3">
            {editedProjects.map((project: any, index: number) => (
              <div
                key={index}
                className={`border rounded-lg p-4 ${project.approvalStatus === 'approved'
                  ? 'bg-green-50 border-green-300'
                  : project.approvalStatus === 'rejected'
                    ? 'bg-red-50 border-red-300'
                    : 'bg-gray-50'
                  }`}
              >
                {isEditing ? (
                  <div className="space-y-3">
                    <div className="flex gap-2">
                      <Input
                        placeholder="Project name"
                        value={project.name}
                        onChange={(e) => handleProjectChange(index, 'name', e.target.value)}
                        className="flex-1"
                      />
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => removeProject(index)}
                      >
                        <X className="h-3 w-3" />
                      </Button>
                    </div>
                    <Textarea
                      placeholder="Project description"
                      value={project.description}
                      onChange={(e) => handleProjectChange(index, 'description', e.target.value)}
                      rows={2}
                    />
                  </div>
                ) : (
                  <div>
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1">
                        <h5 className="font-medium">{project.name}</h5>
                        <p className="text-sm text-gray-600 mt-1">{project.description}</p>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          size="sm"
                          variant={project.approvalStatus === 'approved' ? 'default' : 'outline'}
                          onClick={() => handleProjectApproval(index, 'approved')}
                          disabled={project.approvalStatus === 'approved'}
                          className="flex items-center gap-1"
                          data-testid={`button-approve-project-${index}`}
                        >
                          <Check className="h-3 w-3" />
                          {project.approvalStatus === 'approved' ? 'Approved' : 'Approve'}
                        </Button>
                        <Button
                          size="sm"
                          variant={project.approvalStatus === 'rejected' ? 'destructive' : 'outline'}
                          onClick={() => handleProjectApproval(index, 'rejected')}
                          disabled={project.approvalStatus === 'rejected'}
                          className="flex items-center gap-1"
                          data-testid={`button-reject-project-${index}`}
                        >
                          <X className="h-3 w-3" />
                          {project.approvalStatus === 'rejected' ? 'Rejected' : 'Reject'}
                        </Button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Tasks Section */}
        <div>
          <div className="flex items-center justify-between mb-4">
            <h4 className="text-lg font-semibold">Proposed Tasks ({editedTasks.length})</h4>
            {isEditing && (
              <Button size="sm" onClick={addTask} className="flex items-center gap-1">
                <Plus className="h-3 w-3" />
                Add Task
              </Button>
            )}
          </div>

          <div className="space-y-3">
            {editedTasks.map((task: any, index: number) => (
              <div
                key={index}
                className={`border rounded-lg p-4 ${task.approvalStatus === 'approved'
                  ? 'bg-green-50 border-green-300'
                  : task.approvalStatus === 'rejected'
                    ? 'bg-red-50 border-red-300'
                    : 'bg-gray-50'
                  }`}
              >
                {isEditing ? (
                  <div className="space-y-3">
                    <div className="flex gap-2">
                      <Input
                        placeholder="Task title"
                        value={task.title}
                        onChange={(e) => handleTaskChange(index, 'title', e.target.value)}
                        className="flex-1"
                      />
                      <Select
                        value={task.priority}
                        onValueChange={(value) => handleTaskChange(index, 'priority', value)}
                      >
                        <SelectTrigger className="w-32">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="low">Low</SelectItem>
                          <SelectItem value="medium">Medium</SelectItem>
                          <SelectItem value="high">High</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => removeTask(index)}
                      >
                        <X className="h-3 w-3" />
                      </Button>
                    </div>
                    <Textarea
                      placeholder="Task description"
                      value={task.description}
                      onChange={(e) => handleTaskChange(index, 'description', e.target.value)}
                      rows={2}
                    />
                  </div>
                ) : (
                  <div>
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <h5 className="font-medium">{task.title}</h5>
                          <Badge
                            variant={task.priority === 'high' ? 'destructive' : task.priority === 'medium' ? 'default' : 'secondary'}
                          >
                            {task.priority}
                          </Badge>
                        </div>
                        <p className="text-sm text-gray-600">{task.description}</p>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          size="sm"
                          variant={task.approvalStatus === 'approved' ? 'default' : 'outline'}
                          onClick={() => handleTaskApproval(index, 'approved')}
                          disabled={task.approvalStatus === 'approved'}
                          className="flex items-center gap-1"
                          data-testid={`button-approve-task-${index}`}
                        >
                          <Check className="h-3 w-3" />
                          {task.approvalStatus === 'approved' ? 'Approved' : 'Approve'}
                        </Button>
                        <Button
                          size="sm"
                          variant={task.approvalStatus === 'rejected' ? 'destructive' : 'outline'}
                          onClick={() => handleTaskApproval(index, 'rejected')}
                          disabled={task.approvalStatus === 'rejected'}
                          className="flex items-center gap-1"
                          data-testid={`button-reject-task-${index}`}
                        >
                          <X className="h-3 w-3" />
                          {task.approvalStatus === 'rejected' ? 'Rejected' : 'Reject'}
                        </Button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Action Buttons */}
        <div className="pt-4 border-t space-y-3">
          <div className="flex items-center gap-4 text-sm text-gray-600">
            <span>Projects: {approvedProjectCount} approved / {editedProjects.length} total</span>
            <span>Tasks: {approvedTaskCount} approved / {editedTasks.length} total</span>
          </div>
          <div className="flex gap-3">
            <Button
              onClick={handleApprove}
              disabled={isProcessing || (approvedProjectCount === 0 && approvedTaskCount === 0)}
              className="flex items-center gap-2"
              data-testid="button-create-approved"
            >
              <Check className="h-4 w-4" />
              {isProcessing ? 'Processing...' : `Create Approved Items (${approvedProjectCount + approvedTaskCount})`}
            </Button>
            <Button
              variant="outline"
              onClick={() => onReject(approval.id)}
              disabled={isProcessing}
              className="flex items-center gap-2"
              data-testid="button-reject-all"
            >
              <X className="h-4 w-4" />
              Reject All
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

const PAGES_MODULE_KEYS = [
  "dashboard",
  "clients",
  "contact-management",
  "projects",
  "tasks",
  "calendar",
  "communication",
  "notifications",
  "team",
  "reports",
  "time-expenses",
  "billing",
  "settings",
  "practice",
];

const PAGES_MODULE_DEPENDENCIES: Record<string, string[]> = {
  clients: ["projects", "tasks", "time-expenses", "billing", "reports"],
  projects: ["tasks", "time-expenses", "billing", "calendar"],
  tasks: ["time-expenses", "calendar", "reports"],
  calendar: ["tasks", "projects"],
  reports: ["dashboard"],
  practice: ["reports", "dashboard"],
};

export default function Pages() {
  console.log('üöÄ COMPREHENSIVE PAGES COMPONENT LOADED - Pages-fixed.tsx');
  const { user } = useAuth();
  const [match, params] = useRoute('/pages/:tab');
  const [activeTab, setActiveTab] = useState(params?.tab || "practice");
  const [settingsTab, setSettingsTab] = useState("general");
  const [reportTab, setReportTab] = useState("firm-overview");

  const { data: userPermissions } = useQuery({
    queryKey: ["/api/user-permissions"],
    enabled: !!user?.firmId,
  });

  const allowedModules = useMemo(() => {
    if (!user) {
      return [];
    }
    const role = user.role?.toLowerCase() || "";
    if (["firm_admin", "firm_owner", "saas_owner", "super_admin", "manager"].includes(role)) {
      return PAGES_MODULE_KEYS;
    }
    const record = Array.isArray(userPermissions)
      ? userPermissions.find((perm: any) => perm.userId === user.id)
      : null;
    const modules = Array.isArray(record?.modules) ? record.modules : [];
    const expanded = new Set(modules);
    modules.forEach((moduleKey: string) => {
      const deps = PAGES_MODULE_DEPENDENCIES[moduleKey] || [];
      deps.forEach((dep) => expanded.add(dep));
    });
    return expanded.size > 0 ? Array.from(expanded) : ["dashboard"];
  }, [user, userPermissions]);

  // Financial Report Date Range State (default to current month)
  const [financialReportStartDate, setFinancialReportStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [financialReportEndDate, setFinancialReportEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  );

  // AR Aging Report Date State (default to today)
  const [arAgingAsOfDate, setArAgingAsOfDate] = useState(
    format(new Date(), 'yyyy-MM-dd')
  );

  // Client Profitability Report Date Range State (default to YTD - year to date)
  const currentYear = new Date().getFullYear();
  const [clientProfitabilityStartDate, setClientProfitabilityStartDate] = useState(
    `${currentYear}-01-01`
  );
  const [clientProfitabilityEndDate, setClientProfitabilityEndDate] = useState(
    format(new Date(), 'yyyy-MM-dd')
  );

  // Revenue by Service Type Report Date Range State (default to current year)
  const [revenueByServiceStartDate, setRevenueByServiceStartDate] = useState(
    `${currentYear}-01-01`
  );
  const [revenueByServiceEndDate, setRevenueByServiceEndDate] = useState(
    format(new Date(), 'yyyy-MM-dd')
  );

  // Project Status Report Filter State (default to 'all')
  const [projectStatusFilter, setProjectStatusFilter] = useState('all');

  // Task Management Report State (default to current month)
  const [taskManagementStartDate, setTaskManagementStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [taskManagementEndDate, setTaskManagementEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [taskManagementStaffFilter, setTaskManagementStaffFilter] = useState('');

  // Individual Performance Report State (default to current month)
  const [individualPerformanceStartDate, setIndividualPerformanceStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [individualPerformanceEndDate, setIndividualPerformanceEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [individualPerformanceStaffFilter, setIndividualPerformanceStaffFilter] = useState('');

  // Team Capacity Report State (default 30 days forecast)
  const [teamCapacityForecastDays, setTeamCapacityForecastDays] = useState(30);

  // Utilization Report State (default to current month)
  const [utilizationStartDate, setUtilizationStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [utilizationEndDate, setUtilizationEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [utilizationGroupBy, setUtilizationGroupBy] = useState<'staff' | 'project' | 'client' | 'date'>('staff');

  // Time & Billing Analytics Report State (default to current month)
  const [timeBillingStartDate, setTimeBillingStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  );
  const [timeBillingEndDate, setTimeBillingEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  );

  // Workflow Efficiency Report State (default to last 30 days)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const [workflowStartDate, setWorkflowStartDate] = useState(
    format(thirtyDaysAgo, 'yyyy-MM-dd')
  );
  const [workflowEndDate, setWorkflowEndDate] = useState(
    format(new Date(), 'yyyy-MM-dd')
  );

  // Project Details Dialog State
  const [selectedProjectForDetails, setSelectedProjectForDetails] = useState<any | null>(null);
  const [showProjectDetailsDialog, setShowProjectDetailsDialog] = useState(false);
  const [showCreateProjectDialog, setShowCreateProjectDialog] = useState(false);
  const [createProjectClientId, setCreateProjectClientId] = useState<string>("");

  // Project Multi-Select State
  const [selectedProjectIds, setSelectedProjectIds] = useState<Set<number>>(new Set());
  
  // Project Filtering and Sorting State
  const [projectSearchQuery, setProjectSearchQuery] = useState("");
  const [projectSortBy, setProjectSortBy] = useState<string>("name");
  const [projectFilterStatus, setProjectFilterStatus] = useState<string>("all");
  const [projectFilterClient, setProjectFilterClient] = useState<string>("all");
  const [showBulkActionsToolbar, setShowBulkActionsToolbar] = useState(false);

  // Timer State
  const [showStopTimerDialog, setShowStopTimerDialog] = useState(false);
  const [stopTimerNotes, setStopTimerNotes] = useState('');

  // ============================================================================
  // SPRINT 3 - ADVANCED PROJECT MANAGEMENT STATE
  // ============================================================================

  // Project Templates State
  const [showTemplateDialog, setShowTemplateDialog] = useState(false);
  const [showApplyTemplateDialog, setShowApplyTemplateDialog] = useState(false);
  const [showTemplatesList, setShowTemplatesList] = useState(false);
  const [selectedTemplate, setSelectedTemplate] = useState<any>(null);
  const [selectedProjectForTemplate, setSelectedProjectForTemplate] = useState<any>(null);
  const [templateCategory, setTemplateCategory] = useState<string>("all");

  // Resource Allocation State
  const [showResourceView, setShowResourceView] = useState(false);
  const [resourceDateRange, setResourceDateRange] = useState("week");
  const [resourceDepartmentFilter, setResourceDepartmentFilter] = useState<string>("all");

  // Budget Tracking State  
  const [editingBudget, setEditingBudget] = useState<{ projectId: number, budget: string } | null>(null);
  const [showBudgetDialog, setShowBudgetDialog] = useState(false);

  // Profitability Report State (default to current year)
  const [profitabilityStartDate, setProfitabilityStartDate] = useState(`${currentYear}-01-01`);
  const [profitabilityEndDate, setProfitabilityEndDate] = useState(format(new Date(), 'yyyy-MM-dd'));
  const [profitabilityClientFilter, setProfitabilityClientFilter] = useState<string>("all");
  const [profitabilityProjectFilter, setProfitabilityProjectFilter] = useState<string>("all");

  // Milestone Tracking State
  const [showMilestoneDialog, setShowMilestoneDialog] = useState(false);
  const [editingMilestone, setEditingMilestone] = useState<any>(null);
  const [selectedProjectForMilestone, setSelectedProjectForMilestone] = useState<any>(null);

  // Update activeTab when URL parameter changes
  useEffect(() => {
    if (params?.tab) {
      setActiveTab(params.tab);
    }
  }, [params?.tab]);

  useEffect(() => {
    if (allowedModules.length > 0 && !allowedModules.includes(activeTab)) {
      setActiveTab(allowedModules[0]);
    }
  }, [activeTab, allowedModules]);
  const [showNewClientDialog, setShowNewClientDialog] = useState(false);
  const [showNewTaskDialog, setShowNewTaskDialog] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [clientSearchTerm, setClientSearchTerm] = useState("");
  const [clientSortBy, setClientSortBy] = useState("name");
  const [clientSortDirection, setClientSortDirection] = useState<"asc" | "desc">("asc");
  const [visibleColumns, setVisibleColumns] = useState({
    clientName: true,
    contactPerson: true,
    industry: true,
    businessNumber: true,
    yearEnd: true,
    workType: true,
    status: true,
    actions: true
  });
  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);

  // Invoice form state
  const [invoiceLineItems, setInvoiceLineItems] = useState([
    { description: '', quantity: 1, unitPrice: 0 }
  ]);
  const [invoiceTaxRate, setInvoiceTaxRate] = useState(13);
  const [invoiceDiscount, setInvoiceDiscount] = useState(0);

  // Calculate invoice totals in real-time
  const calculateInvoiceTotals = () => {
    const subtotal = invoiceLineItems.reduce((sum, item) => {
      return sum + (parseFloat(item.quantity || '0') * parseFloat(item.unitPrice || '0'));
    }, 0);

    const discountAmount = invoiceDiscount;
    const subtotalAfterDiscount = subtotal - discountAmount;
    const taxAmount = subtotalAfterDiscount * (invoiceTaxRate / 100);
    const total = subtotalAfterDiscount + taxAmount;

    return {
      subtotal,
      discountAmount,
      subtotalAfterDiscount,
      taxAmount,
      total
    };
  };

  const invoiceTotals = calculateInvoiceTotals();

  // Payment recording state
  const [showPaymentDialog, setShowPaymentDialog] = useState(false);
  const [selectedInvoiceForPayment, setSelectedInvoiceForPayment] = useState<any>(null);

  const [showClientDetail, setShowClientDetail] = useState(false);
  const [showClientEdit, setShowClientEdit] = useState(false);
  const [clientFilterBy, setClientFilterBy] = useState("all");
  const [selectedClient, setSelectedClient] = useState<any>(null);
  const [selectedClients, setSelectedClients] = useState<number[]>([]);
  const [showClientDetailsDialog, setShowClientDetailsDialog] = useState(false);
  const [showNewInvoiceDialog, setShowNewInvoiceDialog] = useState(false);
  const [showRecordPaymentDialog, setShowRecordPaymentDialog] = useState(false);
  const [showLogoUploadDialog, setShowLogoUploadDialog] = useState(false);
  const [logoUploadClientId, setLogoUploadClientId] = useState<number | null>(null);
  const [paymentAmount, setPaymentAmount] = useState('');
  const [paymentDate, setPaymentDate] = useState(new Date().toISOString().split('T')[0]);
  const [paymentMethod, setPaymentMethod] = useState('credit_card');
  const [paymentReference, setPaymentReference] = useState('');
  const [paymentNotes, setPaymentNotes] = useState('');
  const [selectedPaymentClient, setSelectedPaymentClient] = useState<number | null>(null);
  const [paymentAllocations, setPaymentAllocations] = useState<{ invoiceId: number, amount: number }[]>([]);

  const [showRecurringInvoiceDialog, setShowRecurringInvoiceDialog] = useState(false);
  const [editingRecurringInvoice, setEditingRecurringInvoice] = useState<any | null>(null);
  // Calendar state
  const [calendarView, setCalendarView] = useState<'month' | 'week' | 'day' | 'kanban' | 'gantt'>('month');
  const [currentDate, setCurrentDate] = useState(new Date());
  const [showNewEventDialog, setShowNewEventDialog] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState<any>(null);
  const [calendarFilter, setCalendarFilter] = useState('all');
  const [draggedItem, setDraggedItem] = useState<any>(null);

  // Timer state
  const [isTimerOpen, setIsTimerOpen] = useState(false);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [showTimeEntry, setShowTimeEntry] = useState(false);
  const [currentTimeEntry, setCurrentTimeEntry] = useState<any>(null);
  const [selectedProjectId, setSelectedProjectId] = useState<string>('');

  // Timer effect
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isTimerRunning) {
      interval = setInterval(() => {
        setElapsedTime(prev => prev + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isTimerRunning]);

  // Reset selected project when time entry dialog opens
  useEffect(() => {
    if (showTimeEntry) {
      setSelectedProjectId('');
    }
  }, [showTimeEntry]);

  // Practice metrics query
  const { data: practiceMetrics } = useQuery({
    queryKey: ["/api/practice/metrics"],
    enabled: false, // Disable for now
  });

  // Dashboard metrics query
  const { data: dashboardMetrics, isLoading: metricsLoading, error: metricsError } = useQuery({
    queryKey: ["/api/dashboard/metrics"],
  });

  // Debug dashboard metrics query
  console.log('üìä Dashboard Metrics Query State:', {
    data: dashboardMetrics,
    loading: metricsLoading,
    error: metricsError
  });

  // Activities query for Recent Activity feed
  const { data: recentActivities, isLoading: activitiesLoading, error: activitiesError } = useQuery({
    queryKey: ["/api/activities"],
  });

  const { data: dashboardNotifications } = useQuery({
    queryKey: ["/api/notifications?limit=5"],
  });

  // Debug activities query
  console.log('üîç Activities Query State:', {
    data: recentActivities,
    loading: activitiesLoading,
    error: activitiesError,
    hasData: recentActivities && recentActivities.length > 0
  });

  // Tasks query
  const { data: tasksResponse } = useQuery({
    queryKey: ["/api/tasks"],
  });
  const tasks = tasksResponse?.data || [];

  // Projects query (for invoice creation and timer)
  const { data: projectsResponse } = useQuery({
    queryKey: ["/api/projects"],
  });
  const projects = projectsResponse?.data || [];

  // Fetch active timer
  const { data: activeTimerData } = useQuery({
    queryKey: ['/api/time-tracking/timer/active'],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/time-tracking/timer/active');
      if (!response.ok) {
        if (response.status === 404) return null; // No active timer
        const error = await response.json().catch(() => ({}));
        if (error.error === 'No active timer' || response.status === 404) return null;
        throw new Error('Failed to fetch active timer');
      }
      const data = await response.json();
      // Handle different response formats
      return data.id ? data : (data.data || data);
    },
    refetchInterval: 1000, // Poll every second to update elapsed time
  });
  const activeTimer = activeTimerData || null;

  // Start timer for task mutation
  const startTimerForTaskMutation = useMutation({
    mutationFn: async (task: any) => {
      // Get clientId from task or project
      const clientId = task.clientId || (task.projectId && projects?.find((p: any) => p.id === task.projectId)?.clientId);
      
      const response = await apiRequest('POST', '/api/time-tracking/timer/start', {
        clientId: clientId,
        projectId: task.projectId,
        taskId: task.id,
        description: `Working on: ${task.title}`,
        type: 'billable'
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || error.message || 'Failed to start timer');
      }
      const data = await response.json();
      // Handle different response formats
      return data.id ? data : (data.data || data);
    },
    onSuccess: (data) => {
      toast({ 
        title: 'Timer started successfully', 
        description: `Timer is now running for this task`
      });
      queryClient.invalidateQueries({ queryKey: ['/api/time-tracking/timer/active'] });
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
      // Immediately refetch active timer to show updated state
      queryClient.refetchQueries({ queryKey: ['/api/time-tracking/timer/active'] });
    },
    onError: (error: any) => {
      console.error('Timer start error:', error);
      toast({ 
        title: 'Failed to start timer', 
        description: error.message || 'An error occurred. Make sure no other timer is running.',
        variant: 'destructive' 
      });
    }
  });

  // Stop timer mutation
  const stopTimerMutation = useMutation({
    mutationFn: async ({ sessionId, notes }: { sessionId?: number; notes?: string }) => {
      const response = await apiRequest('POST', '/api/time-tracking/timer/stop', {
        sessionId: sessionId || activeTimer?.id || activeTimer?.sessionId,
        notes: notes || stopTimerNotes || undefined
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || error.message || 'Failed to stop timer');
      }
      const data = await response.json();
      return data;
    },
    onSuccess: (data) => {
      // Calculate hours from duration (in seconds)
      const duration = data.duration || data.timeEntry?.duration || 0;
      const hours = duration / 3600;
      toast({ 
        title: 'Timer stopped successfully', 
        description: `Time logged: ${hours.toFixed(2)} hours. Time entry has been created.`
      });
      // Immediately clear and refetch active timer to stop it
      queryClient.setQueryData(['/api/time-tracking/timer/active'], null);
      queryClient.invalidateQueries({ queryKey: ['/api/time-tracking/timer/active'] });
      queryClient.refetchQueries({ queryKey: ['/api/time-tracking/timer/active'] });
      // Invalidate tasks to update timer button states
      queryClient.invalidateQueries({ queryKey: ['/api/tasks'] });
      // Invalidate all time entries queries (including task-specific ones used by TaskModal)
      queryClient.invalidateQueries({ 
        predicate: (query) => {
          const key = query.queryKey[0];
          if (typeof key === 'string') {
            const matches = key.startsWith('/api/time-entries') || key.startsWith('/api/time-tracking/entries');
            if (matches) {
              console.log('üîÑ Invalidating time entries query:', key);
            }
            return matches;
          }
          return false;
        }
      });
      // Also explicitly invalidate the task-specific query if we know the taskId
      if (activeTimer?.taskId) {
        console.log('üîÑ Explicitly invalidating time entries for taskId:', activeTimer.taskId);
        queryClient.invalidateQueries({ 
          queryKey: [`/api/time-tracking/entries?taskId=${activeTimer.taskId}`] 
        });
        // Invalidate comments for the newly created time entry
        queryClient.invalidateQueries({ 
          predicate: (query) => {
            const key = query.queryKey[0];
            return typeof key === 'string' && key.startsWith('/api/time-tracking/entries') && key.includes('/comments');
          }
        });
      }
      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });
      setShowStopTimerDialog(false);
      setStopTimerNotes('');
    },
    onError: (error: any) => {
      toast({ 
        title: 'Failed to stop timer', 
        description: error.message || 'An error occurred',
        variant: 'destructive' 
      });
    }
  });

  const notificationItems = Array.isArray(dashboardNotifications?.notifications)
    ? dashboardNotifications.notifications
    : Array.isArray(dashboardNotifications)
      ? dashboardNotifications
      : [];

  const todoItems = tasks
    .filter((task: any) => !["completed", "cancelled"].includes((task.status || "").toLowerCase()))
    .slice(0, 5);

  const calendarItems = tasks
    .filter((task: any) => task.dueDate)
    .sort((a: any, b: any) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime())
    .slice(0, 5);

  // Task statuses query (for dynamic Kanban board)
  const { data: taskStatusesResponse } = useQuery({
    queryKey: ["/api/task-statuses"],
    queryFn: async () => {
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');
      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }
      const response = await fetch(apiConfig.buildUrl('/api/task-statuses'), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch task statuses');
      return response.json();
    },
  });
  const taskStatuses = taskStatusesResponse?.data || [];

  // Projects already defined above for timer mutations

  // Create project mutation
  const createProjectMutation = useMutation({
    mutationFn: async (projectData: { name: string; description?: string; clientId?: number; startDate?: string; endDate?: string; budgetAmount?: number }) => {
      const response = await apiRequest('POST', '/api/projects', projectData);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to create project');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });
      setShowCreateProjectDialog(false);
      toast({
        title: "Success",
        description: "Project created successfully",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message || "Failed to create project",
        variant: "destructive",
      });
    },
  });

  // Bulk update projects mutation
  const bulkUpdateProjectsMutation = useMutation({
    mutationFn: async ({ projectIds, status }: { projectIds: number[]; status: string }) => {
      return await apiRequest('PATCH', '/api/projects/bulk', { projectIds, status });
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });
      setSelectedProjectIds(new Set());
      toast({
        title: "Projects Updated",
        description: `Successfully updated ${data.count} project(s)`,
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to update projects",
        variant: "destructive",
      });
    },
  });

  // Bulk delete projects mutation
  const bulkDeleteProjectsMutation = useMutation({
    mutationFn: async (projectIds: number[]) => {
      return await apiRequest('DELETE', '/api/projects/bulk', { projectIds });
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });
      setSelectedProjectIds(new Set());
      toast({
        title: "Projects Deleted",
        description: `Successfully deleted ${data.count} project(s)`,
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to delete projects",
        variant: "destructive",
      });
    },
  });

  // Task status update mutation (for drag-and-drop)

  const updateTaskStatusMutation = useMutation({
    mutationFn: async ({ taskId, statusId }: { taskId: number; statusId: number }) => {
      const response = await apiRequest('PATCH', `/api/tasks/${taskId}`, { statusId });
      if (!response.ok) {
        throw new Error('Failed to update task status');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/tasks"] });
      toast({
        title: "Task Updated",
        description: "Task status updated successfully",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to update task status",
        variant: "destructive",
      });
    },
  });

  // Query for pending client approvals
  const { data: pendingApprovals } = useQuery({
    queryKey: ["/api/pending-client-approvals"],
    queryFn: async () => {
      // Get JWT token from localStorage
      const token = localStorage.getItem('authToken');
      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }
      const response = await fetch(apiConfig.buildUrl('/api/pending-client-approvals'), {
        headers,
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch pending approvals');
      return response.json();
    },
    refetchInterval: 10000, // Refresh every 10 seconds
  });

  // Mutation for approving clients
  const approveClientMutation = useMutation({
    mutationFn: async ({ approvalId, action, updatedData }: { approvalId: number; action: 'approve' | 'reject'; updatedData?: any }) => {
      const response = await apiRequest('POST', `/api/pending-client-approvals/${approvalId}/${action}`, updatedData || {});
      if (!response.ok) {
        throw new Error('Failed to process approval');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/pending-client-approvals"] });
      queryClient.invalidateQueries({ queryKey: ["/api/clients"] });
      queryClient.invalidateQueries({ queryKey: ["/api/projects"] });
      queryClient.invalidateQueries({ queryKey: ["/api/tasks"] });
      toast({
        title: "Success",
        description: "Client approval processed successfully!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Mutation for approving/rejecting time entries
  const timeEntryApprovalMutation = useMutation({
    mutationFn: async ({ entryId, action }: { entryId: number; action: 'approve' | 'reject' }) => {
      const response = await apiRequest('POST', `/api/pending-approvals/time-entries/${entryId}/${action}`, {});
      if (!response.ok) {
        throw new Error(`Failed to ${action} time entry`);
      }
      return response.json();
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ["/api/pending-client-approvals"] });
      queryClient.invalidateQueries({ queryKey: ["/api/team/time-entries"] });
      toast({
        title: "Success",
        description: `Time entry ${variables.action}d successfully!`,
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Handler functions for time entry approvals
  const handleApproveTimeEntry = (entryId: number) => {
    timeEntryApprovalMutation.mutate({ entryId, action: 'approve' });
  };

  const handleRejectTimeEntry = (entryId: number) => {
    timeEntryApprovalMutation.mutate({ entryId, action: 'reject' });
  };

  // Logo upload mutation
  const uploadLogoMutation = useMutation({
    mutationFn: async ({ clientId, file }: { clientId: number; file: File }) => {
      const formData = new FormData();
      formData.append('logo', file);

      const token = localStorage.getItem('authToken');
      const headers: HeadersInit = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const response = await fetch(apiConfig.buildUrl(`/api/clients/${clientId}/logo`), {
        method: 'POST',
        headers,
        body: formData,
        credentials: 'include'
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to upload logo');
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/clients"] });
      setShowLogoUploadDialog(false);
      setLogoUploadClientId(null);
      toast({
        title: "Success",
        description: "Logo uploaded successfully!"
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message || "Failed to upload logo",
        variant: "destructive"
      });
    },
  });

  // Users query
  const { data: usersResponse } = useQuery({
    queryKey: ["/api/users"],
  });
  const users = usersResponse?.users || [];

  const { data: clients } = useQuery({
    queryKey: ["/api/clients"],
  });

  // Time tracking queries
  const { data: timeEntries } = useQuery({
    queryKey: ["/api/time-entries"],
  });

  // Billing queries
  const { data: invoices } = useQuery({
    queryKey: ["/api/billing/invoices"],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/billing/invoices');
      if (!response.ok) throw new Error('Failed to fetch invoices');
      return response.json();
    },
  });

  const { data: payments } = useQuery({
    queryKey: ["/api/billing/payments"],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/billing/payments');
      if (!response.ok) throw new Error('Failed to fetch payments');
      return response.json();
    },
  });

  const { data: billingSettings } = useQuery({
    queryKey: ["/api/billing/settings"],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/billing/settings');
      if (!response.ok) throw new Error('Failed to fetch billing settings');
      return response.json();
    },
  });

  // Recurring invoices query
  const { data: recurringInvoices, isLoading: isLoadingRecurring } = useQuery({
    queryKey: ["/api/billing/recurring"],
    queryFn: async () => {
      const response = await apiRequest('GET', '/api/billing/recurring');
      if (!response.ok) throw new Error('Failed to fetch recurring invoices');
      return response.json();
    },
  });

  // Create/update recurring invoice mutation
  const saveRecurringInvoiceMutation = useMutation({
    mutationFn: async (data: any) => {
      const isEdit = data.id;
      const method = isEdit ? 'PUT' : 'POST';
      const url = isEdit ? `/api/billing/recurring/${data.id}` : '/api/billing/recurring';
      const response = await apiRequest(method, url, data);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save recurring invoice');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/recurring"] });
      setShowRecurringInvoiceDialog(false);
      setEditingRecurringInvoice(null);
      toast({
        title: "Success",
        description: "Recurring invoice template saved successfully",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Toggle recurring invoice status mutation
  const toggleRecurringStatusMutation = useMutation({
    mutationFn: async ({ id, isActive }: { id: number; isActive: boolean }) => {
      const response = await apiRequest('PATCH', `/api/billing/recurring/${id}`, { isActive });
      if (!response.ok) {
        throw new Error('Failed to update status');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/recurring"] });
      toast({
        title: "Success",
        description: "Status updated successfully",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Generate invoices from recurring templates mutation
  const generateRecurringInvoicesMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('POST', "/api/billing/recurring/generate", {});
      if (!response.ok) {
        throw new Error('Failed to generate invoices');
      }
      return response.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/invoices"] });
      queryClient.invalidateQueries({ queryKey: ["/api/billing/recurring"] });
      toast({
        title: "Success",
        description: `Generated ${data.count || 0} invoices from recurring templates`,
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Delete recurring invoice mutation
  const deleteRecurringInvoiceMutation = useMutation({
    mutationFn: async (id: number) => {
      const response = await apiRequest('DELETE', `/api/billing/recurring/${id}`, {});
      if (!response.ok) {
        throw new Error('Failed to delete recurring invoice');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/recurring"] });
      toast({
        title: "Success",
        description: "Recurring invoice template deleted",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const fetchReport = async (url: string) => {
    const response = await apiRequest("GET", url);
    if (!response.ok) {
      throw new Error("Failed to fetch report data");
    }
    return response.json();
  };

  // Firm Overview Dashboard Query
  const {
    data: firmOverviewData,
    isLoading: isLoadingFirmOverview,
    error: firmOverviewError,
    refetch: refetchFirmOverview
  } = useQuery({
    queryKey: ["/api/reports/firm-overview"],
    queryFn: async () => {
      return fetchReport("/api/reports/firm-overview");
    },
    enabled: activeTab === 'reports' && reportTab === 'firm-overview',
    refetchInterval: 300000, // Auto-refresh every 5 minutes
  });

  // Project Status Report Query
  const {
    data: projectStatusData,
    isLoading: isLoadingProjectStatus,
    error: projectStatusError,
    refetch: refetchProjectStatus
  } = useQuery({
    queryKey: ["/api/reports/project-status", projectStatusFilter],
    queryFn: async () => {
      return fetchReport(`/api/reports/project-status?statusFilter=${projectStatusFilter}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'project-status',
  });

  // Task Management Report Query
  const {
    data: taskManagementData,
    isLoading: isLoadingTaskManagement,
    error: taskManagementError,
    refetch: refetchTaskManagement
  } = useQuery({
    queryKey: ["/api/reports/task-management", taskManagementStartDate, taskManagementEndDate, taskManagementStaffFilter],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (taskManagementStartDate) params.append('startDate', taskManagementStartDate);
      if (taskManagementEndDate) params.append('endDate', taskManagementEndDate);
      if (taskManagementStaffFilter) params.append('staffFilter', taskManagementStaffFilter);

      return fetchReport(`/api/reports/task-management?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'task-management',
  });

  // Financial Performance Report Query
  const {
    data: financialPerformance,
    isLoading: isLoadingFinancialPerformance,
    error: financialPerformanceError
  } = useQuery({
    queryKey: ["/api/reports/financial-performance", financialReportStartDate, financialReportEndDate],
    queryFn: async () => {
      return fetchReport(
        `/api/reports/financial-performance?startDate=${financialReportStartDate}&endDate=${financialReportEndDate}`
      );
    },
    enabled: activeTab === 'reports' && reportTab === 'financial',
  });

  // AR Aging Report Query
  const {
    data: arAgingData,
    isLoading: isLoadingARAging,
    error: arAgingError
  } = useQuery({
    queryKey: ["/api/reports/ar-aging", arAgingAsOfDate],
    queryFn: async () => {
      return fetchReport(`/api/reports/ar-aging?asOfDate=${arAgingAsOfDate}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'ar-aging',
  });

  // Client Profitability Report Query
  const {
    data: clientProfitabilityData,
    isLoading: isLoadingClientProfitability,
    error: clientProfitabilityError
  } = useQuery({
    queryKey: ["/api/reports/client-profitability", clientProfitabilityStartDate, clientProfitabilityEndDate],
    queryFn: async () => {
      return fetchReport(
        `/api/reports/client-profitability?startDate=${clientProfitabilityStartDate}&endDate=${clientProfitabilityEndDate}`
      );
    },
    enabled: activeTab === 'reports' && reportTab === 'client-profitability',
  });

  // Revenue by Service Type Report Query
  const {
    data: revenueByServiceData,
    isLoading: isLoadingRevenueByService,
    error: revenueByServiceError
  } = useQuery({
    queryKey: ["/api/reports/revenue-by-service", revenueByServiceStartDate, revenueByServiceEndDate],
    queryFn: async () => {
      return fetchReport(
        `/api/reports/revenue-by-service?startDate=${revenueByServiceStartDate}&endDate=${revenueByServiceEndDate}`
      );
    },
    enabled: activeTab === 'reports' && reportTab === 'revenue-by-service',
  });

  // Upcoming Deadlines Report Query
  const {
    data: upcomingDeadlinesData,
    isLoading: isLoadingUpcomingDeadlines,
    error: upcomingDeadlinesError,
    refetch: refetchUpcomingDeadlines
  } = useQuery({
    queryKey: ["/api/reports/upcoming-deadlines"],
    queryFn: async () => {
      return fetchReport('/api/reports/upcoming-deadlines');
    },
    enabled: activeTab === 'reports' && reportTab === 'upcoming-deadlines',
  });

  // Overdue Items Report Query
  const {
    data: overdueItemsData,
    isLoading: isLoadingOverdueItems,
    error: overdueItemsError,
    refetch: refetchOverdueItems
  } = useQuery({
    queryKey: ["/api/reports/overdue-items"],
    queryFn: async () => {
      return fetchReport('/api/reports/overdue-items');
    },
    enabled: activeTab === 'reports' && reportTab === 'overdue-items',
  });

  // Individual Performance Report Query
  const {
    data: individualPerformanceData,
    isLoading: isLoadingIndividualPerformance,
    error: individualPerformanceError,
    refetch: refetchIndividualPerformance
  } = useQuery({
    queryKey: [
      "/api/reports/individual-performance",
      individualPerformanceStartDate,
      individualPerformanceEndDate,
      individualPerformanceStaffFilter
    ],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: individualPerformanceStartDate,
        endDate: individualPerformanceEndDate,
      });
      if (individualPerformanceStaffFilter) {
        params.append('staffId', individualPerformanceStaffFilter);
      }
      return fetchReport(`/api/reports/individual-performance?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'individual-performance',
  });

  // Team Capacity Report Query
  const {
    data: teamCapacityData,
    isLoading: isLoadingTeamCapacity,
    error: teamCapacityError,
    refetch: refetchTeamCapacity
  } = useQuery({
    queryKey: ["/api/reports/team-capacity", teamCapacityForecastDays],
    queryFn: async () => {
      const params = new URLSearchParams({
        forecastDays: teamCapacityForecastDays.toString(),
      });
      return fetchReport(`/api/reports/team-capacity?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'team-capacity',
  });

  // Utilization Report Query
  const {
    data: utilizationData,
    isLoading: isLoadingUtilization,
    error: utilizationError,
    refetch: refetchUtilization
  } = useQuery({
    queryKey: ["/api/reports/utilization", utilizationStartDate, utilizationEndDate, utilizationGroupBy],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: utilizationStartDate,
        endDate: utilizationEndDate,
        groupBy: utilizationGroupBy,
      });
      return fetchReport(`/api/reports/utilization?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'utilization',
  });

  // Time & Billing Analytics Query
  const {
    data: timeBillingData,
    isLoading: isLoadingTimeBilling,
    error: timeBillingError,
    refetch: refetchTimeBilling
  } = useQuery({
    queryKey: ["/api/reports/time-billing-analytics", timeBillingStartDate, timeBillingEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: timeBillingStartDate,
        endDate: timeBillingEndDate,
      });
      return fetchReport(`/api/reports/time-billing-analytics?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'time-billing',
  });

  // ============================================================================
  // SPRINT 3 QUERIES - Project Templates, Resources, Profitability, Milestones
  // ============================================================================

  // Project Templates Query
  const { data: projectTemplatesData, isLoading: isLoadingTemplates } = useQuery({
    queryKey: ["/api/project-templates", templateCategory],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (templateCategory && templateCategory !== "all") {
        params.append("category", templateCategory);
      }
      const response = await fetch(`/api/project-templates?${params.toString()}`);
      if (!response.ok) throw new Error('Failed to fetch templates');
      return response.json();
    },
    enabled: showTemplatesList || showApplyTemplateDialog,
  });

  // Resource Allocation Query
  const { data: resourceAllocationData, isLoading: isLoadingResources } = useQuery({
    queryKey: ["/api/team/resource-allocation", resourceDateRange, resourceDepartmentFilter],
    queryFn: async () => {
      const params = new URLSearchParams({
        dateRange: resourceDateRange,
      });
      if (resourceDepartmentFilter && resourceDepartmentFilter !== "all") {
        params.append("department", resourceDepartmentFilter);
      }
      const response = await fetch(`/api/team/resource-allocation?${params.toString()}`);
      if (!response.ok) throw new Error('Failed to fetch resource allocation');
      return response.json();
    },
    enabled: showResourceView,
    refetchInterval: 60000, // Refresh every minute
  });

  // Profitability Report Query
  const { data: profitabilityData, isLoading: isLoadingProfitability } = useQuery({
    queryKey: ["/api/reports/profitability", profitabilityStartDate, profitabilityEndDate, profitabilityClientFilter, profitabilityProjectFilter],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: profitabilityStartDate,
        endDate: profitabilityEndDate,
      });
      if (profitabilityClientFilter && profitabilityClientFilter !== "all") {
        params.append("clientId", profitabilityClientFilter);
      }
      if (profitabilityProjectFilter && profitabilityProjectFilter !== "all") {
        params.append("projectId", profitabilityProjectFilter);
      }
      return fetchReport(`/api/reports/profitability?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'profitability',
  });

  // Project Milestones Query
  const { data: milestonesData, isLoading: isLoadingMilestones } = useQuery({
    queryKey: ["/api/project-milestones", selectedProjectForMilestone?.id],
    queryFn: async () => {
      if (!selectedProjectForMilestone?.id) return { data: [] };
      const response = await fetch(`/api/project-milestones?projectId=${selectedProjectForMilestone.id}`);
      if (!response.ok) throw new Error('Failed to fetch milestones');
      return response.json();
    },
    enabled: !!selectedProjectForMilestone?.id,
  });

  // ============================================================================
  // SPRINT 3 MUTATIONS - Templates, Budget, Milestones
  // ============================================================================

  // Create Project Template Mutation
  const createTemplateMutation = useMutation({
    mutationFn: async (templateData: any) => {
      const response = await apiRequest('POST', '/api/project-templates', templateData);
      if (!response.ok) throw new Error('Failed to create template');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/project-templates"] });
      setShowTemplateDialog(false);
      toast({ title: "Template created successfully" });
    },
    onError: (error: Error) => {
      toast({ title: "Error creating template", description: error.message, variant: "destructive" });
    },
  });

  // Apply Template Mutation
  const applyTemplateMutation = useMutation({
    mutationFn: async ({ projectId, templateId }: { projectId: number; templateId: number }) => {
      const response = await apiRequest('POST', '/api/project-templates/apply', { projectId, templateId, autoCreateTasks: true });
      if (!response.ok) throw new Error('Failed to apply template');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/projects"] });
      queryClient.invalidateQueries({ queryKey: ["/api/tasks"] });
      setShowApplyTemplateDialog(false);
      toast({ title: "Template applied successfully" });
    },
    onError: (error: Error) => {
      toast({ title: "Error applying template", description: error.message, variant: "destructive" });
    },
  });

  // Update Project Budget Mutation
  const updateBudgetMutation = useMutation({
    mutationFn: async ({ projectId, budget }: { projectId: number; budget: string }) => {
      const response = await apiRequest('PATCH', `/api/projects/${projectId}`, { budget });
      if (!response.ok) throw new Error('Failed to update budget');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/projects"] });
      setShowBudgetDialog(false);
      setEditingBudget(null);
      toast({ title: "Budget updated successfully" });
    },
    onError: (error: Error) => {
      toast({ title: "Error updating budget", description: error.message, variant: "destructive" });
    },
  });

  // Create/Update Milestone Mutation
  const milestoneMutation = useMutation({
    mutationFn: async (milestoneData: any) => {
      const method = editingMilestone?.id ? 'PATCH' : 'POST';
      const url = editingMilestone?.id ? `/api/project-milestones/${editingMilestone.id}` : '/api/project-milestones';
      const response = await apiRequest(method, url, milestoneData);
      if (!response.ok) throw new Error(`Failed to ${editingMilestone?.id ? 'update' : 'create'} milestone`);
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/project-milestones"] });
      setShowMilestoneDialog(false);
      setEditingMilestone(null);
      toast({ title: `Milestone ${editingMilestone?.id ? 'updated' : 'created'} successfully` });
    },
    onError: (error: Error) => {
      toast({ title: "Error with milestone", description: error.message, variant: "destructive" });
    },
  });

  // Toggle Milestone Deliverable Mutation
  const toggleDeliverableMutation = useMutation({
    mutationFn: async ({ milestoneId, deliverableIndex, completed }: { milestoneId: number; deliverableIndex: number; completed: boolean }) => {
      const response = await apiRequest('PATCH', `/api/project-milestones/${milestoneId}/deliverable`, { deliverableIndex, completed });
      if (!response.ok) throw new Error('Failed to update deliverable');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/project-milestones"] });
    },
  });



  // Workflow Efficiency Query
  const {
    data: workflowEfficiencyData,
    isLoading: isLoadingWorkflowEfficiency,
    error: workflowEfficiencyError,
    refetch: refetchWorkflowEfficiency
  } = useQuery({
    queryKey: ["/api/reports/workflow-efficiency", workflowStartDate, workflowEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: workflowStartDate,
        endDate: workflowEndDate,
      });
      return fetchReport(`/api/reports/workflow-efficiency?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'workflow-efficiency',
  });

  // Client Health Report State & Query
  const [selectedClientForHealth, setSelectedClientForHealth] = useState<number | null>(null);

  const {
    data: clientHealthData,
    isLoading: isLoadingClientHealth,
    error: clientHealthError,
    refetch: refetchClientHealth
  } = useQuery({
    queryKey: ["/api/reports/client-health", selectedClientForHealth],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (selectedClientForHealth) {
        params.append('clientId', selectedClientForHealth.toString());
      }
      return fetchReport(`/api/reports/client-health?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'client-health',
  });

  // Client Retention Analysis Query
  const {
    data: clientRetentionData,
    isLoading: isLoadingClientRetention,
    error: clientRetentionError,
    refetch: refetchClientRetention
  } = useQuery({
    queryKey: ["/api/reports/client-retention"],
    queryFn: async () => {
      return fetchReport('/api/reports/client-retention');
    },
    enabled: activeTab === 'reports' && reportTab === 'client-retention',
  });

  // Compliance Calendar State & Query
  const [complianceStartDate, setComplianceStartDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );
  const [complianceEndDate, setComplianceEndDate] = useState<string>(
    new Date(new Date().getTime() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  );

  const {
    data: complianceCalendarData,
    isLoading: isLoadingComplianceCalendar,
    error: complianceCalendarError,
    refetch: refetchComplianceCalendar
  } = useQuery({
    queryKey: ["/api/reports/compliance-calendar", complianceStartDate, complianceEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: complianceStartDate,
        endDate: complianceEndDate,
      });
      return fetchReport(`/api/reports/compliance-calendar?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'compliance-calendar',
  });

  // Service Delivery Metrics State & Query
  const [serviceDeliveryStartDate, setServiceDeliveryStartDate] = useState<string>(
    new Date(new Date().getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  );
  const [serviceDeliveryEndDate, setServiceDeliveryEndDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );

  const {
    data: serviceDeliveryData,
    isLoading: isLoadingServiceDelivery,
    error: serviceDeliveryError,
    refetch: refetchServiceDelivery
  } = useQuery({
    queryKey: ["/api/reports/service-delivery", serviceDeliveryStartDate, serviceDeliveryEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: serviceDeliveryStartDate,
        endDate: serviceDeliveryEndDate,
      });
      return fetchReport(`/api/reports/service-delivery?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'service-delivery',
  });

  // Client Communication Log State & Query
  const [clientCommStartDate, setClientCommStartDate] = useState<string>(
    new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  );
  const [clientCommEndDate, setClientCommEndDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );
  const [clientCommFilter, setClientCommFilter] = useState<string>('all');

  const {
    data: clientCommunicationData,
    isLoading: isLoadingClientComm,
    error: clientCommError,
    refetch: refetchClientComm
  } = useQuery({
    queryKey: ["/api/reports/client-communication", clientCommStartDate, clientCommEndDate, clientCommFilter],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: clientCommStartDate,
        endDate: clientCommEndDate,
      });
      if (clientCommFilter !== 'all') {
        params.append('clientId', clientCommFilter);
      }
      return fetchReport(`/api/reports/client-communication?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'client-communication',
  });

  // Realization Rate Report State & Query
  const [realizationStartDate, setRealizationStartDate] = useState<string>(
    new Date(new Date().getTime() - 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // Last 6 months
  );
  const [realizationEndDate, setRealizationEndDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );

  const {
    data: realizationData,
    isLoading: isLoadingRealization,
    error: realizationError,
    refetch: refetchRealization
  } = useQuery({
    queryKey: ["/api/reports/realization-rate", realizationStartDate, realizationEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: realizationStartDate,
        endDate: realizationEndDate,
      });
      return fetchReport(`/api/reports/realization-rate?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'realization-rate',
  });

  // Write-offs & Adjustments Report State & Query
  const [writeoffsStartDate, setWriteoffsStartDate] = useState<string>(
    new Date(new Date().getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // Last 12 months
  );
  const [writeoffsEndDate, setWriteoffsEndDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );

  const {
    data: writeoffsData,
    isLoading: isLoadingWriteoffs,
    error: writeoffsError,
    refetch: refetchWriteoffs
  } = useQuery({
    queryKey: ["/api/reports/writeoffs-adjustments", writeoffsStartDate, writeoffsEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: writeoffsStartDate,
        endDate: writeoffsEndDate,
      });
      return fetchReport(`/api/reports/writeoffs-adjustments?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'writeoffs-adjustments',
  });

  // Cash Flow Forecast Report State & Query
  const [forecastDays, setForecastDays] = useState<number>(90);

  const {
    data: cashFlowData,
    isLoading: isLoadingCashFlow,
    error: cashFlowError,
    refetch: refetchCashFlow
  } = useQuery({
    queryKey: ["/api/reports/cash-flow-forecast", forecastDays],
    queryFn: async () => {
      const params = new URLSearchParams({
        forecastDays: forecastDays.toString(),
      });
      return fetchReport(`/api/reports/cash-flow-forecast?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'cash-flow-forecast',
  });

  // Budget vs Actual Report State & Query
  const [budgetVsActualStartDate, setBudgetVsActualStartDate] = useState<string>(
    new Date(new Date().getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // Last 12 months
  );
  const [budgetVsActualEndDate, setBudgetVsActualEndDate] = useState<string>(
    new Date().toISOString().split('T')[0]
  );

  const {
    data: budgetVsActualData,
    isLoading: isLoadingBudgetVsActual,
    error: budgetVsActualError,
    refetch: refetchBudgetVsActual
  } = useQuery({
    queryKey: ["/api/reports/budget-vs-actual", budgetVsActualStartDate, budgetVsActualEndDate],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: budgetVsActualStartDate,
        endDate: budgetVsActualEndDate,
      });
      return fetchReport(`/api/reports/budget-vs-actual?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'budget-vs-actual',
  });

  // Trend Analysis Report State & Query
  const [trendComparisonType, setTrendComparisonType] = useState<'YoY' | 'QoQ' | 'MoM'>('YoY');

  // Report Subscriptions State
  const [showSubscriptionDialog, setShowSubscriptionDialog] = useState(false);
  const [editingSubscription, setEditingSubscription] = useState<any>(null);
  const [deleteConfirmSubscriptionId, setDeleteConfirmSubscriptionId] = useState<number | null>(null);
  const [recipientInputs, setRecipientInputs] = useState<string[]>(['']);

  // Report Subscription Validation Schema
  const subscriptionFormSchema = z.object({
    reportType: z.enum([
      'financial-performance', 'ar-aging', 'client-profitability', 'revenue-by-service',
      'time-billing', 'firm-overview', 'client-health', 'trend-analysis'
    ]),
    reportName: z.string().min(1, 'Report name is required').max(255),
    frequency: z.enum(['daily', 'weekly', 'monthly', 'quarterly']),
    deliveryDay: z.number().min(0).max(31).optional(),
    deliveryTime: z.string().regex(/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/, 'Time must be in HH:MM format'),
    format: z.enum(['pdf', 'excel', 'both']),
    recipients: z.array(z.string().email()).min(1, 'At least one recipient email is required'),
    isActive: z.boolean().default(true),
  });

  type SubscriptionFormData = z.infer<typeof subscriptionFormSchema>;

  // Report Subscriptions Form
  const subscriptionForm = useForm<SubscriptionFormData>({
    resolver: zodResolver(subscriptionFormSchema),
    defaultValues: {
      reportType: 'financial-performance',
      reportName: 'Financial Performance Report',
      frequency: 'monthly',
      deliveryTime: '09:00',
      format: 'pdf',
      recipients: [],
      isActive: true,
    },
  });

  // Query to fetch all subscriptions
  const {
    data: subscriptionsData,
    isLoading: isLoadingSubscriptions,
    error: subscriptionsError,
    refetch: refetchSubscriptions
  } = useQuery({
    queryKey: ["/api/report-subscriptions"],
    enabled: activeTab === 'reports' && reportTab === 'manage-subscriptions',
  });

  // Create subscription mutation
  const createSubscriptionMutation = useMutation({
    mutationFn: async (data: SubscriptionFormData) => {
      const response = await apiRequest('POST', '/api/report-subscriptions', data);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to create subscription');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/report-subscriptions"] });
      setShowSubscriptionDialog(false);
      subscriptionForm.reset();
      setRecipientInputs(['']);
      toast({
        title: "Success",
        description: "Report subscription created successfully!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Update subscription mutation
  const updateSubscriptionMutation = useMutation({
    mutationFn: async ({ id, data }: { id: number; data: Partial<SubscriptionFormData> }) => {
      const response = await apiRequest('PATCH', `/api/report-subscriptions/${id}`, data);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to update subscription');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/report-subscriptions"] });
      setShowSubscriptionDialog(false);
      setEditingSubscription(null);
      subscriptionForm.reset();
      setRecipientInputs(['']);
      toast({
        title: "Success",
        description: "Report subscription updated successfully!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Delete subscription mutation
  const deleteSubscriptionMutation = useMutation({
    mutationFn: async (id: number) => {
      const response = await apiRequest('DELETE', `/api/report-subscriptions/${id}`, {});
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete subscription');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/report-subscriptions"] });
      setDeleteConfirmSubscriptionId(null);
      toast({
        title: "Success",
        description: "Report subscription deleted successfully!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Toggle subscription active status mutation
  const toggleSubscriptionMutation = useMutation({
    mutationFn: async ({ id, isActive }: { id: number; isActive: boolean }) => {
      const response = await apiRequest('PATCH', `/api/report-subscriptions/${id}/toggle`, { isActive });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to toggle subscription');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/report-subscriptions"] });
      toast({
        title: "Success",
        description: "Subscription status updated!",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Handle opening subscription dialog for edit
  const handleEditSubscription = (subscription: any) => {
    setEditingSubscription(subscription);
    subscriptionForm.reset({
      reportType: subscription.reportType,
      reportName: subscription.reportName,
      frequency: subscription.frequency,
      deliveryDay: subscription.deliveryDay,
      deliveryTime: subscription.deliveryTime,
      format: subscription.format,
      recipients: subscription.recipients || [],
      isActive: subscription.isActive,
    });
    setRecipientInputs(subscription.recipients || ['']);
    setShowSubscriptionDialog(true);
  };

  // Handle subscription form submission
  const handleSubscriptionSubmit = (data: SubscriptionFormData) => {
    if (editingSubscription) {
      updateSubscriptionMutation.mutate({ id: editingSubscription.id, data });
    } else {
      createSubscriptionMutation.mutate(data);
    }
  };

  // Handle adding/removing recipient emails
  const addRecipientInput = () => {
    setRecipientInputs([...recipientInputs, '']);
  };

  const removeRecipientInput = (index: number) => {
    const newInputs = recipientInputs.filter((_, i) => i !== index);
    setRecipientInputs(newInputs.length === 0 ? [''] : newInputs);
    const currentRecipients = subscriptionForm.getValues('recipients');
    subscriptionForm.setValue('recipients', currentRecipients.filter((_, i) => i !== index));
  };

  const updateRecipientEmail = (index: number, email: string) => {
    const newInputs = [...recipientInputs];
    newInputs[index] = email;
    setRecipientInputs(newInputs);
    const validEmails = newInputs.filter(e => e && z.string().email().safeParse(e).success);
    subscriptionForm.setValue('recipients', validEmails);
  };

  // Auto-populate report name based on report type selection
  const reportTypeDisplayNames: Record<string, string> = {
    'financial-performance': 'Financial Performance Report',
    'ar-aging': 'AR Aging Report',
    'client-profitability': 'Client Profitability Report',
    'revenue-by-service': 'Revenue by Service Report',
    'time-billing': 'Time & Billing Report',
    'firm-overview': 'Firm Overview Report',
    'client-health': 'Client Health Report',
    'trend-analysis': 'Trend Analysis Report'
  };

  const {
    data: trendAnalysisData,
    isLoading: isLoadingTrendAnalysis,
    error: trendAnalysisError,
    refetch: refetchTrendAnalysis
  } = useQuery({
    queryKey: ["/api/reports/trend-analysis", trendComparisonType],
    queryFn: async () => {
      const params = new URLSearchParams({
        comparisonType: trendComparisonType,
      });
      return fetchReport(`/api/reports/trend-analysis?${params.toString()}`);
    },
    enabled: activeTab === 'reports' && reportTab === 'trend-analysis',
  });

  // Helper function to safely extract data arrays
  const safeArray = (data: any) => data?.data || data || [];

  // Safe metrics with defaults - now uses real data from clients
  const safeMetrics = {
    totalClients: safeArray(clients).length || 0,
    activeWorkflows: projects.length || 0,
    totalRevenue: (practiceMetrics as any)?.totalRevenue || 0,
    billableHours: (practiceMetrics as any)?.billableHours || 0,
    teamUtilization: (practiceMetrics as any)?.teamUtilization || 0,
    pipelineValue: (practiceMetrics as any)?.pipelineValue || 0,
  };

  // Task form
  const taskForm = useForm<TaskFormData>({
    resolver: zodResolver(taskSchema),
    defaultValues: {
      title: "",
      description: "",
      projectId: "",
      statusId: "",
      priority: "medium",
      startDate: "",
      dueDate: "",
      estimatedHours: "",
      parentTaskId: "",
      assignedUserId: "",
      isRecurring: false,
      recurrenceFrequency: "monthly",
      recurrenceEndCondition: "never",
      recurrenceEndDate: "",
      recurrenceTotalOccurrences: "",
    },
  });

  const isTaskRecurring = taskForm.watch("isRecurring");
  const recurrenceEndCondition = taskForm.watch("recurrenceEndCondition");
  const selectedTaskProjectId = taskForm.watch("projectId");
  const availableParentTasks = selectedTaskProjectId
    ? tasks.filter((task: any) => String(task.projectId) === selectedTaskProjectId)
    : tasks;

  // Set default statusId when task statuses load
  useEffect(() => {
    if (taskStatuses.length > 0 && !taskForm.getValues('statusId')) {
      const firstActiveStatus = taskStatuses
        .filter((s: any) => s.isActive)
        .sort((a: any, b: any) => a.displayOrder - b.displayOrder)[0];
      if (firstActiveStatus) {
        taskForm.setValue('statusId', firstActiveStatus.id.toString());
      }
    }
  }, [taskStatuses, taskForm]);

  // Create task mutation
  const createTaskMutation = useMutation({
    mutationFn: async (data: TaskFormData) => {
      const payload = {
        ...data,
        projectId: parseInt(data.projectId),
        statusId: data.statusId ? parseInt(data.statusId) : undefined,
        assignedTo: data.assignedUserId ? parseInt(data.assignedUserId) : undefined,
        parentTaskId: data.parentTaskId ? parseInt(data.parentTaskId) : undefined,
        dueDate: data.dueDate || undefined,
        startDate: data.startDate || undefined,
        estimatedHours: data.estimatedHours || undefined,
        isRecurring: data.isRecurring || false,
        recurrencePattern: data.isRecurring
          ? {
              frequency: data.recurrenceFrequency || "monthly",
              endCondition: data.recurrenceEndCondition || "never",
              endDate: data.recurrenceEndDate || undefined,
              totalOccurrences: data.recurrenceTotalOccurrences
                ? parseInt(data.recurrenceTotalOccurrences)
                : undefined,
            }
          : undefined,
      };
      const response = await apiRequest('POST', '/api/tasks', payload);
      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.message || 'Failed to create task');
      }

      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/tasks"] });
      setShowNewTaskDialog(false);
      taskForm.reset();
      toast({ title: "Success", description: "Task created successfully!" });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message || "Failed to create task",
        variant: "destructive"
      });
    },
  });

  const handleCreateTask = (data: TaskFormData) => {
    if (data.isRecurring) {
      if (!data.recurrenceFrequency) {
        toast({
          title: "Validation Error",
          description: "Select a recurrence frequency for recurring tasks.",
          variant: "destructive",
        });
        return;
      }

      if (data.recurrenceEndCondition === "on_date" && !data.recurrenceEndDate) {
        toast({
          title: "Validation Error",
          description: "Select an end date for recurring tasks.",
          variant: "destructive",
        });
        return;
      }

      if (data.recurrenceEndCondition === "after" && !data.recurrenceTotalOccurrences) {
        toast({
          title: "Validation Error",
          description: "Enter total occurrences for recurring tasks.",
          variant: "destructive",
        });
        return;
      }
    }

    createTaskMutation.mutate(data);
  };

  // Time entry mutation
  const createTimeEntryMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await fetch("/api/time-entries", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/time-entries"] });
      setShowTimeEntry(false);
      setElapsedTime(0);
      setCurrentTimeEntry(null);
      toast({ title: "Success", description: "Time entry logged successfully!" });
    },
    onError: () => {
      toast({ title: "Error", description: "Failed to log time entry", variant: "destructive" });
    },
  });

  // Handle timer stop with time entry
  const handleStopTimer = () => {
    if (elapsedTime > 0) {
      setCurrentTimeEntry({
        duration: elapsedTime,
        startTime: new Date(Date.now() - elapsedTime * 1000).toISOString(),
        endTime: new Date().toISOString(),
      });
      setIsTimerRunning(false);
      setIsTimerOpen(false);
      setShowTimeEntry(true);
    } else {
      setIsTimerRunning(false);
      setElapsedTime(0);
    }
  };

  // Payment recording mutation
  const recordPaymentMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest("POST", "/api/billing/payments", data);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to record payment');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/invoices"] });
      queryClient.invalidateQueries({ queryKey: ["/api/billing/payments"] });
      setShowPaymentDialog(false);
      setSelectedInvoiceForPayment(null);
      toast({ title: "Success", description: "Payment recorded successfully!" });
    },
    onError: (error: Error) => {
      toast({ title: "Error", description: error.message || "Failed to record payment", variant: "destructive" });
    },
  });

  // Billing settings mutation
  const saveBillingSettingsMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest("PUT", "/api/billing/settings", data);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save settings');
      }
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/billing/settings"] });
      toast({ title: "Success", description: "Billing settings saved successfully!" });
    },
    onError: (error: Error) => {
      toast({ title: "Error", description: error.message || "Failed to save settings", variant: "destructive" });
    },
  });

  // Filtering and sorting functions

  // Task status configuration mutations (for Settings page)
  const createTaskStatusConfigMutation = useMutation({
    mutationFn: async (data: { name: string; color: string }) => {
      return apiRequest('/api/task-statuses', {
        method: 'POST',
        body: JSON.stringify(data),
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/task-statuses'] });
      toast({ title: "Success", description: "Task status created successfully!" });
    },
    onError: (error: Error) => {
      toast({ title: "Error", description: error.message || "Failed to create task status", variant: "destructive" });
    },
  });

  const updateTaskStatusConfigMutation = useMutation({
    mutationFn: async (data: { id: number; name?: string; color?: string }) => {
      const { id, ...updateData } = data;
      return apiRequest(`/api/task-statuses/${id}`, {
        method: 'PATCH',
        body: JSON.stringify(updateData),
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/task-statuses'] });
      toast({ title: "Success", description: "Task status updated successfully!" });
    },
    onError: (error: Error) => {
      toast({ title: "Error", description: error.message || "Failed to update task status", variant: "destructive" });
    },
  });

  const deleteTaskStatusConfigMutation = useMutation({
    mutationFn: async (id: number) => {
      return apiRequest(`/api/task-statuses/${id}`, {
        method: 'DELETE',
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/task-statuses'] });
      toast({ title: "Success", description: "Task status deleted successfully!" });
    },
    onError: (error: Error) => {
      toast({ title: "Error", description: error.message || "Failed to delete task status", variant: "destructive" });
    },
  });
  const getFilteredAndSortedClients = () => {
    let filtered = safeArray(clients);

    // Apply search filter
    if (clientSearchTerm) {
      filtered = filtered.filter((client: any) =>
        client.name.toLowerCase().includes(clientSearchTerm.toLowerCase()) ||
        (client.email && client.email.toLowerCase().includes(clientSearchTerm.toLowerCase()))
      );
    }

    // Apply status filter
    if (clientFilterBy !== 'all') {
      if (clientFilterBy === 'active') {
        filtered = filtered.filter((client: any) => client.status === 'active');
      } else if (clientFilterBy === 'inactive') {
        filtered = filtered.filter((client: any) => client.status === 'inactive');
      } else if (clientFilterBy === 'recent') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filtered = filtered.filter((client: any) =>
          new Date(client.createdAt || client.created_at || Date.now()) >= thirtyDaysAgo
        );
      }
    }

    // Sort clients with direction support
    filtered.sort((a: any, b: any) => {
      let compareResult = 0;

      switch (clientSortBy) {
        case 'name':
          compareResult = a.name.localeCompare(b.name);
          break;
        case 'email':
          compareResult = (a.email || '').localeCompare(b.email || '');
          break;
        case 'contactPerson':
          compareResult = (a.contactPersonName || '').localeCompare(b.contactPersonName || '');
          break;
        case 'industry':
          compareResult = (a.industry || 'General').localeCompare(b.industry || 'General');
          break;
        case 'businessNumber':
          compareResult = (a.businessNumber || '').localeCompare(b.businessNumber || '');
          break;
        case 'yearEnd':
          compareResult = (a.fiscalYearEnd || '').localeCompare(b.fiscalYearEnd || '');
          break;
        case 'workType':
          const aWorkType = Array.isArray(a.workType) ? a.workType[0] || '' : a.workType || '';
          const bWorkType = Array.isArray(b.workType) ? b.workType[0] || '' : b.workType || '';
          compareResult = aWorkType.localeCompare(bWorkType);
          break;
        case 'status':
          compareResult = (a.status || 'active').localeCompare(b.status || 'active');
          break;
        case 'created':
          compareResult = new Date(b.createdAt || b.created_at || 0).getTime() - new Date(a.createdAt || a.created_at || 0).getTime();
          break;
        default:
          return 0;
      }

      // Apply sort direction
      return clientSortDirection === 'asc' ? compareResult : -compareResult;
    });

    return filtered;
  };

  // Sorting handler
  const handleSort = (field: string) => {
    if (clientSortBy === field) {
      // Toggle direction if same field
      setClientSortDirection(clientSortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      // Set new field with ascending direction
      setClientSortBy(field);
      setClientSortDirection('asc');
    }
  };

  // Column visibility toggle
  const toggleColumnVisibility = (column: string) => {
    setVisibleColumns(prev => ({
      ...prev,
      [column]: !prev[column]
    }));
  };

  // Render sort icon
  const renderSortIcon = (field: string) => {
    if (clientSortBy !== field) {
      return null;
    }
    return clientSortDirection === 'asc' ?
      <ChevronUp className="w-4 h-4 ml-1" /> :
      <ChevronDown className="w-4 h-4 ml-1" />;
  };

  // Export functions
  const exportClientsToExcel = () => {
    const data = getFilteredAndSortedClients().map((client: any) => ({
      'Client Name': client.name,
      'Email': client.email,
      'Contact Person': client.contactPersonName || 'Not specified',
      'Industry': client.industry || 'General',
      'Business Number': client.businessNumber || 'Not provided',
      'Year End': client.fiscalYearEnd || 'December 31',
      'Status': client.status
    }));

    // Create CSV content
    const headers = Object.keys(data[0] || {}).join(',');
    const rows = data.map(row => Object.values(row).join(','));
    const csvContent = [headers, ...rows].join('\n');

    // Download file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clients-export-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    toast({
      title: "Export Complete",
      description: "Client data has been exported to Excel successfully.",
    });
  };

  const exportClientsToPDF = () => {
    toast({
      title: "PDF Export",
      description: "PDF export functionality would be implemented here.",
    });
  };

  // Render different content based on active tab
  const renderTabContent = () => {
    if (!allowedModules.includes(activeTab)) {
      return (
        <div className="p-8 text-center">
          <h3 className="text-lg font-semibold text-gray-700">Access Restricted</h3>
          <p className="text-gray-500 mt-2">
            You do not have permission to access this module.
          </p>
        </div>
      );
    }
    switch (activeTab) {
      case 'communication':
        return (
          <div className="h-full">
            <CommunicationHubModern />
          </div>
        );


      case 'dashboard':
        return (
          <div className="space-y-6 w-full max-w-full">
            {/* Metrics Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full max-w-full">
              <Card className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 mb-1">Total Clients</p>
                    <p className="text-3xl font-bold text-gray-900">{dashboardMetrics?.totalClients ?? 'Loading...'}</p>
                  </div>
                  <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <Users className="w-6 h-6 text-blue-600" />
                  </div>
                </div>
              </Card>

              <Card className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 mb-1">Active Tasks</p>
                    <p className="text-3xl font-bold text-gray-900">{dashboardMetrics?.pendingTasks ?? 'Loading...'}</p>
                  </div>
                  <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <CheckCircle2 className="w-6 h-6 text-green-600" />
                  </div>
                </div>
              </Card>

              <Card className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 mb-1">Running Workflows</p>
                    <p className="text-3xl font-bold text-gray-900">{projects.length || 0}</p>
                  </div>
                  <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <Activity className="w-6 h-6 text-purple-600" />
                  </div>
                </div>
              </Card>

              <Card className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 mb-1">Team Members</p>
                    <p className="text-3xl font-bold text-gray-900">{users?.users?.length || 0}</p>
                  </div>
                  <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <Users className="w-6 h-6 text-orange-600" />
                  </div>
                </div>
              </Card>
            </div>

            {/* Recent Activity */}
            <Card>
              <CardHeader>
                <CardTitle>Recent Activity</CardTitle>
                <CardDescription>Latest updates from your practice</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {recentActivities && recentActivities.length > 0 ? (
                  recentActivities.slice(0, 5).map((activity: any) => {
                    const getActivityIcon = (type: string) => {
                      switch (type) {
                        case 'client_created':
                        case 'client_updated':
                          return <Plus className="w-4 h-4 text-green-600" />;
                        case 'task_completed':
                        case 'task_created':
                          return <CheckCircle className="w-4 h-4 text-blue-600" />;
                        case 'workflow_started':
                        case 'workflow_completed':
                          return <Activity className="w-4 h-4 text-purple-600" />;
                        case 'document_uploaded':
                        case 'document_reviewed':
                          return <FileText className="w-4 h-4 text-orange-600" />;
                        case 'client_meeting_scheduled':
                        case 'client_meeting_completed':
                          return <Calendar className="w-4 h-4 text-indigo-600" />;
                        case 'email_sent':
                        case 'phone_call_made':
                          return <Mail className="w-4 h-4 text-cyan-600" />;
                        default:
                          return <Activity className="w-4 h-4 text-gray-600" />;
                      }
                    };

                    const getActivityStyle = (type: string) => {
                      switch (type) {
                        case 'client_created':
                        case 'client_updated':
                          return 'bg-green-50';
                        case 'task_completed':
                        case 'task_created':
                          return 'bg-blue-50';
                        case 'workflow_started':
                        case 'workflow_completed':
                          return 'bg-purple-50';
                        case 'document_uploaded':
                        case 'document_reviewed':
                          return 'bg-orange-50';
                        case 'client_meeting_scheduled':
                        case 'client_meeting_completed':
                          return 'bg-indigo-50';
                        case 'email_sent':
                        case 'phone_call_made':
                          return 'bg-cyan-50';
                        default:
                          return 'bg-gray-50';
                      }
                    };

                    const getIconBackgroundStyle = (type: string) => {
                      switch (type) {
                        case 'client_created':
                        case 'client_updated':
                          return 'bg-green-100';
                        case 'task_completed':
                        case 'task_created':
                          return 'bg-blue-100';
                        case 'workflow_started':
                        case 'workflow_completed':
                          return 'bg-purple-100';
                        case 'document_uploaded':
                        case 'document_reviewed':
                          return 'bg-orange-100';
                        case 'client_meeting_scheduled':
                        case 'client_meeting_completed':
                          return 'bg-indigo-100';
                        case 'email_sent':
                        case 'phone_call_made':
                          return 'bg-cyan-100';
                        default:
                          return 'bg-gray-100';
                      }
                    };

                    const formatTimeAgo = (dateString: string) => {
                      const now = new Date();
                      const activityDate = new Date(dateString);
                      const diffInMinutes = Math.floor((now.getTime() - activityDate.getTime()) / (1000 * 60));

                      if (diffInMinutes < 60) {
                        return diffInMinutes === 0 ? 'Just now' : `${diffInMinutes} minutes ago`;
                      } else if (diffInMinutes < 1440) { // Less than a day
                        const hours = Math.floor(diffInMinutes / 60);
                        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                      } else {
                        const days = Math.floor(diffInMinutes / 1440);
                        return `${days} day${days > 1 ? 's' : ''} ago`;
                      }
                    };

                    return (
                      <div key={activity.id} className={`flex items-start gap-3 p-3 rounded-lg ${getActivityStyle(activity.type)}`}>
                        <div className={`w-8 h-8 ${getIconBackgroundStyle(activity.type)} rounded-full flex items-center justify-center flex-shrink-0 mt-0.5`}>
                          {getActivityIcon(activity.type)}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-medium text-gray-900">{activity.title}</p>
                          <p className="text-sm text-gray-600">
                            {activity.description}
                            {activity.clientName && ` ‚Ä¢ ${activity.clientName}`}
                            {' ‚Ä¢ ' + formatTimeAgo(activity.createdAt)}
                          </p>
                        </div>
                      </div>
                    );
                  })
                ) : (
                  <div className="text-center py-8">
                    <Activity className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                    <h3 className="text-lg font-semibold text-gray-600 mb-2">No Recent Activity</h3>
                    <p className="text-gray-500">Start working with clients to see activity here</p>
                  </div>
                )}
              </CardContent>
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <Card>
                <CardHeader>
                  <CardTitle>To Do Items</CardTitle>
                  <CardDescription>Open tasks requiring attention</CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {todoItems.length > 0 ? (
                    todoItems.map((task: any) => (
                      <div key={task.id} className="flex items-center justify-between">
                        <div className="flex-1">
                          <p className="text-sm font-medium text-gray-900">{task.title}</p>
                          <p className="text-xs text-gray-500">{task.status || "pending"}</p>
                        </div>
                        {task.dueDate && (
                          <span className="text-xs text-gray-500">
                            {format(new Date(task.dueDate), "MMM d")}
                          </span>
                        )}
                      </div>
                    ))
                  ) : (
                    <p className="text-sm text-gray-500">No open tasks right now.</p>
                  )}
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Calendar Quick View</CardTitle>
                  <CardDescription>Upcoming task deadlines</CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {calendarItems.length > 0 ? (
                    calendarItems.map((task: any) => (
                      <div key={task.id} className="flex items-center justify-between">
                        <div className="flex-1">
                          <p className="text-sm font-medium text-gray-900">{task.title}</p>
                          <p className="text-xs text-gray-500">
                            Due {format(new Date(task.dueDate), "MMM d")}
                          </p>
                        </div>
                      </div>
                    ))
                  ) : (
                    <p className="text-sm text-gray-500">No upcoming deadlines.</p>
                  )}
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Notifications</CardTitle>
                  <CardDescription>Recent alerts</CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {notificationItems.length > 0 ? (
                    notificationItems.map((note: any) => (
                      <div key={note.id} className="flex items-start gap-2">
                        <div className="w-2 h-2 mt-2 rounded-full bg-blue-500" />
                        <div>
                          <p className="text-sm font-medium text-gray-900">
                            {note.title || note.message || "Notification"}
                          </p>
                          {note.createdAt && (
                            <p className="text-xs text-gray-500">
                              {format(new Date(note.createdAt), "MMM d")}
                            </p>
                          )}
                        </div>
                      </div>
                    ))
                  ) : (
                    <p className="text-sm text-gray-500">No notifications.</p>
                  )}
                </CardContent>
              </Card>
            </div>
          </div>
        );

      case 'clients':
        return (
          <div className="space-y-6 overflow-x-hidden">
            {/* Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Client Management</h2>
                <p className="text-gray-600">Manage your client relationships and information</p>
              </div>
              <div className="flex items-center gap-3">
                {/* Sort Dropdown */}
                <select
                  value={clientSortBy}
                  onChange={(e) => setClientSortBy(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md text-sm"
                >
                  <option value="name">Sort by Name</option>
                  <option value="email">Sort by Email</option>
                  <option value="industry">Sort by Industry</option>
                  <option value="status">Sort by Status</option>
                  <option value="created">Sort by Date Created</option>
                </select>

                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                  <Input
                    placeholder="Search clients..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-9 w-64"
                  />
                </div>

                {/* Filter & Export Dropdown */}
                <select
                  value={clientFilterBy}
                  onChange={(e) => setClientFilterBy(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-md text-sm"
                >
                  <option value="all">All Clients</option>
                  <option value="active">Active Only</option>
                  <option value="inactive">Inactive Only</option>
                  <option value="recent">Recent (30 days)</option>
                </select>

                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="outline">
                      <Download className="w-4 h-4 mr-2" />
                      Export
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={() => exportClientsToExcel()}>
                      <FileText className="w-4 h-4 mr-2" />
                      Export to Excel
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => exportClientsToPDF()}>
                      <FileText className="w-4 h-4 mr-2" />
                      Export to PDF
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>

                <Button onClick={() => {
                  setShowClientEdit(false);
                  setShowNewClientDialog(true);
                }}>
                  <Plus className="w-4 h-4 mr-2" />
                  Add Client
                </Button>
              </div>
            </div>

            {/* Metrics Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Total Clients</p>
                      <p className="text-2xl font-bold text-gray-900">{safeArray(clients).length || 0}</p>
                    </div>
                    <Users className="w-8 h-8 text-blue-600" />
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Active Clients</p>
                      <p className="text-2xl font-bold text-green-600">{clients?.filter((c: any) => c.status === 'active').length || 0}</p>
                    </div>
                    <CheckCircle className="w-8 h-8 text-green-600" />
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Industries Served</p>
                      <p className="text-2xl font-bold text-purple-600">1</p>
                    </div>
                    <Building className="w-8 h-8 text-purple-600" />
                  </div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Pending Tasks</p>
                      <p className="text-2xl font-bold text-orange-600">0</p>
                    </div>
                    <AlertCircle className="w-8 h-8 text-orange-600" />
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Bulk Actions */}
            {selectedClients.length > 0 && (
              <Card className="mb-4">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">
                      {selectedClients.length} client{selectedClients.length > 1 ? 's' : ''} selected
                    </span>
                    <div className="flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={async () => {
                          if (confirm(`Are you sure you want to deactivate ${selectedClients.length} client(s)?`)) {
                            try {
                              const results = await Promise.allSettled(
                                selectedClients.map(clientId =>
                                  apiRequest('PATCH', `/api/clients/${clientId}`, { status: 'inactive' })
                                )
                              );

                              const failures = results.filter(r => r.status === 'rejected').length;
                              const successes = results.filter(r => r.status === 'fulfilled').length;

                              queryClient.invalidateQueries({ queryKey: ['/api/clients'] });
                              setSelectedClients([]);

                              if (failures === 0) {
                                toast({
                                  title: "Clients Deactivated",
                                  description: `${successes} client(s) have been deactivated`,
                                });
                              } else {
                                toast({
                                  title: "Partial Success",
                                  description: `${successes} succeeded, ${failures} failed`,
                                  variant: "destructive"
                                });
                              }
                            } catch (error) {
                              console.error("Bulk deactivate error:", error);
                              toast({
                                title: "Error",
                                description: "Failed to deactivate clients",
                                variant: "destructive"
                              });
                            }
                          }
                        }}
                      >
                        <X className="w-4 h-4 mr-2" />
                        Deactivate Selected
                      </Button>
                      <Button
                        variant="destructive"
                        size="sm"
                        onClick={async () => {
                          if (confirm(`‚ö†Ô∏è DANGER: Are you sure you want to permanently delete ${selectedClients.length} client(s)? This action cannot be undone and will delete all associated data.`)) {
                            try {
                              const results = await Promise.allSettled(
                                selectedClients.map(clientId =>
                                  apiRequest('DELETE', `/api/clients/${clientId}`)
                                )
                              );

                              const failures = results.filter(r => r.status === 'rejected').length;
                              const successes = results.filter(r => r.status === 'fulfilled').length;

                              queryClient.invalidateQueries({ queryKey: ['/api/clients'] });
                              setSelectedClients([]);

                              if (failures === 0) {
                                toast({
                                  title: "Clients Deleted",
                                  description: `${successes} client(s) have been permanently deleted`,
                                  variant: "destructive"
                                });
                              } else {
                                toast({
                                  title: "Partial Success",
                                  description: `${successes} deleted, ${failures} failed`,
                                  variant: "destructive"
                                });
                              }
                            } catch (error) {
                              console.error("Bulk delete error:", error);
                              toast({
                                title: "Error",
                                description: "Failed to delete clients",
                                variant: "destructive"
                              });
                            }
                          }
                        }}
                      >
                        <Trash2 className="w-4 h-4 mr-2" />
                        Delete Selected
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setSelectedClients([])}
                      >
                        Clear Selection
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Client Table */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle>All Clients</CardTitle>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="outline" size="sm">
                        <Columns className="w-4 h-4 mr-2" />
                        Columns
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end" className="w-48">
                      <div className="p-2">
                        <div className="text-sm font-medium mb-2">Show/Hide Columns</div>
                        {Object.entries({
                          clientName: 'Client Name',
                          contactPerson: 'Contact Person',
                          industry: 'Industry',
                          businessNumber: 'Business Number',
                          yearEnd: 'Year End',
                          workType: 'Work Type',
                          status: 'Status',
                          actions: 'Actions'
                        }).map(([key, label]) => (
                          <div key={key} className="flex items-center space-x-2 py-1">
                            <input
                              type="checkbox"
                              checked={visibleColumns[key as keyof typeof visibleColumns]}
                              onChange={() => toggleColumnVisibility(key)}
                              className="w-4 h-4 rounded border-gray-300"
                            />
                            <span className="text-sm">{label}</span>
                          </div>
                        ))}
                      </div>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </div>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead className="w-12">
                          <input
                            type="checkbox"
                            className="w-4 h-4 rounded border-2 border-gray-300 text-blue-600 focus:ring-blue-500"
                            checked={selectedClients.length === getFilteredAndSortedClients().length && getFilteredAndSortedClients().length > 0}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedClients(getFilteredAndSortedClients().map((client: any) => client.id));
                              } else {
                                setSelectedClients([]);
                              }
                            }}
                          />
                        </TableHead>
                        {visibleColumns.clientName && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('name')}
                            >
                              Client Name
                              {renderSortIcon('name')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.contactPerson && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('contactPerson')}
                            >
                              Contact Person
                              {renderSortIcon('contactPerson')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.industry && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('industry')}
                            >
                              Industry
                              {renderSortIcon('industry')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.businessNumber && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('businessNumber')}
                            >
                              Business Number
                              {renderSortIcon('businessNumber')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.yearEnd && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('yearEnd')}
                            >
                              Year End
                              {renderSortIcon('yearEnd')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.workType && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('workType')}
                            >
                              Work Type
                              {renderSortIcon('workType')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.status && (
                          <TableHead>
                            <button
                              className="flex items-center hover:text-blue-600 font-medium"
                              onClick={() => handleSort('status')}
                            >
                              Status
                              {renderSortIcon('status')}
                            </button>
                          </TableHead>
                        )}
                        {visibleColumns.actions && (
                          <TableHead>Actions</TableHead>
                        )}
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {getFilteredAndSortedClients().map((client: any) => (
                        <TableRow
                          key={client.id}
                          className="hover:bg-gray-50 cursor-pointer"
                          onClick={(e) => {
                            // Don't trigger row click if clicking on checkbox
                            if ((e.target as HTMLElement).type === 'checkbox') return;
                            setSelectedClientId(client.id.toString());
                            setShowClientDetail(true);
                          }}
                        >
                          <TableCell>
                            <input
                              type="checkbox"
                              className="w-4 h-4 rounded border-2 border-gray-300 text-blue-600 focus:ring-blue-500"
                              checked={selectedClients.includes(client.id)}
                              onChange={(e) => {
                                e.stopPropagation();
                                if (e.target.checked) {
                                  setSelectedClients([...selectedClients, client.id]);
                                } else {
                                  setSelectedClients(selectedClients.filter(id => id !== client.id));
                                }
                              }}
                              onClick={(e) => e.stopPropagation()}
                            />
                          </TableCell>
                          {visibleColumns.clientName && (
                            <TableCell>
                              <div className="flex items-center gap-3">
                                {client.logo ? (
                                  <ClientLogo
                                    logoUrl={client.logo}
                                    clientName={client.name}
                                    clientId={client.id}
                                  />
                                ) : (
                                  <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <Building className="w-4 h-4 text-blue-600" />
                                  </div>
                                )}
                                <div className="min-w-0 flex-1">
                                  <div className="font-medium hover:text-blue-600 truncate">{client.name}</div>
                                  <div className="text-sm text-gray-500 truncate">{client.email}</div>
                                </div>
                              </div>
                            </TableCell>
                          )}
                          {visibleColumns.contactPerson && (
                            <TableCell>
                              <div>
                                <div className="font-medium">{client.contactPersonName || "Not specified"}</div>
                                <div className="text-sm text-gray-500">{client.contactPersonEmail || ""}</div>
                              </div>
                            </TableCell>
                          )}
                          {visibleColumns.industry && (
                            <TableCell>{client.industry || "General"}</TableCell>
                          )}
                          {visibleColumns.businessNumber && (
                            <TableCell>{client.businessNumber || "Not provided"}</TableCell>
                          )}
                          {visibleColumns.yearEnd && (
                            <TableCell>{client.fiscalYearEnd || "December 31"}</TableCell>
                          )}
                          {visibleColumns.workType && (
                            <TableCell>
                              <Badge variant="outline">
                                {Array.isArray(client.workType) ? client.workType[0] : "Bookkeeping"}
                              </Badge>
                            </TableCell>
                          )}
                          {visibleColumns.status && (
                            <TableCell>
                              <Badge variant={client.status === 'active' ? 'default' : 'secondary'}>
                                {client.status}
                              </Badge>
                            </TableCell>
                          )}
                          {visibleColumns.actions && (
                            <TableCell>
                              <div className="flex items-center gap-2">
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setSelectedClientId(client.id.toString());
                                    setShowClientDetail(true);
                                  }}
                                >
                                  <Eye className="w-4 h-4" />
                                </Button>
                                <DropdownMenu>
                                  <DropdownMenuTrigger asChild>
                                    <Button variant="ghost" size="sm" onClick={(e) => e.stopPropagation()}>
                                      <MoreHorizontal className="w-4 h-4" />
                                    </Button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent align="end">
                                    <DropdownMenuItem onClick={(e) => {
                                      console.log('üîç View Details clicked for client:', client.id, client.name);
                                      e.stopPropagation();
                                      setSelectedClientId(client.id.toString());
                                      setShowClientDetail(true);
                                    }}>
                                      <Eye className="w-4 h-4 mr-2" />
                                      View Details
                                    </DropdownMenuItem>
                                    <DropdownMenuItem onClick={(e) => {
                                      console.log('üìÑ View Documents clicked for client:', client.id, client.name);
                                      e.stopPropagation();
                                      toast({
                                        title: "Documents",
                                        description: `Opening document manager for ${client.name}`,
                                      });
                                    }}>
                                      <FileText className="w-4 h-4 mr-2" />
                                      View Documents
                                    </DropdownMenuItem>
                                    <DropdownMenuItem onClick={(e) => {
                                      console.log('üìß Send Email clicked for client:', client.id, client.name);
                                      e.stopPropagation();
                                      const emailUrl = `mailto:${client.email || client.contactPersonEmail}?subject=Message from Accounting Firm`;
                                      window.open(emailUrl, '_blank');
                                      toast({
                                        title: "Email Client",
                                        description: `Opening email to ${client.name}`,
                                      });
                                    }}>
                                      <Mail className="w-4 h-4 mr-2" />
                                      Send Email
                                    </DropdownMenuItem>
                                    <DropdownMenuItem onClick={(e) => {
                                      console.log('üñºÔ∏è Upload Logo clicked for client:', client.id, client.name);
                                      e.stopPropagation();
                                      setLogoUploadClientId(client.id);
                                      setShowLogoUploadDialog(true);
                                    }}>
                                      <Image className="w-4 h-4 mr-2" />
                                      Upload Logo
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      className="text-orange-600"
                                      onClick={async (e) => {
                                        console.log('‚ùå Deactivate clicked for client:', client.id, client.name);
                                        e.stopPropagation();
                                        if (confirm(`Are you sure you want to deactivate ${client.name}?`)) {
                                          try {
                                            await apiRequest('PATCH', `/api/clients/${client.id}`, { status: 'inactive' });

                                            // Invalidate clients query to refresh the list
                                            queryClient.invalidateQueries({ queryKey: ['/api/clients'] });

                                            toast({
                                              title: "Client Deactivated",
                                              description: `${client.name} has been deactivated`,
                                              variant: "destructive"
                                            });
                                          } catch (error) {
                                            toast({
                                              title: "Error",
                                              description: `Failed to deactivate ${client.name}`,
                                              variant: "destructive"
                                            });
                                          }
                                        }
                                      }}
                                    >
                                      <X className="w-4 h-4 mr-2" />
                                      Deactivate Client
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      className="text-red-600"
                                      onClick={async (e) => {
                                        console.log('üóëÔ∏è Delete clicked for client:', client.id, client.name);
                                        e.stopPropagation();
                                        if (confirm(`‚ö†Ô∏è DANGER: Are you sure you want to permanently delete ${client.name}? This action cannot be undone and will delete all associated data including transactions, projects, and documents.`)) {
                                          try {
                                            await apiRequest('DELETE', `/api/clients/${client.id}`);

                                            // Invalidate clients query to refresh the list
                                            queryClient.invalidateQueries({ queryKey: ['/api/clients'] });

                                            toast({
                                              title: "Client Deleted",
                                              description: `${client.name} has been permanently deleted`,
                                              variant: "destructive"
                                            });
                                          } catch (error) {
                                            toast({
                                              title: "Error",
                                              description: `Failed to delete ${client.name}`,
                                              variant: "destructive"
                                            });
                                          }
                                        }
                                      }}
                                    >
                                      <Trash2 className="w-4 h-4 mr-2" />
                                      Delete Client
                                    </DropdownMenuItem>
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </div>
                            </TableCell>
                          )}
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </CardContent>
            </Card>
          </div>
        );

      case 'tasks':
        return (
          <TasksView
            tasks={tasks}
            taskStatuses={taskStatuses}
            activeTimer={activeTimer}
            startTimerForTaskMutation={startTimerForTaskMutation}
            stopTimerMutation={stopTimerMutation}
            showStopTimerDialog={showStopTimerDialog}
            setShowStopTimerDialog={setShowStopTimerDialog}
            stopTimerNotes={stopTimerNotes}
            setStopTimerNotes={setStopTimerNotes}
            clients={clients}
            projects={projects}
            users={users}
            updateTaskStatusMutation={updateTaskStatusMutation}
            setShowNewTaskDialog={setShowNewTaskDialog}
          />
        );

      case 'projects':
        return (
          <div className="space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Project Management</h2>
                <p className="text-gray-600">Organize work by projects with tasks underneath</p>
              </div>
              <div className="flex items-center gap-3">
                {/* Sort Dropdown */}
                <select
                  className="px-3 py-2 border border-gray-300 rounded-md text-sm"
                  value={projectSortBy}
                  onChange={(e) => setProjectSortBy(e.target.value)}
                >
                  <option value="name">Sort by Name</option>
                  <option value="status">Sort by Status</option>
                  <option value="date">Sort by Start Date</option>
                  <option value="client">Sort by Client</option>
                </select>

                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                  <Input
                    placeholder="Search projects..."
                    className="pl-9 w-64"
                    value={projectSearchQuery}
                    onChange={(e) => setProjectSearchQuery(e.target.value)}
                  />
                </div>

                <select
                  className="px-3 py-2 border border-gray-300 rounded-md text-sm"
                  value={projectFilterStatus}
                  onChange={(e) => setProjectFilterStatus(e.target.value)}
                >
                  <option value="all">All Projects</option>
                  <option value="not_started">Not Started</option>
                  <option value="in_progress">In Progress</option>
                  <option value="on_hold">On Hold</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>

                <select
                  className="px-3 py-2 border border-gray-300 rounded-md text-sm"
                  value={projectFilterClient}
                  onChange={(e) => setProjectFilterClient(e.target.value)}
                >
                  <option value="all">All Clients</option>
                  {clients?.map((client: any) => (
                    <option key={client.id} value={client.id.toString()}>
                      {client.name || client.business_name}
                    </option>
                  ))}
                </select>

                <Button variant="outline">
                  <Download className="w-4 h-4 mr-2" />
                  Export
                </Button>

                {/* Templates Button */}
                <Button
                  variant="outline"
                  onClick={() => setShowTemplatesList(true)}
                  data-testid="button-templates"
                >
                  <Folder className="w-4 h-4 mr-2" />
                  Templates
                </Button>

                {/* Resource Allocation Button */}
                <Button
                  variant="outline"
                  onClick={() => setShowResourceView(true)}
                  data-testid="button-resources"
                >
                  <Users className="w-4 h-4 mr-2" />
                  Resources
                </Button>

                <Button onClick={() => setShowCreateProjectDialog(true)}>
                  <Plus className="w-4 h-4 mr-2" />
                  New Project
                </Button>
              </div>
            </div>

            {/* Status Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Not Started</p>
                      <p className="text-3xl font-bold text-red-600">
                        {projects.filter((p: any) => p.status === 'not_started').length}
                      </p>
                    </div>
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                      <AlertCircle className="w-6 h-6 text-red-600" />
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">In Progress</p>
                      <p className="text-3xl font-bold text-blue-600">
                        {projects.filter((p: any) => p.status === 'in_progress').length}
                      </p>
                    </div>
                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                      <Clock className="w-6 h-6 text-blue-600" />
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Completed</p>
                      <p className="text-3xl font-bold text-green-600">
                        {projects.filter((p: any) => p.status === 'completed').length}
                      </p>
                    </div>
                    <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                      <CheckCircle className="w-6 h-6 text-green-600" />
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* All Projects Section */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle>All Projects</CardTitle>
                    <CardDescription>
                      Projects organized by client with status indicators
                      {(() => {
                        const filteredCount = projects.filter((p: any) => {
                          if (projectSearchQuery) {
                            const query = projectSearchQuery.toLowerCase();
                            if (!p.name?.toLowerCase().includes(query) &&
                                !p.description?.toLowerCase().includes(query) &&
                                !(p.clientName || clients?.find((c: any) => c.id === (p.clientId || p.client_id))?.name || '').toLowerCase().includes(query)) {
                              return false;
                            }
                          }
                          if (projectFilterStatus !== 'all' && p.status !== projectFilterStatus) return false;
                          if (projectFilterClient !== 'all') {
                            const clientId = parseInt(projectFilterClient);
                            if ((p.clientId || p.client_id) !== clientId) return false;
                          }
                          return true;
                        }).length;
                        return filteredCount !== projects.length ? ` (Showing ${filteredCount} of ${projects.length})` : ` (${projects.length} total)`;
                      })()}
                    </CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                {projects.length > 0 ? (
                  <div className="space-y-4">
                    {/* Bulk Actions Toolbar */}
                    {selectedProjectIds.size > 0 && (
                      <div className="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center gap-4">
                          <span className="text-sm font-medium text-blue-900">
                            {selectedProjectIds.size} project{selectedProjectIds.size > 1 ? 's' : ''} selected
                          </span>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setSelectedProjectIds(new Set())}
                            data-testid="button-clear-selection"
                          >
                            Clear Selection
                          </Button>
                        </div>
                        <div className="flex items-center gap-2">
                          <select
                            className="h-9 px-3 rounded-md border border-gray-300 text-sm"
                            onChange={(e) => {
                              if (e.target.value) {
                                const newStatus = e.target.value;
                                bulkUpdateProjectsMutation.mutate({
                                  projectIds: Array.from(selectedProjectIds),
                                  status: newStatus
                                });
                                e.target.value = '';
                              }
                            }}
                            disabled={bulkUpdateProjectsMutation.isPending}
                            data-testid="select-bulk-status"
                          >
                            <option value="">Change Status...</option>
                            <option value="not_started">Not Started</option>
                            <option value="in_progress">In Progress</option>
                            <option value="on_hold">On Hold</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                          </select>
                          <Button
                            variant="destructive"
                            size="sm"
                            onClick={() => {
                              if (confirm(`Are you sure you want to delete ${selectedProjectIds.size} project(s)? This action cannot be undone.`)) {
                                bulkDeleteProjectsMutation.mutate(Array.from(selectedProjectIds));
                              }
                            }}
                            disabled={bulkDeleteProjectsMutation.isPending}
                            data-testid="button-bulk-delete"
                          >
                            <Trash2 className="w-4 h-4 mr-2" />
                            {bulkDeleteProjectsMutation.isPending ? 'Deleting...' : 'Delete'}
                          </Button>
                        </div>
                      </div>
                    )}


                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead className="w-12">
                            <input
                              type="checkbox"
                              checked={(() => {
                                const filteredProjects = projects.filter((p: any) => {
                                  if (projectSearchQuery) {
                                    const query = projectSearchQuery.toLowerCase();
                                    if (!p.name?.toLowerCase().includes(query) &&
                                        !p.description?.toLowerCase().includes(query) &&
                                        !(p.clientName || clients?.find((c: any) => c.id === (p.clientId || p.client_id))?.name || '').toLowerCase().includes(query)) {
                                      return false;
                                    }
                                  }
                                  if (projectFilterStatus !== 'all' && p.status !== projectFilterStatus) return false;
                                  if (projectFilterClient !== 'all') {
                                    const clientId = parseInt(projectFilterClient);
                                    if ((p.clientId || p.client_id) !== clientId) return false;
                                  }
                                  return true;
                                });
                                return filteredProjects.length > 0 && filteredProjects.every((p: any) => selectedProjectIds.has(p.id));
                              })()}
                              onChange={(e) => {
                                const filteredProjects = projects.filter((p: any) => {
                                  if (projectSearchQuery) {
                                    const query = projectSearchQuery.toLowerCase();
                                    if (!p.name?.toLowerCase().includes(query) &&
                                        !p.description?.toLowerCase().includes(query) &&
                                        !(p.clientName || clients?.find((c: any) => c.id === (p.clientId || p.client_id))?.name || '').toLowerCase().includes(query)) {
                                      return false;
                                    }
                                  }
                                  if (projectFilterStatus !== 'all' && p.status !== projectFilterStatus) return false;
                                  if (projectFilterClient !== 'all') {
                                    const clientId = parseInt(projectFilterClient);
                                    if ((p.clientId || p.client_id) !== clientId) return false;
                                  }
                                  return true;
                                });
                                if (e.target.checked) {
                                  const newSelected = new Set(selectedProjectIds);
                                  filteredProjects.forEach((p: any) => newSelected.add(p.id));
                                  setSelectedProjectIds(newSelected);
                                } else {
                                  const newSelected = new Set(selectedProjectIds);
                                  filteredProjects.forEach((p: any) => newSelected.delete(p.id));
                                  setSelectedProjectIds(newSelected);
                                }
                              }}
                              className="cursor-pointer"
                              data-testid="checkbox-select-all-projects"
                            />
                          </TableHead>
                          <TableHead className="cursor-pointer" onClick={() => setProjectSortBy(projectSortBy === 'name' ? 'name_desc' : 'name')}>
                            Project Name
                            {projectSortBy === 'name' && ' ‚Üë'}
                            {projectSortBy === 'name_desc' && ' ‚Üì'}
                          </TableHead>
                          <TableHead className="cursor-pointer" onClick={() => setProjectSortBy(projectSortBy === 'client' ? 'client_desc' : 'client')}>
                            Client
                            {projectSortBy === 'client' && ' ‚Üë'}
                            {projectSortBy === 'client_desc' && ' ‚Üì'}
                          </TableHead>
                          <TableHead className="cursor-pointer" onClick={() => setProjectSortBy(projectSortBy === 'status' ? 'status_desc' : 'status')}>
                            Status
                            {projectSortBy === 'status' && ' ‚Üë'}
                            {projectSortBy === 'status_desc' && ' ‚Üì'}
                          </TableHead>
                          <TableHead className="cursor-pointer" onClick={() => setProjectSortBy(projectSortBy === 'date' ? 'date_desc' : 'date')}>
                            Start Date
                            {projectSortBy === 'date' && ' ‚Üë'}
                            {projectSortBy === 'date_desc' && ' ‚Üì'}
                          </TableHead>
                          <TableHead>End Date</TableHead>
                          <TableHead>Budget</TableHead>
                          <TableHead>Actions</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {(() => {
                          // Apply filters and sorting
                          let filteredProjects = [...projects];
                          
                          // Filter by search query
                          if (projectSearchQuery) {
                            const query = projectSearchQuery.toLowerCase();
                            filteredProjects = filteredProjects.filter((p: any) => 
                              p.name?.toLowerCase().includes(query) ||
                              p.description?.toLowerCase().includes(query) ||
                              (p.clientName || clients?.find((c: any) => c.id === (p.clientId || p.client_id))?.name || '').toLowerCase().includes(query)
                            );
                          }
                          
                          // Filter by status
                          if (projectFilterStatus !== 'all') {
                            filteredProjects = filteredProjects.filter((p: any) => p.status === projectFilterStatus);
                          }
                          
                          // Filter by client
                          if (projectFilterClient !== 'all') {
                            const clientId = parseInt(projectFilterClient);
                            filteredProjects = filteredProjects.filter((p: any) => 
                              (p.clientId || p.client_id) === clientId
                            );
                          }
                          
                          // Sort projects
                          filteredProjects.sort((a: any, b: any) => {
                            let result = 0;
                            const sortField = projectSortBy.replace('_desc', '');
                            const isDesc = projectSortBy.endsWith('_desc');
                            
                            switch (sortField) {
                              case 'name':
                                result = (a.name || '').localeCompare(b.name || '');
                                break;
                              case 'status':
                                result = (a.status || '').localeCompare(b.status || '');
                                break;
                              case 'date':
                                const aDate = a.startDate || a.start_date || '';
                                const bDate = b.startDate || b.start_date || '';
                                if (!aDate && !bDate) result = 0;
                                else if (!aDate) result = 1;
                                else if (!bDate) result = -1;
                                else result = aDate.localeCompare(bDate);
                                break;
                              case 'client':
                                const aClient = a.clientName || clients?.find((c: any) => c.id === (a.clientId || a.client_id))?.name || '';
                                const bClient = b.clientName || clients?.find((c: any) => c.id === (b.clientId || b.client_id))?.name || '';
                                result = aClient.localeCompare(bClient);
                                break;
                              default:
                                result = 0;
                            }
                            
                            return isDesc ? -result : result;
                          });
                          
                          return filteredProjects.map((project: any) => {
                            // Use clientName from API response, or fallback to clients lookup
                            const clientId = project.clientId || project.client_id;
                            const clientName = project.clientName || clients?.find((c: any) => c.id === clientId)?.name || clients?.find((c: any) => c.id === clientId)?.business_name || 'Unknown Client';
                            const isSelected = selectedProjectIds.has(project.id);
                            return (
                            <TableRow key={project.id} className={`transition-colors ${isSelected ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                              <TableCell onClick={(e) => e.stopPropagation()}>
                                <input
                                  type="checkbox"
                                  checked={isSelected}
                                  onChange={(e) => {
                                    const newSelected = new Set(selectedProjectIds);
                                    if (e.target.checked) {
                                      newSelected.add(project.id);
                                    } else {
                                      newSelected.delete(project.id);
                                    }
                                    setSelectedProjectIds(newSelected);
                                  }}
                                  className="cursor-pointer"
                                  data-testid={`checkbox-project-${project.id}`}
                                />
                              </TableCell>
                              <TableCell className="font-medium cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>{project.name}</TableCell>
                              <TableCell className="cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>{clientName}</TableCell>
                              <TableCell className="cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>
                                <Badge variant={
                                  project.status === 'completed' ? 'default' :
                                    project.status === 'in_progress' ? 'secondary' :
                                      project.status === 'not_started' ? 'outline' : 'outline'
                                }>
                                  {project.status?.replace('_', ' ').replace(/\b\w/g, (l: string) => l.toUpperCase()) || 'Not Started'}
                                </Badge>
                              </TableCell>
                              <TableCell className="cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>
                                {(() => {
                                  const date = project.startDate || project.start_date;
                                  if (!date) return '-';
                                  // Format as YYYY-MM-DD to avoid timezone issues
                                  if (typeof date === 'string') {
                                    return date.split('T')[0];
                                  }
                                  const d = new Date(date);
                                  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                                })()}
                              </TableCell>
                              <TableCell className="cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>
                                {(() => {
                                  const date = project.endDate || project.end_date;
                                  if (!date) return '-';
                                  // Format as YYYY-MM-DD to avoid timezone issues
                                  if (typeof date === 'string') {
                                    return date.split('T')[0];
                                  }
                                  const d = new Date(date);
                                  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                                })()}
                              </TableCell>
                              <TableCell className="cursor-pointer" onClick={() => { setSelectedProjectForDetails(project); setShowProjectDetailsDialog(true); }}>{(project.budgetAmount || project.budget_amount) ? `$${Number(project.budgetAmount || project.budget_amount).toLocaleString()}` : '-'}</TableCell>
                              <TableCell onClick={(e) => e.stopPropagation()}>
                                <div className="flex gap-2">
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => {
                                      setSelectedProjectForDetails(project);
                                      setShowProjectDetailsDialog(true);
                                    }}
                                  >
                                    Edit
                                  </Button>
                                </div>
                              </TableCell>
                            </TableRow>
                            );
                          });
                        })()}
                      </TableBody>
                    </Table>

                  </div>
                ) : (
                  <div className="text-center py-16">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                      <Briefcase className="w-8 h-8 text-gray-400" />
                    </div>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No projects found</h3>
                    <p className="text-gray-500 mb-6">Get started by creating your first project</p>
                    <Button onClick={() => setShowCreateProjectDialog(true)}>
                      <Plus className="w-4 h-4 mr-2" />
                      Create Project
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Project Details Dialog */}

            <ProjectModal
              project={selectedProjectForDetails}
              open={showProjectDetailsDialog}
              onClose={() => setShowProjectDetailsDialog(false)}
              clients={clients}
            />

            {/* Create Project Dialog */}
            <Dialog open={showCreateProjectDialog} onOpenChange={setShowCreateProjectDialog}>
              <DialogContent className="max-w-2xl">
                <DialogHeader>
                  <DialogTitle>Create New Project</DialogTitle>
                  <DialogDescription>
                    Create a new project for your practice management
                  </DialogDescription>
                </DialogHeader>
                <form
                  onSubmit={(e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target as HTMLFormElement);
                    if (!createProjectClientId) {
                      toast({
                        title: "Error",
                        description: "Client is required",
                        variant: "destructive",
                      });
                      return;
                    }
                    const projectData = {
                      name: formData.get('name') as string,
                      description: formData.get('description') as string || undefined,
                      clientId: parseInt(createProjectClientId),
                      startDate: formData.get('startDate') as string || undefined,
                      endDate: formData.get('endDate') as string || undefined,
                      budgetAmount: formData.get('budgetAmount') ? parseFloat(formData.get('budgetAmount') as string) : undefined,
                    };
                    if (!projectData.name?.trim()) {
                      toast({
                        title: "Error",
                        description: "Project name is required",
                        variant: "destructive",
                      });
                      return;
                    }
                    createProjectMutation.mutate(projectData);
                  }}
                  className="space-y-4"
                >
                  <div>
                    <Label htmlFor="project-name">Project Name *</Label>
                    <Input
                      id="project-name"
                      name="name"
                      placeholder="Enter project name"
                      required
                    />
                  </div>

                  <div>
                    <Label htmlFor="project-description">Description</Label>
                    <Textarea
                      id="project-description"
                      name="description"
                      placeholder="Enter project description"
                      rows={3}
                    />
                  </div>

                  <div>
                    <Label htmlFor="project-client">Client *</Label>
                    <Select value={createProjectClientId} onValueChange={setCreateProjectClientId}>
                      <SelectTrigger>
                        <SelectValue placeholder="Select a client" />
                      </SelectTrigger>
                      <SelectContent>
                        {safeArray(clients).map((client: any) => (
                          <SelectItem key={client.id} value={client.id.toString()}>
                            {client.name || client.business_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="project-start-date">Start Date</Label>
                      <Input
                        id="project-start-date"
                        name="startDate"
                        type="date"
                      />
                    </div>
                    <div>
                      <Label htmlFor="project-end-date">End Date</Label>
                      <Input
                        id="project-end-date"
                        name="endDate"
                        type="date"
                      />
                    </div>
                  </div>

                  <div>
                    <Label htmlFor="project-budget">Budget Amount</Label>
                    <Input
                      id="project-budget"
                      name="budgetAmount"
                      type="number"
                      step="0.01"
                      min="0"
                      placeholder="0.00"
                    />
                  </div>

                  <DialogFooter>
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => setShowCreateProjectDialog(false)}
                      disabled={createProjectMutation.isPending}
                    >
                      Cancel
                    </Button>
                    <Button
                      type="submit"
                      disabled={createProjectMutation.isPending}
                    >
                      {createProjectMutation.isPending ? "Creating..." : "Create Project"}
                    </Button>
                  </DialogFooter>
                </form>
              </DialogContent>
            </Dialog>
          </div>
        );

      case 'calendar':
        return <CalendarPage />;


      case 'time-expenses':
        return <TimeExpensesView />;

      case 'billing':
        // Calculate real billing metrics
        const invoicesList = Array.isArray(invoices) ? invoices : [];
        const timeEntriesList = Array.isArray(timeEntries) ? timeEntries : [];

        const outstandingReceivables = invoicesList
          .filter((inv: any) => inv.status === 'sent' || inv.status === 'overdue')
          .reduce((sum: number, inv: any) => sum + parseFloat(inv.totalAmount || '0'), 0);

        const unbilledTimeValue = timeEntriesList
          .filter((entry: any) => !entry.billedAt && entry.billableAmount)
          .reduce((sum: number, entry: any) => sum + parseFloat(entry.billableAmount || '0'), 0);

        const totalBilledHours = timeEntriesList
          .filter((entry: any) => entry.billedAt)
          .reduce((sum: number, entry: any) => sum + (parseFloat(entry.duration || '0') / 60), 0);

        const totalTrackedHours = timeEntriesList
          .reduce((sum: number, entry: any) => sum + (parseFloat(entry.duration || '0') / 60), 0);

        const realizationRate = totalTrackedHours > 0
          ? Math.round((totalBilledHours / totalTrackedHours) * 100)
          : 0;

        return (
          <div className="space-y-6">
            {/* Billing Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Smart Billing & Payments</h2>
                <p className="text-gray-600">Automate billing workflows with time tracking, invoice management, and payment processing</p>
              </div>
              <div className="flex items-center gap-3">
                <Badge variant="secondary" className="bg-green-100 text-green-700">
                  <DollarSign className="w-3 h-3 mr-1" />
                  Revenue Tracking Active
                </Badge>
                <Button onClick={() => setShowRecordPaymentDialog(true)} variant="outline">
                  <Receipt className="w-4 h-4 mr-2" />
                  Record Payment
                </Button>
                <Button onClick={() => setShowNewInvoiceDialog(true)}>
                  <Plus className="w-4 h-4 mr-2" />
                  Create Invoice
                </Button>
              </div>
            </div>

            {/* Key Metrics */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Outstanding Receivables</CardTitle>
                  <DollarSign className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">${outstandingReceivables.toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">{invoicesList.filter((inv: any) => inv.status === 'sent' || inv.status === 'overdue').length} unpaid invoices</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">WIP Value</CardTitle>
                  <Clock className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">${unbilledTimeValue.toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">Unbilled time entries</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Realization Rate</CardTitle>
                  <TrendingUp className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{realizationRate}%</div>
                  <p className="text-xs text-muted-foreground">Time to billing ratio</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Total Invoiced</CardTitle>
                  <CalendarDays className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">${invoicesList.reduce((sum: number, inv: any) => sum + parseFloat(inv.totalAmount || '0'), 0).toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">{invoicesList.length} total invoices</p>
                </CardContent>
              </Card>
            </div>

            {/* Main Billing Interface */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Time Tracking Panel */}
              <Card className="lg:col-span-1">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Timer className="w-5 h-5 text-blue-500" />
                    Time Tracking
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  {/* Active Timer */}
                  <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                        <span className="text-sm font-medium">Currently Tracking</span>
                      </div>
                      <span className="text-lg font-mono">02:45:32</span>
                    </div>
                    <p className="text-sm text-blue-700 font-medium">ABC Corp - Tax Return Review</p>
                    <p className="text-xs text-blue-600">Started 2:45 PM</p>
                    <div className="flex gap-2 mt-3">
                      <Button size="sm" variant="outline" className="h-7">
                        <Pause className="w-3 h-3 mr-1" />
                        Pause
                      </Button>
                      <Button size="sm" variant="outline" className="h-7">
                        <Square className="w-3 h-3 mr-1" />
                        Stop
                      </Button>
                    </div>
                  </div>

                  {/* Recent Time Entries */}
                  <div>
                    <h4 className="font-medium mb-3">Recent Entries</h4>
                    {timeEntriesList.length === 0 ? (
                      <div className="text-center py-4 text-gray-500">
                        <Clock className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                        <p className="text-sm">No time entries yet</p>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {timeEntriesList.slice(0, 3).map((entry: any, index: number) => {
                          const entryClient = safeArray(clients).find((c: any) => c.id === entry.clientId);
                          const hours = entry.duration ? (parseFloat(entry.duration || '0') / 60).toFixed(2) : 0;
                          const amount = entry.billableAmount || 0;
                          return (
                            <div key={index} className="p-3 border rounded-lg hover:bg-gray-50">
                              <div className="flex justify-between items-start">
                                <div>
                                  <p className="font-medium text-sm">{entryClient?.name || 'Unknown'}</p>
                                  <p className="text-xs text-gray-600">{entry.description || 'No description'}</p>
                                </div>
                                <div className="text-right">
                                  <p className="font-medium text-sm">${amount.toFixed(2)}</p>
                                  <p className="text-xs text-gray-600">{hours}h @ ${entry.billableRate || 0}/h</p>
                                </div>
                              </div>
                              <div className="flex gap-1 mt-2">
                                <Button variant="ghost" size="sm" className="h-6 text-xs">Edit</Button>
                                <Button variant="ghost" size="sm" className="h-6 text-xs" disabled={!!entry.billedAt}>
                                  {entry.billedAt ? 'Billed' : 'Bill'}
                                </Button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>

                  <Button className="w-full" variant="outline">
                    <Plus className="w-4 h-4 mr-2" />
                    New Time Entry
                  </Button>
                </CardContent>
              </Card>

              {/* Invoice Management */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle className="flex items-center gap-2">
                      <FileText className="w-5 h-5 text-green-500" />
                      Invoice Management
                    </CardTitle>
                    <div className="flex items-center gap-2">
                      <select className="px-3 py-1 border border-gray-300 rounded-md text-sm">
                        <option value="all">All Invoices</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                      </select>
                      <Button variant="outline" size="sm">
                        <Download className="w-4 h-4 mr-2" />
                        Export
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  {invoicesList.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <FileText className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                      <p className="font-medium">No invoices yet</p>
                      <p className="text-sm mt-1">Create your first invoice to start billing clients</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {invoicesList.map((invoice: any, index: number) => {
                        const invoiceClient = safeArray(clients).find((c: any) => c.id === invoice.clientId);
                        return (
                          <div key={index} className="p-4 border rounded-lg hover:bg-gray-50">
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3">
                                  <span className="font-mono text-sm font-medium">{invoice.invoiceNumber || `INV-${invoice.id}`}</span>
                                  <Badge
                                    variant={
                                      invoice.status === 'paid' ? 'default' :
                                        invoice.status === 'sent' ? 'secondary' :
                                          invoice.status === 'overdue' ? 'destructive' : 'outline'
                                    }
                                    className="text-xs"
                                  >
                                    {invoice.status.toUpperCase()}
                                  </Badge>
                                </div>
                                <p className="font-medium mt-1">{invoiceClient?.name || 'Unknown Client'}</p>
                                <p className="text-sm text-gray-600">Due: {invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : 'Not set'}</p>
                              </div>
                              <div className="text-right">
                                <p className="text-lg font-bold">${invoice.totalAmount?.toLocaleString() || '0'}</p>
                                <div className="flex gap-1 mt-2">
                                  <Button variant="ghost" size="sm" className="h-7 text-xs">
                                    <Eye className="w-3 h-3 mr-1" />
                                    View
                                  </Button>
                                  <Button variant="ghost" size="sm" className="h-7 text-xs">
                                    <Send className="w-3 h-3 mr-1" />
                                    Send
                                  </Button>
                                  {invoice.status !== 'paid' && (
                                    <Button
                                      variant="ghost"
                                      size="sm"
                                      className="h-7 text-xs text-green-600"
                                      onClick={() => {
                                        setSelectedInvoiceForPayment(invoice);
                                        setShowPaymentDialog(true);
                                      }}
                                      data-testid="button-record-payment"
                                    >
                                      <DollarSign className="w-3 h-3 mr-1" />
                                      Pay
                                    </Button>
                                  )}
                                  <Button variant="ghost" size="sm" className="h-7 text-xs">
                                    <MoreHorizontal className="w-3 h-3" />
                                  </Button>
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  <div className="mt-4 pt-4 border-t">
                    <Button className="w-full" variant="outline">
                      <Plus className="w-4 h-4 mr-2" />
                      Create New Invoice
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>


            {/* Recurring Invoice Templates */}
            <Card className="lg:col-span-2">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2">
                    <RefreshCw className="w-5 h-5 text-purple-500" />
                    Recurring Invoice Templates
                  </CardTitle>
                  <div className="flex items-center gap-2">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => generateRecurringInvoicesMutation.mutate()}
                      disabled={generateRecurringInvoicesMutation.isPending}
                      data-testid="button-generate-now"
                    >
                      <Zap className="w-4 h-4 mr-2" />
                      Generate Now
                    </Button>
                    <Button
                      size="sm"
                      onClick={() => {
                        setEditingRecurringInvoice(null);
                        setShowRecurringInvoiceDialog(true);
                      }}
                      data-testid="button-create-template"
                    >
                      <Plus className="w-4 h-4 mr-2" />
                      Create Template
                    </Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                {isLoadingRecurring ? (
                  <div className="flex items-center justify-center py-12">
                    <div className="text-center">
                      <RefreshCw className="w-8 h-8 text-gray-400 animate-spin mx-auto mb-2" />
                      <p className="text-sm text-gray-500">Loading templates...</p>
                    </div>
                  </div>
                ) : !recurringInvoices || recurringInvoices.length === 0 ? (
                  <div className="text-center py-12">
                    <RefreshCw className="w-12 h-12 text-gray-300 mx-auto mb-4" />
                    <h3 className="text-lg font-semibold mb-2">No Recurring Templates</h3>
                    <p className="text-gray-600 mb-4">Create automated invoice templates for recurring billing</p>
                    <Button
                      onClick={() => {
                        setEditingRecurringInvoice(null);
                        setShowRecurringInvoiceDialog(true);
                      }}
                      data-testid="button-create-first-template"
                    >
                      <Plus className="w-4 h-4 mr-2" />
                      Create Your First Template
                    </Button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {recurringInvoices.map((template: any) => {
                      const frequencyLabels: Record<string, string> = {
                        daily: "Daily",
                        weekly: "Weekly",
                        biweekly: "Bi-weekly",
                        monthly: "Monthly",
                        quarterly: "Quarterly",
                        semi_annual: "Semi-Annual",
                        annual: "Annual"
                      };

                      return (
                        <div
                          key={template.id}
                          className="p-4 border rounded-lg hover:shadow-md transition-shadow"
                          data-testid={`recurring-template-${template.id}`}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-2">
                                <h4 className="font-semibold text-lg">{template.templateName}</h4>
                                <Badge variant={template.isActive ? "default" : "secondary"}>
                                  {template.isActive ? "Active" : "Paused"}
                                </Badge>
                                {template.autoSend && (
                                  <Badge variant="outline" className="text-xs">
                                    <Zap className="w-3 h-3 mr-1" />
                                    Auto-Send
                                  </Badge>
                                )}
                              </div>

                              <div className="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                <div>
                                  <p className="flex items-center gap-2">
                                    <Building className="w-4 h-4" />
                                    {template.clientName || `Client ID: ${template.clientId}`}
                                  </p>
                                  <p className="flex items-center gap-2 mt-1">
                                    <DollarSign className="w-4 h-4" />
                                    ${Number(template.amount).toFixed(2)}
                                  </p>
                                </div>
                                <div>
                                  <p className="flex items-center gap-2">
                                    <Clock className="w-4 h-4" />
                                    {frequencyLabels[template.frequency] || template.frequency}
                                  </p>
                                  <p className="flex items-center gap-2 mt-1">
                                    <CalendarDays className="w-4 h-4" />
                                    Next: {template.nextInvoiceDate ? format(new Date(template.nextInvoiceDate), 'MMM dd, yyyy') : 'N/A'}
                                  </p>
                                </div>
                              </div>

                              {template.description && (
                                <p className="text-sm text-gray-500 mt-2 line-clamp-2">
                                  {template.description}
                                </p>
                              )}
                            </div>

                            <div className="flex items-center gap-2 ml-4">
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => {
                                  setEditingRecurringInvoice(template);
                                  setShowRecurringInvoiceDialog(true);
                                }}
                                data-testid={`button-edit-${template.id}`}
                              >
                                <Edit3 className="w-4 h-4" />
                              </Button>
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => toggleRecurringStatusMutation.mutate({
                                  id: template.id,
                                  isActive: !template.isActive
                                })}
                                disabled={toggleRecurringStatusMutation.isPending}
                                data-testid={`button-toggle-${template.id}`}
                              >
                                {template.isActive ? (
                                  <Pause className="w-4 h-4 text-orange-500" />
                                ) : (
                                  <Play className="w-4 h-4 text-green-500" />
                                )}
                              </Button>
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => {
                                  if (confirm('Are you sure you want to delete this recurring invoice template?')) {
                                    deleteRecurringInvoiceMutation.mutate(template.id);
                                  }
                                }}
                                disabled={deleteRecurringInvoiceMutation.isPending}
                                data-testid={`button-delete-${template.id}`}
                              >
                                <Trash2 className="w-4 h-4 text-red-500" />
                              </Button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </CardContent>
            </Card>
            {/* WIP & Realization Dashboard */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <BarChart3 className="w-5 h-5 text-purple-500" />
                    WIP Analysis
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {[
                      { client: 'ABC Corporation', wip: '$4,200', hours: '28h', lastBilled: '2 weeks ago' },
                      { client: 'XYZ Limited', wip: '$2,800', hours: '18h', lastBilled: '1 week ago' },
                      { client: 'Smith & Associates', wip: '$6,500', hours: '45h', lastBilled: '3 weeks ago' },
                      { client: 'Johnson Family', wip: '$1,200', hours: '8h', lastBilled: '1 week ago' }
                    ].map((item, index) => (
                      <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                          <p className="font-medium">{item.client}</p>
                          <p className="text-sm text-gray-600">{item.hours} ‚Ä¢ Last billed {item.lastBilled}</p>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-purple-600">{item.wip}</p>
                          <Button variant="ghost" size="sm" className="h-6 text-xs">
                            <FileText className="w-3 h-3 mr-1" />
                            Bill Now
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <CreditCard className="w-5 h-5 text-blue-500" />
                    Payment Management
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {/* Payment Status */}
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div className="p-3 bg-green-50 rounded-lg">
                        <p className="text-2xl font-bold text-green-600">15</p>
                        <p className="text-xs text-green-700">Paid On Time</p>
                      </div>
                      <div className="p-3 bg-yellow-50 rounded-lg">
                        <p className="text-2xl font-bold text-yellow-600">3</p>
                        <p className="text-xs text-yellow-700">Pending</p>
                      </div>
                      <div className="p-3 bg-red-50 rounded-lg">
                        <p className="text-2xl font-bold text-red-600">2</p>
                        <p className="text-xs text-red-700">Overdue</p>
                      </div>
                    </div>

                    {/* Payment Methods */}
                    <div>
                      <h4 className="font-medium mb-3">Payment Options</h4>
                      <div className="space-y-2">
                        <div className="flex items-center justify-between p-2 border rounded">
                          <div className="flex items-center gap-2">
                            <CreditCard className="w-4 h-4 text-blue-500" />
                            <span className="text-sm">Credit Card</span>
                          </div>
                          <Badge variant="secondary">Active</Badge>
                        </div>
                        <div className="flex items-center justify-between p-2 border rounded">
                          <div className="flex items-center gap-2">
                            <Building className="w-4 h-4 text-green-500" />
                            <span className="text-sm">Direct Debit</span>
                          </div>
                          <Badge variant="secondary">Active</Badge>
                        </div>
                        <div className="flex items-center justify-between p-2 border rounded">
                          <div className="flex items-center gap-2">
                            <Smartphone className="w-4 h-4 text-purple-500" />
                            <span className="text-sm">Digital Wallet</span>
                          </div>
                          <Badge variant="outline">Configure</Badge>
                        </div>
                      </div>
                    </div>

                    {/* Auto-Payment Setup */}
                    <div className="p-3 bg-blue-50 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <Zap className="w-4 h-4 text-blue-500" />
                        <span className="text-sm font-medium">Auto-Payment</span>
                      </div>
                      <p className="text-xs text-blue-700 mb-2">Enable automatic payment collection for recurring clients</p>
                      <Button size="sm" variant="outline" className="w-full">
                        Setup Auto-Payment
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Aged Receivables */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Clock className="w-5 h-5 text-orange-500" />
                  Aged Receivables Dashboard
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="text-center p-4 border rounded-lg">
                    <p className="text-2xl font-bold text-green-600">$12,500</p>
                    <p className="text-sm text-gray-600">Current (0-30 days)</p>
                  </div>
                  <div className="text-center p-4 border rounded-lg">
                    <p className="text-2xl font-bold text-yellow-600">$8,200</p>
                    <p className="text-sm text-gray-600">31-60 days</p>
                  </div>
                  <div className="text-center p-4 border rounded-lg">
                    <p className="text-2xl font-bold text-orange-600">$3,100</p>
                    <p className="text-sm text-gray-600">61-90 days</p>
                  </div>
                  <div className="text-center p-4 border rounded-lg">
                    <p className="text-2xl font-bold text-red-600">$700</p>
                    <p className="text-sm text-gray-600">90+ days</p>
                  </div>
                </div>

                <div className="space-y-2">
                  <h4 className="font-medium">Outstanding Invoices</h4>
                  {[
                    { client: 'ABC Corp', amount: '$2,450', days: 45, status: 'follow-up' },
                    { client: 'XYZ Ltd', amount: '$1,800', days: 15, status: 'current' },
                    { client: 'Smith & Co', amount: '$3,200', days: 75, status: 'urgent' }
                  ].map((item, index) => (
                    <div key={index} className="flex items-center justify-between p-3 border rounded-lg">
                      <div>
                        <p className="font-medium">{item.client}</p>
                        <p className="text-sm text-gray-600">{item.days} days outstanding</p>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className="font-bold">{item.amount}</span>
                        <Badge
                          variant={
                            item.status === 'current' ? 'secondary' :
                              item.status === 'follow-up' ? 'default' : 'destructive'
                          }
                        >
                          {item.status}
                        </Badge>
                        <Button variant="outline" size="sm">
                          <Send className="w-3 h-3 mr-1" />
                          Remind
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>
        );

      case 'reports':
        // Access control - only managers/admin/owners can access reports
        // Check if user is authenticated and has proper role
        if (!user || !['super_admin', 'saas_owner', 'firm_admin', 'firm_owner', 'manager', 'admin', 'owner'].includes(user.role?.toLowerCase() || '')) {
          return (
            <div className="flex items-center justify-center h-96">
              <Card className="max-w-md">
                <CardContent className="p-8 text-center">
                  <AlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold mb-2">Access Restricted</h3>
                  <p className="text-gray-600">Reports are only accessible to Managers, Admins, and Owners.</p>
                </CardContent>
              </Card>
            </div>
          );
        }

        return (
          <div className="space-y-6" data-testid="content-reports">
            {/* Reports Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">Practice Reports & Analytics</h2>
                <p className="text-gray-600">Comprehensive insights into your practice performance</p>
              </div>
              <div className="flex gap-2">
                <Button variant="outline" size="sm">
                  <Download className="w-4 h-4 mr-2" />
                  Export All
                </Button>
                <Button variant="outline" size="sm">
                  <Calendar className="w-4 h-4 mr-2" />
                  Schedule
                </Button>
              </div>
            </div>

            {/* Report Navigation Tabs */}
            <Card>
              <CardHeader>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant={reportTab === 'firm-overview' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('firm-overview')}
                    className="text-xs"
                    data-testid="button-firm-overview-tab"
                  >
                    üè¢ Firm Overview
                  </Button>
                  <Button
                    variant={reportTab === 'project-status' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('project-status')}
                    className="text-xs"
                    data-testid="button-project-status-tab"
                  >
                    üìä Project Status
                  </Button>
                  <Button
                    variant={reportTab === 'task-management' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('task-management')}
                    className="text-xs"
                    data-testid="button-task-management-tab"
                  >
                    üìã Task Management
                  </Button>
                  <Button
                    variant={reportTab === 'upcoming-deadlines' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('upcoming-deadlines')}
                    className="text-xs"
                    data-testid="button-upcoming-deadlines-tab"
                  >
                    ‚è∞ Upcoming Deadlines
                  </Button>
                  <Button
                    variant={reportTab === 'overdue-items' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('overdue-items')}
                    className="text-xs"
                    data-testid="button-overdue-items-tab"
                  >
                    üî¥ Overdue Items
                  </Button>
                  <Button
                    variant={reportTab === 'individual-performance' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('individual-performance')}
                    className="text-xs"
                    data-testid="button-individual-performance-tab"
                  >
                    üë§ Individual Performance
                  </Button>
                  <Button
                    variant={reportTab === 'team-capacity' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('team-capacity')}
                    className="text-xs"
                    data-testid="button-team-capacity-tab"
                  >
                    üë• Team Capacity
                  </Button>
                  <Button
                    variant={reportTab === 'utilization' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('utilization')}
                    className="text-xs"
                    data-testid="button-utilization-tab"
                  >
                    üìä Utilization Report
                  </Button>
                  <Button
                    variant={reportTab === 'time-billing' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('time-billing')}
                    className="text-xs"
                    data-testid="button-time-billing-tab"
                  >
                    üí∞ Time & Billing Analytics
                  </Button>
                  <Button
                    variant={reportTab === 'workflow-efficiency' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('workflow-efficiency')}
                    className="text-xs"
                    data-testid="button-workflow-efficiency-tab"
                  >
                    ‚ö° Workflow Efficiency
                  </Button>
                  <Button
                    variant={reportTab === 'client-health' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('client-health')}
                    className="text-xs"
                    data-testid="button-client-health-tab"
                  >
                    ‚ù§Ô∏è Client Health
                  </Button>
                  <Button
                    variant={reportTab === 'client-retention' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('client-retention')}
                    className="text-xs"
                    data-testid="button-client-retention-tab"
                  >
                    üìà Client Retention
                  </Button>
                  <Button
                    variant={reportTab === 'compliance-calendar' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('compliance-calendar')}
                    className="text-xs"
                    data-testid="button-compliance-calendar-tab"
                  >
                    üìÖ Compliance Calendar
                  </Button>
                  <Button
                    variant={reportTab === 'service-delivery' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('service-delivery')}
                    className="text-xs"
                    data-testid="button-service-delivery-tab"
                  >
                    üéØ Service Delivery
                  </Button>
                  <Button
                    variant={reportTab === 'client-communication' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('client-communication')}
                    className="text-xs"
                    data-testid="button-client-communication-tab"
                  >
                    üí¨ Client Communications
                  </Button>
                  <Button
                    variant={reportTab === 'realization-rate' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('realization-rate')}
                    className="text-xs"
                    data-testid="button-realization-rate-tab"
                  >
                    üíØ Realization Rate
                  </Button>
                  <Button
                    variant={reportTab === 'writeoffs-adjustments' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('writeoffs-adjustments')}
                    className="text-xs"
                    data-testid="button-writeoffs-adjustments-tab"
                  >
                    ‚úÇÔ∏è Write-offs & Adjustments
                  </Button>
                  <Button
                    variant={reportTab === 'cash-flow-forecast' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('cash-flow-forecast')}
                    className="text-xs"
                    data-testid="button-cash-flow-forecast-tab"
                  >
                    üíµ Cash Flow Forecast
                  </Button>
                  <Button
                    variant={reportTab === 'budget-vs-actual' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('budget-vs-actual')}
                    className="text-xs"
                    data-testid="button-budget-vs-actual-tab"
                  >
                    üìä Budget vs Actual
                  </Button>
                  <Button
                    variant={reportTab === 'trend-analysis' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('trend-analysis')}
                    className="text-xs"
                    data-testid="button-trend-analysis-tab"
                  >
                    üìà Trend Analysis
                  </Button>
                  <Button
                    variant={reportTab === 'manage-subscriptions' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('manage-subscriptions')}
                    className="text-xs"
                    data-testid="button-manage-subscriptions-tab"
                  >
                    ‚öôÔ∏è Manage Subscriptions
                  </Button>
                  <Button
                    variant={reportTab === 'financial' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('financial')}
                    className="text-xs"
                  >
                    üí∞ Financial Performance
                  </Button>
                  <Button
                    variant={reportTab === 'ar-aging' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('ar-aging')}
                    className="text-xs"
                  >
                    ‚è∞ AR Aging
                  </Button>
                  <Button
                    variant={reportTab === 'time-billing' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('time-billing')}
                    className="text-xs"
                  >
                    ‚è±Ô∏è Time & Billing
                  </Button>
                  <Button
                    variant={reportTab === 'client-profitability' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('client-profitability')}
                    className="text-xs"
                  >
                    üìä Client Profitability
                  </Button>
                  <Button
                    variant={reportTab === 'revenue-by-service' ? "default" : "outline"}
                    size="sm"
                    onClick={() => setReportTab('revenue-by-service')}
                    className="text-xs"
                    data-testid="button-revenue-by-service-tab"
                  >
                    üìà Revenue by Service Type
                  </Button>
                </div>
              </CardHeader>
            </Card>

            {/* Report Content */}
            {/* Firm Overview Dashboard */}
            {reportTab === 'firm-overview' && (
              <div className="space-y-6">
                {/* Header with Export and Refresh */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Firm Overview Dashboard</CardTitle>
                        <CardDescription>Executive summary of your entire practice</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchFirmOverview()}
                          disabled={isLoadingFirmOverview}
                          data-testid="button-refresh-overview"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingFirmOverview ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!firmOverviewData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const today = new Date();
                            const dateRange: DateRange = {
                              startDate: new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0],
                              endDate: today.toISOString().split('T')[0]
                            };

                            const tables: TableData[] = [
                              {
                                title: "Financial Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Revenue MTD", `$${firmOverviewData.financial.revenueMTD.value.toLocaleString()}`, `${firmOverviewData.financial.revenueMTD.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(firmOverviewData.financial.revenueMTD.trend).toFixed(1)}%`],
                                  ["Revenue YTD", `$${firmOverviewData.financial.revenueYTD.value.toLocaleString()}`, `${firmOverviewData.financial.revenueYTD.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(firmOverviewData.financial.revenueYTD.trend).toFixed(1)}%`],
                                  ["Outstanding AR", `$${firmOverviewData.financial.outstandingAR.value.toLocaleString()}`, `${firmOverviewData.financial.outstandingAR.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(firmOverviewData.financial.outstandingAR.trend).toFixed(1)}%`],
                                  ["Profit Margin", `${firmOverviewData.financial.profitMargin.value.toFixed(1)}%`, `${firmOverviewData.financial.profitMargin.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(firmOverviewData.financial.profitMargin.trend).toFixed(1)}%`]
                                ]
                              },
                              {
                                title: "Client Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Total Clients", firmOverviewData.clients.total.value.toString(), `${firmOverviewData.clients.total.trend}%`],
                                  ["Active Clients", firmOverviewData.clients.active.value.toString(), `${firmOverviewData.clients.active.trend}%`],
                                  ["New This Month", firmOverviewData.clients.newThisMonth.value.toString(), `${firmOverviewData.clients.newThisMonth.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(firmOverviewData.clients.newThisMonth.trend).toFixed(1)}%`]
                                ]
                              },
                              {
                                title: "Project & Team Metrics",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Active Projects", firmOverviewData.projects.active.value.toString()],
                                  ["Completion Rate", `${firmOverviewData.projects.completionRate.value.toFixed(1)}%`],
                                  ["Active Staff", firmOverviewData.team.activeStaff.value.toString()],
                                  ["Avg Utilization", `${firmOverviewData.team.avgUtilization.value.toFixed(1)}%`]
                                ]
                              }
                            ];

                            await exportReportToPDF({
                              title: "Firm Overview Dashboard",
                              dateRange,
                              tables,
                              summary: [
                                { label: "Revenue YTD", value: `$${firmOverviewData.financial.revenueYTD.value.toLocaleString()}` },
                                { label: "Active Clients", value: firmOverviewData.clients.active.value.toString() },
                                { label: "Open Tasks", value: firmOverviewData.tasks.open.value.toString() }
                              ]
                            }, firmInfo, "Firm_Overview_Dashboard.pdf");

                            toast({
                              title: "Export Complete",
                              description: "PDF dashboard has been downloaded"
                            });
                          }}
                          disabled={isLoadingFirmOverview || !firmOverviewData}
                          data-testid="button-export-overview-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!firmOverviewData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm"
                            };

                            const today = new Date();
                            const dateRange: DateRange = {
                              startDate: new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0],
                              endDate: today.toISOString().split('T')[0]
                            };

                            const tables: TableData[] = [
                              {
                                title: "Financial Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Revenue MTD", firmOverviewData.financial.revenueMTD.value, firmOverviewData.financial.revenueMTD.trend],
                                  ["Revenue YTD", firmOverviewData.financial.revenueYTD.value, firmOverviewData.financial.revenueYTD.trend],
                                  ["Outstanding AR", firmOverviewData.financial.outstandingAR.value, firmOverviewData.financial.outstandingAR.trend],
                                  ["Profit Margin", firmOverviewData.financial.profitMargin.value, firmOverviewData.financial.profitMargin.trend]
                                ]
                              },
                              {
                                title: "Client Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Total Clients", firmOverviewData.clients.total.value, firmOverviewData.clients.total.trend],
                                  ["Active Clients", firmOverviewData.clients.active.value, firmOverviewData.clients.active.trend],
                                  ["New This Month", firmOverviewData.clients.newThisMonth.value, firmOverviewData.clients.newThisMonth.trend]
                                ]
                              },
                              {
                                title: "Project Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Active Projects", firmOverviewData.projects.active.value, firmOverviewData.projects.active.trend],
                                  ["Completion Rate", firmOverviewData.projects.completionRate.value, firmOverviewData.projects.completionRate.trend],
                                  ["On-Time Delivery", firmOverviewData.projects.onTimeDelivery.value, firmOverviewData.projects.onTimeDelivery.trend],
                                  ["Avg Days to Complete", firmOverviewData.projects.avgDaysToComplete.value, firmOverviewData.projects.avgDaysToComplete.trend]
                                ]
                              },
                              {
                                title: "Team Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Active Staff", firmOverviewData.team.activeStaff.value, firmOverviewData.team.activeStaff.trend],
                                  ["Avg Utilization", firmOverviewData.team.avgUtilization.value, firmOverviewData.team.avgUtilization.trend],
                                  ["Billable Hours MTD", firmOverviewData.team.billableHoursMTD.value, firmOverviewData.team.billableHoursMTD.trend]
                                ]
                              },
                              {
                                title: "Task Metrics",
                                headers: ["Metric", "Value", "Trend"],
                                rows: [
                                  ["Open Tasks", firmOverviewData.tasks.open.value, firmOverviewData.tasks.open.trend],
                                  ["Completed This Month", firmOverviewData.tasks.completedThisMonth.value, firmOverviewData.tasks.completedThisMonth.trend],
                                  ["Overdue Tasks", firmOverviewData.tasks.overdue.value, firmOverviewData.tasks.overdue.trend]
                                ]
                              }
                            ];

                            exportReportToExcel({
                              title: "Firm Overview Dashboard",
                              dateRange,
                              tables
                            }, firmInfo, "Firm_Overview_Dashboard.xlsx");

                            toast({
                              title: "Export Complete",
                              description: "Excel dashboard has been downloaded"
                            });
                          }}
                          disabled={isLoadingFirmOverview || !firmOverviewData}
                          data-testid="button-export-overview-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Error State */}
                {firmOverviewError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="pt-6">
                      <div className="flex items-center gap-2 text-red-600">
                        <AlertCircle className="w-5 h-5" />
                        <p>Failed to load firm overview data. Please try again.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Loading State */}
                {isLoadingFirmOverview && (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="flex items-center justify-center py-12">
                        <RefreshCw className="w-8 h-8 animate-spin text-gray-400" />
                        <p className="ml-3 text-gray-500">Loading firm overview...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Dashboard Content */}
                {firmOverviewData && !isLoadingFirmOverview && (
                  <>
                    {/* Financial Section */}
                    <div>
                      <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <DollarSign className="w-5 h-5 text-green-600" />
                        Financial Performance
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card className="border-l-4 border-l-blue-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Revenue MTD</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">${firmOverviewData.financial.revenueMTD.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            <p className={`text-sm mt-1 ${firmOverviewData.financial.revenueMTD.trend >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {firmOverviewData.financial.revenueMTD.trend >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(firmOverviewData.financial.revenueMTD.trend).toFixed(1)}% vs last month
                            </p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-green-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Revenue YTD</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">${firmOverviewData.financial.revenueYTD.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            <p className={`text-sm mt-1 ${firmOverviewData.financial.revenueYTD.trend >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {firmOverviewData.financial.revenueYTD.trend >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(firmOverviewData.financial.revenueYTD.trend).toFixed(1)}% vs last year
                            </p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-orange-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Outstanding AR</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">${firmOverviewData.financial.outstandingAR.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            <p className={`text-sm mt-1 ${firmOverviewData.financial.outstandingAR.trend <= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {firmOverviewData.financial.outstandingAR.trend >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(firmOverviewData.financial.outstandingAR.trend).toFixed(1)}% vs last month
                            </p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-purple-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Profit Margin</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.financial.profitMargin.value.toFixed(1)}%</div>
                            <p className={`text-sm mt-1 ${firmOverviewData.financial.profitMargin.trend >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {firmOverviewData.financial.profitMargin.trend >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(firmOverviewData.financial.profitMargin.trend).toFixed(1)}% vs last year
                            </p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Client Section */}
                    <div>
                      <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <Users className="w-5 h-5 text-blue-600" />
                        Client Metrics
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Card className="border-l-4 border-l-blue-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Total Clients</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.clients.total.value}</div>
                            <p className="text-sm text-gray-500 mt-1">All clients in system</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-green-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Active Clients</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.clients.active.value}</div>
                            <p className="text-sm text-gray-500 mt-1">With activity (90 days)</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-purple-500">
                          <CardHeader className="pb-3">
                            <CardDescription>New This Month</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.clients.newThisMonth.value}</div>
                            <p className={`text-sm mt-1 ${firmOverviewData.clients.newThisMonth.trend >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {firmOverviewData.clients.newThisMonth.trend >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(firmOverviewData.clients.newThisMonth.trend).toFixed(1)}% vs last month
                            </p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Project Section */}
                    <div>
                      <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <Briefcase className="w-5 h-5 text-indigo-600" />
                        Project Performance
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card className="border-l-4 border-l-blue-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Active Projects</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.projects.active.value}</div>
                            <p className="text-sm text-gray-500 mt-1">In progress</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-green-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Completion Rate</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.projects.completionRate.value.toFixed(1)}%</div>
                            <p className="text-sm text-gray-500 mt-1">Projects completed</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-purple-500">
                          <CardHeader className="pb-3">
                            <CardDescription>On-Time Delivery</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.projects.onTimeDelivery.value.toFixed(1)}%</div>
                            <p className="text-sm text-gray-500 mt-1">Delivered on schedule</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-orange-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Avg Days to Complete</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.projects.avgDaysToComplete.value.toFixed(0)}</div>
                            <p className="text-sm text-gray-500 mt-1">Average timeline</p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Team Section */}
                    <div>
                      <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <Users className="w-5 h-5 text-teal-600" />
                        Team Performance
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Card className="border-l-4 border-l-blue-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Active Staff</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.team.activeStaff.value}</div>
                            <p className="text-sm text-gray-500 mt-1">Team members</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-green-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Avg Utilization Rate</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.team.avgUtilization.value.toFixed(1)}%</div>
                            <p className="text-sm text-gray-500 mt-1">Billable vs total</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-purple-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Billable Hours MTD</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.team.billableHoursMTD.value.toFixed(1)}</div>
                            <p className="text-sm text-gray-500 mt-1">This month</p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Task Section */}
                    <div>
                      <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <CheckSquare className="w-5 h-5 text-pink-600" />
                        Task Metrics
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Card className="border-l-4 border-l-blue-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Open Tasks</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.tasks.open.value}</div>
                            <p className="text-sm text-gray-500 mt-1">Pending completion</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-green-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Completed This Month</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold">{firmOverviewData.tasks.completedThisMonth.value}</div>
                            <p className="text-sm text-gray-500 mt-1">Tasks finished</p>
                          </CardContent>
                        </Card>
                        <Card className="border-l-4 border-l-red-500">
                          <CardHeader className="pb-3">
                            <CardDescription>Overdue Tasks</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="text-2xl font-bold text-red-600">{firmOverviewData.tasks.overdue.value}</div>
                            <p className="text-sm text-gray-500 mt-1">Needs attention</p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Charts Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Revenue Trend Chart */}
                      <ReportLineChart
                        data={firmOverviewData.charts.revenueTrend}
                        xKey="month"
                        yKey="revenue"
                        title="Revenue Trend (Last 6 Months)"
                        colors={["#3b82f6"]}
                        height={300}
                      />

                      {/* Project Status Chart */}
                      <ReportPieChart
                        data={firmOverviewData.charts.projectStatus}
                        nameKey="status"
                        valueKey="count"
                        title="Project Status Distribution"
                        height={300}
                      />

                      {/* Team Utilization Chart */}
                      <div className="lg:col-span-2">
                        <ReportBarChart
                          data={firmOverviewData.charts.teamUtilization}
                          xKey="name"
                          yKey="utilization"
                          title="Team Utilization by Staff Member"
                          colors={["#10b981"]}
                          height={300}
                        />
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

            {/* Project Status Report */}
            {reportTab === 'project-status' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Project Status Report</CardTitle>
                        <CardDescription>Track project health, timeline, and budget performance</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Select value={projectStatusFilter} onValueChange={setProjectStatusFilter}>
                          <SelectTrigger className="w-40" data-testid="select-project-status-filter">
                            <SelectValue placeholder="Filter by status" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="all">All Projects</SelectItem>
                            <SelectItem value="active">Active</SelectItem>
                            <SelectItem value="on-track">On Track</SelectItem>
                            <SelectItem value="at-risk">At Risk</SelectItem>
                            <SelectItem value="behind">Behind</SelectItem>
                            <SelectItem value="completed">Completed</SelectItem>
                          </SelectContent>
                        </Select>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!projectStatusData) return;
                            const projects = projectStatusData.projects || [];

                            const tables: TableData[] = [
                              {
                                title: "Project Status Summary",
                                headers: ["Project", "Client", "Status", "Health", "Progress", "Budget Hours", "Actual Hours", "Variance", "Days Remaining", "Assigned Staff"],
                                rows: projects.map((p: any) => [
                                  p.projectName,
                                  p.clientName,
                                  p.status,
                                  p.healthStatus === 'on_track' ? 'On Track' : p.healthStatus === 'at_risk' ? 'At Risk' : 'Behind',
                                  `${p.progressPercentage}%`,
                                  `${p.budgetedHours}h`,
                                  `${p.actualHours}h`,
                                  `${p.budgetVariance > 0 ? '+' : ''}${p.budgetVariance.toFixed(1)}%`,
                                  p.daysRemaining.toString(),
                                  p.assignedStaff
                                ])
                              }
                            ];

                            const firmInfo: FirmInfo = {
                              name: "Practice Management System",
                              address: "",
                              phone: "",
                              email: ""
                            };

                            await exportReportToPDF({
                              title: "Project Status Report",
                              dateRange: { startDate: "", endDate: "" },
                              tables
                            }, firmInfo, "Project_Status_Report.pdf");
                          }}
                          data-testid="button-export-project-status-pdf"
                        >
                          <FileTextIcon className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!projectStatusData) return;
                            const projects = projectStatusData.projects || [];

                            const tables: TableData[] = [
                              {
                                title: "Project Status Summary",
                                headers: ["Project", "Client", "Status", "Health", "Progress", "Start Date", "Deadline", "Days Remaining", "Budget Hours", "Actual Hours", "Variance %", "Budget Amount", "Actual Amount", "Assigned Staff"],
                                rows: projects.map((p: any) => [
                                  p.projectName,
                                  p.clientName,
                                  p.status,
                                  p.healthStatus === 'on_track' ? 'On Track' : p.healthStatus === 'at_risk' ? 'At Risk' : 'Behind',
                                  `${p.progressPercentage}%`,
                                  p.startDate,
                                  p.endDate,
                                  p.daysRemaining.toString(),
                                  p.budgetedHours.toString(),
                                  p.actualHours.toString(),
                                  `${p.budgetVariance > 0 ? '+' : ''}${p.budgetVariance.toFixed(1)}%`,
                                  p.budgetedAmount.toString(),
                                  p.actualAmount.toString(),
                                  p.assignedStaff
                                ])
                              }
                            ];

                            const firmInfo: FirmInfo = {
                              name: "Practice Management System",
                              address: "",
                              phone: "",
                              email: ""
                            };

                            exportReportToExcel({
                              title: "Project Status Report",
                              dateRange: { startDate: "", endDate: "" },
                              tables
                            }, firmInfo, "Project_Status_Report.xlsx");
                          }}
                          data-testid="button-export-project-status-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchProjectStatus()}
                          data-testid="button-refresh-project-status"
                        >
                          <RefreshCw className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingProjectStatus && (
                  <Card>
                    <CardContent className="p-12">
                      <div className="flex flex-col items-center justify-center space-y-4">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                        <p className="text-gray-600">Loading project status data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {projectStatusError && (
                  <Card className="border-red-200">
                    <CardContent className="p-8">
                      <div className="flex items-center gap-3 text-red-600">
                        <AlertCircle className="w-6 h-6" />
                        <div>
                          <h3 className="font-semibold">Error Loading Report</h3>
                          <p className="text-sm">{(projectStatusError as Error).message}</p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {projectStatusData && !isLoadingProjectStatus && (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Total Projects</p>
                              <p className="text-3xl font-bold text-gray-900">{projectStatusData.summary.totalProjects}</p>
                            </div>
                            <Briefcase className="w-10 h-10 text-blue-500" />
                          </div>
                        </CardContent>
                      </Card>
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">On Track</p>
                              <p className="text-3xl font-bold text-green-600">{projectStatusData.summary.onTrack}</p>
                            </div>
                            <CheckCircle className="w-10 h-10 text-green-500" />
                          </div>
                        </CardContent>
                      </Card>
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">At Risk</p>
                              <p className="text-3xl font-bold text-yellow-600">{projectStatusData.summary.atRisk}</p>
                            </div>
                            <AlertCircle className="w-10 h-10 text-yellow-500" />
                          </div>
                        </CardContent>
                      </Card>
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Behind Schedule</p>
                              <p className="text-3xl font-bold text-red-600">{projectStatusData.summary.behind}</p>
                            </div>
                            <AlertTriangle className="w-10 h-10 text-red-500" />
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Project Health Pie Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Project Health Distribution</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportPieChart
                            data={[
                              { name: "On Track", value: projectStatusData.summary.onTrack, color: "#10b981" },
                              { name: "At Risk", value: projectStatusData.summary.atRisk, color: "#f59e0b" },
                              { name: "Behind", value: projectStatusData.summary.behind, color: "#ef4444" }
                            ]}
                            nameKey="name"
                            valueKey="value"
                            title=""
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Budget Variance Bar Chart - Top 10 Projects */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Budget Variance (Top 10 Projects)</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={projectStatusData.projects
                              .sort((a: any, b: any) => Math.abs(b.budgetVariance) - Math.abs(a.budgetVariance))
                              .slice(0, 10)
                              .map((p: any) => ({
                                name: p.projectName.length > 20 ? p.projectName.substring(0, 20) + '...' : p.projectName,
                                variance: p.budgetVariance
                              }))}
                            xKey="name"
                            yKey="variance"
                            title=""
                            colors={["#3b82f6"]}
                            height={300}
                          />
                        </CardContent>
                      </Card>
                    </div>

                    {/* Detailed Project Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Project Details</CardTitle>
                        <CardDescription>Comprehensive project status, timeline, and budget information</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead className="font-semibold">Health</TableHead>
                                <TableHead className="font-semibold">Project</TableHead>
                                <TableHead className="font-semibold">Client</TableHead>
                                <TableHead className="font-semibold">Status</TableHead>
                                <TableHead className="font-semibold">Progress</TableHead>
                                <TableHead className="font-semibold">Start Date</TableHead>
                                <TableHead className="font-semibold">Deadline</TableHead>
                                <TableHead className="font-semibold">Days Left</TableHead>
                                <TableHead className="font-semibold">Budget Hrs</TableHead>
                                <TableHead className="font-semibold">Actual Hrs</TableHead>
                                <TableHead className="font-semibold">Variance</TableHead>
                                <TableHead className="font-semibold">Budget $</TableHead>
                                <TableHead className="font-semibold">Actual $</TableHead>
                                <TableHead className="font-semibold">Assigned Staff</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {projectStatusData.projects
                                .sort((a: any, b: any) => {
                                  // Sort by deadline (soonest first)
                                  if (!a.endDate) return 1;
                                  if (!b.endDate) return -1;
                                  return new Date(a.endDate).getTime() - new Date(b.endDate).getTime();
                                })
                                .map((project: any) => {
                                  const healthIcon = project.healthStatus === 'on_track' ? 'üü¢' :
                                    project.healthStatus === 'at_risk' ? 'üü°' : 'üî¥';
                                  const statusColor = project.status === 'active' ? 'bg-blue-100 text-blue-800' :
                                    project.status === 'completed' ? 'bg-green-100 text-green-800' :
                                      'bg-gray-100 text-gray-800';
                                  const varianceColor = project.budgetVariance > 25 ? 'text-red-600 font-semibold' :
                                    project.budgetVariance > 10 ? 'text-yellow-600 font-semibold' :
                                      'text-green-600';

                                  return (
                                    <TableRow key={project.projectId} className="hover:bg-gray-50">
                                      <TableCell className="text-xl">{healthIcon}</TableCell>
                                      <TableCell className="font-medium">{project.projectName}</TableCell>
                                      <TableCell>{project.clientName}</TableCell>
                                      <TableCell>
                                        <Badge className={statusColor}>{project.status}</Badge>
                                      </TableCell>
                                      <TableCell>
                                        <div className="flex items-center gap-2">
                                          <Progress value={project.progressPercentage} className="w-20" />
                                          <span className="text-sm">{project.progressPercentage}%</span>
                                        </div>
                                      </TableCell>
                                      <TableCell className="text-sm">{project.startDate || 'N/A'}</TableCell>
                                      <TableCell className="text-sm">{project.endDate || 'N/A'}</TableCell>
                                      <TableCell className={project.daysRemaining < 0 ? 'text-red-600 font-semibold' : ''}>
                                        {project.daysRemaining} days
                                      </TableCell>
                                      <TableCell>{project.budgetedHours.toFixed(1)}</TableCell>
                                      <TableCell>{project.actualHours.toFixed(1)}</TableCell>
                                      <TableCell className={varianceColor}>
                                        {project.budgetVariance > 0 ? '+' : ''}{project.budgetVariance.toFixed(1)}%
                                      </TableCell>
                                      <TableCell>${project.budgetedAmount.toLocaleString()}</TableCell>
                                      <TableCell>${project.actualAmount.toLocaleString()}</TableCell>
                                      <TableCell className="text-sm max-w-xs truncate" title={project.assignedStaff}>
                                        {project.assignedStaff}
                                      </TableCell>
                                    </TableRow>
                                  );
                                })}
                            </TableBody>
                          </Table>
                          {projectStatusData.projects.length === 0 && (
                            <div className="text-center py-12 text-gray-500">
                              No projects found matching the selected filter.
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Task Management Report */}
            {reportTab === 'task-management' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Task Management Report</CardTitle>
                        <CardDescription>Track completion rates, bottlenecks, and staff workload</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={taskManagementStartDate}
                            onChange={(e) => setTaskManagementStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-task-mgmt-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={taskManagementEndDate}
                            onChange={(e) => setTaskManagementEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-task-mgmt-end-date"
                          />
                        </div>
                        <Select value={taskManagementStaffFilter} onValueChange={setTaskManagementStaffFilter}>
                          <SelectTrigger className="w-48" data-testid="select-staff-filter">
                            <SelectValue placeholder="All Staff" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="">All Staff</SelectItem>
                            {safeArray(users).map((user: any) => (
                              <SelectItem key={user.id} value={user.id.toString()}>{user.name}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!taskManagementData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Firm Name",
                              address: "123 Main Street",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const tables: TableData[] = [
                              {
                                title: "Task Management Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Tasks", taskManagementData.summary.totalTasks.toString()],
                                  ["Completed Tasks", taskManagementData.summary.completedTasks.toString()],
                                  ["Open Tasks", taskManagementData.summary.openTasks.toString()],
                                  ["Overdue Tasks", taskManagementData.summary.overdueTasks.toString()],
                                  ["Completion Rate", `${taskManagementData.summary.completionRate.toFixed(1)}%`],
                                  ["Average Completion Time", `${taskManagementData.summary.averageCompletionTime.toFixed(1)} days`],
                                ]
                              },
                              {
                                title: "Staff Workload",
                                headers: ["Staff Member", "Assigned", "Open", "Completed", "Overdue", "Completion Rate"],
                                rows: taskManagementData.byStaff.map((staff: any) => [
                                  staff.userName,
                                  staff.assignedTasks.toString(),
                                  staff.openTasks.toString(),
                                  staff.completedTasks.toString(),
                                  staff.overdueTasks.toString(),
                                  `${staff.completionRate.toFixed(1)}%`
                                ])
                              },
                              {
                                title: "Bottleneck Tasks (>7 days in status)",
                                headers: ["Task", "Status", "Priority", "Assigned To", "Days in Status", "Project", "Client"],
                                rows: taskManagementData.bottlenecks.map((task: any) => [
                                  task.title,
                                  task.status,
                                  task.priority,
                                  task.assignedTo,
                                  task.daysInStatus.toString(),
                                  task.projectName,
                                  task.clientName
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Task Management Report",
                              dateRange: { startDate: taskManagementStartDate, endDate: taskManagementEndDate },
                              tables
                            }, firmInfo, "Task_Management_Report.pdf");
                          }}
                          data-testid="button-export-pdf"
                        >
                          <FileText className="w-4 h-4 mr-2" />
                          PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!taskManagementData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Firm Name",
                              address: "123 Main Street",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const tables: TableData[] = [
                              {
                                title: "Task Management Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Tasks", taskManagementData.summary.totalTasks.toString()],
                                  ["Completed Tasks", taskManagementData.summary.completedTasks.toString()],
                                  ["Open Tasks", taskManagementData.summary.openTasks.toString()],
                                  ["Overdue Tasks", taskManagementData.summary.overdueTasks.toString()],
                                  ["Completion Rate", `${taskManagementData.summary.completionRate.toFixed(1)}%`],
                                  ["Average Completion Time", `${taskManagementData.summary.averageCompletionTime.toFixed(1)} days`],
                                ]
                              },
                              {
                                title: "Staff Workload",
                                headers: ["Staff Member", "Assigned", "Open", "Completed", "Overdue", "Completion Rate"],
                                rows: taskManagementData.byStaff.map((staff: any) => [
                                  staff.userName,
                                  staff.assignedTasks.toString(),
                                  staff.openTasks.toString(),
                                  staff.completedTasks.toString(),
                                  staff.overdueTasks.toString(),
                                  `${staff.completionRate.toFixed(1)}%`
                                ])
                              },
                              {
                                title: "Priority Distribution",
                                headers: ["Priority", "Total", "Completed", "Overdue"],
                                rows: taskManagementData.byPriority.map((p: any) => [
                                  p.priority,
                                  p.count.toString(),
                                  p.completed.toString(),
                                  p.overdue.toString()
                                ])
                              },
                              {
                                title: "Bottleneck Tasks (>7 days in status)",
                                headers: ["Task", "Status", "Priority", "Assigned To", "Days in Status", "Due Date", "Project", "Client"],
                                rows: taskManagementData.bottlenecks.map((task: any) => [
                                  task.title,
                                  task.status,
                                  task.priority,
                                  task.assignedTo,
                                  task.daysInStatus.toString(),
                                  task.dueDate || 'N/A',
                                  task.projectName,
                                  task.clientName
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Task Management Report",
                              dateRange: { startDate: taskManagementStartDate, endDate: taskManagementEndDate },
                              tables
                            }, firmInfo, "Task_Management_Report.xlsx");
                          }}
                          data-testid="button-export-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingTaskManagement && (
                  <div className="flex justify-center items-center py-12">
                    <div className="text-center">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                      <p className="mt-4 text-gray-600">Loading task management data...</p>
                    </div>
                  </div>
                )}

                {taskManagementError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="pt-6">
                      <div className="flex items-center gap-2 text-red-800">
                        <AlertTriangle className="w-5 h-5" />
                        <p>Error loading task management data. Please try again.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {!isLoadingTaskManagement && !taskManagementError && taskManagementData && (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Total Tasks</CardTitle>
                          <CheckSquare className="h-4 w-4 text-gray-500" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{taskManagementData.summary.totalTasks}</div>
                          <p className="text-xs text-gray-500 mt-1">In selected period</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Completed</CardTitle>
                          <CheckCircle className="h-4 w-4 text-green-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">{taskManagementData.summary.completedTasks}</div>
                          <p className="text-xs text-gray-500 mt-1">Successfully finished</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Open Tasks</CardTitle>
                          <Clock className="h-4 w-4 text-blue-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-blue-600">{taskManagementData.summary.openTasks}</div>
                          <p className="text-xs text-gray-500 mt-1">In progress or pending</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Overdue</CardTitle>
                          <AlertCircle className="h-4 w-4 text-red-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-red-600">{taskManagementData.summary.overdueTasks}</div>
                          <p className="text-xs text-gray-500 mt-1">Past due date</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Completion Rate Card */}
                    <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white">
                      <CardHeader>
                        <CardTitle className="text-lg">Task Completion Rate</CardTitle>
                        <CardDescription>Overall completion performance</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="flex items-center justify-between">
                          <div>
                            <div className="text-5xl font-bold text-blue-600">
                              {taskManagementData.summary.completionRate.toFixed(1)}%
                            </div>
                            <p className="text-sm text-gray-600 mt-2">
                              {taskManagementData.summary.completedTasks} of {taskManagementData.summary.totalTasks} tasks completed
                            </p>
                            <p className="text-sm text-gray-600 mt-1">
                              Average completion time: <span className="font-semibold">{taskManagementData.summary.averageCompletionTime.toFixed(1)} days</span>
                            </p>
                          </div>
                          <div className="text-6xl">üìä</div>
                        </div>
                        <Progress value={taskManagementData.summary.completionRate} className="mt-4 h-3" />
                      </CardContent>
                    </Card>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      {/* Task Status Distribution */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Task Status Distribution</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportPieChart
                            data={taskManagementData.statusDistribution.map((s: any) => ({
                              name: s.status,
                              value: s.count
                            }))}
                            nameKey="name"
                            valueKey="value"
                            title=""
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Staff Workload */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Staff Workload (Open Tasks)</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={taskManagementData.byStaff.map((staff: any) => ({
                              name: staff.userName.length > 15 ? staff.userName.substring(0, 15) + '...' : staff.userName,
                              value: staff.openTasks
                            }))}
                            xKey="name"
                            yKey="value"
                            title=""
                            colors={["#3b82f6"]}
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Priority Distribution */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Tasks by Priority</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={taskManagementData.byPriority.map((p: any) => ({
                              name: p.priority.charAt(0).toUpperCase() + p.priority.slice(1),
                              value: p.count
                            }))}
                            xKey="name"
                            yKey="value"
                            title=""
                            colors={["#ef4444", "#f59e0b", "#10b981"]}
                            height={300}
                          />
                        </CardContent>
                      </Card>
                    </div>

                    {/* Bottleneck Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Bottleneck Analysis</CardTitle>
                        <CardDescription>
                          Tasks stuck in the same status for more than 7 days ({taskManagementData.bottlenecks.length} tasks)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {taskManagementData.bottlenecks.length > 0 ? (
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead className="font-semibold">Task</TableHead>
                                  <TableHead className="font-semibold">Status</TableHead>
                                  <TableHead className="font-semibold">Priority</TableHead>
                                  <TableHead className="font-semibold">Assigned To</TableHead>
                                  <TableHead className="font-semibold">Days in Status</TableHead>
                                  <TableHead className="font-semibold">Project</TableHead>
                                  <TableHead className="font-semibold">Client</TableHead>
                                  <TableHead className="font-semibold">Due Date</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {taskManagementData.bottlenecks.map((task: any) => {
                                  const priorityColor = task.priority === 'high' ? 'bg-red-100 text-red-800' :
                                    task.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-green-100 text-green-800';
                                  const daysColor = task.daysInStatus > 30 ? 'text-red-600 font-bold' :
                                    task.daysInStatus > 14 ? 'text-orange-600 font-semibold' :
                                      'text-yellow-600';
                                  const statusColor = task.status === 'blocked' ? 'bg-red-100 text-red-800' :
                                    task.status === 'in_progress' ? 'bg-blue-100 text-blue-800' :
                                      'bg-gray-100 text-gray-800';

                                  return (
                                    <TableRow
                                      key={task.taskId}
                                      className={`hover:bg-gray-50 ${task.isOverdue ? 'bg-red-50' : ''}`}
                                    >
                                      <TableCell className="font-medium max-w-xs">
                                        {task.title}
                                        {task.isOverdue && (
                                          <span className="ml-2 text-red-600 text-xs">‚ö†Ô∏è Overdue</span>
                                        )}
                                      </TableCell>
                                      <TableCell>
                                        <Badge className={statusColor}>
                                          {task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('_', ' ')}
                                        </Badge>
                                      </TableCell>
                                      <TableCell>
                                        <Badge className={priorityColor}>
                                          {task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                        </Badge>
                                      </TableCell>
                                      <TableCell>{task.assignedTo}</TableCell>
                                      <TableCell className={daysColor}>
                                        {task.daysInStatus} days
                                      </TableCell>
                                      <TableCell className="max-w-xs truncate" title={task.projectName}>
                                        {task.projectName}
                                      </TableCell>
                                      <TableCell className="max-w-xs truncate" title={task.clientName}>
                                        {task.clientName}
                                      </TableCell>
                                      <TableCell className={task.isOverdue ? 'text-red-600 font-semibold' : ''}>
                                        {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'}
                                      </TableCell>
                                    </TableRow>
                                  );
                                })}
                              </TableBody>
                            </Table>
                          </div>
                        ) : (
                          <div className="text-center py-12 text-gray-500">
                            <CheckCircle className="w-12 h-12 mx-auto mb-4 text-green-500" />
                            <p className="font-semibold">No bottlenecks detected!</p>
                            <p className="text-sm mt-1">All tasks are progressing well.</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>

                    {/* Staff Performance Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Staff Task Performance</CardTitle>
                        <CardDescription>Individual task completion metrics</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead className="font-semibold">Staff Member</TableHead>
                                <TableHead className="font-semibold">Assigned Tasks</TableHead>
                                <TableHead className="font-semibold">Open</TableHead>
                                <TableHead className="font-semibold">Completed</TableHead>
                                <TableHead className="font-semibold">Overdue</TableHead>
                                <TableHead className="font-semibold">Completion Rate</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {taskManagementData.byStaff
                                .sort((a: any, b: any) => b.assignedTasks - a.assignedTasks)
                                .map((staff: any) => {
                                  const completionColor = staff.completionRate >= 80 ? 'text-green-600 font-semibold' :
                                    staff.completionRate >= 60 ? 'text-yellow-600' :
                                      'text-red-600';

                                  return (
                                    <TableRow key={staff.userId} className="hover:bg-gray-50">
                                      <TableCell className="font-medium">{staff.userName}</TableCell>
                                      <TableCell>{staff.assignedTasks}</TableCell>
                                      <TableCell className="text-blue-600">{staff.openTasks}</TableCell>
                                      <TableCell className="text-green-600">{staff.completedTasks}</TableCell>
                                      <TableCell className={staff.overdueTasks > 0 ? 'text-red-600 font-semibold' : ''}>
                                        {staff.overdueTasks}
                                      </TableCell>
                                      <TableCell>
                                        <div className="flex items-center gap-2">
                                          <span className={completionColor}>{staff.completionRate.toFixed(1)}%</span>
                                          <Progress value={staff.completionRate} className="w-20 h-2" />
                                        </div>
                                      </TableCell>
                                    </TableRow>
                                  );
                                })}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Upcoming Deadlines Report */}
            {reportTab === 'upcoming-deadlines' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>‚è∞ Upcoming Deadlines Dashboard</CardTitle>
                        <CardDescription>Critical dates for tasks and projects in the next 30/60/90 days</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchUpcomingDeadlines()}
                          disabled={isLoadingUpcomingDeadlines}
                          data-testid="button-refresh-deadlines"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingUpcomingDeadlines ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!upcomingDeadlinesData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const today = new Date();

                            // Merge and sort all deadlines
                            const allDeadlines = [
                              ...(upcomingDeadlinesData.next30Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '30' })),
                              ...(upcomingDeadlinesData.next30Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '30' })),
                              ...(upcomingDeadlinesData.next60Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '60' })),
                              ...(upcomingDeadlinesData.next60Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '60' })),
                              ...(upcomingDeadlinesData.next90Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '90' })),
                              ...(upcomingDeadlinesData.next90Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '90' })),
                            ].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                            const tables: TableData[] = [
                              {
                                title: "All Upcoming Deadlines (Sorted by Due Date)",
                                headers: ["Type", "Name", "Client", "Due Date", "Days Until Due", "Priority/Status", "Assigned To"],
                                rows: allDeadlines.map((item: any) => [
                                  item.type,
                                  item.type === 'Task' ? item.title : item.projectName,
                                  item.clientName,
                                  item.type === 'Task' ? new Date(item.dueDate).toLocaleDateString() : new Date(item.endDate).toLocaleDateString(),
                                  `${item.daysUntilDue} days`,
                                  item.type === 'Task' ? (item.priority || 'N/A') : (item.status || 'N/A'),
                                  item.type === 'Task' ? (item.assigneeName || 'Unassigned') : 'N/A'
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Upcoming Deadlines Dashboard",
                              dateRange: { startDate: today.toISOString().split('T')[0], endDate: new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
                              tables
                            }, firmInfo, "Upcoming_Deadlines_Report.pdf");
                          }}
                          data-testid="button-export-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!upcomingDeadlinesData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const today = new Date();

                            // Merge and sort all deadlines
                            const allDeadlines = [
                              ...(upcomingDeadlinesData.next30Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '30' })),
                              ...(upcomingDeadlinesData.next30Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '30' })),
                              ...(upcomingDeadlinesData.next60Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '60' })),
                              ...(upcomingDeadlinesData.next60Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '60' })),
                              ...(upcomingDeadlinesData.next90Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task', bucket: '90' })),
                              ...(upcomingDeadlinesData.next90Days?.projects || []).map((p: any) => ({ ...p, type: 'Project', bucket: '90' })),
                            ].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                            const tables: TableData[] = [
                              {
                                title: "All Upcoming Deadlines (Sorted by Due Date)",
                                headers: ["Type", "Name", "Client", "Due Date", "Days Until Due", "Priority/Status", "Assigned To"],
                                rows: allDeadlines.map((item: any) => [
                                  item.type,
                                  item.type === 'Task' ? item.title : item.projectName,
                                  item.clientName,
                                  item.type === 'Task' ? new Date(item.dueDate).toLocaleDateString() : new Date(item.endDate).toLocaleDateString(),
                                  `${item.daysUntilDue} days`,
                                  item.type === 'Task' ? (item.priority || 'N/A') : (item.status || 'N/A'),
                                  item.type === 'Task' ? (item.assigneeName || 'Unassigned') : 'N/A'
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Upcoming Deadlines Dashboard",
                              dateRange: { startDate: today.toISOString().split('T')[0], endDate: new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] },
                              tables
                            }, firmInfo, "Upcoming_Deadlines_Report.xlsx");
                          }}
                          data-testid="button-export-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingUpcomingDeadlines && (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <RefreshCw className="w-8 h-8 animate-spin text-blue-500 mx-auto mb-4" />
                        <p className="text-gray-500">Loading upcoming deadlines...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {upcomingDeadlinesError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="flex items-center gap-3 py-4">
                      <AlertTriangle className="w-6 h-6 text-red-600" />
                      <div>
                        <p className="font-semibold text-red-800">Error loading upcoming deadlines</p>
                        <p className="text-sm text-red-700">{(upcomingDeadlinesError as Error).message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {upcomingDeadlinesData && !isLoadingUpcomingDeadlines && (
                  <>
                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card className="border-2 border-red-200 bg-gradient-to-br from-red-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Next 7 Days</CardTitle>
                          <AlertTriangle className="h-4 w-4 text-red-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-red-600">
                            {(() => {
                              const tasks7Days = (upcomingDeadlinesData.next30Days?.tasks || []).filter((t: any) => t.daysUntilDue <= 7);
                              const projects7Days = (upcomingDeadlinesData.next30Days?.projects || []).filter((p: any) => p.daysUntilDue <= 7);
                              return tasks7Days.length + projects7Days.length;
                            })()}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Critical deadlines</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-orange-200 bg-gradient-to-br from-orange-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Next 30 Days</CardTitle>
                          <Clock className="h-4 w-4 text-orange-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-orange-600">
                            {((upcomingDeadlinesData.next30Days?.tasks || []).length + (upcomingDeadlinesData.next30Days?.projects || []).length)}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Urgent items</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-yellow-200 bg-gradient-to-br from-yellow-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Next 60 Days</CardTitle>
                          <CalendarDays className="h-4 w-4 text-yellow-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-yellow-600">
                            {((upcomingDeadlinesData.next60Days?.tasks || []).length + (upcomingDeadlinesData.next60Days?.projects || []).length)}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Important deadlines</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Next 90 Days</CardTitle>
                          <Target className="h-4 w-4 text-blue-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-blue-600">
                            {((upcomingDeadlinesData.next90Days?.tasks || []).length + (upcomingDeadlinesData.next90Days?.projects || []).length)}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Upcoming items</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Urgency Alert Section */}
                    {(() => {
                      const urgentTasks = (upcomingDeadlinesData.next30Days?.tasks || []).filter((t: any) => t.daysUntilDue <= 7);
                      const urgentProjects = (upcomingDeadlinesData.next30Days?.projects || []).filter((p: any) => p.daysUntilDue <= 7);
                      const urgentItems = [...urgentTasks, ...urgentProjects].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                      if (urgentItems.length > 0) {
                        return (
                          <Card className="border-2 border-red-300 bg-gradient-to-br from-red-50 to-orange-50">
                            <CardHeader>
                              <div className="flex items-center gap-2">
                                <AlertTriangle className="w-6 h-6 text-red-600" />
                                <div>
                                  <CardTitle className="text-red-800">üö® Critical Deadlines Alert</CardTitle>
                                  <CardDescription className="text-red-700">
                                    {urgentItems.length} item{urgentItems.length !== 1 ? 's' : ''} due within the next 7 days - immediate attention required!
                                  </CardDescription>
                                </div>
                              </div>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-3">
                                {urgentItems.map((item: any, index: number) => {
                                  const isTask = 'title' in item;
                                  const daysColor = item.daysUntilDue <= 2 ? 'bg-red-600 text-white' :
                                    item.daysUntilDue <= 5 ? 'bg-orange-500 text-white' :
                                      'bg-yellow-500 text-white';

                                  return (
                                    <div
                                      key={`urgent-${index}`}
                                      className="flex items-center justify-between p-3 bg-white rounded-lg border-2 border-red-200 hover:shadow-md transition-shadow"
                                    >
                                      <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                          <Badge variant={isTask ? "default" : "secondary"} className="text-xs">
                                            {isTask ? 'üìã Task' : 'üìÅ Project'}
                                          </Badge>
                                          <span className="font-semibold text-gray-900">
                                            {isTask ? item.title : item.projectName}
                                          </span>
                                        </div>
                                        <div className="flex items-center gap-3 text-sm text-gray-600">
                                          <span className="flex items-center gap-1">
                                            <Building2 className="w-3 h-3" />
                                            {item.clientName}
                                          </span>
                                          {isTask && item.projectName && (
                                            <span className="flex items-center gap-1">
                                              <Folder className="w-3 h-3" />
                                              {item.projectName}
                                            </span>
                                          )}
                                          {isTask && item.assigneeName && (
                                            <span className="flex items-center gap-1">
                                              <User className="w-3 h-3" />
                                              {item.assigneeName}
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                      <div className="flex items-center gap-3">
                                        {isTask && item.priority && (
                                          <Badge className={
                                            item.priority === 'high' ? 'bg-red-100 text-red-800' :
                                              item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-green-100 text-green-800'
                                          }>
                                            {item.priority.toUpperCase()}
                                          </Badge>
                                        )}
                                        <div className="text-right">
                                          <div className={`px-3 py-1 rounded-full text-xs font-bold ${daysColor}`}>
                                            {item.daysUntilDue === 0 ? 'DUE TODAY' :
                                              item.daysUntilDue === 1 ? 'DUE TOMORROW' :
                                                `${item.daysUntilDue} DAYS`}
                                          </div>
                                          <div className="text-xs text-gray-500 mt-1">
                                            {new Date(isTask ? item.dueDate : item.endDate).toLocaleDateString()}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </CardContent>
                          </Card>
                        );
                      }
                      return null;
                    })()}

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Deadline Distribution Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Deadline Distribution</CardTitle>
                          <CardDescription>Number of deadlines by time bucket</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={[
                              {
                                name: '< 7 days',
                                value: (() => {
                                  const tasks = (upcomingDeadlinesData.next30Days?.tasks || []).filter((t: any) => t.daysUntilDue <= 7);
                                  const projects = (upcomingDeadlinesData.next30Days?.projects || []).filter((p: any) => p.daysUntilDue <= 7);
                                  return tasks.length + projects.length;
                                })()
                              },
                              {
                                name: '7-30 days',
                                value: (() => {
                                  const tasks = (upcomingDeadlinesData.next30Days?.tasks || []).filter((t: any) => t.daysUntilDue > 7);
                                  const projects = (upcomingDeadlinesData.next30Days?.projects || []).filter((p: any) => p.daysUntilDue > 7);
                                  return tasks.length + projects.length;
                                })()
                              },
                              {
                                name: '30-60 days',
                                value: (upcomingDeadlinesData.next60Days?.tasks || []).length + (upcomingDeadlinesData.next60Days?.projects || []).length
                              },
                              {
                                name: '60-90 days',
                                value: (upcomingDeadlinesData.next90Days?.tasks || []).length + (upcomingDeadlinesData.next90Days?.projects || []).length
                              }
                            ]}
                            xKey="name"
                            yKey="value"
                            title=""
                            colors={["#dc2626", "#f97316", "#eab308", "#3b82f6"]}
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Priority Breakdown Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Deadlines by Priority</CardTitle>
                          <CardDescription>Task priority distribution (next 90 days)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          {(() => {
                            const allTasks = [
                              ...(upcomingDeadlinesData.next30Days?.tasks || []),
                              ...(upcomingDeadlinesData.next60Days?.tasks || []),
                              ...(upcomingDeadlinesData.next90Days?.tasks || [])
                            ];

                            const priorityCounts = allTasks.reduce((acc: any, task: any) => {
                              const priority = (task.priority || 'medium').toLowerCase();
                              acc[priority] = (acc[priority] || 0) + 1;
                              return acc;
                            }, {});

                            const chartData = [
                              { name: 'High', value: priorityCounts.high || 0 },
                              { name: 'Medium', value: priorityCounts.medium || 0 },
                              { name: 'Low', value: priorityCounts.low || 0 }
                            ];

                            return (
                              <ReportPieChart
                                data={chartData}
                                nameKey="name"
                                valueKey="value"
                                title=""
                                height={300}
                              />
                            );
                          })()}
                        </CardContent>
                      </Card>
                    </div>

                    {/* Timeline View - Next 30 Days */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <span className="text-orange-600">üìÖ</span>
                          Next 30 Days Timeline
                        </CardTitle>
                        <CardDescription>
                          {((upcomingDeadlinesData.next30Days?.tasks || []).length + (upcomingDeadlinesData.next30Days?.projects || []).length)} deadline{((upcomingDeadlinesData.next30Days?.tasks || []).length + (upcomingDeadlinesData.next30Days?.projects || []).length) !== 1 ? 's' : ''}
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {(() => {
                          const allItems = [
                            ...(upcomingDeadlinesData.next30Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task' })),
                            ...(upcomingDeadlinesData.next30Days?.projects || []).map((p: any) => ({ ...p, type: 'Project' }))
                          ].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                          if (allItems.length === 0) {
                            return (
                              <div className="text-center py-12 text-gray-500">
                                <CheckCircle className="w-12 h-12 mx-auto mb-4 text-green-500" />
                                <p className="font-semibold">No deadlines in the next 30 days!</p>
                              </div>
                            );
                          }

                          return (
                            <div className="overflow-x-auto">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead className="font-semibold">Type</TableHead>
                                    <TableHead className="font-semibold">Name</TableHead>
                                    <TableHead className="font-semibold">Client</TableHead>
                                    <TableHead className="font-semibold">Due Date</TableHead>
                                    <TableHead className="font-semibold">Days Until Due</TableHead>
                                    <TableHead className="font-semibold">Priority/Status</TableHead>
                                    <TableHead className="font-semibold">Assigned To</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {allItems.map((item: any, index: number) => {
                                    const isTask = item.type === 'Task';
                                    const daysColor = item.daysUntilDue <= 7 ? 'text-red-600 font-bold' :
                                      item.daysUntilDue <= 14 ? 'text-orange-600 font-semibold' :
                                        'text-gray-700';
                                    const rowBg = item.daysUntilDue <= 7 ? 'bg-red-50' : '';

                                    return (
                                      <TableRow key={`30day-${index}`} className={`hover:bg-gray-50 ${rowBg}`}>
                                        <TableCell>
                                          <Badge variant={isTask ? "default" : "secondary"}>
                                            {isTask ? 'üìã Task' : 'üìÅ Project'}
                                          </Badge>
                                        </TableCell>
                                        <TableCell className="font-medium max-w-xs">
                                          {isTask ? item.title : item.projectName}
                                          {isTask && item.projectName && (
                                            <div className="text-xs text-gray-500 mt-1">
                                              üìÅ {item.projectName}
                                            </div>
                                          )}
                                        </TableCell>
                                        <TableCell>{item.clientName}</TableCell>
                                        <TableCell>
                                          {new Date(isTask ? item.dueDate : item.endDate).toLocaleDateString()}
                                        </TableCell>
                                        <TableCell className={daysColor}>
                                          {item.daysUntilDue} days
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (
                                            <Badge className={
                                              item.priority === 'high' ? 'bg-red-100 text-red-800' :
                                                item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                  'bg-green-100 text-green-800'
                                            }>
                                              {item.priority?.toUpperCase() || 'N/A'}
                                            </Badge>
                                          ) : (
                                            <Badge variant="outline">{item.status}</Badge>
                                          )}
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (item.assigneeName || 'Unassigned') : '-'}
                                        </TableCell>
                                      </TableRow>
                                    );
                                  })}
                                </TableBody>
                              </Table>
                            </div>
                          );
                        })()}
                      </CardContent>
                    </Card>

                    {/* Timeline View - Next 60 Days */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <span className="text-yellow-600">üìÖ</span>
                          Next 60 Days Timeline
                        </CardTitle>
                        <CardDescription>
                          {((upcomingDeadlinesData.next60Days?.tasks || []).length + (upcomingDeadlinesData.next60Days?.projects || []).length)} deadline{((upcomingDeadlinesData.next60Days?.tasks || []).length + (upcomingDeadlinesData.next60Days?.projects || []).length) !== 1 ? 's' : ''}
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {(() => {
                          const allItems = [
                            ...(upcomingDeadlinesData.next60Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task' })),
                            ...(upcomingDeadlinesData.next60Days?.projects || []).map((p: any) => ({ ...p, type: 'Project' }))
                          ].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                          if (allItems.length === 0) {
                            return (
                              <div className="text-center py-12 text-gray-500">
                                <CheckCircle className="w-12 h-12 mx-auto mb-4 text-green-500" />
                                <p className="font-semibold">No deadlines in this period!</p>
                              </div>
                            );
                          }

                          return (
                            <div className="overflow-x-auto">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead className="font-semibold">Type</TableHead>
                                    <TableHead className="font-semibold">Name</TableHead>
                                    <TableHead className="font-semibold">Client</TableHead>
                                    <TableHead className="font-semibold">Due Date</TableHead>
                                    <TableHead className="font-semibold">Days Until Due</TableHead>
                                    <TableHead className="font-semibold">Priority/Status</TableHead>
                                    <TableHead className="font-semibold">Assigned To</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {allItems.map((item: any, index: number) => {
                                    const isTask = item.type === 'Task';

                                    return (
                                      <TableRow key={`60day-${index}`} className="hover:bg-gray-50">
                                        <TableCell>
                                          <Badge variant={isTask ? "default" : "secondary"}>
                                            {isTask ? 'üìã Task' : 'üìÅ Project'}
                                          </Badge>
                                        </TableCell>
                                        <TableCell className="font-medium max-w-xs">
                                          {isTask ? item.title : item.projectName}
                                          {isTask && item.projectName && (
                                            <div className="text-xs text-gray-500 mt-1">
                                              üìÅ {item.projectName}
                                            </div>
                                          )}
                                        </TableCell>
                                        <TableCell>{item.clientName}</TableCell>
                                        <TableCell>
                                          {new Date(isTask ? item.dueDate : item.endDate).toLocaleDateString()}
                                        </TableCell>
                                        <TableCell className="text-gray-700">
                                          {item.daysUntilDue} days
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (
                                            <Badge className={
                                              item.priority === 'high' ? 'bg-red-100 text-red-800' :
                                                item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                  'bg-green-100 text-green-800'
                                            }>
                                              {item.priority?.toUpperCase() || 'N/A'}
                                            </Badge>
                                          ) : (
                                            <Badge variant="outline">{item.status}</Badge>
                                          )}
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (item.assigneeName || 'Unassigned') : '-'}
                                        </TableCell>
                                      </TableRow>
                                    );
                                  })}
                                </TableBody>
                              </Table>
                            </div>
                          );
                        })()}
                      </CardContent>
                    </Card>

                    {/* Timeline View - Next 90 Days */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <span className="text-blue-600">üìÖ</span>
                          Next 90 Days Timeline
                        </CardTitle>
                        <CardDescription>
                          {((upcomingDeadlinesData.next90Days?.tasks || []).length + (upcomingDeadlinesData.next90Days?.projects || []).length)} deadline{((upcomingDeadlinesData.next90Days?.tasks || []).length + (upcomingDeadlinesData.next90Days?.projects || []).length) !== 1 ? 's' : ''}
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {(() => {
                          const allItems = [
                            ...(upcomingDeadlinesData.next90Days?.tasks || []).map((t: any) => ({ ...t, type: 'Task' })),
                            ...(upcomingDeadlinesData.next90Days?.projects || []).map((p: any) => ({ ...p, type: 'Project' }))
                          ].sort((a, b) => a.daysUntilDue - b.daysUntilDue);

                          if (allItems.length === 0) {
                            return (
                              <div className="text-center py-12 text-gray-500">
                                <CheckCircle className="w-12 h-12 mx-auto mb-4 text-green-500" />
                                <p className="font-semibold">No deadlines in this period!</p>
                              </div>
                            );
                          }

                          return (
                            <div className="overflow-x-auto">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead className="font-semibold">Type</TableHead>
                                    <TableHead className="font-semibold">Name</TableHead>
                                    <TableHead className="font-semibold">Client</TableHead>
                                    <TableHead className="font-semibold">Due Date</TableHead>
                                    <TableHead className="font-semibold">Days Until Due</TableHead>
                                    <TableHead className="font-semibold">Priority/Status</TableHead>
                                    <TableHead className="font-semibold">Assigned To</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {allItems.map((item: any, index: number) => {
                                    const isTask = item.type === 'Task';

                                    return (
                                      <TableRow key={`90day-${index}`} className="hover:bg-gray-50">
                                        <TableCell>
                                          <Badge variant={isTask ? "default" : "secondary"}>
                                            {isTask ? 'üìã Task' : 'üìÅ Project'}
                                          </Badge>
                                        </TableCell>
                                        <TableCell className="font-medium max-w-xs">
                                          {isTask ? item.title : item.projectName}
                                          {isTask && item.projectName && (
                                            <div className="text-xs text-gray-500 mt-1">
                                              üìÅ {item.projectName}
                                            </div>
                                          )}
                                        </TableCell>
                                        <TableCell>{item.clientName}</TableCell>
                                        <TableCell>
                                          {new Date(isTask ? item.dueDate : item.endDate).toLocaleDateString()}
                                        </TableCell>
                                        <TableCell className="text-gray-700">
                                          {item.daysUntilDue} days
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (
                                            <Badge className={
                                              item.priority === 'high' ? 'bg-red-100 text-red-800' :
                                                item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                  'bg-green-100 text-green-800'
                                            }>
                                              {item.priority?.toUpperCase() || 'N/A'}
                                            </Badge>
                                          ) : (
                                            <Badge variant="outline">{item.status}</Badge>
                                          )}
                                        </TableCell>
                                        <TableCell>
                                          {isTask ? (item.assigneeName || 'Unassigned') : '-'}
                                        </TableCell>
                                      </TableRow>
                                    );
                                  })}
                                </TableBody>
                              </Table>
                            </div>
                          );
                        })()}
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Overdue Items Report */}
            {reportTab === 'overdue-items' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üî¥ Overdue Items Dashboard</CardTitle>
                        <CardDescription>Critical overdue tasks and projects requiring immediate attention</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchOverdueItems()}
                          disabled={isLoadingOverdueItems}
                          data-testid="button-refresh-overdue"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingOverdueItems ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!overdueItemsData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const today = new Date();

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Count"],
                                rows: [
                                  ["Total Overdue Items", overdueItemsData.summary?.totalOverdue?.toString() || "0"],
                                  ["Overdue Tasks", overdueItemsData.summary?.overdueTasks?.toString() || "0"],
                                  ["Overdue Projects", overdueItemsData.summary?.overdueProjects?.toString() || "0"],
                                  ["Critically Overdue (>30 days)", overdueItemsData.summary?.criticallyOverdue?.toString() || "0"],
                                  ["Very Overdue (15-30 days)", overdueItemsData.summary?.veryOverdue?.toString() || "0"],
                                  ["Recently Overdue (<15 days)", overdueItemsData.summary?.recentlyOverdue?.toString() || "0"],
                                ]
                              },
                              {
                                title: "All Overdue Items (Sorted by Days Overdue)",
                                headers: ["Type", "Name", "Client", "Project", "Priority", "Assignee", "Due Date", "Days Overdue"],
                                rows: (overdueItemsData.items || []).map((item: any) => [
                                  item.type === 'task' ? 'Task' : 'Project',
                                  item.name,
                                  item.clientName,
                                  item.projectName || '-',
                                  item.priority || 'N/A',
                                  item.assigneeName || 'Unassigned',
                                  new Date(item.dueDate).toLocaleDateString(),
                                  item.daysOverdue.toString()
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Overdue Items Report",
                              dateRange: { startDate: '', endDate: today.toISOString().split('T')[0] },
                              tables
                            }, firmInfo, "Overdue_Items_Report.pdf");
                          }}
                          data-testid="button-export-pdf-overdue"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!overdueItemsData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const today = new Date();

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Count"],
                                rows: [
                                  ["Total Overdue Items", overdueItemsData.summary?.totalOverdue?.toString() || "0"],
                                  ["Overdue Tasks", overdueItemsData.summary?.overdueTasks?.toString() || "0"],
                                  ["Overdue Projects", overdueItemsData.summary?.overdueProjects?.toString() || "0"],
                                  ["Critically Overdue (>30 days)", overdueItemsData.summary?.criticallyOverdue?.toString() || "0"],
                                  ["Very Overdue (15-30 days)", overdueItemsData.summary?.veryOverdue?.toString() || "0"],
                                  ["Recently Overdue (<15 days)", overdueItemsData.summary?.recentlyOverdue?.toString() || "0"],
                                ]
                              },
                              {
                                title: "All Overdue Items (Sorted by Days Overdue)",
                                headers: ["Type", "Name", "Client", "Project", "Priority", "Assignee", "Due Date", "Days Overdue"],
                                rows: (overdueItemsData.items || []).map((item: any) => [
                                  item.type === 'task' ? 'Task' : 'Project',
                                  item.name,
                                  item.clientName,
                                  item.projectName || '-',
                                  item.priority || 'N/A',
                                  item.assigneeName || 'Unassigned',
                                  new Date(item.dueDate).toLocaleDateString(),
                                  item.daysOverdue.toString()
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Overdue Items Report",
                              dateRange: { startDate: '', endDate: today.toISOString().split('T')[0] },
                              tables
                            }, firmInfo, "Overdue_Items_Report.xlsx");
                          }}
                          data-testid="button-export-excel-overdue"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingOverdueItems && (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <RefreshCw className="w-8 h-8 animate-spin text-red-500 mx-auto mb-4" />
                        <p className="text-gray-500">Loading overdue items...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {overdueItemsError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="flex items-center gap-3 py-4">
                      <AlertTriangle className="w-6 h-6 text-red-600" />
                      <div>
                        <p className="font-semibold text-red-800">Error loading overdue items</p>
                        <p className="text-sm text-red-700">{(overdueItemsError as Error).message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {overdueItemsData && !isLoadingOverdueItems && (
                  <>
                    {/* Critical Alert Banner */}
                    {overdueItemsData.summary?.totalOverdue > 0 && (
                      <Card className="border-4 border-red-500 bg-gradient-to-br from-red-100 to-red-50">
                        <CardContent className="py-6">
                          <div className="flex items-center gap-4">
                            <div className="p-4 bg-red-500 rounded-full">
                              <AlertTriangle className="w-8 h-8 text-white" />
                            </div>
                            <div className="flex-1">
                              <h3 className="text-2xl font-bold text-red-900">
                                {overdueItemsData.summary.totalOverdue} Overdue {overdueItemsData.summary.totalOverdue === 1 ? 'Item' : 'Items'} Requiring Immediate Attention
                              </h3>
                              <p className="text-red-700 mt-1">
                                {overdueItemsData.summary.criticallyOverdue > 0 && (
                                  <span className="font-semibold">{overdueItemsData.summary.criticallyOverdue} critically overdue ({'>'}30 days)</span>
                                )}
                                {overdueItemsData.summary.veryOverdue > 0 && (
                                  <span className="ml-3 font-semibold">{overdueItemsData.summary.veryOverdue} very overdue (15-30 days)</span>
                                )}
                              </p>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Summary Cards - 3 KPIs */}
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <Card className="border-2 border-red-200 bg-gradient-to-br from-red-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Total Overdue</CardTitle>
                          <AlertCircle className="h-5 w-5 text-red-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-red-600">
                            {overdueItemsData.summary?.totalOverdue || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Items past due date</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-orange-200 bg-gradient-to-br from-orange-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Overdue Tasks</CardTitle>
                          <CheckSquare className="h-5 w-5 text-orange-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-orange-600">
                            {overdueItemsData.summary?.overdueTasks || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Tasks requiring action</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Overdue Projects</CardTitle>
                          <Briefcase className="h-5 w-5 text-purple-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-purple-600">
                            {overdueItemsData.summary?.overdueProjects || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Projects behind schedule</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Urgency Breakdown Cards */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Urgency Breakdown</CardTitle>
                        <CardDescription>Items categorized by severity of delay</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          <div className="p-4 bg-gradient-to-br from-red-100 to-red-50 rounded-lg border-2 border-red-300">
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-medium text-red-900">Critically Overdue</span>
                              <AlertTriangle className="w-5 h-5 text-red-600" />
                            </div>
                            <div className="text-3xl font-bold text-red-700">
                              {overdueItemsData.summary?.criticallyOverdue || 0}
                            </div>
                            <p className="text-xs text-red-600 mt-1">{'>'}30 days overdue</p>
                          </div>

                          <div className="p-4 bg-gradient-to-br from-orange-100 to-orange-50 rounded-lg border-2 border-orange-300">
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-medium text-orange-900">Very Overdue</span>
                              <Clock className="w-5 h-5 text-orange-600" />
                            </div>
                            <div className="text-3xl font-bold text-orange-700">
                              {overdueItemsData.summary?.veryOverdue || 0}
                            </div>
                            <p className="text-xs text-orange-600 mt-1">15-30 days overdue</p>
                          </div>

                          <div className="p-4 bg-gradient-to-br from-yellow-100 to-yellow-50 rounded-lg border-2 border-yellow-300">
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-medium text-yellow-900">Recently Overdue</span>
                              <CalendarDays className="w-5 h-5 text-yellow-600" />
                            </div>
                            <div className="text-3xl font-bold text-yellow-700">
                              {overdueItemsData.summary?.recentlyOverdue || 0}
                            </div>
                            <p className="text-xs text-yellow-600 mt-1">{'<'}15 days overdue</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Days Overdue Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Days Overdue Distribution</CardTitle>
                          <CardDescription>Breakdown by overdue duration</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={(overdueItemsData.byDaysOverdue || []).map((bucket: any) => ({
                              name: bucket.range,
                              value: bucket.count
                            }))}
                            xKey="name"
                            yKey="value"
                            title=""
                            color="#dc2626"
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Priority Distribution Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Priority Distribution</CardTitle>
                          <CardDescription>Overdue items by priority level</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <ReportPieChart
                            data={(overdueItemsData.byPriority || []).map((p: any) => ({
                              name: p.priority,
                              value: p.count
                            }))}
                            title=""
                            height={300}
                          />
                        </CardContent>
                      </Card>
                    </div>

                    {/* Overdue Items Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>All Overdue Items</CardTitle>
                        <CardDescription>Complete list sorted by days overdue (most critical first)</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Type</TableHead>
                                <TableHead>Name</TableHead>
                                <TableHead>Client</TableHead>
                                <TableHead>Project</TableHead>
                                <TableHead>Priority</TableHead>
                                <TableHead>Assignee</TableHead>
                                <TableHead>Due Date</TableHead>
                                <TableHead>Days Overdue</TableHead>
                                <TableHead>Actions</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {(overdueItemsData.items || []).map((item: any, index: number) => {
                                const isTask = item.type === 'task';
                                const urgencyColor = item.urgencyLevel === 'critical' ? 'bg-red-900 text-white' :
                                  item.urgencyLevel === 'very' ? 'bg-red-600 text-white' :
                                    'bg-orange-500 text-white';
                                const rowColor = item.urgencyLevel === 'critical' ? 'bg-red-50' :
                                  item.urgencyLevel === 'very' ? 'bg-orange-50' :
                                    'bg-yellow-50';

                                return (
                                  <TableRow key={`overdue-${index}`} className={rowColor}>
                                    <TableCell>
                                      <Badge variant={isTask ? "default" : "secondary"} className="text-xs">
                                        {isTask ? 'üìã Task' : 'üìÅ Project'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell className="font-medium max-w-xs">
                                      {item.name}
                                    </TableCell>
                                    <TableCell>
                                      <div className="flex items-center gap-1">
                                        <Building2 className="w-3 h-3 text-gray-500" />
                                        {item.clientName}
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      {item.projectName || '-'}
                                    </TableCell>
                                    <TableCell>
                                      <Badge className={
                                        item.priority === 'high' || item.priority === 'urgent' ? 'bg-red-100 text-red-800' :
                                          item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                      }>
                                        {item.priority?.toUpperCase() || 'N/A'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      {item.assigneeName ? (
                                        <div className="flex items-center gap-1">
                                          <User className="w-3 h-3 text-gray-500" />
                                          {item.assigneeName}
                                        </div>
                                      ) : (
                                        <span className="text-gray-400 italic">Unassigned</span>
                                      )}
                                    </TableCell>
                                    <TableCell>
                                      {new Date(item.dueDate).toLocaleDateString()}
                                    </TableCell>
                                    <TableCell>
                                      <span className={`px-2 py-1 rounded-md text-xs font-bold ${urgencyColor}`}>
                                        {item.daysOverdue} {item.daysOverdue === 1 ? 'day' : 'days'}
                                      </span>
                                    </TableCell>
                                    <TableCell>
                                      <DropdownMenu>
                                        <DropdownMenuTrigger asChild>
                                          <Button variant="ghost" size="sm">
                                            <MoreHorizontal className="w-4 h-4" />
                                          </Button>
                                        </DropdownMenuTrigger>
                                        <DropdownMenuContent align="end">
                                          <DropdownMenuItem disabled>
                                            <CheckCircle className="w-4 h-4 mr-2" />
                                            Mark Complete
                                          </DropdownMenuItem>
                                          <DropdownMenuItem disabled>
                                            <UserPlus className="w-4 h-4 mr-2" />
                                            Reassign
                                          </DropdownMenuItem>
                                          <DropdownMenuItem disabled>
                                            <Calendar className="w-4 h-4 mr-2" />
                                            Update Due Date
                                          </DropdownMenuItem>
                                        </DropdownMenuContent>
                                      </DropdownMenu>
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                        {(overdueItemsData.items || []).length === 0 && (
                          <div className="text-center py-12">
                            <CheckCircle2 className="w-16 h-16 text-green-500 mx-auto mb-4" />
                            <h3 className="text-lg font-semibold text-gray-900 mb-2">üéâ No Overdue Items!</h3>
                            <p className="text-gray-600">All tasks and projects are on track or completed.</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Individual Performance Dashboard */}
            {reportTab === 'individual-performance' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üë§ Individual Performance Dashboard</CardTitle>
                        <CardDescription>Staff metrics, billable hours, and efficiency tracking</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Select
                          value={individualPerformanceStaffFilter}
                          onValueChange={setIndividualPerformanceStaffFilter}
                        >
                          <SelectTrigger className="w-48" data-testid="select-staff-filter">
                            <SelectValue placeholder="All Staff" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="">All Staff</SelectItem>
                            {users.map((user: any) => (
                              <SelectItem key={user.id} value={user.id.toString()}>
                                {user.name || user.email}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={individualPerformanceStartDate}
                            onChange={(e) => setIndividualPerformanceStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-performance-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={individualPerformanceEndDate}
                            onChange={(e) => setIndividualPerformanceEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-performance-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={refetchIndividualPerformance}
                          data-testid="button-refresh-performance"
                        >
                          <RefreshCw className="w-4 h-4 mr-2" />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingIndividualPerformance && (
                  <Card>
                    <CardContent className="py-12">
                      <div className="flex flex-col items-center justify-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p className="text-gray-600">Loading performance data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {individualPerformanceError && (
                  <Card>
                    <CardContent className="py-8">
                      <div className="text-center text-red-600">
                        <AlertTriangle className="w-12 h-12 mx-auto mb-4" />
                        <p className="font-semibold">Error loading performance data</p>
                        <p className="text-sm mt-2">{(individualPerformanceError as Error).message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {!isLoadingIndividualPerformance && !individualPerformanceError && individualPerformanceData && (
                  <>
                    {/* Individual View - Selected Staff Member */}
                    {individualPerformanceData.individual && (
                      <div className="space-y-6">
                        {/* KPI Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                          <Card>
                            <CardHeader className="pb-3">
                              <CardDescription>Total Hours Worked</CardDescription>
                              <CardTitle className="text-3xl font-bold">
                                {individualPerformanceData.individual.totalHours.toFixed(1)}
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="flex items-center text-sm text-gray-600">
                                <Clock className="w-4 h-4 mr-1" />
                                All time entries
                              </div>
                            </CardContent>
                          </Card>

                          <Card>
                            <CardHeader className="pb-3">
                              <CardDescription>Billable Hours</CardDescription>
                              <CardTitle className="text-3xl font-bold text-green-600">
                                {individualPerformanceData.individual.billableHours.toFixed(1)}
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="flex items-center text-sm text-gray-600">
                                <DollarSign className="w-4 h-4 mr-1" />
                                {individualPerformanceData.individual.billablePercentage.toFixed(1)}% of total
                              </div>
                            </CardContent>
                          </Card>

                          <Card>
                            <CardHeader className="pb-3">
                              <CardDescription>Revenue Generated</CardDescription>
                              <CardTitle className="text-3xl font-bold text-blue-600">
                                ${individualPerformanceData.individual.revenueGenerated.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="flex items-center text-sm text-gray-600">
                                <TrendingUp className="w-4 h-4 mr-1" />
                                Billable revenue
                              </div>
                            </CardContent>
                          </Card>

                          <Card>
                            <CardHeader className="pb-3">
                              <CardDescription>Tasks Completed</CardDescription>
                              <CardTitle className="text-3xl font-bold">
                                {individualPerformanceData.individual.tasksCompleted}
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="flex items-center text-sm text-gray-600">
                                <CheckCircle className="w-4 h-4 mr-1" />
                                {individualPerformanceData.individual.completionRate.toFixed(1)}% completion
                              </div>
                            </CardContent>
                          </Card>

                          <Card className={
                            individualPerformanceData.individual.utilizationRate >= 80 ? 'border-green-500 bg-green-50' :
                              individualPerformanceData.individual.utilizationRate >= 60 ? 'border-yellow-500 bg-yellow-50' :
                                'border-red-500 bg-red-50'
                          }>
                            <CardHeader className="pb-3">
                              <CardDescription>Utilization Rate</CardDescription>
                              <CardTitle className={`text-3xl font-bold ${individualPerformanceData.individual.utilizationRate >= 80 ? 'text-green-600' :
                                individualPerformanceData.individual.utilizationRate >= 60 ? 'text-yellow-600' :
                                  'text-red-600'
                                }`}>
                                {individualPerformanceData.individual.utilizationRate.toFixed(1)}%
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="flex items-center text-sm text-gray-600">
                                <Activity className="w-4 h-4 mr-1" />
                                Billable efficiency
                              </div>
                            </CardContent>
                          </Card>
                        </div>

                        {/* Performance Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                          <ReportPieChart
                            data={[
                              { name: 'Billable', value: individualPerformanceData.individual.billableHours },
                              { name: 'Non-Billable', value: individualPerformanceData.individual.nonBillableHours }
                            ]}
                            title="Billable vs Non-Billable Hours"
                            height={300}
                            isLoading={false}
                          />

                          <div className="lg:col-span-2">
                            <ReportLineChart
                              data={individualPerformanceData.individual.dailyHours.map((item: any) => ({
                                date: new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                                Billable: item.billable,
                                'Non-Billable': item.nonBillable
                              }))}
                              xKey="date"
                              yKey={['Billable', 'Non-Billable']}
                              title="Hours Worked Over Time"
                              colors={['#10b981', '#f59e0b']}
                              height={300}
                            />
                          </div>
                        </div>

                        <ReportBarChart
                          data={individualPerformanceData.individual.tasksOverTime.map((item: any) => ({
                            date: new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                            completed: item.completed
                          }))}
                          xKey="date"
                          yKey="completed"
                          title="Tasks Completed Over Time"
                          height={300}
                        />

                        {/* Team Comparison */}
                        <Card>
                          <CardHeader>
                            <CardTitle>Comparison to Team Average</CardTitle>
                            <CardDescription>How this staff member compares to the team</CardDescription>
                          </CardHeader>
                          <CardContent>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                              <div className="p-4 border rounded-lg">
                                <div className="text-sm text-gray-600 mb-2">Billable Hours</div>
                                <div className="flex items-center gap-2">
                                  <div className="text-2xl font-bold">
                                    {individualPerformanceData.individual.billableHours.toFixed(1)}
                                  </div>
                                  <div className={`text-sm ${individualPerformanceData.individual.billableHours >= individualPerformanceData.teamAverages.avgBillableHours
                                    ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                    {individualPerformanceData.individual.billableHours >= individualPerformanceData.teamAverages.avgBillableHours ? '‚ñ≤' : '‚ñº'}
                                    {Math.abs(((individualPerformanceData.individual.billableHours / individualPerformanceData.teamAverages.avgBillableHours - 1) * 100)).toFixed(1)}%
                                  </div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  Team avg: {individualPerformanceData.teamAverages.avgBillableHours.toFixed(1)}
                                </div>
                              </div>

                              <div className="p-4 border rounded-lg">
                                <div className="text-sm text-gray-600 mb-2">Utilization Rate</div>
                                <div className="flex items-center gap-2">
                                  <div className="text-2xl font-bold">
                                    {individualPerformanceData.individual.utilizationRate.toFixed(1)}%
                                  </div>
                                  <div className={`text-sm ${individualPerformanceData.individual.utilizationRate >= individualPerformanceData.teamAverages.avgUtilizationRate
                                    ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                    {individualPerformanceData.individual.utilizationRate >= individualPerformanceData.teamAverages.avgUtilizationRate ? '‚ñ≤' : '‚ñº'}
                                    {Math.abs(individualPerformanceData.individual.utilizationRate - individualPerformanceData.teamAverages.avgUtilizationRate).toFixed(1)}%
                                  </div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  Team avg: {individualPerformanceData.teamAverages.avgUtilizationRate.toFixed(1)}%
                                </div>
                              </div>

                              <div className="p-4 border rounded-lg">
                                <div className="text-sm text-gray-600 mb-2">Tasks Completed</div>
                                <div className="flex items-center gap-2">
                                  <div className="text-2xl font-bold">
                                    {individualPerformanceData.individual.tasksCompleted}
                                  </div>
                                  <div className={`text-sm ${individualPerformanceData.individual.tasksCompleted >= individualPerformanceData.teamAverages.avgTasksCompleted
                                    ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                    {individualPerformanceData.individual.tasksCompleted >= individualPerformanceData.teamAverages.avgTasksCompleted ? '‚ñ≤' : '‚ñº'}
                                    {Math.abs(((individualPerformanceData.individual.tasksCompleted / individualPerformanceData.teamAverages.avgTasksCompleted - 1) * 100)).toFixed(1)}%
                                  </div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  Team avg: {individualPerformanceData.teamAverages.avgTasksCompleted.toFixed(1)}
                                </div>
                              </div>

                              <div className="p-4 border rounded-lg">
                                <div className="text-sm text-gray-600 mb-2">Revenue Generated</div>
                                <div className="flex items-center gap-2">
                                  <div className="text-2xl font-bold">
                                    ${individualPerformanceData.individual.revenueGenerated.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                  </div>
                                  <div className={`text-sm ${individualPerformanceData.individual.revenueGenerated >= individualPerformanceData.teamAverages.avgRevenueGenerated
                                    ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                    {individualPerformanceData.individual.revenueGenerated >= individualPerformanceData.teamAverages.avgRevenueGenerated ? '‚ñ≤' : '‚ñº'}
                                    {Math.abs(((individualPerformanceData.individual.revenueGenerated / individualPerformanceData.teamAverages.avgRevenueGenerated - 1) * 100)).toFixed(1)}%
                                  </div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  Team avg: ${individualPerformanceData.teamAverages.avgRevenueGenerated.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                </div>
                              </div>
                            </div>
                          </CardContent>
                        </Card>

                        {/* Export Buttons for Individual View */}
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={async () => {
                              const firmInfo: FirmInfo = {
                                name: "Your Accounting Firm",
                                address: "123 Main St, City, State",
                                phone: "(555) 123-4567",
                                email: "info@yourfirm.com"
                              };

                              const tables: TableData[] = [
                                {
                                  title: `Performance Summary - ${individualPerformanceData.individual.staffName}`,
                                  headers: ["Metric", "Value"],
                                  rows: [
                                    ["Total Hours", individualPerformanceData.individual.totalHours.toFixed(1)],
                                    ["Billable Hours", individualPerformanceData.individual.billableHours.toFixed(1)],
                                    ["Billable %", individualPerformanceData.individual.billablePercentage.toFixed(1) + '%'],
                                    ["Revenue Generated", '$' + individualPerformanceData.individual.revenueGenerated.toFixed(2)],
                                    ["Tasks Completed", individualPerformanceData.individual.tasksCompleted.toString()],
                                    ["Completion Rate", individualPerformanceData.individual.completionRate.toFixed(1) + '%'],
                                    ["Utilization Rate", individualPerformanceData.individual.utilizationRate.toFixed(1) + '%'],
                                    ["Avg Time per Task", individualPerformanceData.individual.avgTimePerTask.toFixed(1) + ' hours']
                                  ]
                                }
                              ];

                              await exportReportToPDF({
                                title: "Individual Performance Report",
                                dateRange: { startDate: individualPerformanceStartDate, endDate: individualPerformanceEndDate },
                                tables
                              }, firmInfo, `Individual_Performance_${individualPerformanceData.individual.staffName.replace(/\s+/g, '_')}.pdf`);
                            }}
                            data-testid="button-export-pdf-individual"
                          >
                            <FileTextIcon className="w-4 h-4 mr-2" />
                            Export PDF
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              const firmInfo: FirmInfo = {
                                name: "Your Accounting Firm",
                                address: "123 Main St, City, State",
                                phone: "(555) 123-4567",
                                email: "info@yourfirm.com"
                              };

                              const tables: TableData[] = [
                                {
                                  title: `Performance Summary - ${individualPerformanceData.individual.staffName}`,
                                  headers: ["Metric", "Value"],
                                  rows: [
                                    ["Total Hours", individualPerformanceData.individual.totalHours.toFixed(1)],
                                    ["Billable Hours", individualPerformanceData.individual.billableHours.toFixed(1)],
                                    ["Billable %", individualPerformanceData.individual.billablePercentage.toFixed(1) + '%'],
                                    ["Revenue Generated", '$' + individualPerformanceData.individual.revenueGenerated.toFixed(2)],
                                    ["Tasks Completed", individualPerformanceData.individual.tasksCompleted.toString()],
                                    ["Completion Rate", individualPerformanceData.individual.completionRate.toFixed(1) + '%'],
                                    ["Utilization Rate", individualPerformanceData.individual.utilizationRate.toFixed(1) + '%'],
                                    ["Avg Time per Task", individualPerformanceData.individual.avgTimePerTask.toFixed(1) + ' hours']
                                  ]
                                }
                              ];

                              exportReportToExcel({
                                title: "Individual Performance Report",
                                dateRange: { startDate: individualPerformanceStartDate, endDate: individualPerformanceEndDate },
                                tables
                              }, firmInfo, `Individual_Performance_${individualPerformanceData.individual.staffName.replace(/\s+/g, '_')}.xlsx`);
                            }}
                            data-testid="button-export-excel-individual"
                          >
                            <FileSpreadsheet className="w-4 h-4 mr-2" />
                            Export Excel
                          </Button>
                        </div>
                      </div>
                    )}

                    {/* All Staff View - Performance Table */}
                    {individualPerformanceData.allStaff && (
                      <div className="space-y-6">
                        <Card>
                          <CardHeader>
                            <div className="flex justify-between items-center">
                              <div>
                                <CardTitle>All Staff Performance</CardTitle>
                                <CardDescription>Sorted by utilization rate (highest first)</CardDescription>
                              </div>
                              <div className="flex gap-2">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={async () => {
                                    const firmInfo: FirmInfo = {
                                      name: "Your Accounting Firm",
                                      address: "123 Main St, City, State",
                                      phone: "(555) 123-4567",
                                      email: "info@yourfirm.com"
                                    };

                                    const tables: TableData[] = [
                                      {
                                        title: "All Staff Performance",
                                        headers: ["Staff Name", "Total Hours", "Billable Hours", "Billable %", "Revenue", "Tasks", "Utilization %", "Avg Time/Task"],
                                        rows: (individualPerformanceData?.allStaff || []).map((staff: any) => [
                                          staff.staffName || '',
                                          (staff.totalHours || 0).toFixed(1),
                                          (staff.billableHours || 0).toFixed(1),
                                          (staff.billablePercentage || 0).toFixed(1) + '%',
                                          '$' + (staff.revenueGenerated || 0).toFixed(2),
                                          (staff.tasksCompleted || 0).toString(),
                                          (staff.utilizationRate || 0).toFixed(1) + '%',
                                          (staff.avgTimePerTask || 0).toFixed(1) + ' hrs'
                                        ])
                                      }
                                    ];

                                    await exportReportToPDF({
                                      title: "All Staff Performance Report",
                                      dateRange: { startDate: individualPerformanceStartDate, endDate: individualPerformanceEndDate },
                                      tables
                                    }, firmInfo, "All_Staff_Performance.pdf");
                                  }}
                                  data-testid="button-export-pdf-all-staff"
                                >
                                  <FileTextIcon className="w-4 h-4 mr-2" />
                                  Export PDF
                                </Button>
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => {
                                    const firmInfo: FirmInfo = {
                                      name: "Your Accounting Firm",
                                      address: "123 Main St, City, State",
                                      phone: "(555) 123-4567",
                                      email: "info@yourfirm.com"
                                    };

                                    const tables: TableData[] = [
                                      {
                                        title: "All Staff Performance",
                                        headers: ["Staff Name", "Total Hours", "Billable Hours", "Billable %", "Revenue", "Tasks", "Utilization %", "Avg Time/Task"],
                                        rows: (individualPerformanceData?.allStaff || []).map((staff: any) => [
                                          staff.staffName || '',
                                          (staff.totalHours || 0).toFixed(1),
                                          (staff.billableHours || 0).toFixed(1),
                                          (staff.billablePercentage || 0).toFixed(1) + '%',
                                          '$' + (staff.revenueGenerated || 0).toFixed(2),
                                          (staff.tasksCompleted || 0).toString(),
                                          (staff.utilizationRate || 0).toFixed(1) + '%',
                                          (staff.avgTimePerTask || 0).toFixed(1) + ' hrs'
                                        ])
                                      }
                                    ];

                                    exportReportToExcel({
                                      title: "All Staff Performance Report",
                                      dateRange: { startDate: individualPerformanceStartDate, endDate: individualPerformanceEndDate },
                                      tables
                                    }, firmInfo, "All_Staff_Performance.xlsx");
                                  }}
                                  data-testid="button-export-excel-all-staff"
                                >
                                  <FileSpreadsheet className="w-4 h-4 mr-2" />
                                  Export Excel
                                </Button>
                              </div>
                            </div>
                          </CardHeader>
                          <CardContent>
                            <div className="overflow-x-auto">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead>Staff Name</TableHead>
                                    <TableHead className="text-right">Total Hours</TableHead>
                                    <TableHead className="text-right">Billable Hours</TableHead>
                                    <TableHead className="text-right">Billable %</TableHead>
                                    <TableHead className="text-right">Revenue Generated</TableHead>
                                    <TableHead className="text-right">Tasks Completed</TableHead>
                                    <TableHead className="text-right">Utilization Rate</TableHead>
                                    <TableHead className="text-right">Avg Time/Task</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {(individualPerformanceData?.allStaff || []).map((staff: any) => {
                                    const utilizationClass =
                                      staff.utilizationRate >= 80 ? 'bg-green-50' :
                                        staff.utilizationRate >= 60 ? 'bg-yellow-50' :
                                          'bg-red-50';
                                    const utilizationTextClass =
                                      staff.utilizationRate >= 80 ? 'text-green-700 font-bold' :
                                        staff.utilizationRate >= 60 ? 'text-yellow-700 font-semibold' :
                                          'text-red-700 font-bold';

                                    return (
                                      <TableRow key={staff.staffId} className={utilizationClass}>
                                        <TableCell className="font-medium">
                                          <div className="flex items-center gap-2">
                                            <User className="w-4 h-4 text-gray-500" />
                                            {staff.staffName}
                                          </div>
                                        </TableCell>
                                        <TableCell className="text-right">{staff.totalHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right font-semibold text-green-700">
                                          {staff.billableHours.toFixed(1)}
                                        </TableCell>
                                        <TableCell className="text-right">{staff.billablePercentage.toFixed(1)}%</TableCell>
                                        <TableCell className="text-right font-semibold text-blue-700">
                                          ${staff.revenueGenerated.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                        </TableCell>
                                        <TableCell className="text-right">{staff.tasksCompleted}</TableCell>
                                        <TableCell className={`text-right ${utilizationTextClass}`}>
                                          {staff.utilizationRate.toFixed(1)}%
                                        </TableCell>
                                        <TableCell className="text-right">{staff.avgTimePerTask.toFixed(1)} hrs</TableCell>
                                      </TableRow>
                                    );
                                  })}
                                </TableBody>
                              </Table>
                            </div>

                            {/* Team Averages Row */}
                            <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                              <div className="font-semibold text-blue-900 mb-3">Team Averages</div>
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                  <div className="text-gray-600">Avg Billable Hours</div>
                                  <div className="text-lg font-bold text-blue-900">
                                    {individualPerformanceData.teamAverages.avgBillableHours.toFixed(1)}
                                  </div>
                                </div>
                                <div>
                                  <div className="text-gray-600">Avg Utilization</div>
                                  <div className="text-lg font-bold text-blue-900">
                                    {individualPerformanceData.teamAverages.avgUtilizationRate.toFixed(1)}%
                                  </div>
                                </div>
                                <div>
                                  <div className="text-gray-600">Avg Tasks</div>
                                  <div className="text-lg font-bold text-blue-900">
                                    {individualPerformanceData.teamAverages.avgTasksCompleted.toFixed(1)}
                                  </div>
                                </div>
                                <div>
                                  <div className="text-gray-600">Avg Revenue</div>
                                  <div className="text-lg font-bold text-blue-900">
                                    ${individualPerformanceData.teamAverages.avgRevenueGenerated.toLocaleString('en-US', { maximumFractionDigits: 0 })}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      </div>
                    )}
                  </>
                )}
              </div>
            )}

            {/* Team Capacity Dashboard */}
            {reportTab === 'team-capacity' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üë• Team Capacity Dashboard</CardTitle>
                        <CardDescription>Workload distribution and availability forecasting</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2">
                          <Button
                            variant={teamCapacityForecastDays === 30 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setTeamCapacityForecastDays(30)}
                            data-testid="button-forecast-30-days"
                          >
                            30 Days
                          </Button>
                          <Button
                            variant={teamCapacityForecastDays === 60 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setTeamCapacityForecastDays(60)}
                            data-testid="button-forecast-60-days"
                          >
                            60 Days
                          </Button>
                          <Button
                            variant={teamCapacityForecastDays === 90 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setTeamCapacityForecastDays(90)}
                            data-testid="button-forecast-90-days"
                          >
                            90 Days
                          </Button>
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchTeamCapacity()}
                          disabled={isLoadingTeamCapacity}
                          data-testid="button-refresh-team-capacity"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingTeamCapacity ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingTeamCapacity ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="flex flex-col items-center justify-center text-gray-500">
                        <RefreshCw className="w-8 h-8 animate-spin mb-2" />
                        <p>Loading team capacity data...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : teamCapacityError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="flex flex-col items-center justify-center text-red-500">
                        <AlertCircle className="w-8 h-8 mb-2" />
                        <p>Error loading team capacity data</p>
                        <p className="text-sm text-gray-500 mt-1">{teamCapacityError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : teamCapacityData ? (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <Card data-testid="card-total-capacity">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Total Team Capacity</CardTitle>
                          <Users className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{teamCapacityData.summary.totalCapacity.toFixed(0)} hrs/week</div>
                          <p className="text-xs text-muted-foreground">
                            {teamCapacityData.staffCapacity.length} team members
                          </p>
                        </CardContent>
                      </Card>

                      <Card data-testid="card-current-utilization">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Current Utilization</CardTitle>
                          <Activity className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{teamCapacityData.summary.totalUtilization.toFixed(1)}%</div>
                          <Progress
                            value={teamCapacityData.summary.totalUtilization}
                            className="mt-2"
                          />
                        </CardContent>
                      </Card>

                      <Card data-testid="card-available-capacity">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Available Capacity</CardTitle>
                          <CheckCircle className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">
                            {teamCapacityData.summary.availableCapacity.toFixed(0)} hrs/week
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {teamCapacityData.capacityDistribution.available} staff available
                          </p>
                        </CardContent>
                      </Card>

                      <Card data-testid="card-overloaded-staff" className={teamCapacityData.summary.overloadedCount > 0 ? "border-red-500" : ""}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Overloaded Staff</CardTitle>
                          <AlertTriangle className={`h-4 w-4 ${teamCapacityData.summary.overloadedCount > 0 ? 'text-red-500' : 'text-muted-foreground'}`} />
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${teamCapacityData.summary.overloadedCount > 0 ? 'text-red-600' : 'text-gray-600'}`}>
                            {teamCapacityData.summary.overloadedCount}
                          </div>
                          <p className="text-xs text-muted-foreground">
                            {teamCapacityData.capacityDistribution.atCapacity} at capacity
                          </p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Capacity Status Distribution Pie Chart */}
                      <ReportPieChart
                        data={[
                          { name: 'Overloaded', value: teamCapacityData.capacityDistribution.overloaded },
                          { name: 'At Capacity', value: teamCapacityData.capacityDistribution.atCapacity },
                          { name: 'Available', value: teamCapacityData.capacityDistribution.available }
                        ]}
                        title="Capacity Status Distribution"
                        colors={['#ef4444', '#f59e0b', '#10b981']}
                        isLoading={false}
                      />

                      {/* Workload Distribution Bar Chart */}
                      <ReportBarChart
                        data={teamCapacityData.staffCapacity.map((staff: any) => ({
                          name: staff.staffName,
                          value: staff.currentWorkload,
                          status: staff.status
                        }))}
                        xKey="name"
                        yKey="value"
                        title="Current Workload by Staff (hours)"
                        colors={['#3b82f6']}
                        isLoading={false}
                      />
                    </div>

                    {/* Team Capacity Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                          <div>
                            <CardTitle>Team Capacity Details</CardTitle>
                            <CardDescription>Staff workload and availability breakdown</CardDescription>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={async () => {
                                const firmInfo: FirmInfo = {
                                  name: "Your Accounting Firm",
                                  address: "123 Main St, City, State",
                                  phone: "(555) 123-4567",
                                  email: "info@yourfirm.com"
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Team Capacity Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Team Capacity", teamCapacityData.summary.totalCapacity.toFixed(0) + " hrs/week"],
                                      ["Current Utilization", teamCapacityData.summary.totalUtilization.toFixed(1) + "%"],
                                      ["Available Capacity", teamCapacityData.summary.availableCapacity.toFixed(0) + " hrs/week"],
                                      ["Overloaded Staff", teamCapacityData.summary.overloadedCount.toString()],
                                      ["Staff at Capacity", teamCapacityData.capacityDistribution.atCapacity.toString()],
                                      ["Available Staff", teamCapacityData.capacityDistribution.available.toString()]
                                    ]
                                  },
                                  {
                                    title: "Staff Capacity Details",
                                    headers: ["Staff Name", "Current Workload", "Weekly Capacity", "Available Capacity", "Utilization %", "Status", "Open Tasks"],
                                    rows: teamCapacityData.staffCapacity.map((staff: any) => [
                                      staff.staffName,
                                      staff.currentWorkload.toFixed(1) + " hrs",
                                      staff.weeklyCapacity.toFixed(0) + " hrs",
                                      staff.availableCapacity.toFixed(1) + " hrs",
                                      staff.utilizationPercent.toFixed(1) + "%",
                                      staff.status,
                                      staff.openTasksCount.toString()
                                    ])
                                  }
                                ];

                                await exportReportToPDF({
                                  title: "Team Capacity Report",
                                  dateRange: { startDate: format(new Date(), 'yyyy-MM-dd'), endDate: format(addDays(new Date(), teamCapacityForecastDays), 'yyyy-MM-dd') },
                                  tables
                                }, firmInfo, `Team_Capacity_${teamCapacityForecastDays}days.pdf`);
                              }}
                              data-testid="button-export-pdf-capacity"
                            >
                              <FileTextIcon className="w-4 h-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const firmInfo: FirmInfo = {
                                  name: "Your Accounting Firm",
                                  address: "123 Main St, City, State",
                                  phone: "(555) 123-4567",
                                  email: "info@yourfirm.com"
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Team Capacity Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Team Capacity", teamCapacityData.summary.totalCapacity.toFixed(0) + " hrs/week"],
                                      ["Current Utilization", teamCapacityData.summary.totalUtilization.toFixed(1) + "%"],
                                      ["Available Capacity", teamCapacityData.summary.availableCapacity.toFixed(0) + " hrs/week"],
                                      ["Overloaded Staff", teamCapacityData.summary.overloadedCount.toString()],
                                      ["Staff at Capacity", teamCapacityData.capacityDistribution.atCapacity.toString()],
                                      ["Available Staff", teamCapacityData.capacityDistribution.available.toString()]
                                    ]
                                  },
                                  {
                                    title: "Staff Capacity Details",
                                    headers: ["Staff Name", "Current Workload", "Weekly Capacity", "Available Capacity", "Utilization %", "Status", "Open Tasks"],
                                    rows: teamCapacityData.staffCapacity.map((staff: any) => [
                                      staff.staffName,
                                      staff.currentWorkload.toFixed(1) + " hrs",
                                      staff.weeklyCapacity.toFixed(0) + " hrs",
                                      staff.availableCapacity.toFixed(1) + " hrs",
                                      staff.utilizationPercent.toFixed(1) + "%",
                                      staff.status,
                                      staff.openTasksCount.toString()
                                    ])
                                  },
                                  {
                                    title: "Weekly Forecast",
                                    headers: ["Week Starting", "Total Scheduled Work", "Available Capacity", "Utilization %"],
                                    rows: teamCapacityData.weeklyForecast.map((week: any) => [
                                      week.weekStart,
                                      week.totalScheduledWork.toFixed(1) + " hrs",
                                      week.totalAvailableCapacity.toFixed(1) + " hrs",
                                      week.capacityUtilization.toFixed(1) + "%"
                                    ])
                                  }
                                ];

                                exportReportToExcel({
                                  title: "Team Capacity Report",
                                  dateRange: { startDate: format(new Date(), 'yyyy-MM-dd'), endDate: format(addDays(new Date(), teamCapacityForecastDays), 'yyyy-MM-dd') },
                                  tables
                                }, firmInfo, `Team_Capacity_${teamCapacityForecastDays}days.xlsx`);
                              }}
                              data-testid="button-export-excel-capacity"
                            >
                              <FileSpreadsheet className="w-4 h-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Staff Name</TableHead>
                                <TableHead className="text-right">Current Workload</TableHead>
                                <TableHead className="text-right">Weekly Capacity</TableHead>
                                <TableHead className="text-right">Available Capacity</TableHead>
                                <TableHead className="text-right">Utilization %</TableHead>
                                <TableHead>Status</TableHead>
                                <TableHead className="text-right">Open Tasks</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {teamCapacityData.staffCapacity.map((staff: any, index: number) => {
                                const rowClass =
                                  staff.status === 'overloaded' ? 'bg-red-50' :
                                    staff.status === 'at_capacity' ? 'bg-yellow-50' :
                                      'bg-green-50';
                                const statusBadge =
                                  staff.status === 'overloaded' ? (
                                    <Badge variant="destructive">Overloaded</Badge>
                                  ) : staff.status === 'at_capacity' ? (
                                    <Badge className="bg-yellow-500">At Capacity</Badge>
                                  ) : (
                                    <Badge className="bg-green-500">Available</Badge>
                                  );

                                return (
                                  <TableRow key={index} className={rowClass} data-testid={`row-staff-${index}`}>
                                    <TableCell className="font-medium">{staff.staffName}</TableCell>
                                    <TableCell className="text-right">{staff.currentWorkload.toFixed(1)} hrs</TableCell>
                                    <TableCell className="text-right">{staff.weeklyCapacity.toFixed(0)} hrs</TableCell>
                                    <TableCell className="text-right">{staff.availableCapacity.toFixed(1)} hrs</TableCell>
                                    <TableCell className="text-right font-bold">{staff.utilizationPercent.toFixed(1)}%</TableCell>
                                    <TableCell>{statusBadge}</TableCell>
                                    <TableCell className="text-right">{staff.openTasksCount}</TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Capacity Forecast Chart */}
                    <ReportLineChart
                      data={teamCapacityData.weeklyForecast.map((week: any) => ({
                        week: week.weekStart,
                        'Available Capacity': week.totalAvailableCapacity,
                        'Scheduled Work': week.totalScheduledWork
                      }))}
                      xKey="week"
                      yKey={['Available Capacity', 'Scheduled Work']}
                      title={`Team Capacity Forecast (Next ${teamCapacityForecastDays} Days)`}
                      colors={['#10b981', '#3b82f6']}
                      isLoading={false}
                      height={300}
                    />

                    {/* Recommendations Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle>üí° Recommendations</CardTitle>
                        <CardDescription>Workload balancing opportunities</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-6">
                          {teamCapacityData.recommendations.overloadedStaff.length > 0 && (
                            <div>
                              <h4 className="font-semibold text-red-700 mb-3 flex items-center gap-2">
                                <AlertTriangle className="w-5 h-5" />
                                Overloaded Staff (Needs Support)
                              </h4>
                              <div className="space-y-2">
                                {teamCapacityData.recommendations.overloadedStaff.map((staff: any, index: number) => (
                                  <div key={index} className="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                                    <div className="flex items-center gap-3">
                                      <User className="w-5 h-5 text-red-600" />
                                      <div>
                                        <div className="font-medium text-red-900">{staff.staffName}</div>
                                        <div className="text-sm text-red-700">Excess: {staff.excessHours.toFixed(1)} hours over capacity</div>
                                      </div>
                                    </div>
                                    <Badge variant="destructive">Action Needed</Badge>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {teamCapacityData.recommendations.availableStaff.length > 0 && (
                            <div>
                              <h4 className="font-semibold text-green-700 mb-3 flex items-center gap-2">
                                <CheckCircle className="w-5 h-5" />
                                Available Staff (Can Take More Work)
                              </h4>
                              <div className="space-y-2">
                                {teamCapacityData.recommendations.availableStaff.slice(0, 5).map((staff: any, index: number) => (
                                  <div key={index} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div className="flex items-center gap-3">
                                      <UserCheck className="w-5 h-5 text-green-600" />
                                      <div>
                                        <div className="font-medium text-green-900">{staff.staffName}</div>
                                        <div className="text-sm text-green-700">Available: {staff.availableHours.toFixed(1)} hours</div>
                                      </div>
                                    </div>
                                    <Badge className="bg-green-500">Ready for Tasks</Badge>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {teamCapacityData.recommendations.overloadedStaff.length === 0 &&
                            teamCapacityData.recommendations.availableStaff.length === 0 && (
                              <div className="text-center py-8 text-gray-500">
                                <CheckCircle className="w-12 h-12 mx-auto mb-3 text-green-500" />
                                <p className="font-medium">Team capacity is well balanced!</p>
                                <p className="text-sm mt-1">All staff members are within optimal capacity range.</p>
                              </div>
                            )}
                        </div>
                      </CardContent>
                    </Card>
                  </>
                ) : null}
              </div>
            )}

            {/* Utilization Report */}
            {reportTab === 'utilization' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üìä Utilization Report</CardTitle>
                        <CardDescription>Billable vs non-billable time breakdown and utilization analysis</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {/* Date Range Picker */}
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={utilizationStartDate}
                            onChange={(e) => setUtilizationStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-utilization-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={utilizationEndDate}
                            onChange={(e) => setUtilizationEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-utilization-end-date"
                          />
                        </div>

                        {/* Group By Selector */}
                        <Select value={utilizationGroupBy} onValueChange={(value: any) => setUtilizationGroupBy(value)}>
                          <SelectTrigger className="w-40" data-testid="select-utilization-groupby">
                            <SelectValue placeholder="Group By" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="staff">By Staff</SelectItem>
                            <SelectItem value="project">By Project</SelectItem>
                            <SelectItem value="client">By Client</SelectItem>
                            <SelectItem value="date">By Week</SelectItem>
                          </SelectContent>
                        </Select>

                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchUtilization()}
                          disabled={isLoadingUtilization}
                          data-testid="button-refresh-utilization"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingUtilization ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingUtilization ? (
                  <Card>
                    <CardContent className="p-12">
                      <div className="flex flex-col items-center justify-center space-y-4">
                        <RefreshCw className="w-12 h-12 animate-spin text-blue-500" />
                        <p className="text-lg font-medium text-gray-700">Loading utilization data...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : utilizationError ? (
                  <Card>
                    <CardContent className="p-12">
                      <div className="flex flex-col items-center justify-center space-y-4">
                        <AlertTriangle className="w-12 h-12 text-red-500" />
                        <p className="text-lg font-medium text-red-700">Failed to load utilization data</p>
                        <Button variant="outline" onClick={() => refetchUtilization()}>
                          Try Again
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                ) : utilizationData ? (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm text-gray-600">Total Hours Tracked</p>
                              <p className="text-3xl font-bold text-gray-900 mt-2">{utilizationData.summary.totalHours.toFixed(1)}</p>
                            </div>
                            <Clock className="w-12 h-12 text-blue-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm text-gray-600">Billable Hours</p>
                              <p className="text-3xl font-bold text-green-600 mt-2">{utilizationData.summary.billableHours.toFixed(1)}</p>
                            </div>
                            <DollarSign className="w-12 h-12 text-green-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm text-gray-600">Non-Billable Hours</p>
                              <p className="text-3xl font-bold text-gray-600 mt-2">{utilizationData.summary.nonBillableHours.toFixed(1)}</p>
                            </div>
                            <Activity className="w-12 h-12 text-gray-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm text-gray-600">Overall Utilization</p>
                              <p className={`text-3xl font-bold mt-2 ${utilizationData.summary.overallUtilization >= 70 ? 'text-green-600' :
                                utilizationData.summary.overallUtilization >= 50 ? 'text-yellow-600' :
                                  'text-red-600'
                                }`}>
                                {utilizationData.summary.overallUtilization.toFixed(1)}%
                              </p>
                            </div>
                            <TrendingUp className={`w-12 h-12 opacity-20 ${utilizationData.summary.overallUtilization >= 70 ? 'text-green-500' :
                              utilizationData.summary.overallUtilization >= 50 ? 'text-yellow-500' :
                                'text-red-500'
                              }`} />
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Utilization Breakdown Chart - Stacked Bar */}
                    <ReportBarChart
                      data={utilizationData.breakdown.map((item: any) => ({
                        name: item.groupName,
                        'Billable Hours': item.billableHours,
                        'Non-Billable Hours': item.nonBillableHours
                      }))}
                      xKey="name"
                      yKey={['Billable Hours', 'Non-Billable Hours']}
                      title={`Utilization Breakdown by ${utilizationGroupBy === 'staff' ? 'Staff' : utilizationGroupBy === 'project' ? 'Project' : utilizationGroupBy === 'client' ? 'Client' : 'Week'}`}
                      colors={['#10b981', '#6b7280']}
                      isLoading={false}
                      height={350}
                    />

                    {/* Utilization Trend Chart - Line Chart */}
                    <ReportLineChart
                      data={utilizationData.trends.weekly.map((week: any) => ({
                        week: week.week,
                        'Utilization %': week.utilization,
                        'Billable Hours': week.billableHours,
                        'Non-Billable Hours': week.nonBillableHours
                      }))}
                      xKey="week"
                      yKey={['Utilization %']}
                      title="Utilization Trend (Weekly)"
                      colors={['#3b82f6']}
                      isLoading={false}
                      height={300}
                    />

                    {/* Detailed Utilization Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex justify-between items-center">
                          <div>
                            <CardTitle>Detailed Breakdown</CardTitle>
                            <CardDescription>
                              {utilizationGroupBy === 'staff' ? 'Staff utilization metrics' :
                                utilizationGroupBy === 'project' ? 'Project time tracking' :
                                  utilizationGroupBy === 'client' ? 'Client billing analysis' :
                                    'Weekly time distribution'}
                            </CardDescription>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={async () => {
                                const firmInfo: FirmInfo = {
                                  name: "Your Accounting Firm",
                                  address: "123 Main St, City, State",
                                  phone: "(555) 123-4567",
                                  email: "info@yourfirm.com"
                                };

                                const dateRange: DateRange = {
                                  startDate: utilizationStartDate,
                                  endDate: utilizationEndDate
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Summary Metrics",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Hours", utilizationData.summary.totalHours.toFixed(1)],
                                      ["Billable Hours", utilizationData.summary.billableHours.toFixed(1)],
                                      ["Non-Billable Hours", utilizationData.summary.nonBillableHours.toFixed(1)],
                                      ["Overall Utilization", `${utilizationData.summary.overallUtilization.toFixed(1)}%`],
                                      ["Billable Rate", `${utilizationData.summary.billableRate.toFixed(1)}%`]
                                    ]
                                  },
                                  {
                                    title: `Breakdown by ${utilizationGroupBy.charAt(0).toUpperCase() + utilizationGroupBy.slice(1)}`,
                                    headers:
                                      utilizationGroupBy === 'staff' ? ["Staff Name", "Total Hours", "Billable Hours", "Non-Billable Hours", "Utilization %", "Avg Hrs/Day"] :
                                        utilizationGroupBy === 'project' ? ["Project Name", "Client", "Total Hours", "Billable Hours", "Budget Hours", "Variance"] :
                                          utilizationGroupBy === 'client' ? ["Client Name", "Total Hours", "Billable Hours", "Revenue", "Projects"] :
                                            ["Week", "Total Hours", "Billable Hours", "Non-Billable Hours", "Utilization %"],
                                    rows: utilizationData.breakdown.map((item: any) => {
                                      if (utilizationGroupBy === 'staff') {
                                        return [item.groupName, item.totalHours.toFixed(1), item.billableHours.toFixed(1), item.nonBillableHours.toFixed(1), `${item.utilization.toFixed(1)}%`, item.avgHoursPerDay?.toFixed(1) || 'N/A'];
                                      } else if (utilizationGroupBy === 'project') {
                                        return [item.groupName, item.clientName || 'N/A', item.totalHours.toFixed(1), item.billableHours.toFixed(1), item.budgetHours?.toFixed(1) || 'N/A', item.hoursVariance?.toFixed(1) || 'N/A'];
                                      } else if (utilizationGroupBy === 'client') {
                                        return [item.groupName, item.totalHours.toFixed(1), item.billableHours.toFixed(1), `$${item.revenueGenerated?.toFixed(2) || '0.00'}`, item.projectCount?.toString() || '0'];
                                      } else {
                                        return [item.groupName, item.totalHours.toFixed(1), item.billableHours.toFixed(1), item.nonBillableHours.toFixed(1), `${item.utilization.toFixed(1)}%`];
                                      }
                                    })
                                  }
                                ];

                                await exportReportToPDF({
                                  title: "Utilization Report",
                                  dateRange,
                                  tables,
                                  summary: [
                                    { label: "Total Hours", value: utilizationData.summary.totalHours.toFixed(1) },
                                    { label: "Billable Hours", value: utilizationData.summary.billableHours.toFixed(1) },
                                    { label: "Utilization %", value: `${utilizationData.summary.overallUtilization.toFixed(1)}%` }
                                  ]
                                }, firmInfo, "Utilization_Report.pdf");

                                toast({
                                  title: "Export Complete",
                                  description: "Utilization report exported to PDF"
                                });
                              }}
                              data-testid="button-export-utilization-pdf"
                            >
                              <Download className="w-4 h-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const tables: TableData[] = [
                                  {
                                    title: "Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Hours", utilizationData.summary.totalHours],
                                      ["Billable Hours", utilizationData.summary.billableHours],
                                      ["Non-Billable Hours", utilizationData.summary.nonBillableHours],
                                      ["Overall Utilization %", utilizationData.summary.overallUtilization],
                                      ["Billable Rate %", utilizationData.summary.billableRate]
                                    ]
                                  },
                                  {
                                    title: `Breakdown by ${utilizationGroupBy.charAt(0).toUpperCase() + utilizationGroupBy.slice(1)}`,
                                    headers:
                                      utilizationGroupBy === 'staff' ? ["Staff Name", "Total Hours", "Billable Hours", "Non-Billable Hours", "Utilization %", "Billable Rate %", "Avg Hrs/Day", "Revenue"] :
                                        utilizationGroupBy === 'project' ? ["Project Name", "Client", "Total Hours", "Billable Hours", "Non-Billable Hours", "Budget Hours", "Variance", "Utilization %"] :
                                          utilizationGroupBy === 'client' ? ["Client Name", "Total Hours", "Billable Hours", "Non-Billable Hours", "Revenue", "Projects", "Utilization %"] :
                                            ["Week", "Total Hours", "Billable Hours", "Non-Billable Hours", "Utilization %", "Billable Rate %"],
                                    rows: utilizationData.breakdown.map((item: any) => {
                                      if (utilizationGroupBy === 'staff') {
                                        return [item.groupName, item.totalHours, item.billableHours, item.nonBillableHours, item.utilization, item.billableRate, item.avgHoursPerDay || 0, item.revenueGenerated || 0];
                                      } else if (utilizationGroupBy === 'project') {
                                        return [item.groupName, item.clientName || '', item.totalHours, item.billableHours, item.nonBillableHours, item.budgetHours || 0, item.hoursVariance || 0, item.utilization];
                                      } else if (utilizationGroupBy === 'client') {
                                        return [item.groupName, item.totalHours, item.billableHours, item.nonBillableHours, item.revenueGenerated || 0, item.projectCount || 0, item.utilization];
                                      } else {
                                        return [item.groupName, item.totalHours, item.billableHours, item.nonBillableHours, item.utilization, item.billableRate];
                                      }
                                    })
                                  }
                                ];

                                exportReportToExcel(tables, "Utilization_Report.xlsx");

                                toast({
                                  title: "Export Complete",
                                  description: "Utilization report exported to Excel"
                                });
                              }}
                              data-testid="button-export-utilization-excel"
                            >
                              <FileSpreadsheet className="w-4 h-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                {utilizationGroupBy === 'staff' ? (
                                  <>
                                    <TableHead>Staff Name</TableHead>
                                    <TableHead className="text-right">Total Hours</TableHead>
                                    <TableHead className="text-right">Billable</TableHead>
                                    <TableHead className="text-right">Non-Billable</TableHead>
                                    <TableHead className="text-right">Utilization %</TableHead>
                                    <TableHead className="text-right">Billable Rate %</TableHead>
                                    <TableHead className="text-right">Avg Hrs/Day</TableHead>
                                  </>
                                ) : utilizationGroupBy === 'project' ? (
                                  <>
                                    <TableHead>Project Name</TableHead>
                                    <TableHead>Client</TableHead>
                                    <TableHead className="text-right">Total Hours</TableHead>
                                    <TableHead className="text-right">Billable</TableHead>
                                    <TableHead className="text-right">Non-Billable</TableHead>
                                    <TableHead className="text-right">Budget</TableHead>
                                    <TableHead className="text-right">Variance</TableHead>
                                  </>
                                ) : utilizationGroupBy === 'client' ? (
                                  <>
                                    <TableHead>Client Name</TableHead>
                                    <TableHead className="text-right">Total Hours</TableHead>
                                    <TableHead className="text-right">Billable</TableHead>
                                    <TableHead className="text-right">Revenue</TableHead>
                                    <TableHead className="text-right">Projects</TableHead>
                                    <TableHead className="text-right">Utilization %</TableHead>
                                  </>
                                ) : (
                                  <>
                                    <TableHead>Week</TableHead>
                                    <TableHead className="text-right">Total Hours</TableHead>
                                    <TableHead className="text-right">Billable</TableHead>
                                    <TableHead className="text-right">Non-Billable</TableHead>
                                    <TableHead className="text-right">Utilization %</TableHead>
                                  </>
                                )}
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {utilizationData.breakdown.map((item: any, index: number) => {
                                const utilizationColor =
                                  item.utilization >= 70 ? 'text-green-600' :
                                    item.utilization >= 50 ? 'text-yellow-600' :
                                      'text-red-600';

                                const rowClass =
                                  item.utilization >= 70 ? 'bg-green-50' :
                                    item.utilization >= 50 ? 'bg-yellow-50' :
                                      'bg-red-50';

                                return (
                                  <TableRow key={index} className={rowClass} data-testid={`row-utilization-${index}`}>
                                    {utilizationGroupBy === 'staff' ? (
                                      <>
                                        <TableCell className="font-medium">{item.groupName}</TableCell>
                                        <TableCell className="text-right">{item.totalHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-green-600">{item.billableHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-gray-600">{item.nonBillableHours.toFixed(1)}</TableCell>
                                        <TableCell className={`text-right font-bold ${utilizationColor}`}>{item.utilization.toFixed(1)}%</TableCell>
                                        <TableCell className="text-right">{item.billableRate.toFixed(1)}%</TableCell>
                                        <TableCell className="text-right">{item.avgHoursPerDay?.toFixed(1) || 'N/A'}</TableCell>
                                      </>
                                    ) : utilizationGroupBy === 'project' ? (
                                      <>
                                        <TableCell className="font-medium">{item.groupName}</TableCell>
                                        <TableCell>{item.clientName || 'N/A'}</TableCell>
                                        <TableCell className="text-right">{item.totalHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-green-600">{item.billableHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-gray-600">{item.nonBillableHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right">{item.budgetHours?.toFixed(1) || 'N/A'}</TableCell>
                                        <TableCell className={`text-right ${item.hoursVariance && item.hoursVariance < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                          {item.hoursVariance?.toFixed(1) || 'N/A'}
                                        </TableCell>
                                      </>
                                    ) : utilizationGroupBy === 'client' ? (
                                      <>
                                        <TableCell className="font-medium">{item.groupName}</TableCell>
                                        <TableCell className="text-right">{item.totalHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-green-600">{item.billableHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right">${item.revenueGenerated?.toFixed(2) || '0.00'}</TableCell>
                                        <TableCell className="text-right">{item.projectCount || 0}</TableCell>
                                        <TableCell className={`text-right font-bold ${utilizationColor}`}>{item.utilization.toFixed(1)}%</TableCell>
                                      </>
                                    ) : (
                                      <>
                                        <TableCell className="font-medium">{item.groupName}</TableCell>
                                        <TableCell className="text-right">{item.totalHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-green-600">{item.billableHours.toFixed(1)}</TableCell>
                                        <TableCell className="text-right text-gray-600">{item.nonBillableHours.toFixed(1)}</TableCell>
                                        <TableCell className={`text-right font-bold ${utilizationColor}`}>{item.utilization.toFixed(1)}%</TableCell>
                                      </>
                                    )}
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                ) : null}
              </div>
            )}

            {/* Time & Billing Analytics Report */}
            {reportTab === 'time-billing' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üí∞ Time & Billing Analytics</CardTitle>
                        <CardDescription>Comprehensive billing rate analysis and revenue optimization insights</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={timeBillingStartDate}
                            onChange={(e) => setTimeBillingStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-time-billing-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={timeBillingEndDate}
                            onChange={(e) => setTimeBillingEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-time-billing-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchTimeBilling()}
                          data-testid="button-refresh-time-billing"
                        >
                          <RefreshCw className="w-4 h-4 mr-2" />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingTimeBilling ? (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <Activity className="w-12 h-12 animate-spin mx-auto mb-4 text-gray-400" />
                        <p className="text-gray-500">Loading billing analytics...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : timeBillingError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading Time & Billing Analytics: {timeBillingError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : timeBillingData ? (
                  <>
                    {/* KPI Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Total Revenue</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">
                            ${timeBillingData.summary.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">From billable time</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Billable Hours</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-blue-600">
                            {timeBillingData.summary.totalBillableHours.toFixed(1)}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            of {timeBillingData.summary.totalWorkedHours.toFixed(1)} total hours
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Effective Rate</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-purple-600">
                            ${timeBillingData.summary.averageEffectiveRate.toFixed(2)}/hr
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            vs ${timeBillingData.summary.averageStandardRate.toFixed(2)} standard
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Rate Variance</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${timeBillingData.summary.overallRateVariancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {timeBillingData.summary.overallRateVariancePercent >= 0 ? '+' : ''}{timeBillingData.summary.overallRateVariancePercent.toFixed(1)}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            ${timeBillingData.summary.overallRateVariance >= 0 ? '+' : ''}{timeBillingData.summary.overallRateVariance.toFixed(2)}/hr
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Realization Rate</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${timeBillingData.summary.realizationRate >= 80 ? 'text-green-600' : timeBillingData.summary.realizationRate >= 70 ? 'text-yellow-600' : 'text-red-600'}`}>
                            {timeBillingData.summary.realizationRate.toFixed(1)}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Billable vs worked time</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Rate Analysis Charts */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <ReportBarChart
                        data={timeBillingData.staffAnalysis.slice(0, 10).map((staff: any) => ({
                          name: staff.staffName,
                          'Standard Rate': staff.standardRate,
                          'Effective Rate': staff.effectiveRate,
                        }))}
                        xKey="name"
                        yKeys={['Standard Rate', 'Effective Rate']}
                        title="Effective Rate vs Standard Rate by Staff"
                        colors={['#94a3b8', '#3b82f6']}
                        isLoading={isLoadingTimeBilling}
                      />

                      <ReportLineChart
                        data={timeBillingData.revenueTrends.weekly.map((item: any) => ({
                          week: format(new Date(item.week), 'MMM d'),
                          'Effective Rate': item.effectiveRate,
                        }))}
                        xKey="week"
                        yKey="Effective Rate"
                        title="Revenue per Hour Trend (Weekly)"
                        colors={['#10b981']}
                        isLoading={isLoadingTimeBilling}
                      />

                      <ReportPieChart
                        data={timeBillingData.clientAnalysis.slice(0, 8).map((client: any) => ({
                          name: client.clientName,
                          value: client.revenue,
                        }))}
                        title="Revenue Distribution by Client"
                        isLoading={isLoadingTimeBilling}
                      />
                    </div>

                    {/* Rate Variance Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex justify-between items-center">
                          <div>
                            <CardTitle>Staff Rate Variance Analysis</CardTitle>
                            <CardDescription>Compare actual billing rates vs standard rates</CardDescription>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={async () => {
                                const firmInfo: FirmInfo = {
                                  name: "Your Accounting Firm"
                                };

                                const dateRange: DateRange = {
                                  startDate: timeBillingStartDate,
                                  endDate: timeBillingEndDate
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Staff Rate Variance",
                                    headers: ["Staff", "Standard Rate", "Effective Rate", "Variance ($)", "Variance (%)", "Billable Hours", "Revenue"],
                                    rows: timeBillingData.staffAnalysis.map((staff: any) => [
                                      staff.staffName,
                                      `$${staff.standardRate}`,
                                      `$${staff.effectiveRate}`,
                                      `$${staff.rateVariance >= 0 ? '+' : ''}${staff.rateVariance}`,
                                      `${staff.rateVariancePercent >= 0 ? '+' : ''}${staff.rateVariancePercent.toFixed(1)}%`,
                                      staff.billableHours.toString(),
                                      `$${staff.revenue.toFixed(2)}`
                                    ])
                                  }
                                ];

                                await exportReportToPDF({
                                  title: "Time & Billing Analytics",
                                  dateRange,
                                  tables,
                                  summary: [
                                    { label: "Total Revenue", value: `$${timeBillingData.summary.totalRevenue.toFixed(2)}` },
                                    { label: "Effective Rate", value: `$${timeBillingData.summary.averageEffectiveRate.toFixed(2)}/hr` },
                                    { label: "Realization Rate", value: `${timeBillingData.summary.realizationRate.toFixed(1)}%` }
                                  ]
                                }, firmInfo, "Time_Billing_Analytics.pdf");

                                toast({
                                  title: "Export Complete",
                                  description: "PDF report has been downloaded"
                                });
                              }}
                              data-testid="button-export-billing-pdf"
                            >
                              <Download className="w-4 h-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const firmInfo: FirmInfo = {
                                  name: "Your Accounting Firm"
                                };

                                const dateRange: DateRange = {
                                  startDate: timeBillingStartDate,
                                  endDate: timeBillingEndDate
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Staff Rate Variance",
                                    headers: ["Staff", "Standard Rate", "Effective Rate", "Variance ($)", "Variance (%)", "Billable Hours", "Revenue"],
                                    rows: timeBillingData.staffAnalysis.map((staff: any) => [
                                      staff.staffName,
                                      staff.standardRate,
                                      staff.effectiveRate,
                                      staff.rateVariance,
                                      staff.rateVariancePercent,
                                      staff.billableHours,
                                      staff.revenue
                                    ])
                                  },
                                  {
                                    title: "Client Rate Analysis",
                                    headers: ["Client", "Blended Rate", "Total Hours", "Revenue", "Projects"],
                                    rows: timeBillingData.clientAnalysis.map((client: any) => [
                                      client.clientName,
                                      client.blendedRate,
                                      client.totalHours,
                                      client.revenue,
                                      client.projectsCount
                                    ])
                                  }
                                ];

                                exportReportToExcel({
                                  title: "Time & Billing Analytics",
                                  dateRange,
                                  tables
                                }, firmInfo, "Time_Billing_Analytics.xlsx");

                                toast({
                                  title: "Export Complete",
                                  description: "Excel workbook has been downloaded"
                                });
                              }}
                              data-testid="button-export-billing-excel"
                            >
                              <FileSpreadsheet className="w-4 h-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Staff Name</TableHead>
                                <TableHead className="text-right">Standard Rate</TableHead>
                                <TableHead className="text-right">Effective Rate</TableHead>
                                <TableHead className="text-right">Rate Variance ($)</TableHead>
                                <TableHead className="text-right">Rate Variance (%)</TableHead>
                                <TableHead className="text-right">Billable Hours</TableHead>
                                <TableHead className="text-right">Revenue</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {timeBillingData.staffAnalysis.map((staff: any, index: number) => (
                                <TableRow
                                  key={index}
                                  className={staff.rateVariancePercent >= 0 ? 'bg-green-50' : 'bg-red-50'}
                                  data-testid={`row-staff-variance-${index}`}
                                >
                                  <TableCell className="font-medium">{staff.staffName}</TableCell>
                                  <TableCell className="text-right">${staff.standardRate.toFixed(2)}</TableCell>
                                  <TableCell className="text-right font-semibold">${staff.effectiveRate.toFixed(2)}</TableCell>
                                  <TableCell className={`text-right font-bold ${staff.rateVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {staff.rateVariance >= 0 ? '+' : ''}${staff.rateVariance.toFixed(2)}
                                  </TableCell>
                                  <TableCell className={`text-right font-bold ${staff.rateVariancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {staff.rateVariancePercent >= 0 ? '+' : ''}{staff.rateVariancePercent.toFixed(1)}%
                                  </TableCell>
                                  <TableCell className="text-right">{staff.billableHours.toFixed(1)}</TableCell>
                                  <TableCell className="text-right font-semibold">${staff.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Client Rate Analysis Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Client Rate Analysis</CardTitle>
                        <CardDescription>Blended rates and revenue by client</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Blended Rate</TableHead>
                                <TableHead className="text-right">Total Hours</TableHead>
                                <TableHead className="text-right">Revenue</TableHead>
                                <TableHead className="text-right">Projects Count</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {timeBillingData.clientAnalysis.map((client: any, index: number) => (
                                <TableRow key={index} data-testid={`row-client-rate-${index}`}>
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right font-semibold">${client.blendedRate.toFixed(2)}/hr</TableCell>
                                  <TableCell className="text-right">{client.totalHours.toFixed(1)}</TableCell>
                                  <TableCell className="text-right font-bold text-green-600">
                                    ${client.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">{client.projectsCount}</TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Optimization Recommendations */}
                    {timeBillingData.optimizationRecommendations && timeBillingData.optimizationRecommendations.length > 0 && (
                      <Card>
                        <CardHeader>
                          <div className="flex items-center gap-2">
                            <Zap className="w-5 h-5 text-yellow-500" />
                            <CardTitle>Optimization Recommendations</CardTitle>
                          </div>
                          <CardDescription>Actionable insights to improve billing efficiency and revenue</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-3">
                            {timeBillingData.optimizationRecommendations.map((rec: any, index: number) => (
                              <div
                                key={index}
                                className={`p-4 rounded-lg border-l-4 ${rec.severity === 'high' ? 'bg-red-50 border-red-500' :
                                  rec.severity === 'medium' ? 'bg-yellow-50 border-yellow-500' :
                                    'bg-blue-50 border-blue-500'
                                  }`}
                                data-testid={`recommendation-${index}`}
                              >
                                <div className="flex items-start gap-3">
                                  <div className="mt-1">
                                    {rec.severity === 'high' ? (
                                      <AlertTriangle className="w-5 h-5 text-red-600" />
                                    ) : rec.severity === 'medium' ? (
                                      <AlertCircle className="w-5 h-5 text-yellow-600" />
                                    ) : (
                                      <TrendingUp className="w-5 h-5 text-blue-600" />
                                    )}
                                  </div>
                                  <div className="flex-1">
                                    <h4 className="font-semibold text-gray-900">{rec.title}</h4>
                                    <p className="text-sm text-gray-700 mt-1">{rec.description}</p>
                                    {rec.potentialImpact && (
                                      <p className="text-sm text-gray-600 mt-2">
                                        <strong>Potential Impact:</strong> {rec.potentialImpact}
                                      </p>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-gray-500">
                        <BarChart3 className="w-12 h-12 mx-auto mb-4" />
                        <p>No billing analytics data available for the selected date range.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}
              </div>
            )}

            {/* Workflow Efficiency Report */}
            {reportTab === 'workflow-efficiency' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>‚ö° Workflow Efficiency Report</CardTitle>
                        <CardDescription>Analyze process bottlenecks and optimization opportunities</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={workflowStartDate}
                            onChange={(e) => setWorkflowStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-workflow-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={workflowEndDate}
                            onChange={(e) => setWorkflowEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-workflow-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchWorkflowEfficiency()}
                          data-testid="button-refresh-workflow"
                        >
                          <RefreshCw className="w-4 h-4 mr-2" />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingWorkflowEfficiency ? (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <Activity className="w-12 h-12 animate-spin mx-auto mb-4 text-gray-400" />
                        <p className="text-gray-500">Loading workflow efficiency data...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : workflowEfficiencyError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading Workflow Efficiency: {workflowEfficiencyError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : workflowEfficiencyData ? (
                  <>
                    {/* KPI Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Average Lead Time</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-blue-600">
                            {workflowEfficiencyData.summary.averageLeadTime.toFixed(1)} days
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Creation to completion</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Average Cycle Time</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-purple-600">
                            {workflowEfficiencyData.summary.averageCycleTime.toFixed(1)} days
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Start to completion</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Throughput</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">
                            {workflowEfficiencyData.summary.throughput.toFixed(1)} tasks/week
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            {workflowEfficiencyData.summary.totalTasksCompleted} completed
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Current WIP</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-orange-600">
                            {workflowEfficiencyData.summary.currentWIP}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Tasks in progress</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Status Time Analysis Chart */}
                      <ReportBarChart
                        data={workflowEfficiencyData.statusMetrics.map((metric: any) => ({
                          name: metric.status.toUpperCase(),
                          value: metric.averageDaysInStatus,
                        }))}
                        xKey="name"
                        yKey="value"
                        title="Average Days in Each Status"
                        isLoading={false}
                        height={300}
                      />

                      {/* Throughput Trend Chart */}
                      <ReportLineChart
                        data={workflowEfficiencyData.throughputTrend.map((week: any) => ({
                          week: week.weekStart,
                          tasks: week.tasksCompleted,
                        }))}
                        xKey="week"
                        yKey="tasks"
                        title="Tasks Completed Per Week"
                        isLoading={false}
                        height={300}
                      />
                    </div>

                    {/* Status Distribution Pie Chart */}
                    <ReportPieChart
                      data={workflowEfficiencyData.wipDistribution.map((item: any) => ({
                        name: item.status.toUpperCase(),
                        value: item.count,
                      }))}
                      title="WIP Distribution by Status"
                      isLoading={false}
                      height={300}
                    />

                    {/* Bottleneck Analysis Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Bottleneck Analysis</CardTitle>
                        <CardDescription>Identify workflow stages causing delays</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Status</TableHead>
                                <TableHead className="text-right">Avg Time (days)</TableHead>
                                <TableHead className="text-right">Current Count</TableHead>
                                <TableHead className="text-right">Bottleneck Score</TableHead>
                                <TableHead>Recommendation</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {workflowEfficiencyData.statusMetrics.map((metric: any, index: number) => {
                                const severity =
                                  metric.averageDaysInStatus > 7 ? 'critical' :
                                    metric.averageDaysInStatus > 3 ? 'moderate' :
                                      'efficient';

                                const rowClass =
                                  severity === 'critical' ? 'bg-red-50' :
                                    severity === 'moderate' ? 'bg-yellow-50' :
                                      'bg-green-50';

                                const textColor =
                                  severity === 'critical' ? 'text-red-600' :
                                    severity === 'moderate' ? 'text-yellow-600' :
                                      'text-green-600';

                                return (
                                  <TableRow key={index} className={rowClass}>
                                    <TableCell className="font-medium">{metric.status.toUpperCase()}</TableCell>
                                    <TableCell className={`text-right font-bold ${textColor}`}>
                                      {metric.averageDaysInStatus.toFixed(1)}
                                    </TableCell>
                                    <TableCell className="text-right">{metric.currentCount}</TableCell>
                                    <TableCell className={`text-right font-bold ${textColor}`}>
                                      {metric.bottleneckScore.toFixed(1)}
                                    </TableCell>
                                    <TableCell className="text-sm">
                                      {severity === 'critical' ?
                                        `Critical bottleneck - Add resources or split ${metric.status} phase` :
                                        severity === 'moderate' ?
                                          `Review ${metric.status} workflow for optimization` :
                                          'Working efficiently'
                                      }
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Process Inefficiency Table */}
                    {workflowEfficiencyData.processInefficiencies && workflowEfficiencyData.processInefficiencies.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Process Inefficiencies</CardTitle>
                          <CardDescription>Tasks requiring attention (stuck {'>'}7 days or excessive status changes)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Task Title</TableHead>
                                  <TableHead>Current Status</TableHead>
                                  <TableHead className="text-right">Days in Status</TableHead>
                                  <TableHead className="text-right">Status Changes</TableHead>
                                  <TableHead>Client</TableHead>
                                  <TableHead>Project</TableHead>
                                  <TableHead>Assignee</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {workflowEfficiencyData.processInefficiencies.map((task: any, index: number) => (
                                  <TableRow key={index} className="hover:bg-gray-50">
                                    <TableCell className="font-medium">{task.taskTitle}</TableCell>
                                    <TableCell>
                                      <Badge variant="outline">{task.currentStatus.toUpperCase()}</Badge>
                                    </TableCell>
                                    <TableCell className={`text-right font-bold ${task.daysInCurrentStatus > 14 ? 'text-red-600' : task.daysInCurrentStatus > 7 ? 'text-yellow-600' : 'text-gray-600'}`}>
                                      {task.daysInCurrentStatus.toFixed(1)}
                                    </TableCell>
                                    <TableCell className={`text-right ${task.statusChangeCount > 5 ? 'text-red-600' : 'text-gray-600'}`}>
                                      {task.statusChangeCount}
                                    </TableCell>
                                    <TableCell className="text-sm">{task.clientName}</TableCell>
                                    <TableCell className="text-sm">{task.projectName}</TableCell>
                                    <TableCell className="text-sm">{task.assigneeName}</TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Optimization Recommendations */}
                    {workflowEfficiencyData.recommendations && workflowEfficiencyData.recommendations.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Optimization Recommendations</CardTitle>
                          <CardDescription>Action items to improve workflow efficiency</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-4">
                            {workflowEfficiencyData.recommendations.map((rec: any, index: number) => (
                              <div
                                key={index}
                                className={`p-4 rounded-lg border-l-4 ${rec.severity === 'critical' ? 'border-red-500 bg-red-50' :
                                  rec.severity === 'moderate' ? 'border-yellow-500 bg-yellow-50' :
                                    'border-blue-500 bg-blue-50'
                                  }`}
                              >
                                <div className="flex gap-3">
                                  <div className="mt-1">
                                    {rec.severity === 'critical' ? (
                                      <AlertTriangle className="w-5 h-5 text-red-600" />
                                    ) : rec.severity === 'moderate' ? (
                                      <AlertCircle className="w-5 h-5 text-yellow-600" />
                                    ) : (
                                      <TrendingUp className="w-5 h-5 text-blue-600" />
                                    )}
                                  </div>
                                  <div className="flex-1">
                                    <h4 className="font-semibold text-gray-900">{rec.title}</h4>
                                    <p className="text-sm text-gray-700 mt-1">{rec.description}</p>
                                    {rec.affectedStatus && (
                                      <p className="text-sm text-gray-600 mt-1">
                                        <strong>Affected Status:</strong> {rec.affectedStatus.toUpperCase()} ({rec.affectedTaskCount} tasks)
                                      </p>
                                    )}
                                    {rec.potentialImpact && (
                                      <p className="text-sm text-gray-600 mt-2">
                                        <strong>Recommendation:</strong> {rec.potentialImpact}
                                      </p>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Export Buttons */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Export Report</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="flex gap-4">
                          <Button
                            onClick={async () => {
                              const firmInfo: FirmInfo = {
                                name: "Your Accounting Firm",
                                address: "123 Main St, City, State",
                                phone: "(555) 123-4567",
                                email: "info@yourfirm.com"
                              };

                              const dateRange: DateRange = {
                                startDate: workflowStartDate,
                                endDate: workflowEndDate
                              };

                              const tables: TableData[] = [
                                {
                                  title: "Workflow Efficiency Summary",
                                  headers: ["Metric", "Value"],
                                  rows: [
                                    ["Average Lead Time", `${workflowEfficiencyData.summary.averageLeadTime.toFixed(1)} days`],
                                    ["Average Cycle Time", `${workflowEfficiencyData.summary.averageCycleTime.toFixed(1)} days`],
                                    ["Throughput", `${workflowEfficiencyData.summary.throughput.toFixed(1)} tasks/week`],
                                    ["Current WIP", `${workflowEfficiencyData.summary.currentWIP} tasks`],
                                    ["Tasks Completed", `${workflowEfficiencyData.summary.totalTasksCompleted}`],
                                  ]
                                },
                                {
                                  title: "Bottleneck Analysis",
                                  headers: ["Status", "Avg Days", "Current Count", "Bottleneck Score"],
                                  rows: workflowEfficiencyData.statusMetrics.map((m: any) => [
                                    m.status.toUpperCase(),
                                    m.averageDaysInStatus.toFixed(1),
                                    m.currentCount.toString(),
                                    m.bottleneckScore.toFixed(1)
                                  ])
                                }
                              ];

                              await exportReportToPDF("Workflow Efficiency Report", firmInfo, dateRange, tables);
                            }}
                            data-testid="button-export-workflow-pdf"
                          >
                            <Download className="w-4 h-4 mr-2" />
                            Export PDF
                          </Button>

                          <Button
                            variant="outline"
                            onClick={() => {
                              const workbookData = [
                                {
                                  sheetName: "Summary",
                                  data: [
                                    ["Metric", "Value"],
                                    ["Average Lead Time", `${workflowEfficiencyData.summary.averageLeadTime.toFixed(1)} days`],
                                    ["Average Cycle Time", `${workflowEfficiencyData.summary.averageCycleTime.toFixed(1)} days`],
                                    ["Throughput", `${workflowEfficiencyData.summary.throughput.toFixed(1)} tasks/week`],
                                    ["Current WIP", workflowEfficiencyData.summary.currentWIP],
                                    ["Tasks Completed", workflowEfficiencyData.summary.totalTasksCompleted],
                                  ]
                                },
                                {
                                  sheetName: "Bottleneck Analysis",
                                  data: [
                                    ["Status", "Avg Days", "Current Count", "Bottleneck Score"],
                                    ...workflowEfficiencyData.statusMetrics.map((m: any) => [
                                      m.status.toUpperCase(),
                                      m.averageDaysInStatus,
                                      m.currentCount,
                                      m.bottleneckScore
                                    ])
                                  ]
                                },
                                {
                                  sheetName: "Process Inefficiencies",
                                  data: [
                                    ["Task Title", "Status", "Days in Status", "Status Changes", "Client", "Project", "Assignee"],
                                    ...workflowEfficiencyData.processInefficiencies.map((t: any) => [
                                      t.taskTitle,
                                      t.currentStatus.toUpperCase(),
                                      t.daysInCurrentStatus,
                                      t.statusChangeCount,
                                      t.clientName,
                                      t.projectName,
                                      t.assigneeName
                                    ])
                                  ]
                                }
                              ];

                              exportReportToExcel(workbookData, "Workflow_Efficiency_Report");
                            }}
                            data-testid="button-export-workflow-excel"
                          >
                            <FileSpreadsheet className="w-4 h-4 mr-2" />
                            Export Excel
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                ) : (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-gray-500">
                        <Activity className="w-12 h-12 mx-auto mb-4" />
                        <p>No workflow efficiency data available for the selected date range.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}
              </div>
            )}

            {/* Client Health Report */}
            {reportTab === 'client-health' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Client Health Report</CardTitle>
                        <CardDescription>Engagement scores, satisfaction metrics, and risk indicators for client retention</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2 items-center">
                        {/* Client Selector */}
                        <Select
                          value={selectedClientForHealth?.toString() || "all"}
                          onValueChange={(value) => {
                            setSelectedClientForHealth(value === "all" ? null : parseInt(value));
                          }}
                        >
                          <SelectTrigger className="w-[200px]" data-testid="select-client-health">
                            <SelectValue placeholder="Select Client" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="all">All Clients</SelectItem>
                            {safeArray(clients).map((client: any) => (
                              <SelectItem key={client.id} value={client.id.toString()}>
                                {client.name}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchClientHealth()}
                          disabled={isLoadingClientHealth}
                          data-testid="button-refresh-client-health"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingClientHealth ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingClientHealth && (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <RefreshCw className="w-8 h-8 animate-spin text-primary mx-auto mb-4" />
                        <p className="text-gray-500">Loading client health data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {clientHealthError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="flex items-center gap-3 py-4">
                      <AlertTriangle className="w-6 h-6 text-red-600" />
                      <div>
                        <p className="font-semibold text-red-800">Error loading client health data</p>
                        <p className="text-sm text-red-700">{(clientHealthError as Error).message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {clientHealthData && !isLoadingClientHealth && !selectedClientForHealth && (
                  <>
                    {/* Summary Cards - All Clients View */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
                          <Users className="h-5 w-5 text-blue-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-blue-600">
                            {clientHealthData.summary?.totalClients || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Active client accounts</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-green-200 bg-gradient-to-br from-green-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Healthy Clients</CardTitle>
                          <CheckCircle className="h-5 w-5 text-green-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-green-600">
                            {clientHealthData.summary?.healthyClients || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Health score {'>'}  80</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-orange-200 bg-gradient-to-br from-orange-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">At Risk</CardTitle>
                          <AlertCircle className="h-5 w-5 text-orange-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-orange-600">
                            {clientHealthData.summary?.atRiskClients || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Health score 40-60</p>
                        </CardContent>
                      </Card>

                      <Card className="border-2 border-red-200 bg-gradient-to-br from-red-50 to-white">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Critical</CardTitle>
                          <AlertTriangle className="h-5 w-5 text-red-600" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-4xl font-bold text-red-600">
                            {clientHealthData.summary?.criticalClients || 0}
                          </div>
                          <p className="text-xs text-gray-600 mt-1">Health score {'<'} 40</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Health Distribution Pie Chart */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Health Distribution by Category</CardTitle>
                        <CardDescription>Client health status breakdown</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <ReportPieChart
                          data={[
                            {
                              name: 'Healthy',
                              value: clientHealthData.summary?.healthyClients || 0,
                              color: '#10b981'
                            },
                            {
                              name: 'Good',
                              value: clientHealthData.summary?.goodClients || 0,
                              color: '#3b82f6'
                            },
                            {
                              name: 'At Risk',
                              value: clientHealthData.summary?.atRiskClients || 0,
                              color: '#f97316'
                            },
                            {
                              name: 'Critical',
                              value: clientHealthData.summary?.criticalClients || 0,
                              color: '#ef4444'
                            }
                          ]}
                          title="Client Health Categories"
                        />
                      </CardContent>
                    </Card>

                    {/* Engagement vs Revenue Scatter Chart */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Engagement vs Revenue Analysis</CardTitle>
                        <CardDescription>Client engagement score compared to revenue (last 12 months)</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <ReportBarChart
                          data={(clientHealthData.clients || []).map((client: any) => ({
                            name: client.clientName.length > 15 ? client.clientName.substring(0, 15) + '...' : client.clientName,
                            'Engagement Score': client.engagementScore,
                            'Revenue (x$1000)': Math.round(client.revenueMetrics.totalRevenue12Mo / 1000)
                          }))}
                          title="Engagement & Revenue by Client"
                          dataKeys={['Engagement Score', 'Revenue (x$1000)']}
                        />
                      </CardContent>
                    </Card>

                    {/* Client Health Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Client Health Details</CardTitle>
                        <CardDescription>Comprehensive health metrics sorted by priority (lowest health score first)</CardDescription>
                        <div className="flex gap-2 mt-4">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={async () => {
                              if (!clientHealthData) return;

                              const firmInfo: FirmInfo = {
                                name: "Your Accounting Firm",
                                address: "123 Main St, City, State",
                                phone: "(555) 123-4567",
                                email: "info@yourfirm.com"
                              };

                              const today = new Date();

                              const tables: TableData[] = [
                                {
                                  title: "Summary",
                                  headers: ["Metric", "Count"],
                                  rows: [
                                    ["Total Clients", clientHealthData.summary?.totalClients?.toString() || "0"],
                                    ["Healthy Clients (>80)", clientHealthData.summary?.healthyClients?.toString() || "0"],
                                    ["Good Clients (60-80)", clientHealthData.summary?.goodClients?.toString() || "0"],
                                    ["At Risk Clients (40-60)", clientHealthData.summary?.atRiskClients?.toString() || "0"],
                                    ["Critical Clients (<40)", clientHealthData.summary?.criticalClients?.toString() || "0"],
                                  ]
                                },
                                {
                                  title: "Client Health Details",
                                  headers: ["Client", "Health Score", "Category", "Engagement", "Revenue (12mo)", "Revenue Trend", "Outstanding AR", "Risk Count", "Last Activity"],
                                  rows: (clientHealthData.clients || []).map((client: any) => [
                                    client.clientName,
                                    client.healthScore.toString(),
                                    client.healthCategory,
                                    client.engagementScore.toString(),
                                    `$${client.revenueMetrics.totalRevenue12Mo.toFixed(2)}`,
                                    `${client.revenueMetrics.revenueTrend > 0 ? '+' : ''}${client.revenueMetrics.revenueTrend.toFixed(1)}%`,
                                    `$${client.revenueMetrics.outstandingAR.toFixed(2)}`,
                                    client.riskIndicators.length.toString(),
                                    client.activityMetrics.lastActivityDate ? new Date(client.activityMetrics.lastActivityDate).toLocaleDateString() : 'No activity'
                                  ])
                                }
                              ];

                              await exportReportToPDF({
                                title: "Client Health Report",
                                dateRange: { startDate: '', endDate: today.toISOString().split('T')[0] },
                                tables
                              }, firmInfo, "Client_Health_Report.pdf");
                            }}
                            data-testid="button-export-pdf-client-health"
                          >
                            <Download className="w-4 h-4 mr-2" />
                            Export PDF
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              if (!clientHealthData) return;

                              const firmInfo: FirmInfo = {
                                name: "Your Accounting Firm",
                                address: "123 Main St, City, State",
                                phone: "(555) 123-4567",
                                email: "info@yourfirm.com"
                              };

                              const workbookData = [
                                {
                                  sheetName: "Summary",
                                  data: [
                                    ["Metric", "Count"],
                                    ["Total Clients", clientHealthData.summary?.totalClients?.toString() || "0"],
                                    ["Healthy Clients (>80)", clientHealthData.summary?.healthyClients?.toString() || "0"],
                                    ["Good Clients (60-80)", clientHealthData.summary?.goodClients?.toString() || "0"],
                                    ["At Risk Clients (40-60)", clientHealthData.summary?.atRiskClients?.toString() || "0"],
                                    ["Critical Clients (<40)", clientHealthData.summary?.criticalClients?.toString() || "0"],
                                  ]
                                },
                                {
                                  sheetName: "Client Health Details",
                                  data: [
                                    ["Client", "Health Score", "Category", "Engagement", "Revenue (12mo)", "Revenue Trend", "Outstanding AR", "Risk Count", "Last Activity"],
                                    ...(clientHealthData.clients || []).map((client: any) => [
                                      client.clientName,
                                      client.healthScore,
                                      client.healthCategory,
                                      client.engagementScore,
                                      client.revenueMetrics.totalRevenue12Mo,
                                      client.revenueMetrics.revenueTrend,
                                      client.revenueMetrics.outstandingAR,
                                      client.riskIndicators.length,
                                      client.activityMetrics.lastActivityDate ? new Date(client.activityMetrics.lastActivityDate).toLocaleDateString() : 'No activity'
                                    ])
                                  ]
                                },
                                {
                                  sheetName: "Risk Indicators",
                                  data: [
                                    ["Client", "Risk Type", "Severity", "Description"],
                                    ...(clientHealthData.clients || []).flatMap((client: any) =>
                                      client.riskIndicators.map((risk: any) => [
                                        client.clientName,
                                        risk.type,
                                        risk.severity,
                                        risk.description
                                      ])
                                    )
                                  ]
                                }
                              ];

                              exportReportToExcel(workbookData, "Client_Health_Report");
                            }}
                            data-testid="button-export-excel-client-health"
                          >
                            <FileSpreadsheet className="w-4 h-4 mr-2" />
                            Export Excel
                          </Button>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>Client Name</TableHead>
                              <TableHead className="text-center">Health Score</TableHead>
                              <TableHead className="text-center">Category</TableHead>
                              <TableHead className="text-center">Engagement</TableHead>
                              <TableHead className="text-right">Revenue (12mo)</TableHead>
                              <TableHead className="text-center">Trend</TableHead>
                              <TableHead className="text-right">Outstanding AR</TableHead>
                              <TableHead className="text-center">Risk Indicators</TableHead>
                              <TableHead>Last Activity</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {(clientHealthData.clients || []).map((client: any) => {
                              const rowColor =
                                client.healthCategory === 'Healthy' ? 'bg-green-50 hover:bg-green-100' :
                                  client.healthCategory === 'Good' ? 'bg-blue-50 hover:bg-blue-100' :
                                    client.healthCategory === 'At Risk' ? 'bg-orange-50 hover:bg-orange-100' :
                                      'bg-red-50 hover:bg-red-100';

                              const badgeColor =
                                client.healthCategory === 'Healthy' ? 'bg-green-500' :
                                  client.healthCategory === 'Good' ? 'bg-blue-500' :
                                    client.healthCategory === 'At Risk' ? 'bg-orange-500' :
                                      'bg-red-500';

                              return (
                                <TableRow key={client.clientId} className={rowColor}>
                                  <TableCell className="font-medium">
                                    <button
                                      onClick={() => setSelectedClientForHealth(client.clientId)}
                                      className="text-blue-600 hover:underline flex items-center gap-2"
                                    >
                                      {client.clientName}
                                      <Eye className="w-4 h-4" />
                                    </button>
                                  </TableCell>
                                  <TableCell className="text-center">
                                    <div className="flex flex-col items-center">
                                      <span className="text-2xl font-bold">{client.healthScore}</span>
                                      <Progress value={client.healthScore} className="w-20 h-2 mt-1" />
                                    </div>
                                  </TableCell>
                                  <TableCell className="text-center">
                                    <Badge className={`${badgeColor} text-white`}>
                                      {client.healthCategory}
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-center">
                                    <span className="font-semibold">{client.engagementScore}</span>
                                  </TableCell>
                                  <TableCell className="text-right font-semibold">
                                    ${client.revenueMetrics.totalRevenue12Mo.toFixed(0)}
                                  </TableCell>
                                  <TableCell className="text-center">
                                    <span className={client.revenueMetrics.revenueTrend >= 0 ? 'text-green-600' : 'text-red-600'}>
                                      {client.revenueMetrics.revenueTrend > 0 ? '‚Üë' : '‚Üì'} {Math.abs(client.revenueMetrics.revenueTrend).toFixed(1)}%
                                    </span>
                                  </TableCell>
                                  <TableCell className="text-right">
                                    <span className={client.revenueMetrics.outstandingAR > 0 ? 'text-orange-600 font-semibold' : ''}>
                                      ${client.revenueMetrics.outstandingAR.toFixed(0)}
                                    </span>
                                  </TableCell>
                                  <TableCell className="text-center">
                                    {client.riskIndicators.length > 0 ? (
                                      <Badge variant="destructive">{client.riskIndicators.length} risks</Badge>
                                    ) : (
                                      <span className="text-green-600">‚úì None</span>
                                    )}
                                  </TableCell>
                                  <TableCell>
                                    {client.activityMetrics.lastActivityDate ? (
                                      <div className="text-sm">
                                        {new Date(client.activityMetrics.lastActivityDate).toLocaleDateString()}
                                        <div className="text-xs text-gray-500">
                                          ({client.activityMetrics.daysSinceLastActivity} days ago)
                                        </div>
                                      </div>
                                    ) : (
                                      <span className="text-gray-400">No activity</span>
                                    )}
                                  </TableCell>
                                </TableRow>
                              );
                            })}
                          </TableBody>
                        </Table>
                      </CardContent>
                    </Card>

                    {/* Action Recommendations */}
                    {clientHealthData.clients && clientHealthData.clients.filter((c: any) => c.healthCategory === 'Critical' || c.healthCategory === 'At Risk').length > 0 && (
                      <Card className="border-orange-200 bg-orange-50">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 text-orange-900">
                            <AlertTriangle className="w-6 h-6" />
                            Action Required: Clients Needing Attention
                          </CardTitle>
                          <CardDescription className="text-orange-700">
                            Immediate actions recommended to improve client health and retention
                          </CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {clientHealthData.clients
                            .filter((c: any) => c.healthCategory === 'Critical' || c.healthCategory === 'At Risk')
                            .slice(0, 5)
                            .map((client: any) => (
                              <div key={client.clientId} className="bg-white p-4 rounded-lg border border-orange-200">
                                <div className="flex items-start justify-between mb-2">
                                  <div>
                                    <h4 className="font-semibold text-lg">{client.clientName}</h4>
                                    <Badge className={client.healthCategory === 'Critical' ? 'bg-red-500' : 'bg-orange-500'}>
                                      {client.healthCategory} - Score: {client.healthScore}
                                    </Badge>
                                  </div>
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => setSelectedClientForHealth(client.clientId)}
                                  >
                                    View Details
                                  </Button>
                                </div>
                                <div className="mt-3 space-y-1">
                                  <p className="text-sm font-medium text-gray-700">Risk Indicators:</p>
                                  <ul className="list-disc list-inside text-sm text-gray-600">
                                    {client.riskIndicators.map((risk: any, idx: number) => (
                                      <li key={idx} className={risk.severity === 'high' ? 'text-red-600 font-semibold' : ''}>
                                        {risk.description}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                                <div className="mt-3 p-3 bg-blue-50 rounded border border-blue-200">
                                  <p className="text-sm font-medium text-blue-900">Recommended Actions:</p>
                                  <ul className="list-disc list-inside text-sm text-blue-700 mt-1">
                                    {client.paymentMetrics.daysOverdue > 30 && (
                                      <li>Contact client immediately regarding overdue payment (${client.revenueMetrics.outstandingAR.toFixed(0)})</li>
                                    )}
                                    {client.activityMetrics.daysSinceLastActivity > 60 && (
                                      <li>Schedule check-in call - no activity for {client.activityMetrics.daysSinceLastActivity} days</li>
                                    )}
                                    {client.revenueMetrics.revenueTrend < -20 && (
                                      <li>Discuss declining revenue ({client.revenueMetrics.revenueTrend.toFixed(1)}% drop) and explore new services</li>
                                    )}
                                    {client.engagementScore < 40 && (
                                      <li>Review service delivery and client satisfaction - low engagement score</li>
                                    )}
                                  </ul>
                                </div>
                              </div>
                            ))}
                        </CardContent>
                      </Card>
                    )}
                  </>
                )}

                {/* Individual Client View */}
                {clientHealthData && !isLoadingClientHealth && selectedClientForHealth && clientHealthData.clients && clientHealthData.clients.length > 0 && (
                  <>
                    {(() => {
                      const client = clientHealthData.clients[0];
                      const healthColor =
                        client.healthCategory === 'Healthy' ? 'text-green-600' :
                          client.healthCategory === 'Good' ? 'text-blue-600' :
                            client.healthCategory === 'At Risk' ? 'text-orange-600' :
                              'text-red-600';

                      return (
                        <>
                          <Card>
                            <CardHeader>
                              <div className="flex justify-between items-start">
                                <div>
                                  <CardTitle className="text-2xl">{client.clientName} - Health Report</CardTitle>
                                  <CardDescription>Comprehensive health analysis and recommendations</CardDescription>
                                </div>
                                <Button variant="outline" size="sm" onClick={() => setSelectedClientForHealth(null)}>
                                  <ChevronLeft className="w-4 h-4 mr-2" />
                                  Back to All Clients
                                </Button>
                              </div>
                            </CardHeader>
                            <CardContent>
                              {/* Large Health Score Gauge */}
                              <div className="text-center py-8 bg-gradient-to-br from-gray-50 to-white rounded-lg border-2">
                                <div className="text-6xl font-bold mb-2 ${healthColor}">
                                  {client.healthScore}
                                </div>
                                <Progress value={client.healthScore} className="w-64 h-4 mx-auto mb-4" />
                                <Badge className={`text-lg px-4 py-2 ${client.healthCategory === 'Healthy' ? 'bg-green-500' :
                                  client.healthCategory === 'Good' ? 'bg-blue-500' :
                                    client.healthCategory === 'At Risk' ? 'bg-orange-500' :
                                      'bg-red-500'
                                  }`}>
                                  {client.healthCategory}
                                </Badge>
                                <p className="text-sm text-gray-600 mt-2">Overall Health Score</p>
                              </div>
                            </CardContent>
                          </Card>

                          {/* Breakdown Cards */}
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <Card>
                              <CardHeader>
                                <CardTitle className="text-sm">Engagement Score</CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="text-3xl font-bold text-blue-600">{client.engagementScore}</div>
                                <Progress value={client.engagementScore} className="mt-2" />
                                <div className="mt-3 text-xs space-y-1">
                                  <div>Active Projects (90d): {client.activityMetrics.activeProjectsLast90Days}</div>
                                  <div>Task Completion: {client.activityMetrics.taskCompletionRate.toFixed(0)}%</div>
                                  <div>Time Tracked: {client.activityMetrics.timeTrackedLast30Days.toFixed(1)}h</div>
                                  <div>Messages: {client.activityMetrics.communicationFrequency}</div>
                                </div>
                              </CardContent>
                            </Card>

                            <Card>
                              <CardHeader>
                                <CardTitle className="text-sm">Revenue Trend</CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className={`text-3xl font-bold ${client.revenueMetrics.revenueTrend >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                  {client.revenueMetrics.revenueTrend > 0 ? '+' : ''}{client.revenueMetrics.revenueTrend.toFixed(1)}%
                                </div>
                                <Progress value={Math.min(100, Math.max(0, 50 + client.revenueMetrics.revenueTrend))} className="mt-2" />
                                <div className="mt-3 text-xs space-y-1">
                                  <div>Total Revenue (12mo): ${client.revenueMetrics.totalRevenue12Mo.toFixed(0)}</div>
                                  <div>Avg Project Value: ${client.revenueMetrics.averageProjectValue.toFixed(0)}</div>
                                  <div>Outstanding AR: ${client.revenueMetrics.outstandingAR.toFixed(0)}</div>
                                </div>
                              </CardContent>
                            </Card>

                            <Card>
                              <CardHeader>
                                <CardTitle className="text-sm">Payment Health</CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="text-3xl font-bold text-green-600">{client.paymentMetrics.paymentTimeliness}</div>
                                <Progress value={client.paymentMetrics.paymentTimeliness} className="mt-2" />
                                <div className="mt-3 text-xs space-y-1">
                                  <div>Overdue Amount: ${client.paymentMetrics.overdueAmount.toFixed(0)}</div>
                                  <div>Days Overdue: {client.paymentMetrics.daysOverdue}</div>
                                  {client.paymentMetrics.daysOverdue === 0 && (
                                    <div className="text-green-600 font-semibold">‚úì Payments Current</div>
                                  )}
                                </div>
                              </CardContent>
                            </Card>

                            <Card>
                              <CardHeader>
                                <CardTitle className="text-sm">Activity Level</CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="text-3xl font-bold text-purple-600">
                                  {client.activityMetrics.daysSinceLastActivity < 30 ? 'High' :
                                    client.activityMetrics.daysSinceLastActivity < 60 ? 'Medium' : 'Low'}
                                </div>
                                <div className="mt-3 text-xs space-y-1">
                                  <div>Last Activity: {client.activityMetrics.lastActivityDate ? new Date(client.activityMetrics.lastActivityDate).toLocaleDateString() : 'None'}</div>
                                  <div>Days Since: {client.activityMetrics.daysSinceLastActivity}</div>
                                  <div>Time Tracked Avg: {client.activityMetrics.timeTrackedAvg.toFixed(1)}h/mo</div>
                                </div>
                              </CardContent>
                            </Card>
                          </div>

                          {/* Risk Indicators Section */}
                          {client.riskIndicators.length > 0 && (
                            <Card className="border-red-200 bg-red-50">
                              <CardHeader>
                                <CardTitle className="flex items-center gap-2 text-red-900">
                                  <AlertTriangle className="w-5 h-5" />
                                  Risk Indicators ({client.riskIndicators.length})
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-2">
                                  {client.riskIndicators.map((risk: any, idx: number) => (
                                    <div key={idx} className={`p-3 rounded border ${risk.severity === 'high' ? 'bg-red-100 border-red-300' :
                                      risk.severity === 'medium' ? 'bg-orange-100 border-orange-300' :
                                        'bg-yellow-100 border-yellow-300'
                                      }`}>
                                      <div className="flex items-start gap-3">
                                        <Badge variant={risk.severity === 'high' ? 'destructive' : 'default'} className="mt-0.5">
                                          {risk.severity.toUpperCase()}
                                        </Badge>
                                        <div className="flex-1">
                                          <p className="font-semibold text-sm">{risk.type.replace(/_/g, ' ').toUpperCase()}</p>
                                          <p className="text-sm mt-1">{risk.description}</p>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </CardContent>
                            </Card>
                          )}

                          {/* Recommendations */}
                          <Card className="border-blue-200 bg-blue-50">
                            <CardHeader>
                              <CardTitle className="text-blue-900">Recommendations for Improving Client Health</CardTitle>
                            </CardHeader>
                            <CardContent>
                              <ul className="space-y-2">
                                {client.engagementScore < 50 && (
                                  <li className="flex items-start gap-2">
                                    <CheckCircle className="w-5 h-5 text-blue-600 mt-0.5" />
                                    <div>
                                      <p className="font-semibold">Increase Engagement</p>
                                      <p className="text-sm text-gray-700">Schedule regular check-ins and proactive communications to boost engagement score</p>
                                    </div>
                                  </li>
                                )}
                                {client.revenueMetrics.revenueTrend < 0 && (
                                  <li className="flex items-start gap-2">
                                    <TrendingUp className="w-5 h-5 text-blue-600 mt-0.5" />
                                    <div>
                                      <p className="font-semibold">Grow Revenue</p>
                                      <p className="text-sm text-gray-700">Explore upsell opportunities and additional services to reverse revenue decline</p>
                                    </div>
                                  </li>
                                )}
                                {client.paymentMetrics.daysOverdue > 0 && (
                                  <li className="flex items-start gap-2">
                                    <DollarSign className="w-5 h-5 text-blue-600 mt-0.5" />
                                    <div>
                                      <p className="font-semibold">Improve Payment Collection</p>
                                      <p className="text-sm text-gray-700">Follow up on overdue invoices and consider payment plan options</p>
                                    </div>
                                  </li>
                                )}
                                {client.activityMetrics.daysSinceLastActivity > 60 && (
                                  <li className="flex items-start gap-2">
                                    <Activity className="w-5 h-5 text-blue-600 mt-0.5" />
                                    <div>
                                      <p className="font-semibold">Re-engage Client</p>
                                      <p className="text-sm text-gray-700">Client has been inactive for {client.activityMetrics.daysSinceLastActivity} days - schedule a check-in call</p>
                                    </div>
                                  </li>
                                )}
                                {client.riskIndicators.length === 0 && client.healthScore > 80 && (
                                  <li className="flex items-start gap-2">
                                    <Star className="w-5 h-5 text-green-600 mt-0.5" />
                                    <div>
                                      <p className="font-semibold text-green-800">Client in Great Shape!</p>
                                      <p className="text-sm text-gray-700">Maintain current service levels and consider requesting referrals or testimonials</p>
                                    </div>
                                  </li>
                                )}
                              </ul>
                            </CardContent>
                          </Card>
                        </>
                      );
                    })()}
                  </>
                )}
              </div>
            )}

            {/* Client Retention Analysis Report */}
            {reportTab === 'client-retention' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Client Retention Analysis</CardTitle>
                        <CardDescription>Churn prediction, lifetime value calculations, and retention metrics for strategic growth</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchClientRetention()}
                          disabled={isLoadingClientRetention}
                          data-testid="button-refresh-client-retention"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingClientRetention ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!clientRetentionData) return;

                            const today = new Date();
                            const firmInfo = {
                              name: "Your Firm Name",
                              address: "Firm Address",
                              phone: "Phone Number",
                              email: "Email"
                            };

                            const tables = [
                              {
                                title: "Summary Metrics",
                                data: [
                                  ["Metric", "Value"],
                                  ["Total Active Clients", clientRetentionData.summary?.totalActiveClients?.toString() || "0"],
                                  ["Overall Retention Rate", `${clientRetentionData.summary?.overallRetentionRate?.toFixed(1) || "0"}%`],
                                  ["Average CLV", `$${clientRetentionData.summary?.averageCLV?.toLocaleString() || "0"}`],
                                  ["Churn Rate", `${clientRetentionData.summary?.churnRate?.toFixed(1) || "0"}%`],
                                  ["At-Risk Clients", clientRetentionData.summary?.atRiskClients?.toString() || "0"],
                                  ["Revenue Retention Rate", `${clientRetentionData.summary?.revenueRetentionRate?.toFixed(1) || "0"}%`],
                                ]
                              },
                              {
                                title: "Client Lifetime Value",
                                data: [
                                  ["Client", "Total Revenue", "Years Active", "Avg Revenue/Year", "Projected CLV", "Churn Risk"],
                                  ...(clientRetentionData.clientLifetimeValue || []).slice(0, 20).map((client: any) => [
                                    client.clientName,
                                    `$${client.totalRevenue?.toLocaleString() || "0"}`,
                                    client.yearsActive?.toString() || "0",
                                    `$${client.avgRevenuePerYear?.toLocaleString() || "0"}`,
                                    `$${client.projectedCLV?.toLocaleString() || "0"}`,
                                    client.churnRisk || "Low"
                                  ])
                                ]
                              },
                              {
                                title: "At-Risk Clients",
                                data: [
                                  ["Client", "Risk Level", "Days Since Activity", "Revenue Trend", "Payment Status", "Recommended Action"],
                                  ...(clientRetentionData.churnRiskClients || []).slice(0, 15).map((client: any) => [
                                    client.clientName,
                                    client.churnRiskLevel,
                                    client.daysSinceLastActivity?.toString() || "0",
                                    `${client.revenueTrend?.toFixed(1) || "0"}%`,
                                    client.paymentStatus || "Current",
                                    client.recommendedAction || ""
                                  ])
                                ]
                              }
                            ];

                            await exportReportToPDF({
                              title: "Client Retention Analysis",
                              dateRange: { startDate: '', endDate: today.toISOString().split('T')[0] },
                              tables
                            }, firmInfo, "Client_Retention_Report.pdf");
                          }}
                          data-testid="button-export-pdf-client-retention"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!clientRetentionData) return;

                            const workbookData = [
                              {
                                sheetName: "Summary",
                                data: [
                                  ["Client Retention Analysis Summary"],
                                  [""],
                                  ["Metric", "Value"],
                                  ["Total Active Clients", clientRetentionData.summary?.totalActiveClients?.toString() || "0"],
                                  ["Overall Retention Rate", `${clientRetentionData.summary?.overallRetentionRate?.toFixed(1) || "0"}%`],
                                  ["Average CLV", `$${clientRetentionData.summary?.averageCLV?.toLocaleString() || "0"}`],
                                  ["Churn Rate", `${clientRetentionData.summary?.churnRate?.toFixed(1) || "0"}%`],
                                  ["At-Risk Clients", clientRetentionData.summary?.atRiskClients?.toString() || "0"],
                                  ["Average Client Lifespan", `${clientRetentionData.summary?.averageClientLifespan?.toFixed(1) || "0"} years`],
                                  ["Revenue Retention Rate", `${clientRetentionData.summary?.revenueRetentionRate?.toFixed(1) || "0"}%`],
                                ]
                              },
                              {
                                sheetName: "Client Lifetime Value",
                                data: [
                                  ["Client", "Total Revenue", "Years Active", "Avg Revenue/Year", "Projected CLV", "Churn Risk", "Last Activity", "Days Since Activity", "Revenue Trend", "Payment Status"],
                                  ...(clientRetentionData.clientLifetimeValue || []).map((client: any) => [
                                    client.clientName,
                                    client.totalRevenue || 0,
                                    client.yearsActive || 0,
                                    client.avgRevenuePerYear || 0,
                                    client.projectedCLV || 0,
                                    client.churnRisk || "Low",
                                    client.lastActivity || "N/A",
                                    client.daysSinceLastActivity || 0,
                                    `${client.revenueTrend?.toFixed(1) || "0"}%`,
                                    client.paymentStatus || "Current"
                                  ])
                                ]
                              },
                              {
                                sheetName: "Churn Risk Analysis",
                                data: [
                                  ["Client", "Risk Level", "Days Since Activity", "Revenue Trend", "Payment Status", "Risk Factors", "Recommended Action"],
                                  ...(clientRetentionData.churnRiskClients || []).map((client: any) => [
                                    client.clientName,
                                    client.churnRiskLevel,
                                    client.daysSinceLastActivity || 0,
                                    `${client.revenueTrend?.toFixed(1) || "0"}%`,
                                    client.paymentStatus || "Current",
                                    client.riskFactors?.join("; ") || "",
                                    client.recommendedAction || ""
                                  ])
                                ]
                              },
                              {
                                sheetName: "Retention Trend",
                                data: [
                                  ["Month", "Retention Rate", "Active Clients", "New Clients", "Churned Clients"],
                                  ...(clientRetentionData.retentionTrend || []).map((month: any) => [
                                    month.month,
                                    `${month.retentionRate?.toFixed(1) || "0"}%`,
                                    month.activeClients || 0,
                                    month.newClients || 0,
                                    month.churnedClients || 0
                                  ])
                                ]
                              }
                            ];

                            exportReportToExcel(workbookData, "Client_Retention_Analysis");
                          }}
                          data-testid="button-export-excel-client-retention"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingClientRetention && (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-gray-500">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p>Loading retention analysis...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {clientRetentionError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="py-8">
                      <div className="text-center text-red-700">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p className="font-semibold mb-2">Error Loading Retention Data</p>
                        <p className="text-sm">{(clientRetentionError as Error).message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {!isLoadingClientRetention && !clientRetentionError && clientRetentionData && (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Total Active Clients</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-blue-600">
                            {clientRetentionData.summary?.totalActiveClients || 0}
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Retention Rate</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-green-600">
                            {clientRetentionData.summary?.overallRetentionRate?.toFixed(1) || "0"}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Last 12 months avg</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Average CLV</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-purple-600">
                            ${(clientRetentionData.summary?.averageCLV || 0).toLocaleString()}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Projected lifetime value</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Churn Rate</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-orange-600">
                            {clientRetentionData.summary?.churnRate?.toFixed(1) || "0"}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Annual churn</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>At-Risk Clients</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-red-600">
                            {clientRetentionData.summary?.atRiskClients || 0}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">High churn risk</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Retention Trend Chart */}
                      <ReportLineChart
                        data={clientRetentionData.retentionTrend || []}
                        xKey="month"
                        yKey="retentionRate"
                        title="Retention Rate Trend (Last 12 Months)"
                        height={300}
                        isLoading={isLoadingClientRetention}
                      />

                      {/* Churn Risk Distribution */}
                      <ReportPieChart
                        data={clientRetentionData.churnRiskDistribution || []}
                        dataKey="count"
                        nameKey="riskLevel"
                        title="Churn Risk Distribution"
                        height={300}
                        isLoading={isLoadingClientRetention}
                      />
                    </div>

                    {/* CLV Distribution Chart */}
                    <ReportBarChart
                      data={clientRetentionData.clvDistribution || []}
                      xKey="range"
                      yKey="count"
                      title="Client Lifetime Value Distribution"
                      height={300}
                      isLoading={isLoadingClientRetention}
                    />

                    {/* Client Lifetime Value Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Client Lifetime Value Analysis</CardTitle>
                        <CardDescription>Sorted by total revenue (highest first)</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Total Revenue</TableHead>
                                <TableHead className="text-right">Years Active</TableHead>
                                <TableHead className="text-right">Avg Revenue/Year</TableHead>
                                <TableHead className="text-right">Projected CLV</TableHead>
                                <TableHead>Churn Risk</TableHead>
                                <TableHead>Last Activity</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {(clientRetentionData.clientLifetimeValue || []).map((client: any, index: number) => (
                                <TableRow key={index} className={
                                  client.churnRisk === 'High' ? 'bg-red-50' :
                                    client.churnRisk === 'Medium' ? 'bg-yellow-50' :
                                      'bg-green-50'
                                }>
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right font-semibold">
                                    ${(client.totalRevenue || 0).toLocaleString()}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {client.yearsActive?.toFixed(1) || "0"}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    ${(client.avgRevenuePerYear || 0).toLocaleString()}
                                  </TableCell>
                                  <TableCell className="text-right font-semibold text-purple-600">
                                    ${(client.projectedCLV || 0).toLocaleString()}
                                  </TableCell>
                                  <TableCell>
                                    <Badge variant={
                                      client.churnRisk === 'High' ? 'destructive' :
                                        client.churnRisk === 'Medium' ? 'default' :
                                          'outline'
                                    } className={
                                      client.churnRisk === 'Low' ? 'bg-green-100 text-green-800 border-green-300' : ''
                                    }>
                                      {client.churnRisk || 'Low'}
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-sm">
                                    {client.lastActivity ? new Date(client.lastActivity).toLocaleDateString() : 'N/A'}
                                    {client.daysSinceLastActivity > 0 && (
                                      <div className="text-xs text-gray-500">
                                        ({client.daysSinceLastActivity} days ago)
                                      </div>
                                    )}
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Churn Risk Analysis Table */}
                    <Card className="border-orange-200">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <AlertTriangle className="w-5 h-5 text-orange-600" />
                          Churn Risk Analysis - Immediate Action Required
                        </CardTitle>
                        <CardDescription>
                          Clients at Medium or High risk of churning (sorted by risk level)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {clientRetentionData.churnRiskClients && clientRetentionData.churnRiskClients.length > 0 ? (
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Client Name</TableHead>
                                  <TableHead>Risk Level</TableHead>
                                  <TableHead className="text-right">Days Since Activity</TableHead>
                                  <TableHead className="text-right">Revenue Trend</TableHead>
                                  <TableHead>Payment Status</TableHead>
                                  <TableHead>Risk Factors</TableHead>
                                  <TableHead>Recommended Action</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {clientRetentionData.churnRiskClients.map((client: any, index: number) => (
                                  <TableRow key={index} className={
                                    client.churnRiskLevel === 'High' ? 'bg-red-50' : 'bg-yellow-50'
                                  }>
                                    <TableCell className="font-medium">{client.clientName}</TableCell>
                                    <TableCell>
                                      <Badge variant={client.churnRiskLevel === 'High' ? 'destructive' : 'default'}>
                                        {client.churnRiskLevel}
                                      </Badge>
                                    </TableCell>
                                    <TableCell className="text-right">
                                      <span className={client.daysSinceLastActivity > 90 ? 'text-red-600 font-semibold' : ''}>
                                        {client.daysSinceLastActivity || 0}
                                      </span>
                                    </TableCell>
                                    <TableCell className="text-right">
                                      <span className={client.revenueTrend < 0 ? 'text-red-600' : 'text-green-600'}>
                                        {client.revenueTrend?.toFixed(1) || "0"}%
                                      </span>
                                    </TableCell>
                                    <TableCell>
                                      <Badge variant={
                                        client.paymentStatus === 'Critical' || client.paymentStatus === 'At Risk' ? 'destructive' : 'outline'
                                      }>
                                        {client.paymentStatus || 'Current'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell className="max-w-xs">
                                      <ul className="text-sm space-y-1">
                                        {(client.riskFactors || []).map((factor: string, idx: number) => (
                                          <li key={idx} className="flex items-start gap-1">
                                            <span className="text-red-500 mt-0.5">‚Ä¢</span>
                                            <span>{factor}</span>
                                          </li>
                                        ))}
                                      </ul>
                                    </TableCell>
                                    <TableCell className="max-w-sm">
                                      <p className="text-sm">{client.recommendedAction || ''}</p>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        ) : (
                          <div className="text-center py-8 text-gray-500">
                            <CheckCircle className="w-12 h-12 mx-auto mb-4 text-green-500" />
                            <p className="font-semibold text-green-700">Great News!</p>
                            <p className="mt-2">No clients at medium or high churn risk</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>

                    {/* Cohort Analysis */}
                    {clientRetentionData.cohortAnalysis && clientRetentionData.cohortAnalysis.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Cohort Analysis</CardTitle>
                          <CardDescription>Retention rates by acquisition period</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Cohort</TableHead>
                                  <TableHead className="text-right">Initial Clients</TableHead>
                                  <TableHead className="text-right">Current Retention</TableHead>
                                  <TableHead className="text-right">Retained Clients</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {clientRetentionData.cohortAnalysis.map((cohort: any, index: number) => {
                                  const latestRetention = cohort.retentionByMonth?.[cohort.retentionByMonth.length - 1];
                                  return (
                                    <TableRow key={index}>
                                      <TableCell className="font-medium">{cohort.cohort}</TableCell>
                                      <TableCell className="text-right">{cohort.initialClients || 0}</TableCell>
                                      <TableCell className="text-right">
                                        <span className={
                                          (latestRetention?.retentionRate || 0) > 80 ? 'text-green-600 font-semibold' :
                                            (latestRetention?.retentionRate || 0) > 60 ? 'text-yellow-600' :
                                              'text-red-600 font-semibold'
                                        }>
                                          {latestRetention?.retentionRate?.toFixed(1) || "0"}%
                                        </span>
                                      </TableCell>
                                      <TableCell className="text-right">
                                        {latestRetention?.retainedClients || 0} / {cohort.initialClients || 0}
                                      </TableCell>
                                    </TableRow>
                                  );
                                })}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Retention Recommendations */}
                    <Card className="border-blue-200 bg-blue-50">
                      <CardHeader>
                        <CardTitle className="text-blue-900 flex items-center gap-2">
                          <Target className="w-5 h-5" />
                          Strategic Recommendations for Client Retention
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        {clientRetentionData.recommendations && clientRetentionData.recommendations.length > 0 ? (
                          <ul className="space-y-3">
                            {clientRetentionData.recommendations.map((recommendation: string, index: number) => (
                              <li key={index} className="flex items-start gap-3">
                                <div className="mt-0.5">
                                  {recommendation.includes('URGENT') || recommendation.includes('üö®') ? (
                                    <AlertTriangle className="w-5 h-5 text-red-600" />
                                  ) : recommendation.includes('‚ö†Ô∏è') ? (
                                    <AlertCircle className="w-5 h-5 text-orange-600" />
                                  ) : (
                                    <CheckCircle className="w-5 h-5 text-blue-600" />
                                  )}
                                </div>
                                <p className="text-sm text-gray-700 flex-1">{recommendation}</p>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          <p className="text-sm text-gray-700">No specific recommendations at this time. Continue monitoring retention metrics.</p>
                        )}
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Compliance Calendar Report */}
            {reportTab === 'compliance-calendar' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Compliance Calendar</CardTitle>
                        <CardDescription>Regulatory deadlines and filing requirements tracking</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={complianceStartDate}
                            onChange={(e) => setComplianceStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-compliance-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={complianceEndDate}
                            onChange={(e) => setComplianceEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-compliance-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchComplianceCalendar()}
                          disabled={isLoadingComplianceCalendar}
                          data-testid="button-refresh-compliance"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingComplianceCalendar ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!complianceCalendarData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: complianceStartDate,
                              endDate: complianceEndDate
                            };

                            const allDeadlines = [
                              ...complianceCalendarData.upcomingDeadlines.overdue,
                              ...complianceCalendarData.upcomingDeadlines.next30Days,
                              ...complianceCalendarData.upcomingDeadlines.days31To60,
                              ...complianceCalendarData.upcomingDeadlines.days61To90,
                              ...complianceCalendarData.upcomingDeadlines.days90Plus
                            ];

                            const tables: TableData[] = [
                              {
                                title: "All Compliance Deadlines",
                                headers: ["Client", "Type", "Deadline", "Days Until Due", "Frequency", "Status"],
                                rows: allDeadlines.map((item: any) => [
                                  item.clientName,
                                  item.complianceType,
                                  format(new Date(item.deadlineDate), 'MMM dd, yyyy'),
                                  item.daysUntilDue.toString(),
                                  item.filingFrequency,
                                  item.status
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Compliance Calendar",
                              dateRange,
                              tables,
                              summary: [
                                `Total Compliance Items: ${complianceCalendarData.summary.totalItems}`,
                                `Due in Next 30 Days: ${complianceCalendarData.summary.dueNext30Days}`,
                                `Overdue: ${complianceCalendarData.summary.overdue}`,
                                `Completed: ${complianceCalendarData.summary.completed}`
                              ]
                            }, firmInfo, "Compliance_Calendar.pdf");
                          }}
                          data-testid="button-export-pdf-compliance"
                        >
                          <Printer className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!complianceCalendarData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: complianceStartDate,
                              endDate: complianceEndDate
                            };

                            const allDeadlines = [
                              ...complianceCalendarData.upcomingDeadlines.overdue,
                              ...complianceCalendarData.upcomingDeadlines.next30Days,
                              ...complianceCalendarData.upcomingDeadlines.days31To60,
                              ...complianceCalendarData.upcomingDeadlines.days61To90,
                              ...complianceCalendarData.upcomingDeadlines.days90Plus
                            ];

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Compliance Items", complianceCalendarData.summary.totalItems.toString()],
                                  ["Due in Next 30 Days", complianceCalendarData.summary.dueNext30Days.toString()],
                                  ["Overdue", complianceCalendarData.summary.overdue.toString()],
                                  ["Completed", complianceCalendarData.summary.completed.toString()]
                                ]
                              },
                              {
                                title: "All Compliance Deadlines",
                                headers: ["Client", "Type", "Deadline", "Days Until Due", "Frequency", "Status"],
                                rows: allDeadlines.map((item: any) => [
                                  item.clientName,
                                  item.complianceType,
                                  format(new Date(item.deadlineDate), 'MMM dd, yyyy'),
                                  item.daysUntilDue.toString(),
                                  item.filingFrequency,
                                  item.status
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Compliance Calendar",
                              dateRange,
                              tables
                            }, firmInfo, "Compliance_Calendar.xlsx");
                          }}
                          data-testid="button-export-excel-compliance"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingComplianceCalendar && (
                  <Card>
                    <CardContent className="p-12 text-center">
                      <div className="flex flex-col items-center gap-4">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
                        <p className="text-gray-500">Loading compliance calendar data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {complianceCalendarError && (
                  <Card className="border-red-300 bg-red-50">
                    <CardContent className="p-6">
                      <p className="text-red-800">Error loading compliance calendar: {(complianceCalendarError as Error).message}</p>
                    </CardContent>
                  </Card>
                )}

                {complianceCalendarData && (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-500">Total Compliance Items</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold">{complianceCalendarData.summary.totalItems}</div>
                          <p className="text-xs text-gray-500 mt-1">In selected date range</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-500">Due in Next 30 Days</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-orange-600">{complianceCalendarData.summary.dueNext30Days}</div>
                          <p className="text-xs text-gray-500 mt-1">Requires immediate attention</p>
                        </CardContent>
                      </Card>

                      <Card className={complianceCalendarData.summary.overdue > 0 ? "border-red-300 bg-red-50" : ""}>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-500">Overdue Items</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-3xl font-bold ${complianceCalendarData.summary.overdue > 0 ? 'text-red-600' : 'text-gray-900'}`}>
                            {complianceCalendarData.summary.overdue}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Past deadline</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-500">Completed Items</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-3xl font-bold text-green-600">{complianceCalendarData.summary.completed}</div>
                          <p className="text-xs text-gray-500 mt-1">Filed on time</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Compliance Type Distribution Chart */}
                      <ReportPieChart
                        title="Compliance Type Distribution"
                        description="Breakdown by filing type"
                        data={complianceCalendarData.complianceTypeDistribution}
                      />

                      {/* Timeline View Chart */}
                      <ReportBarChart
                        title="Deadlines by Month"
                        description="Next 6 months timeline"
                        data={complianceCalendarData.monthlyTimeline}
                        xAxisKey="month"
                        yAxisKey="count"
                        barColor="#3b82f6"
                      />
                    </div>

                    {/* Upcoming Deadlines Table (Grouped by Time Buckets) */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Upcoming Deadlines</CardTitle>
                        <CardDescription>Organized by time period</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-6">
                          {/* Overdue Bucket */}
                          {complianceCalendarData.upcomingDeadlines.overdue.length > 0 && (
                            <div className="border border-red-300 rounded-lg overflow-hidden">
                              <div className="bg-red-100 px-4 py-3 border-b border-red-300">
                                <div className="flex items-center justify-between">
                                  <h3 className="text-lg font-semibold text-red-900 flex items-center gap-2">
                                    <AlertTriangle className="w-5 h-5" />
                                    Overdue ({complianceCalendarData.upcomingDeadlines.overdue.length})
                                  </h3>
                                  <Badge variant="destructive">Critical</Badge>
                                </div>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Client Name</TableHead>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Past Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                      <TableHead>Status</TableHead>
                                      <TableHead>Action</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {complianceCalendarData.upcomingDeadlines.overdue.map((item: any, index: number) => (
                                      <TableRow key={index} className="bg-red-50">
                                        <TableCell className="font-medium">{item.clientName}</TableCell>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell className="text-red-600 font-semibold">{Math.abs(item.daysUntilDue)} days</TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                        <TableCell>
                                          <Badge variant="destructive">{item.status}</Badge>
                                        </TableCell>
                                        <TableCell>
                                          <Button size="sm" variant="outline" className="text-xs">
                                            View Details
                                          </Button>
                                        </TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          )}

                          {/* Next 30 Days Bucket */}
                          {complianceCalendarData.upcomingDeadlines.next30Days.length > 0 && (
                            <div className="border border-orange-300 rounded-lg overflow-hidden">
                              <div className="bg-orange-100 px-4 py-3 border-b border-orange-300">
                                <h3 className="text-lg font-semibold text-orange-900">
                                  Next 30 Days ({complianceCalendarData.upcomingDeadlines.next30Days.length})
                                </h3>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Client Name</TableHead>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Until Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                      <TableHead>Status</TableHead>
                                      <TableHead>Action</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {complianceCalendarData.upcomingDeadlines.next30Days.map((item: any, index: number) => (
                                      <TableRow key={index}>
                                        <TableCell className="font-medium">{item.clientName}</TableCell>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell className="text-orange-600 font-semibold">{item.daysUntilDue} days</TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                        <TableCell>
                                          <Badge className="bg-orange-500">{item.status}</Badge>
                                        </TableCell>
                                        <TableCell>
                                          <Button size="sm" variant="outline" className="text-xs">
                                            View Details
                                          </Button>
                                        </TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          )}

                          {/* 31-60 Days Bucket */}
                          {complianceCalendarData.upcomingDeadlines.days31To60.length > 0 && (
                            <div className="border border-yellow-300 rounded-lg overflow-hidden">
                              <div className="bg-yellow-100 px-4 py-3 border-b border-yellow-300">
                                <h3 className="text-lg font-semibold text-yellow-900">
                                  31-60 Days ({complianceCalendarData.upcomingDeadlines.days31To60.length})
                                </h3>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Client Name</TableHead>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Until Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                      <TableHead>Status</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {complianceCalendarData.upcomingDeadlines.days31To60.map((item: any, index: number) => (
                                      <TableRow key={index}>
                                        <TableCell className="font-medium">{item.clientName}</TableCell>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell>{item.daysUntilDue} days</TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                        <TableCell>
                                          <Badge className="bg-yellow-500">{item.status}</Badge>
                                        </TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          )}

                          {/* 61-90 Days Bucket */}
                          {complianceCalendarData.upcomingDeadlines.days61To90.length > 0 && (
                            <div className="border border-blue-300 rounded-lg overflow-hidden">
                              <div className="bg-blue-100 px-4 py-3 border-b border-blue-300">
                                <h3 className="text-lg font-semibold text-blue-900">
                                  61-90 Days ({complianceCalendarData.upcomingDeadlines.days61To90.length})
                                </h3>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Client Name</TableHead>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Until Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {complianceCalendarData.upcomingDeadlines.days61To90.map((item: any, index: number) => (
                                      <TableRow key={index}>
                                        <TableCell className="font-medium">{item.clientName}</TableCell>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell>{item.daysUntilDue} days</TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          )}

                          {/* 90+ Days Bucket */}
                          {complianceCalendarData.upcomingDeadlines.days90Plus.length > 0 && (
                            <div className="border border-gray-300 rounded-lg overflow-hidden">
                              <div className="bg-gray-100 px-4 py-3 border-b border-gray-300">
                                <h3 className="text-lg font-semibold text-gray-900">
                                  90+ Days ({complianceCalendarData.upcomingDeadlines.days90Plus.length})
                                </h3>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Client Name</TableHead>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Until Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {complianceCalendarData.upcomingDeadlines.days90Plus.map((item: any, index: number) => (
                                      <TableRow key={index}>
                                        <TableCell className="font-medium">{item.clientName}</TableCell>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell>{item.daysUntilDue} days</TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>

                    {/* Compliance by Client Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Compliance Items by Client</CardTitle>
                        <CardDescription>All upcoming items grouped by client</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {complianceCalendarData.complianceByClient.map((client: any, index: number) => (
                            <div key={index} className="border rounded-lg overflow-hidden">
                              <div className="bg-gray-50 px-4 py-3 border-b">
                                <div className="flex items-center justify-between">
                                  <h3 className="font-semibold flex items-center gap-2">
                                    <Building2 className="w-4 h-4" />
                                    {client.clientName}
                                  </h3>
                                  <Badge>{client.itemCount} items</Badge>
                                </div>
                              </div>
                              <div className="overflow-x-auto">
                                <Table>
                                  <TableHeader>
                                    <TableRow>
                                      <TableHead>Compliance Type</TableHead>
                                      <TableHead>Deadline</TableHead>
                                      <TableHead>Days Until Due</TableHead>
                                      <TableHead>Frequency</TableHead>
                                      <TableHead>Status</TableHead>
                                    </TableRow>
                                  </TableHeader>
                                  <TableBody>
                                    {client.items.map((item: any, itemIndex: number) => (
                                      <TableRow key={itemIndex}>
                                        <TableCell>{item.complianceType}</TableCell>
                                        <TableCell>{format(new Date(item.deadlineDate), 'MMM dd, yyyy')}</TableCell>
                                        <TableCell className={item.daysUntilDue < 0 ? 'text-red-600 font-semibold' : item.daysUntilDue <= 30 ? 'text-orange-600 font-semibold' : ''}>
                                          {item.daysUntilDue < 0 ? `${Math.abs(item.daysUntilDue)} days past` : `${item.daysUntilDue} days`}
                                        </TableCell>
                                        <TableCell>{item.filingFrequency}</TableCell>
                                        <TableCell>
                                          <Badge
                                            variant={item.status === 'Overdue' ? 'destructive' : 'default'}
                                            className={
                                              item.status === 'Due Soon' ? 'bg-orange-500' :
                                                item.status === 'Completed' ? 'bg-green-500' :
                                                  item.status === 'Upcoming' ? 'bg-blue-500' :
                                                    ''
                                            }
                                          >
                                            {item.status}
                                          </Badge>
                                        </TableCell>
                                      </TableRow>
                                    ))}
                                  </TableBody>
                                </Table>
                              </div>
                            </div>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {/* Service Delivery Metrics Report */}
            {reportTab === 'service-delivery' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Service Delivery Metrics</CardTitle>
                        <CardDescription>SLA compliance and quality indicators for client service delivery</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={serviceDeliveryStartDate}
                            onChange={(e) => setServiceDeliveryStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-service-delivery-start-date"
                          />
                          <span>to</span>
                          <Input
                            type="date"
                            value={serviceDeliveryEndDate}
                            onChange={(e) => setServiceDeliveryEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-service-delivery-end-date"
                          />
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => refetchServiceDelivery()}
                            data-testid="button-refresh-service-delivery"
                          >
                            <RefreshCw className="h-4 w-4 mr-2" />
                            Refresh
                          </Button>
                        </div>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingServiceDelivery ? (
                  <div className="flex items-center justify-center py-12">
                    <div className="text-center">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                      <p className="mt-4 text-gray-600">Loading service delivery metrics...</p>
                    </div>
                  </div>
                ) : serviceDeliveryError ? (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="text-center text-red-600">
                        <AlertCircle className="h-12 w-12 mx-auto mb-4" />
                        <p>Error loading service delivery data. Please try again.</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : serviceDeliveryData ? (
                  <>
                    {/* KPI Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>On-Time Completion Rate</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="flex items-baseline justify-between">
                            <div className="text-3xl font-bold text-green-600">
                              {serviceDeliveryData.summary.onTimeCompletionRate.toFixed(1)}%
                            </div>
                            <Target className="h-8 w-8 text-green-600 opacity-30" />
                          </div>
                          <p className="text-xs text-gray-500 mt-2">
                            {serviceDeliveryData.slaMetrics.tasksCompletedOnTime} of {serviceDeliveryData.summary.totalTasksCompleted} tasks on time
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Average Response Time</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="flex items-baseline justify-between">
                            <div className="text-3xl font-bold text-blue-600">
                              {serviceDeliveryData.summary.averageResponseTime.toFixed(1)}
                            </div>
                            <Clock className="h-8 w-8 text-blue-600 opacity-30" />
                          </div>
                          <p className="text-xs text-gray-500 mt-2">
                            days to start task
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Average Completion Time</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="flex items-baseline justify-between">
                            <div className="text-3xl font-bold text-purple-600">
                              {serviceDeliveryData.summary.averageCompletionTime.toFixed(1)}
                            </div>
                            <Timer className="h-8 w-8 text-purple-600 opacity-30" />
                          </div>
                          <p className="text-xs text-gray-500 mt-2">
                            days from start to complete
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Tasks Completed</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="flex items-baseline justify-between">
                            <div className="text-3xl font-bold text-orange-600">
                              {serviceDeliveryData.summary.totalTasksCompleted}
                            </div>
                            <CheckCircle className="h-8 w-8 text-orange-600 opacity-30" />
                          </div>
                          <p className="text-xs text-gray-500 mt-2">
                            in selected period
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>SLA Compliance Score</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="flex items-baseline justify-between">
                            <div className={`text-3xl font-bold ${serviceDeliveryData.summary.slaComplianceScore >= 90 ? 'text-green-600' :
                              serviceDeliveryData.summary.slaComplianceScore >= 70 ? 'text-yellow-600' :
                                'text-red-600'
                              }`}>
                              {serviceDeliveryData.summary.slaComplianceScore.toFixed(0)}
                            </div>
                            <Star className={`h-8 w-8 opacity-30 ${serviceDeliveryData.summary.slaComplianceScore >= 90 ? 'text-green-600' :
                              serviceDeliveryData.summary.slaComplianceScore >= 70 ? 'text-yellow-600' :
                                'text-red-600'
                              }`} />
                          </div>
                          <p className="text-xs text-gray-500 mt-2">
                            composite quality metric
                          </p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* SLA Compliance Trend Chart */}
                      <ReportLineChart
                        data={serviceDeliveryData.deliveryTrends.map((trend: any) => ({
                          period: trend.period,
                          'On-Time %': trend.onTimeRate
                        }))}
                        xKey="period"
                        yKey="On-Time %"
                        title="SLA Compliance Trend"
                        colors={["#10b981"]}
                        isLoading={false}
                        height={300}
                      />

                      {/* Completion Time Distribution */}
                      <ReportBarChart
                        data={serviceDeliveryData.completionTimeDistribution}
                        xKey="range"
                        yKey="count"
                        title="Completion Time Distribution"
                        color="#3b82f6"
                        isLoading={false}
                        height={300}
                      />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Service Quality Distribution */}
                      <ReportPieChart
                        data={serviceDeliveryData.serviceQualityDistribution.map((item: any) => ({
                          name: item.status,
                          value: item.count
                        }))}
                        title="Service Quality Distribution"
                        colors={["#10b981", "#f59e0b", "#ef4444", "#6b7280"]}
                        isLoading={false}
                        height={300}
                      />

                      {/* SLA Metrics Summary Card */}
                      <Card>
                        <CardHeader>
                          <CardTitle>SLA Performance Summary</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-4">
                            <div className="flex justify-between items-center">
                              <span className="text-sm font-medium">Tasks On Time</span>
                              <span className="text-sm font-bold text-green-600">{serviceDeliveryData.slaMetrics.tasksCompletedOnTime}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm font-medium">Tasks Late</span>
                              <span className="text-sm font-bold text-red-600">{serviceDeliveryData.slaMetrics.tasksCompletedLate}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm font-medium">On-Time Rate</span>
                              <span className="text-sm font-bold">{serviceDeliveryData.slaMetrics.onTimeRate.toFixed(1)}%</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm font-medium">Avg Days Late (for late tasks)</span>
                              <span className="text-sm font-bold text-orange-600">{serviceDeliveryData.slaMetrics.averageDaysLate.toFixed(1)} days</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm font-medium">Avg Cycle Time</span>
                              <span className="text-sm font-bold">{serviceDeliveryData.summary.averageCycleTime.toFixed(1)} days</span>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Detailed Service Metrics Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex justify-between items-center">
                          <div>
                            <CardTitle>Service Metrics by Client</CardTitle>
                            <CardDescription>Performance breakdown for each client (sorted by on-time % - lowest first)</CardDescription>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={async () => {
                                const dateRange: DateRange = {
                                  startDate: serviceDeliveryStartDate,
                                  endDate: serviceDeliveryEndDate
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Service Metrics by Client",
                                    headers: ["Client Name", "Tasks Completed", "On-Time %", "Avg Response Days", "Avg Completion Days", "Quality Score"],
                                    rows: serviceDeliveryData.clientMetrics.map((client: any) => [
                                      client.clientName,
                                      client.tasksCompleted.toString(),
                                      `${client.onTimePercentage.toFixed(1)}%`,
                                      client.avgResponseDays.toFixed(1),
                                      client.avgCompletionDays.toFixed(1),
                                      client.qualityScore.toFixed(0)
                                    ])
                                  },
                                  {
                                    title: "Late Tasks Analysis",
                                    headers: ["Task Title", "Client", "Due Date", "Completed", "Days Late"],
                                    rows: serviceDeliveryData.lateTasks.map((task: any) => [
                                      task.taskTitle,
                                      task.clientName,
                                      task.dueDate,
                                      task.completedDate,
                                      task.daysLate.toString()
                                    ])
                                  }
                                ];

                                await exportReportToPDF({
                                  title: "Service Delivery Metrics",
                                  dateRange,
                                  tables,
                                  summary: [
                                    `Total Tasks Completed: ${serviceDeliveryData.summary.totalTasksCompleted}`,
                                    `On-Time Completion Rate: ${serviceDeliveryData.summary.onTimeCompletionRate.toFixed(1)}%`,
                                    `SLA Compliance Score: ${serviceDeliveryData.summary.slaComplianceScore.toFixed(0)}`,
                                    `Average Response Time: ${serviceDeliveryData.summary.averageResponseTime.toFixed(1)} days`,
                                    `Average Completion Time: ${serviceDeliveryData.summary.averageCompletionTime.toFixed(1)} days`
                                  ]
                                }, firmInfo);
                              }}
                              data-testid="button-export-pdf-service-delivery"
                            >
                              <FileTextIcon className="h-4 w-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => {
                                const dateRange: DateRange = {
                                  startDate: serviceDeliveryStartDate,
                                  endDate: serviceDeliveryEndDate
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Service Metrics by Client",
                                    headers: ["Client Name", "Tasks Completed", "On-Time %", "Avg Response Days", "Avg Completion Days", "Quality Score"],
                                    rows: serviceDeliveryData.clientMetrics.map((client: any) => [
                                      client.clientName,
                                      client.tasksCompleted.toString(),
                                      `${client.onTimePercentage.toFixed(1)}%`,
                                      client.avgResponseDays.toFixed(1),
                                      client.avgCompletionDays.toFixed(1),
                                      client.qualityScore.toFixed(0)
                                    ])
                                  },
                                  {
                                    title: "Late Tasks Analysis",
                                    headers: ["Task Title", "Client", "Due Date", "Completed", "Days Late", "Notes"],
                                    rows: serviceDeliveryData.lateTasks.map((task: any) => [
                                      task.taskTitle,
                                      task.clientName,
                                      task.dueDate,
                                      task.completedDate,
                                      task.daysLate.toString(),
                                      task.notes || ''
                                    ])
                                  },
                                  {
                                    title: "Performance by Staff",
                                    headers: ["Staff Name", "Tasks Completed", "On-Time %", "Avg Completion Time"],
                                    rows: serviceDeliveryData.staffMetrics.map((staff: any) => [
                                      staff.staffName,
                                      staff.tasksCompleted.toString(),
                                      `${staff.onTimePercentage.toFixed(1)}%`,
                                      staff.avgCompletionTime.toFixed(1)
                                    ])
                                  }
                                ];

                                exportReportToExcel({
                                  title: "Service Delivery Metrics",
                                  dateRange,
                                  tables
                                }, firmInfo, "Service_Delivery_Metrics.xlsx");
                              }}
                              data-testid="button-export-excel-service-delivery"
                            >
                              <FileSpreadsheet className="h-4 w-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Tasks Completed</TableHead>
                                <TableHead className="text-right">On-Time %</TableHead>
                                <TableHead className="text-right">Avg Response Days</TableHead>
                                <TableHead className="text-right">Avg Completion Days</TableHead>
                                <TableHead className="text-right">Quality Score</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {serviceDeliveryData.clientMetrics.map((client: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right">{client.tasksCompleted}</TableCell>
                                  <TableCell className="text-right">
                                    <Badge className={
                                      client.onTimePercentage >= 90 ? 'bg-green-500' :
                                        client.onTimePercentage >= 70 ? 'bg-yellow-500' :
                                          'bg-red-500'
                                    }>
                                      {client.onTimePercentage.toFixed(1)}%
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-right">{client.avgResponseDays.toFixed(1)}</TableCell>
                                  <TableCell className="text-right">{client.avgCompletionDays.toFixed(1)}</TableCell>
                                  <TableCell className="text-right">
                                    <Badge variant="outline" className={
                                      client.qualityScore >= 90 ? 'border-green-500 text-green-700' :
                                        client.qualityScore >= 70 ? 'border-yellow-500 text-yellow-700' :
                                          'border-red-500 text-red-700'
                                    }>
                                      {client.qualityScore.toFixed(0)}
                                    </Badge>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Late Tasks Analysis */}
                    {serviceDeliveryData.lateTasks.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Late Tasks Analysis</CardTitle>
                          <CardDescription>Tasks completed after due date (sorted by days late - most late first)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Task Title</TableHead>
                                  <TableHead>Client</TableHead>
                                  <TableHead>Due Date</TableHead>
                                  <TableHead>Completed Date</TableHead>
                                  <TableHead className="text-right">Days Late</TableHead>
                                  <TableHead>Notes</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {serviceDeliveryData.lateTasks.map((task: any, index: number) => (
                                  <TableRow key={index}>
                                    <TableCell className="font-medium">{task.taskTitle}</TableCell>
                                    <TableCell>{task.clientName}</TableCell>
                                    <TableCell>{format(new Date(task.dueDate), 'MMM dd, yyyy')}</TableCell>
                                    <TableCell>{format(new Date(task.completedDate), 'MMM dd, yyyy')}</TableCell>
                                    <TableCell className="text-right">
                                      <Badge variant="destructive">{task.daysLate} days</Badge>
                                    </TableCell>
                                    <TableCell className="text-xs text-gray-600">{task.notes || '-'}</TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Performance by Staff */}
                    {serviceDeliveryData.staffMetrics.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Performance by Staff</CardTitle>
                          <CardDescription>Individual staff performance metrics (sorted by on-time % - highest first)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Staff Name</TableHead>
                                  <TableHead className="text-right">Tasks Completed</TableHead>
                                  <TableHead className="text-right">On-Time %</TableHead>
                                  <TableHead className="text-right">Avg Completion Time (days)</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {serviceDeliveryData.staffMetrics.map((staff: any, index: number) => (
                                  <TableRow key={index}>
                                    <TableCell className="font-medium flex items-center gap-2">
                                      <User className="h-4 w-4 text-gray-400" />
                                      {staff.staffName}
                                    </TableCell>
                                    <TableCell className="text-right">{staff.tasksCompleted}</TableCell>
                                    <TableCell className="text-right">
                                      <Badge className={
                                        staff.onTimePercentage >= 90 ? 'bg-green-500' :
                                          staff.onTimePercentage >= 70 ? 'bg-yellow-500' :
                                            'bg-red-500'
                                      }>
                                        {staff.onTimePercentage.toFixed(1)}%
                                      </Badge>
                                    </TableCell>
                                    <TableCell className="text-right">{staff.avgCompletionTime.toFixed(1)}</TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : null}
              </div>
            )}

            {/* Client Communication Log Report */}
            {reportTab === 'client-communication' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Client Communication Log</CardTitle>
                        <CardDescription>Comprehensive communication metrics showing all interactions and response times</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center flex-wrap">
                          <Input
                            type="date"
                            value={clientCommStartDate}
                            onChange={(e) => setClientCommStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-client-comm-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={clientCommEndDate}
                            onChange={(e) => setClientCommEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-client-comm-end-date"
                          />
                          <Select value={clientCommFilter} onValueChange={setClientCommFilter}>
                            <SelectTrigger className="w-48" data-testid="select-client-filter">
                              <SelectValue placeholder="Filter by client" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="all">All Clients</SelectItem>
                              {(clients || []).map((client: any) => (
                                <SelectItem key={client.id} value={client.id.toString()}>
                                  {client.name}
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingClientComm ? (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="flex items-center justify-center h-64">
                        <div className="text-center">
                          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                          <p className="mt-4 text-sm text-gray-500">Loading communication data...</p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ) : clientCommError ? (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="text-center text-red-500">
                        <AlertCircle className="h-12 w-12 mx-auto mb-4" />
                        <p>Error loading communication data</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : clientCommunicationData ? (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Total Communications</CardDescription>
                          <CardTitle className="text-3xl">{clientCommunicationData.summary.totalCommunications}</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <p className="text-xs text-gray-500">All messages in period</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Average Response Time</CardDescription>
                          <CardTitle className="text-3xl">
                            {clientCommunicationData.summary.averageResponseTimeHours.toFixed(1)}h
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <Badge className={
                            clientCommunicationData.summary.averageResponseTimeHours < 4 ? 'bg-green-500' :
                              clientCommunicationData.summary.averageResponseTimeHours < 24 ? 'bg-yellow-500' :
                                'bg-red-500'
                          }>
                            {clientCommunicationData.summary.averageResponseTimeHours < 4 ? 'Excellent' :
                              clientCommunicationData.summary.averageResponseTimeHours < 24 ? 'Good' : 'Needs Improvement'}
                          </Badge>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Response Rate</CardDescription>
                          <CardTitle className="text-3xl">
                            {clientCommunicationData.summary.responseRate.toFixed(1)}%
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <Badge className={
                            clientCommunicationData.summary.responseRate >= 90 ? 'bg-green-500' :
                              clientCommunicationData.summary.responseRate >= 70 ? 'bg-yellow-500' :
                                'bg-red-500'
                          }>
                            {clientCommunicationData.summary.responseRate >= 90 ? 'Excellent' :
                              clientCommunicationData.summary.responseRate >= 70 ? 'Good' : 'Needs Improvement'}
                          </Badge>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Inbound Messages</CardDescription>
                          <CardTitle className="text-3xl">{clientCommunicationData.summary.inboundMessages}</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <p className="text-xs text-gray-500">From clients</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Outbound Messages</CardDescription>
                          <CardTitle className="text-3xl">{clientCommunicationData.summary.outboundMessages}</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <p className="text-xs text-gray-500">To clients</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Communication Volume Trend Chart */}
                      <ReportLineChart
                        data={clientCommunicationData.volumeTrend}
                        xKey="date"
                        yKey={["count", "inbound", "outbound"]}
                        title="Communication Volume Trend"
                        colors={["#3b82f6", "#10b981", "#f59e0b"]}
                      />

                      {/* Communication by Channel Chart */}
                      <ReportPieChart
                        data={clientCommunicationData.channelDistribution}
                        dataKey="count"
                        nameKey="channel"
                        title="Communication by Channel"
                      />
                    </div>

                    {/* Response Time by Client Chart */}
                    <ReportBarChart
                      data={clientCommunicationData.clientCommunications.slice(0, 10)}
                      xKey="clientName"
                      yKey="avgResponseTimeHours"
                      title="Average Response Time by Client (Top 10)"
                    />

                    {/* Unresponded Messages Alert */}
                    {clientCommunicationData.unrespondedMessages.length > 0 && (
                      <Card className="border-red-500 bg-red-50">
                        <CardHeader>
                          <div className="flex items-center gap-2">
                            <AlertTriangle className="h-5 w-5 text-red-600" />
                            <CardTitle className="text-red-900">Unresponded Client Messages</CardTitle>
                          </div>
                          <CardDescription className="text-red-700">
                            {clientCommunicationData.unrespondedMessages.length} client message(s) waiting for response
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-2">
                            {clientCommunicationData.unrespondedMessages.slice(0, 5).map((msg: any) => (
                              <div key={msg.messageId} className="flex justify-between items-center p-2 bg-white rounded border border-red-200">
                                <div>
                                  <p className="font-medium text-sm">{msg.clientName}</p>
                                  <p className="text-xs text-gray-600">{msg.subject}</p>
                                  <p className="text-xs text-gray-500">
                                    {msg.channel} ‚Ä¢ {format(new Date(msg.date), 'MMM dd, yyyy')}
                                  </p>
                                </div>
                                <Badge variant="destructive">
                                  {msg.hoursWaiting.toFixed(0)}h waiting
                                </Badge>
                              </div>
                            ))}
                            {clientCommunicationData.unrespondedMessages.length > 5 && (
                              <p className="text-xs text-red-600 mt-2">
                                +{clientCommunicationData.unrespondedMessages.length - 5} more unresponded messages
                              </p>
                            )}
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Communication Log Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex justify-between items-center">
                          <div>
                            <CardTitle>Client Communication Log</CardTitle>
                            <CardDescription>Communication metrics by client (sorted by most active)</CardDescription>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const dateRange = {
                                  startDate: clientCommStartDate,
                                  endDate: clientCommEndDate
                                };

                                const firmInfo: FirmInfo = {
                                  name: user?.firm || 'Firm',
                                  address: '',
                                  phone: '',
                                  email: ''
                                };

                                const tables = [
                                  {
                                    title: "Communication Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Communications", clientCommunicationData.summary.totalCommunications.toString()],
                                      ["Inbound Messages", clientCommunicationData.summary.inboundMessages.toString()],
                                      ["Outbound Messages", clientCommunicationData.summary.outboundMessages.toString()],
                                      ["Average Response Time", `${clientCommunicationData.summary.averageResponseTimeHours.toFixed(1)} hours`],
                                      ["Response Rate", `${clientCommunicationData.summary.responseRate.toFixed(1)}%`]
                                    ]
                                  },
                                  {
                                    title: "Communication by Client",
                                    headers: ["Client", "Total", "Inbound", "Outbound", "Avg Response (hrs)", "Response Rate %", "Unresponded"],
                                    rows: clientCommunicationData.clientCommunications.map((client: any) => [
                                      client.clientName,
                                      client.totalMessages.toString(),
                                      client.inbound.toString(),
                                      client.outbound.toString(),
                                      client.avgResponseTimeHours.toFixed(1),
                                      client.responseRate.toFixed(1),
                                      client.unrespondedCount.toString()
                                    ])
                                  }
                                ];

                                exportReportToPDF({
                                  title: "Client Communication Log",
                                  dateRange,
                                  tables,
                                  summary: [
                                    `Total Communications: ${clientCommunicationData.summary.totalCommunications}`,
                                    `Average Response Time: ${clientCommunicationData.summary.averageResponseTimeHours.toFixed(1)} hours`,
                                    `Response Rate: ${clientCommunicationData.summary.responseRate.toFixed(1)}%`,
                                    `Unresponded Messages: ${clientCommunicationData.unrespondedMessages.length}`
                                  ]
                                }, firmInfo);
                              }}
                              data-testid="button-export-pdf-client-comm"
                            >
                              <Printer className="h-4 w-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const dateRange = {
                                  startDate: clientCommStartDate,
                                  endDate: clientCommEndDate
                                };

                                const firmInfo: FirmInfo = {
                                  name: user?.firm || 'Firm',
                                  address: '',
                                  phone: '',
                                  email: ''
                                };

                                const tables = [
                                  {
                                    title: "Communication Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Total Communications", clientCommunicationData.summary.totalCommunications.toString()],
                                      ["Inbound Messages", clientCommunicationData.summary.inboundMessages.toString()],
                                      ["Outbound Messages", clientCommunicationData.summary.outboundMessages.toString()],
                                      ["Average Response Time", `${clientCommunicationData.summary.averageResponseTimeHours.toFixed(1)} hours`],
                                      ["Response Rate", `${clientCommunicationData.summary.responseRate.toFixed(1)}%`]
                                    ]
                                  },
                                  {
                                    title: "Communication by Client",
                                    headers: ["Client", "Total", "Inbound", "Outbound", "Avg Response (hrs)", "Response Rate %", "Unresponded"],
                                    rows: clientCommunicationData.clientCommunications.map((client: any) => [
                                      client.clientName,
                                      client.totalMessages.toString(),
                                      client.inbound.toString(),
                                      client.outbound.toString(),
                                      client.avgResponseTimeHours.toFixed(1),
                                      client.responseRate.toFixed(1),
                                      client.unrespondedCount.toString()
                                    ])
                                  },
                                  {
                                    title: "Channel Distribution",
                                    headers: ["Channel", "Count", "Percentage"],
                                    rows: clientCommunicationData.channelDistribution.map((channel: any) => [
                                      channel.channel,
                                      channel.count.toString(),
                                      `${channel.percentage.toFixed(1)}%`
                                    ])
                                  }
                                ];

                                exportReportToExcel({
                                  title: "Client Communication Log",
                                  dateRange,
                                  tables
                                }, firmInfo, "Client_Communication_Log.xlsx");
                              }}
                              data-testid="button-export-excel-client-comm"
                            >
                              <FileSpreadsheet className="h-4 w-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Total Messages</TableHead>
                                <TableHead className="text-right">Inbound</TableHead>
                                <TableHead className="text-right">Outbound</TableHead>
                                <TableHead className="text-right">Avg Response Time</TableHead>
                                <TableHead className="text-right">Response Rate</TableHead>
                                <TableHead className="text-right">Unresponded</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {clientCommunicationData.clientCommunications.map((client: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right">{client.totalMessages}</TableCell>
                                  <TableCell className="text-right">{client.inbound}</TableCell>
                                  <TableCell className="text-right">{client.outbound}</TableCell>
                                  <TableCell className="text-right">
                                    <Badge className={
                                      client.avgResponseTimeHours < 4 ? 'bg-green-500' :
                                        client.avgResponseTimeHours < 24 ? 'bg-yellow-500' :
                                          'bg-red-500'
                                    }>
                                      {client.avgResponseTimeHours.toFixed(1)}h
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-right">{client.responseRate.toFixed(1)}%</TableCell>
                                  <TableCell className="text-right">
                                    {client.unrespondedCount > 0 ? (
                                      <Badge variant="destructive">{client.unrespondedCount}</Badge>
                                    ) : (
                                      <span className="text-gray-400">0</span>
                                    )}
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Recent Messages Table */}
                    {clientCommunicationData.recentMessages.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Recent Messages</CardTitle>
                          <CardDescription>Last 50 communication messages</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Date/Time</TableHead>
                                  <TableHead>Client</TableHead>
                                  <TableHead>Direction</TableHead>
                                  <TableHead>Channel</TableHead>
                                  <TableHead>Subject</TableHead>
                                  <TableHead>Preview</TableHead>
                                  <TableHead className="text-right">Response Time</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {clientCommunicationData.recentMessages.map((msg: any) => (
                                  <TableRow key={msg.id}>
                                    <TableCell className="text-xs">{format(new Date(msg.date), 'MMM dd, HH:mm')}</TableCell>
                                    <TableCell className="text-sm">{msg.clientName}</TableCell>
                                    <TableCell>
                                      <Badge variant={msg.direction === 'Inbound' ? 'secondary' : 'outline'}>
                                        {msg.direction}
                                      </Badge>
                                    </TableCell>
                                    <TableCell className="text-sm">{msg.channel}</TableCell>
                                    <TableCell className="text-sm">{msg.subject}</TableCell>
                                    <TableCell className="text-xs text-gray-600 max-w-xs truncate">{msg.preview}</TableCell>
                                    <TableCell className="text-right text-xs">
                                      {msg.responseTimeHours !== null ? (
                                        <Badge className={
                                          msg.responseTimeHours < 4 ? 'bg-green-500' :
                                            msg.responseTimeHours < 24 ? 'bg-yellow-500' :
                                              'bg-red-500'
                                        }>
                                          {msg.responseTimeHours.toFixed(1)}h
                                        </Badge>
                                      ) : (
                                        <span className="text-gray-400">-</span>
                                      )}
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : null}
              </div>
            )}

            {/* Realization Rate Report */}
            {reportTab === 'realization-rate' && (
              <div className="space-y-6">
                {/* Date Range Selector and Export Actions */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Realization Rate Report</CardTitle>
                        <CardDescription>Compare budgeted amounts vs actual billed amounts for project profitability analysis</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={realizationStartDate}
                            onChange={(e) => setRealizationStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-realization-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={realizationEndDate}
                            onChange={(e) => setRealizationEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-realization-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchRealization()}
                          data-testid="button-refresh-realization"
                        >
                          <RefreshCw className="h-4 w-4 mr-2" />
                          Refresh
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingRealization ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="text-center">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                      <p className="mt-2 text-sm text-gray-500">Loading realization data...</p>
                    </div>
                  </div>
                ) : realizationError ? (
                  <Card>
                    <CardContent className="py-8">
                      <div className="text-center text-red-500">
                        <AlertCircle className="h-8 w-8 mx-auto mb-2" />
                        <p>Error loading realization rate data</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : realizationData ? (
                  <>
                    {/* KPI Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Overall Realization Rate</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            {realizationData.summary.overallRealizationRate.toFixed(1)}%
                          </div>
                          <Badge className={
                            realizationData.summary.overallRealizationRate > 100 ? 'bg-green-500' :
                              realizationData.summary.overallRealizationRate >= 90 ? 'bg-blue-500' :
                                'bg-red-500'
                          }>
                            {realizationData.summary.overallRealizationRate > 100 ? 'Over-realized' :
                              realizationData.summary.overallRealizationRate >= 90 ? 'On-target' :
                                'Under-realized'}
                          </Badge>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Total Budgeted Revenue</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            ${realizationData.summary.totalBudgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Expected revenue</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Total Actual Revenue</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            ${realizationData.summary.totalActualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Invoiced revenue</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Revenue Variance</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${realizationData.summary.revenueVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {realizationData.summary.revenueVariance >= 0 ? '+' : ''}${Math.abs(realizationData.summary.revenueVariance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            {realizationData.summary.revenueVariance >= 0 ? 'Above budget' : 'Below budget'}
                          </p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardDescription>Avg Project Realization</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">
                            {realizationData.summary.averageProjectRealization.toFixed(1)}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            {realizationData.summary.totalProjects} projects
                          </p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Realization Trend Chart */}
                      {realizationData.monthlyTrend.length > 0 && (
                        <ReportLineChart
                          data={realizationData.monthlyTrend}
                          xKey="month"
                          yKey="realizationRate"
                          title="Realization Rate Trend"
                          height={300}
                        />
                      )}

                      {/* Realization Distribution Pie Chart */}
                      <ReportPieChart
                        data={[
                          { name: 'Over-realized (>100%)', value: realizationData.distribution.overRealized, fill: '#10b981' },
                          { name: 'On-target (90-100%)', value: realizationData.distribution.onTarget, fill: '#3b82f6' },
                          { name: 'Under-realized (<90%)', value: realizationData.distribution.underRealized, fill: '#ef4444' }
                        ]}
                        title="Realization Distribution"
                        height={300}
                      />
                    </div>

                    {/* Realization by Client Bar Chart */}
                    {realizationData.clientRealization.length > 0 && (
                      <ReportBarChart
                        data={realizationData.clientRealization.slice(0, 10)}
                        xKey="clientName"
                        yKey="avgRealizationRate"
                        title="Realization Rate by Client (Top 10)"
                        height={350}
                      />
                    )}

                    {/* Project Realization Table */}
                    <Card>
                      <CardHeader>
                        <div className="flex justify-between items-center">
                          <div>
                            <CardTitle>Project Realization Details</CardTitle>
                            <CardDescription>Budget vs actual comparison for all projects (sorted by realization rate)</CardDescription>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const dateRange = {
                                  startDate: realizationStartDate,
                                  endDate: realizationEndDate
                                };

                                const firmInfo: FirmInfo = {
                                  name: user?.firm || 'Firm',
                                  address: '',
                                  phone: '',
                                  email: ''
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Realization Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Overall Realization Rate", `${realizationData.summary.overallRealizationRate.toFixed(1)}%`],
                                      ["Total Budgeted Revenue", `$${realizationData.summary.totalBudgetedRevenue.toLocaleString()}`],
                                      ["Total Actual Revenue", `$${realizationData.summary.totalActualRevenue.toLocaleString()}`],
                                      ["Revenue Variance", `$${realizationData.summary.revenueVariance.toLocaleString()}`],
                                      ["Average Project Realization", `${realizationData.summary.averageProjectRealization.toFixed(1)}%`],
                                      ["Total Projects", realizationData.summary.totalProjects.toString()]
                                    ]
                                  },
                                  {
                                    title: "Project Realization",
                                    headers: ["Project", "Client", "Budgeted Hrs", "Actual Hrs", "Hour Var", "Budgeted $", "Actual $", "$ Var", "Realization %"],
                                    rows: realizationData.projectRealization.map((proj: any) => [
                                      proj.projectName,
                                      proj.clientName,
                                      proj.budgetedHours.toFixed(1),
                                      proj.actualHours.toFixed(1),
                                      proj.hourVariance.toFixed(1),
                                      `$${proj.budgetedRevenue.toLocaleString()}`,
                                      `$${proj.actualRevenue.toLocaleString()}`,
                                      `$${proj.revenueVariance.toLocaleString()}`,
                                      `${proj.realizationRate.toFixed(1)}%`
                                    ])
                                  }
                                ];

                                exportReportToPDF({
                                  title: "Realization Rate Report",
                                  dateRange,
                                  tables
                                }, firmInfo);
                              }}
                              data-testid="button-export-pdf-realization"
                            >
                              <Printer className="h-4 w-4 mr-2" />
                              Export PDF
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const dateRange = {
                                  startDate: realizationStartDate,
                                  endDate: realizationEndDate
                                };

                                const firmInfo: FirmInfo = {
                                  name: user?.firm || 'Firm',
                                  address: '',
                                  phone: '',
                                  email: ''
                                };

                                const tables: TableData[] = [
                                  {
                                    title: "Realization Summary",
                                    headers: ["Metric", "Value"],
                                    rows: [
                                      ["Overall Realization Rate", `${realizationData.summary.overallRealizationRate.toFixed(1)}%`],
                                      ["Total Budgeted Revenue", `$${realizationData.summary.totalBudgetedRevenue.toLocaleString()}`],
                                      ["Total Actual Revenue", `$${realizationData.summary.totalActualRevenue.toLocaleString()}`],
                                      ["Revenue Variance", `$${realizationData.summary.revenueVariance.toLocaleString()}`],
                                      ["Average Project Realization", `${realizationData.summary.averageProjectRealization.toFixed(1)}%`]
                                    ]
                                  },
                                  {
                                    title: "Project Realization",
                                    headers: ["Project", "Client", "Budgeted Hrs", "Actual Hrs", "Hour Var", "Budgeted $", "Actual $", "$ Var", "Realization %"],
                                    rows: realizationData.projectRealization.map((proj: any) => [
                                      proj.projectName,
                                      proj.clientName,
                                      proj.budgetedHours.toFixed(1),
                                      proj.actualHours.toFixed(1),
                                      proj.hourVariance.toFixed(1),
                                      `$${proj.budgetedRevenue.toLocaleString()}`,
                                      `$${proj.actualRevenue.toLocaleString()}`,
                                      `$${proj.revenueVariance.toLocaleString()}`,
                                      `${proj.realizationRate.toFixed(1)}%`
                                    ])
                                  }
                                ];

                                exportReportToExcel({
                                  title: "Realization Rate Report",
                                  dateRange,
                                  tables
                                }, firmInfo, "Realization_Rate_Report.xlsx");
                              }}
                              data-testid="button-export-excel-realization"
                            >
                              <FileSpreadsheet className="h-4 w-4 mr-2" />
                              Export Excel
                            </Button>
                          </div>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Project Name</TableHead>
                                <TableHead>Client</TableHead>
                                <TableHead className="text-right">Budgeted Hrs</TableHead>
                                <TableHead className="text-right">Actual Hrs</TableHead>
                                <TableHead className="text-right">Hour Var</TableHead>
                                <TableHead className="text-right">Budgeted Revenue</TableHead>
                                <TableHead className="text-right">Actual Revenue</TableHead>
                                <TableHead className="text-right">Revenue Var</TableHead>
                                <TableHead className="text-right">Realization %</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {realizationData.projectRealization.map((proj: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{proj.projectName}</TableCell>
                                  <TableCell>{proj.clientName}</TableCell>
                                  <TableCell className="text-right">{proj.budgetedHours.toFixed(1)}</TableCell>
                                  <TableCell className="text-right">{proj.actualHours.toFixed(1)}</TableCell>
                                  <TableCell className={`text-right ${proj.hourVariance >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                    {proj.hourVariance >= 0 ? '+' : ''}{proj.hourVariance.toFixed(1)}
                                  </TableCell>
                                  <TableCell className="text-right">${proj.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                  <TableCell className="text-right">${proj.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                  <TableCell className={`text-right ${proj.revenueVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {proj.revenueVariance >= 0 ? '+' : ''}${Math.abs(proj.revenueVariance).toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    <Badge className={
                                      proj.category === 'over-realized' ? 'bg-green-500' :
                                        proj.category === 'on-target' ? 'bg-blue-500' :
                                          'bg-red-500'
                                    }>
                                      {proj.realizationRate.toFixed(1)}%
                                    </Badge>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Realization by Client Table */}
                    {realizationData.clientRealization.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Realization by Client</CardTitle>
                          <CardDescription>Client-level realization analysis (sorted by total revenue)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Client Name</TableHead>
                                  <TableHead className="text-right">Projects Count</TableHead>
                                  <TableHead className="text-right">Budgeted Revenue</TableHead>
                                  <TableHead className="text-right">Actual Revenue</TableHead>
                                  <TableHead className="text-right">Avg Realization %</TableHead>
                                  <TableHead>Status</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {realizationData.clientRealization.map((client: any, index: number) => (
                                  <TableRow key={index}>
                                    <TableCell className="font-medium">{client.clientName}</TableCell>
                                    <TableCell className="text-right">{client.projectsCount}</TableCell>
                                    <TableCell className="text-right">${client.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-right">${client.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-right">
                                      <Badge className={
                                        client.avgRealizationRate > 100 ? 'bg-green-500' :
                                          client.avgRealizationRate >= 90 ? 'bg-blue-500' :
                                            'bg-red-500'
                                      }>
                                        {client.avgRealizationRate.toFixed(1)}%
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      <Badge variant={client.status === 'on-track' ? 'default' : 'destructive'}>
                                        {client.status === 'on-track' ? 'On Track' : 'Needs Attention'}
                                      </Badge>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Write-Ups and Write-Downs Analysis */}
                    {realizationData.writeUpsDowns.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Write-Ups and Write-Downs Analysis</CardTitle>
                          <CardDescription>Projects with significant variances ({'>'} ¬±20%)</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto">
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>Project Name</TableHead>
                                  <TableHead>Client</TableHead>
                                  <TableHead className="text-right">Budgeted Revenue</TableHead>
                                  <TableHead className="text-right">Actual Revenue</TableHead>
                                  <TableHead className="text-right">Variance ($)</TableHead>
                                  <TableHead className="text-right">Variance (%)</TableHead>
                                  <TableHead>Type</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {realizationData.writeUpsDowns.map((item: any, index: number) => (
                                  <TableRow key={index}>
                                    <TableCell className="font-medium">{item.projectName}</TableCell>
                                    <TableCell>{item.clientName}</TableCell>
                                    <TableCell className="text-right">${item.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-right">${item.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className={`text-right font-semibold ${item.variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      {item.variance >= 0 ? '+' : ''}${Math.abs(item.variance).toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className={`text-right font-semibold ${item.variancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      {item.variancePercent >= 0 ? '+' : ''}{item.variancePercent.toFixed(1)}%
                                    </TableCell>
                                    <TableCell>
                                      <Badge variant={item.type === 'write-up' ? 'default' : 'destructive'}>
                                        {item.type === 'write-up' ? 'Write-Up' : 'Write-Down'}
                                      </Badge>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : null}
              </div>
            )}

            {/* Write-offs & Adjustments Report */}
            {reportTab === 'writeoffs-adjustments' && (
              <div className="space-y-6">
                {/* Header with Date Range and Export Buttons */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Write-offs & Adjustments Report</CardTitle>
                        <CardDescription>Track discounts, credits, and uncollectible amounts</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={writeoffsStartDate}
                            onChange={(e) => setWriteoffsStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-writeoffs-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={writeoffsEndDate}
                            onChange={(e) => setWriteoffsEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-writeoffs-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            const firmInfo: FirmInfo = {
                              name: "Your Firm Name",
                              address: "123 Main Street",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              start: writeoffsStartDate,
                              end: writeoffsEndDate
                            };

                            if (!writeoffsData) return;

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Invoiced", `$${writeoffsData.summary.totalInvoiced.toLocaleString()}`],
                                  ["Total Adjustments", `$${writeoffsData.summary.totalAdjustments.toLocaleString()}`],
                                  ["Total Write-offs", `$${writeoffsData.summary.totalWriteoffs.toLocaleString()}`],
                                  ["Adjustment Rate", `${writeoffsData.summary.adjustmentRate.toFixed(2)}%`],
                                  ["Write-off Rate", `${writeoffsData.summary.writeoffRate.toFixed(2)}%`],
                                ]
                              },
                              {
                                title: "Top Adjustments by Invoice",
                                headers: ["Invoice #", "Client", "Original", "Adjustments", "Write-offs", "Type"],
                                rows: writeoffsData.adjustmentDetails.slice(0, 10).map((adj: any) => [
                                  adj.invoiceNumber,
                                  adj.clientName,
                                  `$${adj.originalAmount.toLocaleString()}`,
                                  `$${adj.adjustments.toLocaleString()}`,
                                  `$${adj.writeoffs.toLocaleString()}`,
                                  adj.adjustmentType
                                ])
                              }
                            ];

                            exportReportToPDF({
                              title: "Write-offs & Adjustments Report",
                              dateRange,
                              tables
                            }, firmInfo, "Writeoffs_Adjustments_Report.pdf");
                          }}
                          data-testid="button-export-writeoffs-pdf"
                        >
                          <Download className="h-4 w-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            const firmInfo: FirmInfo = {
                              name: "Your Firm Name",
                              address: "123 Main Street",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              start: writeoffsStartDate,
                              end: writeoffsEndDate
                            };

                            if (!writeoffsData) return;

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Invoiced", `$${writeoffsData.summary.totalInvoiced.toLocaleString()}`],
                                  ["Total Adjustments", `$${writeoffsData.summary.totalAdjustments.toLocaleString()}`],
                                  ["Total Write-offs", `$${writeoffsData.summary.totalWriteoffs.toLocaleString()}`],
                                  ["Adjustment Rate", `${writeoffsData.summary.adjustmentRate.toFixed(2)}%`],
                                  ["Write-off Rate", `${writeoffsData.summary.writeoffRate.toFixed(2)}%`],
                                ]
                              },
                              {
                                title: "Adjustment Details",
                                headers: ["Invoice #", "Date", "Client", "Project", "Original Amount", "Adjustments", "Write-offs", "Final Amount", "Type", "Reason"],
                                rows: writeoffsData.adjustmentDetails.map((adj: any) => [
                                  adj.invoiceNumber,
                                  adj.invoiceDate,
                                  adj.clientName,
                                  adj.projectName,
                                  adj.originalAmount.toString(),
                                  adj.adjustments.toString(),
                                  adj.writeoffs.toString(),
                                  adj.finalAmount.toString(),
                                  adj.adjustmentType,
                                  adj.reason
                                ])
                              },
                              {
                                title: "Client Summary",
                                headers: ["Client Name", "Invoice Count", "Total Invoiced", "Total Adjustments", "Adjustment Rate %", "Total Write-offs", "Write-off Rate %"],
                                rows: writeoffsData.clientSummary.map((client: any) => [
                                  client.clientName,
                                  client.invoiceCount.toString(),
                                  client.totalInvoiced.toString(),
                                  client.totalAdjustments.toString(),
                                  client.adjustmentRate.toFixed(2),
                                  client.totalWriteoffs.toString(),
                                  client.writeoffRate.toFixed(2)
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Write-offs & Adjustments Report",
                              dateRange,
                              tables
                            }, firmInfo, "Writeoffs_Adjustments_Report.xlsx");
                          }}
                          data-testid="button-export-writeoffs-excel"
                        >
                          <FileSpreadsheet className="h-4 w-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Loading State */}
                {isLoadingWriteoffs && (
                  <Card>
                    <CardContent className="py-8">
                      <div className="flex items-center justify-center">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                        <span className="ml-3 text-gray-600">Loading write-offs & adjustments data...</span>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Error State */}
                {writeoffsError && (
                  <Card>
                    <CardContent className="py-8">
                      <div className="text-center text-red-600">
                        <AlertCircle className="h-8 w-8 mx-auto mb-2" />
                        <p>Error loading write-offs & adjustments data</p>
                        <p className="text-sm mt-2">{writeoffsError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Report Content */}
                {writeoffsData && !isLoadingWriteoffs ? (
                  <>
                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Total Invoiced</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">${writeoffsData.summary.totalInvoiced.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                          <p className="text-xs text-gray-500 mt-1">Total invoice amount</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Total Adjustments</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-yellow-600">${writeoffsData.summary.totalAdjustments.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                          <p className="text-xs text-gray-500 mt-1">Discounts + credits</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Total Write-offs</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-red-600">${writeoffsData.summary.totalWriteoffs.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                          <p className="text-xs text-gray-500 mt-1">Uncollectible amounts</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Adjustment Rate</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${writeoffsData.summary.adjustmentRate > 10 ? 'text-red-600' : 'text-green-600'}`}>
                            {writeoffsData.summary.adjustmentRate.toFixed(2)}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">% of total invoiced</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Write-off Rate</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${writeoffsData.summary.writeoffRate > 5 ? 'text-red-600' : 'text-green-600'}`}>
                            {writeoffsData.summary.writeoffRate.toFixed(2)}%
                          </div>
                          <p className="text-xs text-gray-500 mt-1">% of total invoiced</p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Adjustment Trend Chart */}
                      <ReportLineChart
                        data={writeoffsData.monthlyTrend.map((m: any) => ({
                          month: m.month,
                          Adjustments: m.adjustments,
                          'Write-offs': m.writeoffs,
                        }))}
                        xKey="month"
                        yKey={['Adjustments', 'Write-offs']}
                        title="Adjustment Trend Over Time"
                        colors={['#eab308', '#ef4444']}
                        isLoading={isLoadingWriteoffs}
                        height={300}
                      />

                      {/* Adjustment Type Distribution */}
                      <ReportPieChart
                        data={[
                          { name: 'Discounts', value: writeoffsData.typeDistribution.discounts },
                          { name: 'Credits', value: writeoffsData.typeDistribution.credits },
                          { name: 'Write-offs', value: writeoffsData.typeDistribution.writeoffs },
                        ]}
                        title="Adjustment Type Distribution"
                        colors={['#eab308', '#f97316', '#ef4444']}
                        isLoading={isLoadingWriteoffs}
                        height={300}
                      />
                    </div>

                    {/* Adjustments by Client Chart */}
                    <ReportBarChart
                      data={writeoffsData.clientSummary.slice(0, 10).map((client: any) => ({
                        name: client.clientName,
                        'Total Adjustments': client.totalAdjustments,
                        'Total Write-offs': client.totalWriteoffs,
                      }))}
                      xKey="name"
                      yKey={['Total Adjustments', 'Total Write-offs']}
                      title="Top 10 Clients by Adjustments"
                      colors={['#eab308', '#ef4444']}
                      isLoading={isLoadingWriteoffs}
                      height={350}
                    />

                    {/* Write-offs & Adjustments Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Write-offs & Adjustments Details</CardTitle>
                        <CardDescription>Invoice-level adjustment breakdown</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead>Invoice #</TableHead>
                                <TableHead>Invoice Date</TableHead>
                                <TableHead className="text-right">Original Amount</TableHead>
                                <TableHead className="text-right">Adjustments</TableHead>
                                <TableHead className="text-right">Write-offs</TableHead>
                                <TableHead className="text-right">Final Amount</TableHead>
                                <TableHead>Type</TableHead>
                                <TableHead>Reason</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {writeoffsData.adjustmentDetails.map((adj: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{adj.clientName}</TableCell>
                                  <TableCell>{adj.invoiceNumber}</TableCell>
                                  <TableCell>{adj.invoiceDate}</TableCell>
                                  <TableCell className="text-right">${adj.originalAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                  <TableCell className="text-right text-yellow-600 font-semibold">
                                    ${adj.adjustments.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right text-red-600 font-semibold">
                                    ${adj.writeoffs.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right font-semibold">
                                    ${adj.finalAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell>
                                    <Badge
                                      className={
                                        adj.adjustmentType === 'discount' ? 'bg-yellow-100 text-yellow-800' :
                                          adj.adjustmentType === 'credit' ? 'bg-orange-100 text-orange-800' :
                                            adj.adjustmentType === 'write-off' ? 'bg-red-100 text-red-800' :
                                              'bg-gray-100 text-gray-800'
                                      }
                                    >
                                      {adj.adjustmentType}
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-sm text-gray-600">{adj.reason}</TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Client Summary Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Client Summary</CardTitle>
                        <CardDescription>Adjustment and write-off rates by client</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Invoices</TableHead>
                                <TableHead className="text-right">Total Invoiced</TableHead>
                                <TableHead className="text-right">Total Adjustments</TableHead>
                                <TableHead className="text-right">Adjustment Rate</TableHead>
                                <TableHead className="text-right">Total Write-offs</TableHead>
                                <TableHead className="text-right">Write-off Rate</TableHead>
                                <TableHead>Status</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {writeoffsData.clientSummary.map((client: any, index: number) => (
                                <TableRow
                                  key={index}
                                  className={client.adjustmentRate > 10 ? 'bg-red-50' : ''}
                                >
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right">{client.invoiceCount}</TableCell>
                                  <TableCell className="text-right">${client.totalInvoiced.toLocaleString('en-US', { minimumFractionDigits: 2 })}</TableCell>
                                  <TableCell className="text-right text-yellow-600 font-semibold">
                                    ${client.totalAdjustments.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    <Badge className={
                                      client.adjustmentRate > 15 ? 'bg-red-500' :
                                        client.adjustmentRate > 10 ? 'bg-orange-500' :
                                          'bg-green-500'
                                    }>
                                      {client.adjustmentRate.toFixed(2)}%
                                    </Badge>
                                  </TableCell>
                                  <TableCell className="text-right text-red-600 font-semibold">
                                    ${client.totalWriteoffs.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    <Badge className={
                                      client.writeoffRate > 10 ? 'bg-red-500' :
                                        client.writeoffRate > 5 ? 'bg-orange-500' :
                                          'bg-green-500'
                                    }>
                                      {client.writeoffRate.toFixed(2)}%
                                    </Badge>
                                  </TableCell>
                                  <TableCell>
                                    <Badge
                                      variant={
                                        client.status === 'critical' ? 'destructive' :
                                          client.status === 'warning' ? 'default' :
                                            'secondary'
                                      }
                                    >
                                      {client.status === 'critical' ? 'Critical' :
                                        client.status === 'warning' ? 'Warning' :
                                          'Normal'}
                                    </Badge>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Impact Analysis Section */}
                    <Card className="border-l-4 border-l-blue-500">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <TrendingUp className="h-5 w-5 text-blue-500" />
                          Revenue Impact Analysis
                        </CardTitle>
                        <CardDescription>Financial impact and recommendations</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="p-4 bg-red-50 rounded-lg">
                              <p className="text-sm text-gray-600 mb-1">Total Revenue Lost</p>
                              <p className="text-2xl font-bold text-red-600">
                                ${writeoffsData.impactAnalysis.totalRevenueLost.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                              </p>
                            </div>
                            <div className="p-4 bg-orange-50 rounded-lg">
                              <p className="text-sm text-gray-600 mb-1">Percentage of Total Revenue</p>
                              <p className="text-2xl font-bold text-orange-600">
                                {writeoffsData.impactAnalysis.percentOfRevenue.toFixed(2)}%
                              </p>
                            </div>
                          </div>

                          <div className="mt-4">
                            <h4 className="font-semibold mb-2 text-sm text-gray-700">Top Clients by Total Adjustments</h4>
                            <div className="space-y-2">
                              {writeoffsData.impactAnalysis.topClientsByAdjustments.map((client: any, index: number) => (
                                <div key={index} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                  <span className="text-sm font-medium">{client.clientName}</span>
                                  <span className="text-sm font-semibold text-red-600">
                                    ${client.adjustmentAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h4 className="font-semibold mb-2 flex items-center gap-2 text-blue-700">
                              <AlertCircle className="h-4 w-4" />
                              Recommendations
                            </h4>
                            <ul className="space-y-1">
                              {writeoffsData.impactAnalysis.recommendations.map((rec: string, index: number) => (
                                <li key={index} className="text-sm text-gray-700 flex items-start gap-2">
                                  <span className="text-blue-500 mt-1">‚Ä¢</span>
                                  <span>{rec}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                ) : null}
              </div>
            )}

            {/* Cash Flow Forecast Report */}
            {reportTab === 'cash-flow-forecast' && (
              <div className="space-y-6">
                {/* Header with Forecast Period Selector and Export Buttons */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üíµ Cash Flow Forecast</CardTitle>
                        <CardDescription>Projected income and expenses over the next {forecastDays} days</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2">
                          <Button
                            variant={forecastDays === 30 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setForecastDays(30)}
                            data-testid="button-forecast-30-days"
                          >
                            30 Days
                          </Button>
                          <Button
                            variant={forecastDays === 60 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setForecastDays(60)}
                            data-testid="button-forecast-60-days"
                          >
                            60 Days
                          </Button>
                          <Button
                            variant={forecastDays === 90 ? "default" : "outline"}
                            size="sm"
                            onClick={() => setForecastDays(90)}
                            data-testid="button-forecast-90-days"
                          >
                            90 Days
                          </Button>
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchCashFlow()}
                          data-testid="button-refresh-cash-flow"
                        >
                          <RefreshCw className="w-4 h-4 mr-2" />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!cashFlowData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: new Date().toISOString().split('T')[0],
                              endDate: new Date(Date.now() + forecastDays * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                            };

                            try {
                              await exportReportToPDF(
                                'cash-flow-forecast',
                                firmInfo,
                                dateRange,
                                cashFlowData
                              );
                              toast({
                                title: "PDF Exported",
                                description: "Cash Flow Forecast has been exported to PDF successfully."
                              });
                            } catch (error) {
                              toast({
                                title: "Export Failed",
                                description: "Failed to export Cash Flow Forecast to PDF.",
                                variant: "destructive"
                              });
                            }
                          }}
                          data-testid="button-export-cash-flow-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!cashFlowData) return;

                            try {
                              const tables: TableData[] = [
                                {
                                  name: 'Summary',
                                  headers: ['Metric', 'Amount'],
                                  rows: [
                                    ['Starting Balance', `$${cashFlowData.summary.startingBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`],
                                    ['Expected Income', `$${cashFlowData.summary.expectedIncome.toLocaleString('en-US', { minimumFractionDigits: 2 })}`],
                                    ['Expected Expenses', `$${cashFlowData.summary.expectedExpenses.toLocaleString('en-US', { minimumFractionDigits: 2 })}`],
                                    ['Net Cash Flow', `$${cashFlowData.summary.netCashFlow.toLocaleString('en-US', { minimumFractionDigits: 2 })}`],
                                    ['Projected Ending Balance', `$${cashFlowData.summary.projectedEndingBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`],
                                  ]
                                },
                                {
                                  name: 'Weekly Forecast',
                                  headers: ['Period', 'Expected Income', 'Expected Expenses', 'Net Cash Flow', 'Running Balance'],
                                  rows: cashFlowData.weeklyForecast.map((week: any) => [
                                    week.period,
                                    `$${week.expectedIncome.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${week.expectedExpenses.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${week.netCashFlow.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${week.runningBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`
                                  ])
                                },
                                {
                                  name: 'Income Breakdown',
                                  headers: ['Source', 'Amount', 'Due Date Range', 'Details'],
                                  rows: cashFlowData.incomeBreakdown.map((income: any) => [
                                    income.source,
                                    `$${income.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    income.dueDateRange,
                                    income.details
                                  ])
                                },
                                {
                                  name: 'Expense Breakdown',
                                  headers: ['Category', 'Amount', 'Payment Date Range', 'Details'],
                                  rows: cashFlowData.expenseBreakdown.map((expense: any) => [
                                    expense.category,
                                    `$${expense.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    expense.paymentDateRange,
                                    expense.details
                                  ])
                                }
                              ];

                              await exportReportToExcel(
                                'cash-flow-forecast',
                                tables,
                                {
                                  reportTitle: 'Cash Flow Forecast',
                                  generatedDate: new Date().toLocaleDateString(),
                                  forecastPeriod: `${forecastDays} Days`
                                }
                              );

                              toast({
                                title: "Excel Exported",
                                description: "Cash Flow Forecast has been exported to Excel successfully."
                              });
                            } catch (error) {
                              toast({
                                title: "Export Failed",
                                description: "Failed to export Cash Flow Forecast to Excel.",
                                variant: "destructive"
                              });
                            }
                          }}
                          data-testid="button-export-cash-flow-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingCashFlow ? (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <Activity className="w-12 h-12 animate-spin mx-auto mb-4 text-gray-400" />
                        <p className="text-gray-500">Loading cash flow forecast...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : cashFlowError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading Cash Flow Forecast: {cashFlowError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : cashFlowData ? (
                  <>
                    {/* Cash Shortfall Alert (if any) */}
                    {cashFlowData.cashShortfalls && cashFlowData.cashShortfalls.length > 0 && (
                      <Card className="border-red-300 bg-red-50">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 text-red-700">
                            <AlertTriangle className="h-5 w-5" />
                            ‚ö†Ô∏è Cash Shortfall Warning
                          </CardTitle>
                          <CardDescription className="text-red-600">
                            Projected cash shortfall detected in {cashFlowData.cashShortfalls[0].period}
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="p-4 bg-white rounded-lg border border-red-200">
                                <p className="text-sm text-gray-600 mb-1">First Shortfall Date</p>
                                <p className="text-xl font-bold text-red-600">
                                  {cashFlowData.cashShortfalls[0].date}
                                </p>
                              </div>
                              <div className="p-4 bg-white rounded-lg border border-red-200">
                                <p className="text-sm text-gray-600 mb-1">Shortfall Amount</p>
                                <p className="text-xl font-bold text-red-600">
                                  ${cashFlowData.cashShortfalls[0].shortfallAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                </p>
                              </div>
                            </div>
                            <div className="p-4 bg-white rounded-lg border border-red-200">
                              <h4 className="font-semibold mb-2 text-red-700">Recommended Actions:</h4>
                              <ul className="space-y-1">
                                {cashFlowData.recommendations.map((rec: string, index: number) => (
                                  <li key={index} className="text-sm text-gray-700 flex items-start gap-2">
                                    <span className="text-red-500 mt-1">‚Ä¢</span>
                                    <span>{rec}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    )}

                    {/* Summary KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Expected Income</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-green-600">
                            ${cashFlowData.summary.expectedIncome.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Next {forecastDays} days</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Expected Expenses</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold text-red-600">
                            ${cashFlowData.summary.expectedExpenses.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Next {forecastDays} days</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Net Cash Flow</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${cashFlowData.summary.netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            ${cashFlowData.summary.netCashFlow.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Income - Expenses</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Projected Ending Balance</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${cashFlowData.summary.projectedEndingBalance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                            ${cashFlowData.summary.projectedEndingBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">After {forecastDays} days</p>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardHeader className="pb-2">
                          <CardTitle className="text-sm font-medium text-gray-600">Days to Shortfall</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className={`text-2xl font-bold ${cashFlowData.summary.daysToShortfall === null ? 'text-green-600' : 'text-red-600'}`}>
                            {cashFlowData.summary.daysToShortfall === null ? '‚úÖ Healthy' : `${cashFlowData.summary.daysToShortfall} days`}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            {cashFlowData.summary.daysToShortfall === null ? 'No shortfall projected' : 'Until cash shortfall'}
                          </p>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Cash Flow Trend Chart */}
                    <ReportLineChart
                      data={cashFlowData.weeklyForecast.map((week: any) => ({
                        period: week.period,
                        Income: week.expectedIncome,
                        Expenses: week.expectedExpenses,
                        Balance: week.runningBalance,
                      }))}
                      xKey="period"
                      yKey={['Income', 'Expenses', 'Balance']}
                      title="Cash Flow Trend - Income, Expenses & Running Balance"
                      colors={['#10b981', '#ef4444', '#3b82f6']}
                      height={350}
                    />

                    {/* Income vs Expenses Bar Chart */}
                    <ReportBarChart
                      data={cashFlowData.weeklyForecast.map((week: any) => ({
                        period: week.period,
                        Income: week.expectedIncome,
                        Expenses: week.expectedExpenses,
                      }))}
                      xKey="period"
                      yKey={['Income', 'Expenses']}
                      title="Income vs Expenses by Week"
                      colors={['#10b981', '#ef4444']}
                      height={300}
                      stacked={false}
                    />

                    {/* Cash Position Area Chart */}
                    <ReportAreaChart
                      data={cashFlowData.weeklyForecast.map((week: any) => ({
                        period: week.period,
                        'Running Balance': week.runningBalance,
                      }))}
                      xKey="period"
                      yKey={['Running Balance']}
                      title="Cash Position Over Time"
                      colors={['#3b82f6']}
                      height={300}
                    />

                    {/* Weekly Cash Flow Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <CalendarDays className="h-5 w-5 text-blue-500" />
                          Weekly Cash Flow Projection
                        </CardTitle>
                        <CardDescription>Detailed weekly breakdown of income, expenses, and running balance</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Period</TableHead>
                                <TableHead>Date Range</TableHead>
                                <TableHead className="text-right">Expected Income</TableHead>
                                <TableHead className="text-right">Expected Expenses</TableHead>
                                <TableHead className="text-right">Net Cash Flow</TableHead>
                                <TableHead className="text-right">Running Balance</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {cashFlowData.weeklyForecast.map((week: any, index: number) => {
                                const rowClass =
                                  week.runningBalance < 0 ? 'bg-red-50' :
                                    week.runningBalance < 10000 ? 'bg-yellow-50' :
                                      'bg-green-50';

                                const balanceColor =
                                  week.runningBalance < 0 ? 'text-red-600' :
                                    week.runningBalance < 10000 ? 'text-yellow-600' :
                                      'text-green-600';

                                return (
                                  <TableRow key={index} className={rowClass} data-testid={`row-week-${index}`}>
                                    <TableCell className="font-medium">{week.period}</TableCell>
                                    <TableCell className="text-sm text-gray-600">
                                      {week.startDate} to {week.endDate}
                                    </TableCell>
                                    <TableCell className="text-right text-green-600 font-semibold">
                                      ${week.expectedIncome.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className="text-right text-red-600 font-semibold">
                                      ${week.expectedExpenses.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className={`text-right font-semibold ${week.netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      ${week.netCashFlow.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className={`text-right font-bold ${balanceColor}`}>
                                      ${week.runningBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Income Breakdown Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <TrendingUp className="h-5 w-5 text-green-500" />
                          Expected Income Breakdown
                        </CardTitle>
                        <CardDescription>Sources of projected income over the forecast period</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Source</TableHead>
                                <TableHead className="text-right">Amount</TableHead>
                                <TableHead>Due Date Range</TableHead>
                                <TableHead>Details</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {cashFlowData.incomeBreakdown.map((income: any, index: number) => (
                                <TableRow key={index} data-testid={`row-income-${index}`}>
                                  <TableCell className="font-medium">{income.source}</TableCell>
                                  <TableCell className="text-right text-green-600 font-semibold">
                                    ${income.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-sm text-gray-600">{income.dueDateRange}</TableCell>
                                  <TableCell className="text-sm text-gray-600">{income.details}</TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Expense Breakdown Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <DollarSign className="h-5 w-5 text-red-500" />
                          Expected Expenses Breakdown
                        </CardTitle>
                        <CardDescription>Categories of projected expenses over the forecast period</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Category</TableHead>
                                <TableHead className="text-right">Amount</TableHead>
                                <TableHead>Payment Date Range</TableHead>
                                <TableHead>Details</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {cashFlowData.expenseBreakdown.map((expense: any, index: number) => (
                                <TableRow key={index} data-testid={`row-expense-${index}`}>
                                  <TableCell className="font-medium">{expense.category}</TableCell>
                                  <TableCell className="text-right text-red-600 font-semibold">
                                    ${expense.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-sm text-gray-600">{expense.paymentDateRange}</TableCell>
                                  <TableCell className="text-sm text-gray-600">{expense.details}</TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Recommendations Card */}
                    {cashFlowData.recommendations && cashFlowData.recommendations.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2">
                            <AlertCircle className="h-5 w-5 text-blue-500" />
                            Recommendations & Insights
                          </CardTitle>
                          <CardDescription>Strategic recommendations based on cash flow analysis</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-2">
                            {cashFlowData.recommendations.map((rec: string, index: number) => (
                              <div key={index} className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <CheckCircle className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
                                <p className="text-sm text-gray-700">{rec}</p>
                              </div>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : null}
              </div>
            )}

            {/* Budget vs Actual Report */}
            {reportTab === 'budget-vs-actual' && (
              <div className="space-y-6">
                {/* Header with Date Range and Export */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>üìä Budget vs Actual Report</CardTitle>
                        <CardDescription>Comprehensive comparison of planned vs actual performance</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={budgetVsActualStartDate}
                            onChange={(e) => setBudgetVsActualStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-budget-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={budgetVsActualEndDate}
                            onChange={(e) => setBudgetVsActualEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-budget-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchBudgetVsActual()}
                          disabled={isLoadingBudgetVsActual}
                          data-testid="button-refresh-budget"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingBudgetVsActual ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!budgetVsActualData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: budgetVsActualStartDate,
                              endDate: budgetVsActualEndDate
                            };

                            try {
                              await exportReportToPDF(
                                'budget-vs-actual',
                                firmInfo,
                                dateRange,
                                budgetVsActualData
                              );
                              toast({
                                title: "PDF Exported",
                                description: "Budget vs Actual Report has been exported to PDF successfully."
                              });
                            } catch (error) {
                              toast({
                                title: "Export Failed",
                                description: "Failed to export Budget vs Actual Report to PDF.",
                                variant: "destructive"
                              });
                            }
                          }}
                          data-testid="button-export-budget-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!budgetVsActualData) return;

                            try {
                              const tables: TableData[] = [
                                {
                                  name: 'Summary',
                                  headers: ['Metric', 'Budgeted', 'Actual', 'Variance', 'Variance %'],
                                  rows: [
                                    [
                                      'Revenue',
                                      `$${budgetVsActualData.summary.totalBudgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                      `$${budgetVsActualData.summary.totalActualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                      `$${budgetVsActualData.summary.revenueVariance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                      `${budgetVsActualData.summary.revenueVariancePercent.toFixed(1)}%`
                                    ],
                                    [
                                      'Hours',
                                      budgetVsActualData.summary.totalBudgetedHours.toLocaleString('en-US', { minimumFractionDigits: 1 }),
                                      budgetVsActualData.summary.totalActualHours.toLocaleString('en-US', { minimumFractionDigits: 1 }),
                                      budgetVsActualData.summary.hoursVariance.toLocaleString('en-US', { minimumFractionDigits: 1 }),
                                      `${budgetVsActualData.summary.hoursVariancePercent.toFixed(1)}%`
                                    ],
                                  ]
                                },
                                {
                                  name: 'Project Performance',
                                  headers: ['Project', 'Client', 'Budgeted Revenue', 'Actual Revenue', 'Variance', 'Variance %', 'Status'],
                                  rows: budgetVsActualData.projectPerformance.map((p: any) => [
                                    p.projectName,
                                    p.clientName,
                                    `$${p.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${p.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${p.revenueVariance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `${p.revenueVariancePercent.toFixed(1)}%`,
                                    p.status.replace('_', ' ').toUpperCase()
                                  ])
                                },
                                {
                                  name: 'Client Summary',
                                  headers: ['Client', 'Projects', 'Total Budgeted', 'Total Actual', 'Variance', 'Variance %'],
                                  rows: budgetVsActualData.clientSummary.map((c: any) => [
                                    c.clientName,
                                    c.projectsCount.toString(),
                                    `$${c.totalBudgeted.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${c.totalActual.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${c.variance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `${c.variancePercent.toFixed(1)}%`
                                  ])
                                },
                                {
                                  name: 'Monthly Performance',
                                  headers: ['Month', 'Budgeted Revenue', 'Actual Revenue', 'Variance', 'Achievement %'],
                                  rows: budgetVsActualData.monthlyPerformance.map((m: any) => [
                                    m.month,
                                    `$${m.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${m.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `$${m.variance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                                    `${m.achievementPercent.toFixed(1)}%`
                                  ])
                                }
                              ];

                              await exportReportToExcel(
                                'budget-vs-actual',
                                tables,
                                {
                                  reportTitle: 'Budget vs Actual Report',
                                  generatedDate: new Date().toLocaleDateString(),
                                  dateRange: `${budgetVsActualStartDate} to ${budgetVsActualEndDate}`
                                }
                              );

                              toast({
                                title: "Excel Exported",
                                description: "Budget vs Actual Report has been exported to Excel successfully."
                              });
                            } catch (error) {
                              toast({
                                title: "Export Failed",
                                description: "Failed to export Budget vs Actual Report to Excel.",
                                variant: "destructive"
                              });
                            }
                          }}
                          data-testid="button-export-budget-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {isLoadingBudgetVsActual ? (
                  <Card>
                    <CardContent className="flex items-center justify-center py-12">
                      <div className="text-center">
                        <Activity className="w-12 h-12 animate-spin mx-auto mb-4 text-gray-400" />
                        <p className="text-gray-500">Loading budget vs actual data...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : budgetVsActualError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading Budget vs Actual Report: {budgetVsActualError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : budgetVsActualData ? (
                  <>
                    {/* 5 KPI Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Budgeted Revenue</p>
                            <p className="text-2xl font-bold">
                              ${budgetVsActualData.summary.totalBudgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Actual Revenue</p>
                            <p className="text-2xl font-bold">
                              ${budgetVsActualData.summary.totalActualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Revenue Variance</p>
                            <p className={`text-2xl font-bold ${budgetVsActualData.summary.revenueVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              ${budgetVsActualData.summary.revenueVariance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                            </p>
                            <p className={`text-sm ${budgetVsActualData.summary.revenueVariancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {budgetVsActualData.summary.revenueVariancePercent >= 0 ? '+' : ''}
                              {budgetVsActualData.summary.revenueVariancePercent.toFixed(1)}%
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Projects On Budget</p>
                            <p className="text-2xl font-bold">
                              {budgetVsActualData.summary.projectsOnBudget} / {budgetVsActualData.summary.totalProjects}
                            </p>
                            <p className="text-sm text-gray-600">
                              {budgetVsActualData.summary.onBudgetPercentage.toFixed(1)}%
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Performance Score</p>
                            <p className={`text-2xl font-bold ${budgetVsActualData.summary.budgetPerformanceScore >= 85 ? 'text-green-600' :
                              budgetVsActualData.summary.budgetPerformanceScore >= 70 ? 'text-yellow-600' :
                                'text-red-600'
                              }`}>
                              {budgetVsActualData.summary.budgetPerformanceScore.toFixed(0)} / 100
                            </p>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div
                                className={`h-2 rounded-full ${budgetVsActualData.summary.budgetPerformanceScore >= 85 ? 'bg-green-600' :
                                  budgetVsActualData.summary.budgetPerformanceScore >= 70 ? 'bg-yellow-600' :
                                    'bg-red-600'
                                  }`}
                                style={{ width: `${budgetVsActualData.summary.budgetPerformanceScore}%` }}
                              />
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts Row 1: Budget Performance Trend & Variance Distribution */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <ReportLineChart
                        data={budgetVsActualData.monthlyPerformance.map((m: any) => ({
                          month: m.month,
                          'Budgeted Revenue': m.budgetedRevenue,
                          'Actual Revenue': m.actualRevenue,
                        }))}
                        xKey="month"
                        yKey={['Budgeted Revenue', 'Actual Revenue']}
                        title="Budget Performance Trend"
                        colors={['#3b82f6', '#10b981']}
                        height={350}
                      />

                      <ReportPieChart
                        data={[
                          { name: 'On Budget', value: budgetVsActualData.varianceDistribution.onBudget, color: '#3b82f6' },
                          { name: 'Over Budget', value: budgetVsActualData.varianceDistribution.overBudget, color: '#ef4444' },
                          { name: 'Under Budget', value: budgetVsActualData.varianceDistribution.underBudget, color: '#10b981' },
                        ]}
                        title="Variance Distribution"
                        height={350}
                      />
                    </div>

                    {/* Chart Row 2: Budget vs Actual by Project (Top 10) */}
                    <ReportBarChart
                      data={budgetVsActualData.projectPerformance
                        .sort((a: any, b: any) => Math.abs(b.revenueVariancePercent) - Math.abs(a.revenueVariancePercent))
                        .slice(0, 10)
                        .map((p: any) => ({
                          project: p.projectName.length > 20 ? p.projectName.substring(0, 20) + '...' : p.projectName,
                          'Budgeted Revenue': p.budgetedRevenue,
                          'Actual Revenue': p.actualRevenue,
                        }))}
                      xKey="project"
                      yKey={['Budgeted Revenue', 'Actual Revenue']}
                      title="Budget vs Actual by Project (Top 10 by Variance)"
                      colors={['#3b82f6', '#10b981']}
                      height={400}
                    />

                    {/* Project Budget Performance Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Project Budget Performance</CardTitle>
                        <CardDescription>Detailed budget performance for all projects</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Project Name</TableHead>
                                <TableHead>Client</TableHead>
                                <TableHead className="text-right">Budgeted Hrs</TableHead>
                                <TableHead className="text-right">Actual Hrs</TableHead>
                                <TableHead className="text-right">Hour Variance</TableHead>
                                <TableHead className="text-right">Budgeted Revenue</TableHead>
                                <TableHead className="text-right">Actual Revenue</TableHead>
                                <TableHead className="text-right">Revenue Variance</TableHead>
                                <TableHead className="text-right">Variance %</TableHead>
                                <TableHead>Status</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {budgetVsActualData.projectPerformance
                                .sort((a: any, b: any) => b.revenueVariancePercent - a.revenueVariancePercent)
                                .map((project: any) => (
                                  <TableRow key={project.projectId}>
                                    <TableCell className="font-medium">{project.projectName}</TableCell>
                                    <TableCell>{project.clientName}</TableCell>
                                    <TableCell className="text-right">{project.budgetedHours.toFixed(1)}</TableCell>
                                    <TableCell className="text-right">{project.actualHours.toFixed(1)}</TableCell>
                                    <TableCell className={`text-right ${project.hoursVariance >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                      {project.hoursVariance >= 0 ? '+' : ''}{project.hoursVariance.toFixed(1)}
                                    </TableCell>
                                    <TableCell className="text-right">
                                      ${project.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className="text-right">
                                      ${project.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className={`text-right ${project.revenueVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      {project.revenueVariance >= 0 ? '+' : ''}${project.revenueVariance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className={`text-right ${project.revenueVariancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      {project.revenueVariancePercent >= 0 ? '+' : ''}{project.revenueVariancePercent.toFixed(1)}%
                                    </TableCell>
                                    <TableCell>
                                      <Badge
                                        variant={
                                          project.status === 'on_budget' ? 'default' :
                                            project.status === 'over_budget' ? 'destructive' :
                                              'secondary'
                                        }
                                      >
                                        {project.status === 'on_budget' ? 'On Budget' :
                                          project.status === 'over_budget' ? 'Over Budget' :
                                            'Under Budget'}
                                      </Badge>
                                    </TableCell>
                                  </TableRow>
                                ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Client Budget Summary Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Client Budget Summary</CardTitle>
                        <CardDescription>Budget performance aggregated by client</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client Name</TableHead>
                                <TableHead className="text-right">Projects Count</TableHead>
                                <TableHead className="text-right">Total Budgeted</TableHead>
                                <TableHead className="text-right">Total Actual</TableHead>
                                <TableHead className="text-right">Variance</TableHead>
                                <TableHead className="text-right">Variance %</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {budgetVsActualData.clientSummary.map((client: any) => (
                                <TableRow key={client.clientId}>
                                  <TableCell className="font-medium">{client.clientName}</TableCell>
                                  <TableCell className="text-right">{client.projectsCount}</TableCell>
                                  <TableCell className="text-right">
                                    ${client.totalBudgeted.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    ${client.totalActual.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className={`text-right ${client.variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {client.variance >= 0 ? '+' : ''}${client.variance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className={`text-right ${client.variancePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {client.variancePercent >= 0 ? '+' : ''}{client.variancePercent.toFixed(1)}%
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Monthly Budget Performance Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Monthly Budget Performance</CardTitle>
                        <CardDescription>Monthly budget vs actual revenue trend</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Month</TableHead>
                                <TableHead className="text-right">Budgeted Revenue</TableHead>
                                <TableHead className="text-right">Actual Revenue</TableHead>
                                <TableHead className="text-right">Variance</TableHead>
                                <TableHead className="text-right">Achievement %</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {budgetVsActualData.monthlyPerformance.map((month: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{month.month}</TableCell>
                                  <TableCell className="text-right">
                                    ${month.budgetedRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    ${month.actualRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className={`text-right ${month.variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {month.variance >= 0 ? '+' : ''}${month.variance.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className={`text-right ${month.achievementPercent >= 100 ? 'text-green-600' : month.achievementPercent >= 90 ? 'text-yellow-600' : 'text-red-600'}`}>
                                    {month.achievementPercent.toFixed(1)}%
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Budget Insights Section */}
                    {budgetVsActualData.insights && budgetVsActualData.insights.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2">
                            <AlertCircle className="h-5 w-5 text-blue-500" />
                            Budget Insights & Recommendations
                          </CardTitle>
                          <CardDescription>Key insights and actionable recommendations</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="space-y-2">
                            {budgetVsActualData.insights.map((insight: string, index: number) => (
                              <div key={index} className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <CheckCircle className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
                                <p className="text-sm text-gray-700">{insight}</p>
                              </div>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    )}
                  </>
                ) : null}
              </div>
            )}

            {/* Trend Analysis Report */}
            {reportTab === 'trend-analysis' && (
              <div className="space-y-6">
                {/* Header with Comparison Type Selector and Export */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle className="flex items-center gap-2">
                          üìà Trend Analysis Dashboard
                        </CardTitle>
                        <CardDescription>
                          Comprehensive period-over-period performance comparison
                        </CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2 items-center">
                        {/* Comparison Type Selector */}
                        <div className="flex gap-2 items-center border rounded-md p-1">
                          <Button
                            variant={trendComparisonType === 'YoY' ? "default" : "ghost"}
                            size="sm"
                            onClick={() => setTrendComparisonType('YoY')}
                            className="text-xs"
                            data-testid="button-yoy-comparison"
                          >
                            YoY
                          </Button>
                          <Button
                            variant={trendComparisonType === 'QoQ' ? "default" : "ghost"}
                            size="sm"
                            onClick={() => setTrendComparisonType('QoQ')}
                            className="text-xs"
                            data-testid="button-qoq-comparison"
                          >
                            QoQ
                          </Button>
                          <Button
                            variant={trendComparisonType === 'MoM' ? "default" : "ghost"}
                            size="sm"
                            onClick={() => setTrendComparisonType('MoM')}
                            className="text-xs"
                            data-testid="button-mom-comparison"
                          >
                            MoM
                          </Button>
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => refetchTrendAnalysis()}
                          disabled={isLoadingTrendAnalysis}
                          data-testid="button-refresh-trends"
                        >
                          <RefreshCw className={`w-4 h-4 mr-2 ${isLoadingTrendAnalysis ? 'animate-spin' : ''}`} />
                          Refresh
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!trendAnalysisData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: trendAnalysisData.currentPeriod.start,
                              endDate: trendAnalysisData.currentPeriod.end
                            };

                            const metricsTables: TableData[] = [
                              {
                                title: "Key Metrics Comparison",
                                headers: ["Metric", "Current", "Previous", "Change", "Change %"],
                                rows: trendAnalysisData.metricsTable.slice(0, 10).map((m: any) => [
                                  m.name,
                                  m.format === 'currency' ? `$${m.current.toLocaleString()}` :
                                    m.format === 'percentage' ? `${m.current.toFixed(1)}%` :
                                      m.format === 'hours' ? `${m.current.toFixed(1)}h` : m.current.toString(),
                                  m.format === 'currency' ? `$${m.previous.toLocaleString()}` :
                                    m.format === 'percentage' ? `${m.previous.toFixed(1)}%` :
                                      m.format === 'hours' ? `${m.previous.toFixed(1)}h` : m.previous.toString(),
                                  m.format === 'currency' ? `$${m.change.toLocaleString()}` :
                                    m.change.toFixed(1),
                                  `${m.changePercent > 0 ? '+' : ''}${m.changePercent.toFixed(1)}%`
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: `Trend Analysis Report (${trendComparisonType})`,
                              dateRange,
                              tables: metricsTables,
                              summary: [
                                { label: "Comparison Period", value: `${trendAnalysisData.previousPeriod.label} ‚Üí ${trendAnalysisData.currentPeriod.label}` },
                                { label: "Business Health Score", value: `${trendAnalysisData.businessHealthScore.toFixed(0)}/100` },
                                { label: "Overall Trend", value: trendAnalysisData.growthAnalysis.overallTrend }
                              ]
                            }, firmInfo, `Trend_Analysis_${trendComparisonType}_Report.pdf`);

                            toast({
                              title: "PDF Exported",
                              description: "Trend Analysis Report has been exported to PDF successfully."
                            });
                          }}
                          disabled={isLoadingTrendAnalysis || !trendAnalysisData}
                          data-testid="button-export-trend-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!trendAnalysisData) return;

                            const tables: TableData[] = [
                              {
                                title: "Comprehensive Metrics",
                                headers: ["Metric", "Current", "Previous", "Change", "Change %", "Category"],
                                rows: trendAnalysisData.metricsTable.map((m: any) => [
                                  m.name,
                                  m.current,
                                  m.previous,
                                  m.change,
                                  m.changePercent,
                                  m.growthCategory
                                ])
                              },
                              {
                                title: "Historical Trends",
                                headers: ["Period", "Revenue", "Billable Hours", "Active Clients", "Active Projects", "Utilization %"],
                                rows: trendAnalysisData.historicalTrends.map((h: any) => [
                                  h.period,
                                  h.revenue,
                                  h.billableHours,
                                  h.activeClients,
                                  h.activeProjects,
                                  h.utilizationRate
                                ])
                              }
                            ];

                            exportReportToExcel(
                              tables,
                              {
                                reportTitle: `Trend Analysis Report (${trendComparisonType})`,
                                generatedDate: new Date().toLocaleDateString(),
                                dateRange: `${trendAnalysisData.currentPeriod.label} vs ${trendAnalysisData.previousPeriod.label}`
                              },
                              `Trend_Analysis_${trendComparisonType}_Report.xlsx`
                            );

                            toast({
                              title: "Excel Exported",
                              description: "Trend Analysis Report has been exported to Excel successfully."
                            });
                          }}
                          disabled={isLoadingTrendAnalysis || !trendAnalysisData}
                          data-testid="button-export-trend-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Loading State */}
                {isLoadingTrendAnalysis ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="flex flex-col items-center justify-center">
                        <RefreshCw className="h-12 w-12 animate-spin text-blue-500 mb-4" />
                        <p className="text-gray-500">Loading trend analysis data...</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : trendAnalysisError ? (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading Trend Analysis: {trendAnalysisError.message}</p>
                      </div>
                    </CardContent>
                  </Card>
                ) : trendAnalysisData ? (
                  <>
                    {/* Period Comparison Display */}
                    <Card className="bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200">
                      <CardContent className="pt-6">
                        <div className="text-center">
                          <div className="text-sm text-gray-600 mb-2">Comparing</div>
                          <div className="flex items-center justify-center gap-4">
                            <div className="bg-white px-6 py-3 rounded-lg shadow-sm">
                              <div className="text-xs text-gray-500">Previous Period</div>
                              <div className="text-lg font-semibold text-gray-900">
                                {trendAnalysisData.previousPeriod.label}
                              </div>
                            </div>
                            <div className="text-2xl text-blue-500">‚Üí</div>
                            <div className="bg-white px-6 py-3 rounded-lg shadow-sm border-2 border-blue-500">
                              <div className="text-xs text-gray-500">Current Period</div>
                              <div className="text-lg font-semibold text-blue-600">
                                {trendAnalysisData.currentPeriod.label}
                              </div>
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Executive Summary Cards - 4 KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      {/* Revenue Growth Card */}
                      <Card className="hover:shadow-lg transition-shadow">
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <div className="text-sm font-medium text-gray-600">Revenue Growth</div>
                            <div className="text-3xl font-bold">
                              {trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 0 ? '+' : ''}
                              {trendAnalysisData.metrics.revenue.totalRevenue.changePercent.toFixed(1)}%
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                              <span className="text-gray-500">
                                ${trendAnalysisData.metrics.revenue.totalRevenue.previous.toLocaleString()} ‚Üí
                              </span>
                              <span className="font-semibold text-blue-600">
                                ${trendAnalysisData.metrics.revenue.totalRevenue.current.toLocaleString()}
                              </span>
                            </div>
                            <Badge
                              variant={
                                trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 20 ? 'default' :
                                  trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 5 ? 'secondary' :
                                    'outline'
                              }
                              className={
                                trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 20 ? 'bg-green-600' :
                                  trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 5 ? 'bg-green-400' :
                                    trendAnalysisData.metrics.revenue.totalRevenue.changePercent < -5 ? 'bg-red-500' :
                                      'bg-blue-500'
                              }
                            >
                              {trendAnalysisData.metrics.revenue.totalRevenue.growthCategory}
                            </Badge>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Billable Hours Growth Card */}
                      <Card className="hover:shadow-lg transition-shadow">
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <div className="text-sm font-medium text-gray-600">Billable Hours Growth</div>
                            <div className="text-3xl font-bold">
                              {trendAnalysisData.metrics.operational.billableHours.changePercent > 0 ? '+' : ''}
                              {trendAnalysisData.metrics.operational.billableHours.changePercent.toFixed(1)}%
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                              <span className="text-gray-500">
                                {trendAnalysisData.metrics.operational.billableHours.previous.toFixed(0)}h ‚Üí
                              </span>
                              <span className="font-semibold text-blue-600">
                                {trendAnalysisData.metrics.operational.billableHours.current.toFixed(0)}h
                              </span>
                            </div>
                            <Badge
                              variant={
                                trendAnalysisData.metrics.operational.billableHours.changePercent > 20 ? 'default' :
                                  trendAnalysisData.metrics.operational.billableHours.changePercent > 5 ? 'secondary' :
                                    'outline'
                              }
                              className={
                                trendAnalysisData.metrics.operational.billableHours.changePercent > 20 ? 'bg-green-600' :
                                  trendAnalysisData.metrics.operational.billableHours.changePercent > 5 ? 'bg-green-400' :
                                    trendAnalysisData.metrics.operational.billableHours.changePercent < -5 ? 'bg-red-500' :
                                      'bg-blue-500'
                              }
                            >
                              {trendAnalysisData.metrics.operational.billableHours.growthCategory}
                            </Badge>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Client Growth Card */}
                      <Card className="hover:shadow-lg transition-shadow">
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <div className="text-sm font-medium text-gray-600">Client Growth</div>
                            <div className="text-3xl font-bold">
                              {trendAnalysisData.metrics.operational.activeClients.changePercent > 0 ? '+' : ''}
                              {trendAnalysisData.metrics.operational.activeClients.changePercent.toFixed(1)}%
                            </div>
                            <div className="flex items-center gap-2 text-sm">
                              <span className="text-gray-500">
                                {trendAnalysisData.metrics.operational.activeClients.previous} ‚Üí
                              </span>
                              <span className="font-semibold text-blue-600">
                                {trendAnalysisData.metrics.operational.activeClients.current} clients
                              </span>
                            </div>
                            <Badge
                              variant={
                                trendAnalysisData.metrics.operational.activeClients.changePercent > 20 ? 'default' :
                                  trendAnalysisData.metrics.operational.activeClients.changePercent > 5 ? 'secondary' :
                                    'outline'
                              }
                              className={
                                trendAnalysisData.metrics.operational.activeClients.changePercent > 20 ? 'bg-green-600' :
                                  trendAnalysisData.metrics.operational.activeClients.changePercent > 5 ? 'bg-green-400' :
                                    trendAnalysisData.metrics.operational.activeClients.changePercent < -5 ? 'bg-red-500' :
                                      'bg-blue-500'
                              }
                            >
                              {trendAnalysisData.metrics.operational.activeClients.growthCategory}
                            </Badge>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Business Health Score Card */}
                      <Card className="hover:shadow-lg transition-shadow bg-gradient-to-br from-blue-50 to-indigo-50">
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <div className="text-sm font-medium text-gray-600">Business Health Score</div>
                            <div className="text-3xl font-bold text-blue-600">
                              {trendAnalysisData.businessHealthScore.toFixed(0)}/100
                            </div>
                            <Progress value={trendAnalysisData.businessHealthScore} className="h-2" />
                            <Badge
                              variant="default"
                              className={
                                trendAnalysisData.businessHealthScore >= 80 ? 'bg-green-600' :
                                  trendAnalysisData.businessHealthScore >= 60 ? 'bg-blue-500' :
                                    trendAnalysisData.businessHealthScore >= 40 ? 'bg-yellow-500' :
                                      'bg-red-500'
                              }
                            >
                              {trendAnalysisData.businessHealthScore >= 80 ? 'Excellent' :
                                trendAnalysisData.businessHealthScore >= 60 ? 'Good' :
                                  trendAnalysisData.businessHealthScore >= 40 ? 'Fair' :
                                    'Needs Attention'}
                            </Badge>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Revenue Trends Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <DollarSign className="h-5 w-5 text-green-600" />
                          Revenue Trends
                        </CardTitle>
                        <CardDescription>Revenue performance analysis over time</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        {/* Revenue Line Chart */}
                        <ReportLineChart
                          data={trendAnalysisData.historicalTrends.map((h: any) => ({
                            period: h.period,
                            Revenue: h.revenue
                          }))}
                          xKey="period"
                          yKey={['Revenue']}
                          title={`Revenue Trend - Last ${trendComparisonType === 'YoY' ? '24 Months' : trendComparisonType === 'QoQ' ? '4 Quarters' : '12 Months'}`}
                          colors={['#10b981']}
                          height={300}
                        />

                        {/* Revenue Comparison Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <Card className="border-l-4 border-l-green-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Total Revenue</div>
                              <div className="text-2xl font-bold">
                                ${trendAnalysisData.metrics.revenue.totalRevenue.current.toLocaleString()}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.revenue.totalRevenue.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.revenue.totalRevenue.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.revenue.totalRevenue.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-blue-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Revenue per Client</div>
                              <div className="text-2xl font-bold">
                                ${trendAnalysisData.metrics.revenue.revenuePerClient.current.toLocaleString()}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.revenue.revenuePerClient.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.revenue.revenuePerClient.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.revenue.revenuePerClient.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-purple-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Average Invoice Size</div>
                              <div className="text-2xl font-bold">
                                ${trendAnalysisData.metrics.revenue.averageInvoiceSize.current.toLocaleString()}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.revenue.averageInvoiceSize.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.revenue.averageInvoiceSize.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.revenue.averageInvoiceSize.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Operational Trends Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Briefcase className="h-5 w-5 text-blue-600" />
                          Operational Trends
                        </CardTitle>
                        <CardDescription>Projects, clients, and activity metrics</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        {/* Operational Line Chart */}
                        <ReportLineChart
                          data={trendAnalysisData.historicalTrends.map((h: any) => ({
                            period: h.period,
                            'Active Projects': h.activeProjects,
                            'Active Clients': h.activeClients
                          }))}
                          xKey="period"
                          yKey={['Active Projects', 'Active Clients']}
                          title="Projects & Clients Trend"
                          colors={['#3b82f6', '#8b5cf6']}
                          height={300}
                        />

                        {/* Operational Comparison Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <Card className="border-l-4 border-l-blue-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Active Projects</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.operational.activeProjects.current}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.operational.activeProjects.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.operational.activeProjects.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.operational.activeProjects.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-purple-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Active Clients</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.operational.activeClients.current}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.operational.activeClients.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.operational.activeClients.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.operational.activeClients.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-green-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Completed Projects</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.operational.completedProjects.current}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.operational.completedProjects.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.operational.completedProjects.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.operational.completedProjects.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Performance Trends Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <TrendingUp className="h-5 w-5 text-orange-600" />
                          Performance Trends
                        </CardTitle>
                        <CardDescription>Utilization, realization, and efficiency metrics</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        {/* Performance Line Chart */}
                        <ReportLineChart
                          data={trendAnalysisData.historicalTrends.map((h: any) => ({
                            period: h.period,
                            'Utilization %': h.utilizationRate,
                            'Realization %': h.realizationRate
                          }))}
                          xKey="period"
                          yKey={['Utilization %', 'Realization %']}
                          title="Utilization & Realization Trend"
                          colors={['#f97316', '#ec4899']}
                          height={300}
                        />

                        {/* Performance Comparison Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <Card className="border-l-4 border-l-orange-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Utilization Rate</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.performance.utilizationRate.current.toFixed(1)}%
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.performance.utilizationRate.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.performance.utilizationRate.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.performance.utilizationRate.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-pink-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Realization Rate</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.performance.realizationRate.current.toFixed(1)}%
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.performance.realizationRate.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.performance.realizationRate.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.performance.realizationRate.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-indigo-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Avg Project Duration</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.performance.averageProjectDuration.current.toFixed(0)} days
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.performance.averageProjectDuration.changePercent <= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.performance.averageProjectDuration.changePercent < 0 ? '‚Üì' : '‚Üë'}
                                {Math.abs(trendAnalysisData.metrics.performance.averageProjectDuration.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Team Trends Section */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Users className="h-5 w-5 text-indigo-600" />
                          Team Trends
                        </CardTitle>
                        <CardDescription>Team productivity and resource metrics</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        {/* Team Bar Chart */}
                        <ReportBarChart
                          data={trendAnalysisData.historicalTrends.map((h: any) => ({
                            period: h.period,
                            'Billable Hours': h.billableHours
                          }))}
                          xKey="period"
                          yKey={['Billable Hours']}
                          title="Billable Hours Trend"
                          colors={['#6366f1']}
                          height={300}
                        />

                        {/* Team Comparison Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <Card className="border-l-4 border-l-indigo-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Total Billable Hours</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.operational.billableHours.current.toFixed(0)}h
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.operational.billableHours.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.operational.billableHours.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.operational.billableHours.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-cyan-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Avg Hourly Rate</div>
                              <div className="text-2xl font-bold">
                                ${trendAnalysisData.metrics.team.averageHourlyRate.current.toFixed(0)}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.team.averageHourlyRate.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.team.averageHourlyRate.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.team.averageHourlyRate.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="border-l-4 border-l-teal-500">
                            <CardContent className="pt-4">
                              <div className="text-sm text-gray-600 mb-1">Active Staff</div>
                              <div className="text-2xl font-bold">
                                {trendAnalysisData.metrics.team.activeStaff.current}
                              </div>
                              <div className={`text-sm font-semibold mt-2 ${trendAnalysisData.metrics.team.activeStaff.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {trendAnalysisData.metrics.team.activeStaff.changePercent > 0 ? '‚Üë' : '‚Üì'}
                                {Math.abs(trendAnalysisData.metrics.team.activeStaff.changePercent).toFixed(1)}% vs previous
                              </div>
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Comprehensive Metrics Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <BarChart3 className="h-5 w-5 text-blue-600" />
                          Comprehensive Metrics Comparison
                        </CardTitle>
                        <CardDescription>All key metrics sorted by change percentage</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Metric Name</TableHead>
                                <TableHead className="text-right">Current Period</TableHead>
                                <TableHead className="text-right">Previous Period</TableHead>
                                <TableHead className="text-right">Change</TableHead>
                                <TableHead className="text-right">Change %</TableHead>
                                <TableHead>Trend</TableHead>
                                <TableHead>Category</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {trendAnalysisData.metricsTable.map((metric: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{metric.name}</TableCell>
                                  <TableCell className="text-right">
                                    {metric.format === 'currency' && '$'}
                                    {metric.current.toLocaleString('en-US', {
                                      minimumFractionDigits: metric.format === 'currency' ? 2 : 0,
                                      maximumFractionDigits: metric.format === 'currency' ? 2 : 1
                                    })}
                                    {metric.format === 'percentage' && '%'}
                                    {metric.format === 'hours' && 'h'}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {metric.format === 'currency' && '$'}
                                    {metric.previous.toLocaleString('en-US', {
                                      minimumFractionDigits: metric.format === 'currency' ? 2 : 0,
                                      maximumFractionDigits: metric.format === 'currency' ? 2 : 1
                                    })}
                                    {metric.format === 'percentage' && '%'}
                                    {metric.format === 'hours' && 'h'}
                                  </TableCell>
                                  <TableCell className={`text-right ${metric.change >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {metric.change > 0 ? '+' : ''}
                                    {metric.format === 'currency' && '$'}
                                    {metric.change.toLocaleString('en-US', {
                                      minimumFractionDigits: metric.format === 'currency' ? 2 : 0,
                                      maximumFractionDigits: metric.format === 'currency' ? 2 : 1
                                    })}
                                  </TableCell>
                                  <TableCell className={`text-right font-semibold ${metric.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {metric.changePercent > 0 ? '+' : ''}{metric.changePercent.toFixed(1)}%
                                  </TableCell>
                                  <TableCell>
                                    <span className="text-xl">
                                      {metric.trendDirection === 'Up' ? '‚Üë' : metric.trendDirection === 'Down' ? '‚Üì' : '‚Üí'}
                                    </span>
                                  </TableCell>
                                  <TableCell>
                                    <Badge
                                      variant="outline"
                                      className={
                                        metric.growthCategory === 'Strong Growth' ? 'bg-green-600 text-white border-green-600' :
                                          metric.growthCategory === 'Moderate Growth' ? 'bg-green-400 text-white border-green-400' :
                                            metric.growthCategory === 'Stable' ? 'bg-blue-500 text-white border-blue-500' :
                                              metric.growthCategory === 'Decline' ? 'bg-orange-500 text-white border-orange-500' :
                                                'bg-red-500 text-white border-red-500'
                                      }
                                    >
                                      {metric.growthCategory}
                                    </Badge>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Growth Analysis Section */}
                    <Card className="border-2 border-blue-200">
                      <CardHeader className="bg-gradient-to-r from-blue-50 to-indigo-50">
                        <CardTitle className="flex items-center gap-2">
                          <Target className="h-5 w-5 text-blue-600" />
                          Growth Analysis & Insights
                        </CardTitle>
                        <CardDescription>Key findings and strategic recommendations</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6 pt-6">
                        {/* Overall Trend Badge */}
                        <div className="text-center p-4 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg">
                          <div className="text-sm text-gray-600 mb-2">Overall Business Trend</div>
                          <Badge
                            variant="outline"
                            className={`text-lg px-4 py-2 ${trendAnalysisData.growthAnalysis.overallTrend === 'Growing' ? 'bg-green-600 text-white border-green-600' :
                              trendAnalysisData.growthAnalysis.overallTrend === 'Declining' ? 'bg-red-500 text-white border-red-500' :
                                'bg-blue-500 text-white border-blue-500'
                              }`}
                          >
                            {trendAnalysisData.growthAnalysis.overallTrend}
                          </Badge>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {/* Top Growing Metrics */}
                          <Card className="border-l-4 border-l-green-500">
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center gap-2">
                                <TrendingUp className="h-5 w-5 text-green-600" />
                                Top Growing Metrics
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              {trendAnalysisData.growthAnalysis.topGrowing.length > 0 ? (
                                <div className="space-y-3">
                                  {trendAnalysisData.growthAnalysis.topGrowing.map((metric: any, index: number) => (
                                    <div key={index} className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                      <div>
                                        <div className="font-medium text-gray-900">{metric.name}</div>
                                        <div className="text-sm text-gray-600">
                                          {metric.format === 'currency' && '$'}
                                          {metric.previous.toFixed(0)} ‚Üí {metric.current.toFixed(0)}
                                          {metric.format === 'percentage' && '%'}
                                        </div>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-lg font-bold text-green-600">
                                          +{metric.changePercent.toFixed(1)}%
                                        </div>
                                        <div className="text-xs text-gray-600">{metric.growthCategory}</div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              ) : (
                                <p className="text-sm text-gray-500">No growing metrics in this period</p>
                              )}
                            </CardContent>
                          </Card>

                          {/* Top Declining Metrics */}
                          <Card className="border-l-4 border-l-red-500">
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center gap-2">
                                <AlertTriangle className="h-5 w-5 text-red-600" />
                                Areas Needing Attention
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              {trendAnalysisData.growthAnalysis.topDeclining.length > 0 ? (
                                <div className="space-y-3">
                                  {trendAnalysisData.growthAnalysis.topDeclining.map((metric: any, index: number) => (
                                    <div key={index} className="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                      <div>
                                        <div className="font-medium text-gray-900">{metric.name}</div>
                                        <div className="text-sm text-gray-600">
                                          {metric.format === 'currency' && '$'}
                                          {metric.previous.toFixed(0)} ‚Üí {metric.current.toFixed(0)}
                                          {metric.format === 'percentage' && '%'}
                                        </div>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-lg font-bold text-red-600">
                                          {metric.changePercent.toFixed(1)}%
                                        </div>
                                        <div className="text-xs text-gray-600">{metric.growthCategory}</div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              ) : (
                                <p className="text-sm text-gray-500">No declining metrics - great job!</p>
                              )}
                            </CardContent>
                          </Card>
                        </div>

                        {/* Insights */}
                        {trendAnalysisData.growthAnalysis.insights && trendAnalysisData.growthAnalysis.insights.length > 0 && (
                          <div>
                            <h4 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                              <CheckCircle className="h-5 w-5 text-blue-500" />
                              Key Insights & Recommendations
                            </h4>
                            <div className="space-y-2">
                              {trendAnalysisData.growthAnalysis.insights.map((insight: string, index: number) => (
                                <div key={index} className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                  <div className="text-blue-600 mt-0.5">‚Ä¢</div>
                                  <p className="text-sm text-gray-700 flex-1">{insight}</p>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>

                    {/* Historical Comparison Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <CalendarDays className="h-5 w-5 text-purple-600" />
                          Historical Performance Comparison
                        </CardTitle>
                        <CardDescription>
                          Period-by-period breakdown showing key metrics over time
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Period</TableHead>
                                <TableHead className="text-right">Revenue</TableHead>
                                <TableHead className="text-right">Billable Hours</TableHead>
                                <TableHead className="text-right">Active Clients</TableHead>
                                <TableHead className="text-right">Active Projects</TableHead>
                                <TableHead className="text-right">Utilization %</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {trendAnalysisData.historicalTrends.map((period: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{period.period}</TableCell>
                                  <TableCell className="text-right">
                                    ${period.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {period.billableHours.toFixed(1)}h
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {period.activeClients}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {period.activeProjects}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {period.utilizationRate.toFixed(1)}%
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                ) : null}
              </div>
            )}

            {/* Report Subscriptions Management */}
            {reportTab === 'manage-subscriptions' && (
              <div className="space-y-6" data-testid="content-manage-subscriptions">
                {/* Header */}
                <Card>
                  <CardHeader>
                    <div className="flex justify-between items-start">
                      <div>
                        <CardTitle className="flex items-center gap-2">
                          ‚öôÔ∏è Report Subscriptions
                        </CardTitle>
                        <CardDescription>
                          Subscribe to reports and receive them automatically via email
                        </CardDescription>
                      </div>
                      <Button
                        onClick={() => {
                          setEditingSubscription(null);
                          subscriptionForm.reset({
                            reportType: 'financial-performance',
                            reportName: 'Financial Performance Report',
                            frequency: 'monthly',
                            deliveryTime: '09:00',
                            format: 'pdf',
                            recipients: [],
                            isActive: true,
                          });
                          setRecipientInputs(['']);
                          setShowSubscriptionDialog(true);
                        }}
                        data-testid="button-create-subscription"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Create New Subscription
                      </Button>
                    </div>
                  </CardHeader>
                </Card>

                {/* Loading State */}
                {isLoadingSubscriptions && (
                  <Card>
                    <CardContent className="py-12">
                      <div className="flex flex-col items-center justify-center space-y-4">
                        <RefreshCw className="w-12 h-12 text-blue-500 animate-spin" />
                        <p className="text-gray-500">Loading subscriptions...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Error State */}
                {subscriptionsError && (
                  <Card>
                    <CardContent className="py-12">
                      <div className="text-center text-red-500">
                        <AlertCircle className="w-12 h-12 mx-auto mb-4" />
                        <p>Error loading subscriptions: {(subscriptionsError as Error).message}</p>
                        <Button
                          variant="outline"
                          onClick={() => refetchSubscriptions()}
                          className="mt-4"
                        >
                          Try Again
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Empty State */}
                {!isLoadingSubscriptions && !subscriptionsError && (!subscriptionsData || subscriptionsData.length === 0) && (
                  <Card>
                    <CardContent className="py-16">
                      <div className="text-center space-y-4">
                        <div className="flex justify-center">
                          <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center">
                            <Bell className="w-12 h-12 text-gray-400" />
                          </div>
                        </div>
                        <div className="space-y-2">
                          <h3 className="text-xl font-semibold">No subscriptions yet</h3>
                          <p className="text-gray-500 max-w-md mx-auto">
                            Create your first report subscription to receive automated reports via email
                          </p>
                        </div>
                        <Button
                          onClick={() => {
                            setEditingSubscription(null);
                            subscriptionForm.reset();
                            setRecipientInputs(['']);
                            setShowSubscriptionDialog(true);
                          }}
                          data-testid="button-create-first-subscription"
                        >
                          <Plus className="w-4 h-4 mr-2" />
                          Create Subscription
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Subscriptions List */}
                {!isLoadingSubscriptions && !subscriptionsError && subscriptionsData && subscriptionsData.length > 0 && (
                  <Card>
                    <CardHeader>
                      <CardTitle>Active Subscriptions</CardTitle>
                      <CardDescription>
                        {subscriptionsData.length} subscription{subscriptionsData.length !== 1 ? 's' : ''}
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="overflow-x-auto">
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>Report Name</TableHead>
                              <TableHead>Type</TableHead>
                              <TableHead>Frequency</TableHead>
                              <TableHead>Delivery Schedule</TableHead>
                              <TableHead>Format</TableHead>
                              <TableHead>Recipients</TableHead>
                              <TableHead>Status</TableHead>
                              <TableHead>Last Sent</TableHead>
                              <TableHead className="text-right">Actions</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {subscriptionsData.map((subscription: any) => (
                              <TableRow key={subscription.id}>
                                <TableCell className="font-medium">
                                  {subscription.reportName}
                                </TableCell>
                                <TableCell>
                                  <Badge variant="outline" className="text-xs">
                                    {reportTypeDisplayNames[subscription.reportType] || subscription.reportType}
                                  </Badge>
                                </TableCell>
                                <TableCell className="capitalize">
                                  {subscription.frequency}
                                </TableCell>
                                <TableCell>
                                  <div className="text-sm">
                                    {subscription.frequency === 'weekly' && subscription.deliveryDay !== null && (
                                      <span>
                                        {['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][subscription.deliveryDay]}
                                      </span>
                                    )}
                                    {subscription.frequency === 'monthly' && subscription.deliveryDay !== null && (
                                      <span>Day {subscription.deliveryDay}</span>
                                    )}
                                    {subscription.frequency === 'quarterly' && subscription.deliveryDay !== null && (
                                      <span>Day {subscription.deliveryDay} of quarter</span>
                                    )}
                                    {subscription.frequency === 'daily' && (
                                      <span>Daily</span>
                                    )}
                                    <div className="text-gray-500">at {subscription.deliveryTime}</div>
                                  </div>
                                </TableCell>
                                <TableCell className="uppercase text-xs">
                                  {subscription.format}
                                </TableCell>
                                <TableCell>
                                  <div className="text-sm">
                                    {subscription.recipients.length} recipient{subscription.recipients.length !== 1 ? 's' : ''}
                                  </div>
                                  {subscription.recipients.length > 0 && (
                                    <div className="text-xs text-gray-500 truncate max-w-xs">
                                      {subscription.recipients[0]}
                                      {subscription.recipients.length > 1 && ` +${subscription.recipients.length - 1} more`}
                                    </div>
                                  )}
                                </TableCell>
                                <TableCell>
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => toggleSubscriptionMutation.mutate({
                                      id: subscription.id,
                                      isActive: !subscription.isActive
                                    })}
                                    disabled={toggleSubscriptionMutation.isPending}
                                  >
                                    {subscription.isActive ? (
                                      <Badge className="bg-green-500 hover:bg-green-600">Active</Badge>
                                    ) : (
                                      <Badge variant="secondary">Inactive</Badge>
                                    )}
                                  </Button>
                                </TableCell>
                                <TableCell>
                                  {subscription.lastSentAt ? (
                                    <div className="text-sm text-gray-600">
                                      {new Date(subscription.lastSentAt).toLocaleDateString()}
                                    </div>
                                  ) : (
                                    <span className="text-sm text-gray-400">Never</span>
                                  )}
                                </TableCell>
                                <TableCell className="text-right">
                                  <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                      <Button variant="ghost" size="sm" data-testid={`button-actions-${subscription.id}`}>
                                        <MoreHorizontal className="w-4 h-4" />
                                      </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                      <DropdownMenuItem
                                        onClick={() => handleEditSubscription(subscription)}
                                        data-testid={`button-edit-${subscription.id}`}
                                      >
                                        <Edit3 className="w-4 h-4 mr-2" />
                                        Edit
                                      </DropdownMenuItem>
                                      <DropdownMenuItem
                                        onClick={() => setDeleteConfirmSubscriptionId(subscription.id)}
                                        className="text-red-600"
                                        data-testid={`button-delete-${subscription.id}`}
                                      >
                                        <Trash2 className="w-4 h-4 mr-2" />
                                        Delete
                                      </DropdownMenuItem>
                                    </DropdownMenuContent>
                                  </DropdownMenu>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Create/Edit Subscription Dialog */}
                <Dialog open={showSubscriptionDialog} onOpenChange={setShowSubscriptionDialog}>
                  <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
                    <DialogHeader>
                      <DialogTitle>
                        {editingSubscription ? 'Edit Report Subscription' : 'Create Report Subscription'}
                      </DialogTitle>
                      <DialogDescription>
                        Configure automated report delivery to your email
                      </DialogDescription>
                    </DialogHeader>

                    <Form {...subscriptionForm}>
                      <form onSubmit={subscriptionForm.handleSubmit(handleSubscriptionSubmit)} className="space-y-6">
                        {/* Report Type */}
                        <FormField
                          control={subscriptionForm.control}
                          name="reportType"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Report Type *</FormLabel>
                              <Select
                                onValueChange={(value) => {
                                  field.onChange(value);
                                  subscriptionForm.setValue('reportName', reportTypeDisplayNames[value] || value);
                                }}
                                value={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger data-testid="select-report-type">
                                    <SelectValue placeholder="Select report type" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="financial-performance">Financial Performance</SelectItem>
                                  <SelectItem value="ar-aging">AR Aging</SelectItem>
                                  <SelectItem value="client-profitability">Client Profitability</SelectItem>
                                  <SelectItem value="revenue-by-service">Revenue by Service</SelectItem>
                                  <SelectItem value="time-billing">Time & Billing</SelectItem>
                                  <SelectItem value="firm-overview">Firm Overview</SelectItem>
                                  <SelectItem value="client-health">Client Health</SelectItem>
                                  <SelectItem value="trend-analysis">Trend Analysis</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Report Name */}
                        <FormField
                          control={subscriptionForm.control}
                          name="reportName"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Report Name *</FormLabel>
                              <FormControl>
                                <Input {...field} placeholder="e.g., Monthly Financial Report" data-testid="input-report-name" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Frequency */}
                        <FormField
                          control={subscriptionForm.control}
                          name="frequency"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Frequency *</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value}>
                                <FormControl>
                                  <SelectTrigger data-testid="select-frequency">
                                    <SelectValue placeholder="Select frequency" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="daily">Daily</SelectItem>
                                  <SelectItem value="weekly">Weekly</SelectItem>
                                  <SelectItem value="monthly">Monthly</SelectItem>
                                  <SelectItem value="quarterly">Quarterly</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Delivery Day (conditional) */}
                        {subscriptionForm.watch('frequency') === 'weekly' && (
                          <FormField
                            control={subscriptionForm.control}
                            name="deliveryDay"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Delivery Day *</FormLabel>
                                <Select
                                  onValueChange={(value) => field.onChange(parseInt(value))}
                                  value={field.value?.toString()}
                                >
                                  <FormControl>
                                    <SelectTrigger data-testid="select-delivery-day-weekly">
                                      <SelectValue placeholder="Select day of week" />
                                    </SelectTrigger>
                                  </FormControl>
                                  <SelectContent>
                                    <SelectItem value="1">Monday</SelectItem>
                                    <SelectItem value="2">Tuesday</SelectItem>
                                    <SelectItem value="3">Wednesday</SelectItem>
                                    <SelectItem value="4">Thursday</SelectItem>
                                    <SelectItem value="5">Friday</SelectItem>
                                    <SelectItem value="6">Saturday</SelectItem>
                                    <SelectItem value="0">Sunday</SelectItem>
                                  </SelectContent>
                                </Select>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        )}

                        {(subscriptionForm.watch('frequency') === 'monthly' || subscriptionForm.watch('frequency') === 'quarterly') && (
                          <FormField
                            control={subscriptionForm.control}
                            name="deliveryDay"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>
                                  {subscriptionForm.watch('frequency') === 'monthly' ? 'Day of Month' : 'Day of Quarter'} *
                                </FormLabel>
                                <FormControl>
                                  <Input
                                    type="number"
                                    min="1"
                                    max="31"
                                    {...field}
                                    onChange={(e) => field.onChange(parseInt(e.target.value))}
                                    placeholder="1-31"
                                    data-testid="input-delivery-day-monthly"
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        )}

                        {/* Delivery Time */}
                        <FormField
                          control={subscriptionForm.control}
                          name="deliveryTime"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Delivery Time *</FormLabel>
                              <FormControl>
                                <Input {...field} type="time" data-testid="input-delivery-time" />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Format */}
                        <FormField
                          control={subscriptionForm.control}
                          name="format"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Report Format *</FormLabel>
                              <Select onValueChange={field.onChange} value={field.value}>
                                <FormControl>
                                  <SelectTrigger data-testid="select-format">
                                    <SelectValue placeholder="Select format" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value="pdf">PDF Only</SelectItem>
                                  <SelectItem value="excel">Excel Only</SelectItem>
                                  <SelectItem value="both">Both PDF & Excel</SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        {/* Recipients */}
                        <div className="space-y-2">
                          <FormLabel>Recipients * (at least one email required)</FormLabel>
                          {recipientInputs.map((email, index) => (
                            <div key={index} className="flex gap-2">
                              <Input
                                type="email"
                                placeholder="email@example.com"
                                value={email}
                                onChange={(e) => updateRecipientEmail(index, e.target.value)}
                                data-testid={`input-recipient-${index}`}
                              />
                              {recipientInputs.length > 1 && (
                                <Button
                                  type="button"
                                  variant="outline"
                                  size="icon"
                                  onClick={() => removeRecipientInput(index)}
                                  data-testid={`button-remove-recipient-${index}`}
                                >
                                  <Trash2 className="w-4 h-4" />
                                </Button>
                              )}
                            </div>
                          ))}
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={addRecipientInput}
                            data-testid="button-add-recipient"
                          >
                            <Plus className="w-4 h-4 mr-2" />
                            Add Recipient
                          </Button>
                          {subscriptionForm.formState.errors.recipients && (
                            <p className="text-sm text-red-500">{subscriptionForm.formState.errors.recipients.message}</p>
                          )}
                        </div>

                        {/* Active Status */}
                        <FormField
                          control={subscriptionForm.control}
                          name="isActive"
                          render={({ field }) => (
                            <FormItem className="flex items-center justify-between rounded-lg border p-4">
                              <div className="space-y-0.5">
                                <FormLabel className="text-base">Active Subscription</FormLabel>
                                <p className="text-sm text-gray-500">
                                  Enable or disable this subscription
                                </p>
                              </div>
                              <FormControl>
                                <div className="flex items-center space-x-2">
                                  <input
                                    type="checkbox"
                                    checked={field.value}
                                    onChange={field.onChange}
                                    className="w-4 h-4"
                                    data-testid="checkbox-is-active"
                                  />
                                </div>
                              </FormControl>
                            </FormItem>
                          )}
                        />

                        <DialogFooter>
                          <Button
                            type="button"
                            variant="outline"
                            onClick={() => {
                              setShowSubscriptionDialog(false);
                              setEditingSubscription(null);
                              subscriptionForm.reset();
                              setRecipientInputs(['']);
                            }}
                            data-testid="button-cancel-subscription"
                          >
                            Cancel
                          </Button>
                          <Button
                            type="submit"
                            disabled={createSubscriptionMutation.isPending || updateSubscriptionMutation.isPending}
                            data-testid="button-save-subscription"
                          >
                            {(createSubscriptionMutation.isPending || updateSubscriptionMutation.isPending) && (
                              <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                            )}
                            {editingSubscription ? 'Update Subscription' : 'Create Subscription'}
                          </Button>
                        </DialogFooter>
                      </form>
                    </Form>
                  </DialogContent>
                </Dialog>

                {/* Delete Confirmation Dialog */}
                <Dialog open={deleteConfirmSubscriptionId !== null} onOpenChange={() => setDeleteConfirmSubscriptionId(null)}>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Delete Subscription?</DialogTitle>
                      <DialogDescription>
                        Are you sure you want to delete this subscription? This action cannot be undone.
                      </DialogDescription>
                    </DialogHeader>
                    <DialogFooter>
                      <Button
                        variant="outline"
                        onClick={() => setDeleteConfirmSubscriptionId(null)}
                        data-testid="button-cancel-delete"
                      >
                        Cancel
                      </Button>
                      <Button
                        variant="destructive"
                        onClick={() => {
                          if (deleteConfirmSubscriptionId) {
                            deleteSubscriptionMutation.mutate(deleteConfirmSubscriptionId);
                          }
                        }}
                        disabled={deleteSubscriptionMutation.isPending}
                        data-testid="button-confirm-delete"
                      >
                        {deleteSubscriptionMutation.isPending && (
                          <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                        )}
                        Delete
                      </Button>
                    </DialogFooter>
                  </DialogContent>
                </Dialog>
              </div>
            )}

            {reportTab === 'financial' && (
              <div className="space-y-6">
                {/* Date Range Selector and Export Actions */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Financial Performance Report</CardTitle>
                        <CardDescription>Revenue, expenses, and profitability metrics</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={financialReportStartDate}
                            onChange={(e) => setFinancialReportStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-financial-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={financialReportEndDate}
                            onChange={(e) => setFinancialReportEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-financial-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!financialPerformance) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: financialReportStartDate,
                              endDate: financialReportEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Revenue Summary",
                                headers: ["Metric", "Amount"],
                                rows: [
                                  ["Total Invoiced", `$${financialPerformance.revenue.invoiced.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`],
                                  ["Total Collected", `$${financialPerformance.revenue.collected.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`],
                                  ["Outstanding", `$${financialPerformance.revenue.outstanding.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`]
                                ]
                              },
                              {
                                title: "Expense Breakdown",
                                headers: ["Category", "Amount"],
                                rows: financialPerformance.expenses.byCategory.map((cat: any) => [
                                  cat.category,
                                  `$${cat.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Financial Performance Report",
                              dateRange,
                              tables,
                              summary: [
                                { label: "Gross Profit", value: `$${financialPerformance.profitability.grossProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` },
                                { label: "Profit Margin", value: `${financialPerformance.profitability.profitMargin.toFixed(2)}%` },
                                { label: "YTD Revenue Growth", value: `${financialPerformance.ytdComparison.revenueGrowth.toFixed(2)}%` }
                              ]
                            }, firmInfo, "Financial_Performance_Report.pdf");

                            toast({
                              title: "Export Complete",
                              description: "PDF report has been downloaded"
                            });
                          }}
                          disabled={isLoadingFinancialPerformance || !financialPerformance}
                          data-testid="button-export-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!financialPerformance) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm"
                            };

                            const dateRange: DateRange = {
                              startDate: financialReportStartDate,
                              endDate: financialReportEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Revenue Summary",
                                headers: ["Metric", "Amount"],
                                rows: [
                                  ["Total Invoiced", financialPerformance.revenue.invoiced],
                                  ["Total Collected", financialPerformance.revenue.collected],
                                  ["Outstanding", financialPerformance.revenue.outstanding]
                                ]
                              },
                              {
                                title: "Expense Breakdown",
                                headers: ["Category", "Amount"],
                                rows: financialPerformance.expenses.byCategory.map((cat: any) => [
                                  cat.category,
                                  cat.amount
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Financial Performance Report",
                              dateRange,
                              tables
                            }, firmInfo, "Financial_Performance_Report.xlsx");

                            toast({
                              title: "Export Complete",
                              description: "Excel report has been downloaded"
                            });
                          }}
                          disabled={isLoadingFinancialPerformance || !financialPerformance}
                          data-testid="button-export-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Error State */}
                {financialPerformanceError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="pt-6">
                      <div className="flex items-center gap-2 text-red-600">
                        <AlertCircle className="w-5 h-5" />
                        <p>Failed to load financial performance data. Please try again.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Loading State */}
                {isLoadingFinancialPerformance && (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="flex items-center justify-center py-12">
                        <RefreshCw className="w-8 h-8 animate-spin text-gray-400" />
                        <p className="ml-3 text-gray-500">Loading financial data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* KPI Cards */}
                {financialPerformance && !isLoadingFinancialPerformance && (
                  <>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Revenue</p>
                            <p className="text-2xl font-bold text-green-600" data-testid="text-total-revenue">
                              ${financialPerformance.revenue.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className={`text-xs flex items-center gap-1 ${financialPerformance.ytdComparison.revenueGrowth >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {financialPerformance.ytdComparison.revenueGrowth >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(financialPerformance.ytdComparison.revenueGrowth).toFixed(2)}% vs last year
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Expenses</p>
                            <p className="text-2xl font-bold text-blue-600" data-testid="text-total-expenses">
                              ${financialPerformance.expenses.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className={`text-xs flex items-center gap-1 ${financialPerformance.ytdComparison.expenseChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                              {financialPerformance.ytdComparison.expenseChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(financialPerformance.ytdComparison.expenseChange).toFixed(2)}% vs last year
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Gross Profit</p>
                            <p className="text-2xl font-bold text-purple-600" data-testid="text-gross-profit">
                              ${financialPerformance.profitability.grossProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className={`text-xs flex items-center gap-1 ${financialPerformance.ytdComparison.profitChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {financialPerformance.ytdComparison.profitChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(financialPerformance.ytdComparison.profitChange).toFixed(2)}% vs last year
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Profit Margin</p>
                            <p className="text-2xl font-bold text-orange-600" data-testid="text-profit-margin">
                              {financialPerformance.profitability.profitMargin.toFixed(2)}%
                            </p>
                            <p className="text-xs text-gray-500">
                              Gross profit / Total revenue
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Revenue Breakdown */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Invoiced</p>
                            <p className="text-xl font-bold">
                              ${financialPerformance.revenue.invoiced.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Collected</p>
                            <p className="text-xl font-bold text-green-600">
                              ${financialPerformance.revenue.collected.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Outstanding</p>
                            <p className="text-xl font-bold text-orange-600">
                              ${financialPerformance.revenue.outstanding.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Revenue vs Expenses Trend Chart */}
                      <ReportLineChart
                        data={[
                          {
                            month: format(new Date(financialReportStartDate), 'MMM yyyy'),
                            Revenue: financialPerformance.revenue.total,
                            Expenses: financialPerformance.expenses.total
                          }
                        ]}
                        xKey="month"
                        yKey={["Revenue", "Expenses"]}
                        title="Revenue vs Expenses"
                        colors={["#10b981", "#3b82f6"]}
                        isLoading={isLoadingFinancialPerformance}
                        height={300}
                      />

                      {/* Expense Breakdown Chart */}
                      <ReportBarChart
                        data={financialPerformance.expenses.byCategory.map((cat: any) => ({
                          category: cat.category,
                          amount: cat.amount
                        }))}
                        xKey="category"
                        yKey="amount"
                        title="Expense Breakdown by Category"
                        color="#3b82f6"
                        isLoading={isLoadingFinancialPerformance}
                        height={300}
                      />
                    </div>

                    {/* Detailed Expense Table */}
                    {financialPerformance.expenses.byCategory.length > 0 && (
                      <Card>
                        <CardHeader>
                          <CardTitle>Expense Details</CardTitle>
                          <CardDescription>Breakdown by category</CardDescription>
                        </CardHeader>
                        <CardContent>
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Category</TableHead>
                                <TableHead className="text-right">Amount</TableHead>
                                <TableHead className="text-right">% of Total</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {financialPerformance.expenses.byCategory.map((cat: any, index: number) => (
                                <TableRow key={index}>
                                  <TableCell className="font-medium">{cat.category}</TableCell>
                                  <TableCell className="text-right">
                                    ${cat.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                  </TableCell>
                                  <TableCell className="text-right">
                                    {financialPerformance.expenses.total > 0
                                      ? ((cat.amount / financialPerformance.expenses.total) * 100).toFixed(2)
                                      : '0.00'}%
                                  </TableCell>
                                </TableRow>
                              ))}
                              <TableRow className="font-bold bg-gray-50">
                                <TableCell>Total</TableCell>
                                <TableCell className="text-right">
                                  ${financialPerformance.expenses.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </TableCell>
                                <TableCell className="text-right">100.00%</TableCell>
                              </TableRow>
                            </TableBody>
                          </Table>
                        </CardContent>
                      </Card>
                    )}
                  </>
                )}
              </div>
            )}

            {reportTab === 'ar-aging' && (
              <div className="space-y-6">
                {/* AR Aging Report Header with Date Picker and Export Buttons */}
                <Card>
                  <CardHeader>
                    <div className="flex justify-between items-start">
                      <div>
                        <CardTitle>Accounts Receivable Aging Report</CardTitle>
                        <CardDescription>Outstanding invoices by aging brackets</CardDescription>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!arAgingData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: arAgingAsOfDate,
                              endDate: arAgingAsOfDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "AR Aging Summary",
                                headers: ["Aging Bucket", "Amount", "Invoice Count"],
                                rows: [
                                  ["Current (0-30)", `$${arAgingData.summary.current.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, arAgingData.bucketCounts.current.toString()],
                                  ["31-60 Days", `$${arAgingData.summary.days30.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, arAgingData.bucketCounts.days30.toString()],
                                  ["61-90 Days", `$${arAgingData.summary.days60.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, arAgingData.bucketCounts.days60.toString()],
                                  ["91-120 Days", `$${arAgingData.summary.days120.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, arAgingData.bucketCounts.days120.toString()],
                                  ["120+ Days", `$${arAgingData.summary.days120Plus.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, arAgingData.bucketCounts.days120Plus.toString()],
                                  ["Total Outstanding", `$${arAgingData.summary.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, (arAgingData.invoices?.length || 0).toString()]
                                ]
                              },
                              {
                                title: "Detailed Invoice List",
                                headers: ["Client", "Invoice", "Due Date", "Amount", "Days Outstanding", "Aging"],
                                rows: (arAgingData.invoices || []).map((inv: any) => [
                                  inv.clientName,
                                  inv.invoiceNumber,
                                  new Date(inv.dueDate).toLocaleDateString(),
                                  `$${inv.balanceDue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  inv.daysOutstanding.toString(),
                                  inv.agingCategory
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "AR Aging Report",
                              firmInfo,
                              dateRange,
                              tables,
                              fileName: `AR_Aging_Report_${arAgingAsOfDate}.pdf`
                            });
                          }}
                          data-testid="button-export-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!arAgingData) return;

                            const summaryData: TableData = {
                              title: "AR Aging Summary",
                              headers: ["Aging Bucket", "Amount", "Invoice Count", "% of Total"],
                              rows: [
                                [
                                  "Current (0-30)",
                                  arAgingData.summary.current.toFixed(2),
                                  arAgingData.bucketCounts.current.toString(),
                                  arAgingData.summary.total > 0 ? ((arAgingData.summary.current / arAgingData.summary.total) * 100).toFixed(2) + '%' : '0%'
                                ],
                                [
                                  "31-60 Days",
                                  arAgingData.summary.days30.toFixed(2),
                                  arAgingData.bucketCounts.days30.toString(),
                                  arAgingData.summary.total > 0 ? ((arAgingData.summary.days30 / arAgingData.summary.total) * 100).toFixed(2) + '%' : '0%'
                                ],
                                [
                                  "61-90 Days",
                                  arAgingData.summary.days60.toFixed(2),
                                  arAgingData.bucketCounts.days60.toString(),
                                  arAgingData.summary.total > 0 ? ((arAgingData.summary.days60 / arAgingData.summary.total) * 100).toFixed(2) + '%' : '0%'
                                ],
                                [
                                  "91-120 Days",
                                  arAgingData.summary.days120.toFixed(2),
                                  arAgingData.bucketCounts.days120.toString(),
                                  arAgingData.summary.total > 0 ? ((arAgingData.summary.days120 / arAgingData.summary.total) * 100).toFixed(2) + '%' : '0%'
                                ],
                                [
                                  "120+ Days",
                                  arAgingData.summary.days120Plus.toFixed(2),
                                  arAgingData.bucketCounts.days120Plus.toString(),
                                  arAgingData.summary.total > 0 ? ((arAgingData.summary.days120Plus / arAgingData.summary.total) * 100).toFixed(2) + '%' : '0%'
                                ],
                                [
                                  "Total Outstanding",
                                  arAgingData.summary.total.toFixed(2),
                                  (arAgingData.invoices?.length || 0).toString(),
                                  "100%"
                                ]
                              ]
                            };

                            const detailedData: TableData = {
                              title: "Detailed Invoice List",
                              headers: ["Client", "Invoice Number", "Invoice Date", "Due Date", "Total Amount", "Balance Due", "Days Outstanding", "Aging Category"],
                              rows: (arAgingData.invoices || []).map((inv: any) => [
                                inv.clientName,
                                inv.invoiceNumber,
                                new Date(inv.invoiceDate).toLocaleDateString(),
                                new Date(inv.dueDate).toLocaleDateString(),
                                inv.totalAmount.toFixed(2),
                                inv.balanceDue.toFixed(2),
                                inv.daysOutstanding.toString(),
                                inv.agingCategory
                              ])
                            };

                            await exportReportToExcel({
                              fileName: `AR_Aging_Report_${arAgingAsOfDate}.xlsx`,
                              sheets: [
                                { name: "Summary", data: summaryData },
                                { name: "Detailed Invoice List", data: detailedData }
                              ],
                              reportTitle: "AR Aging Report",
                              asOfDate: arAgingAsOfDate
                            });
                          }}
                          data-testid="button-export-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                    <div className="mt-4 flex items-center gap-4">
                      <div className="flex items-center gap-2">
                        <label className="text-sm font-medium">As of Date:</label>
                        <Input
                          type="date"
                          value={arAgingAsOfDate}
                          onChange={(e) => setArAgingAsOfDate(e.target.value)}
                          className="w-40"
                          data-testid="input-ar-aging-date"
                        />
                      </div>
                      {arAgingData && (
                        <div className="text-sm text-gray-600">
                          Total Outstanding: <span className="font-bold text-lg text-blue-600">
                            ${arAgingData.summary.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </span>
                        </div>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent>
                    {/* Loading State */}
                    {isLoadingARAging && (
                      <div className="flex items-center justify-center py-12">
                        <RefreshCw className="h-8 w-8 animate-spin text-blue-500" />
                        <span className="ml-2 text-gray-600">Loading AR aging data...</span>
                      </div>
                    )}

                    {/* Error State */}
                    {arAgingError && (
                      <div className="flex items-center justify-center py-12 text-red-600">
                        <AlertTriangle className="h-8 w-8 mr-2" />
                        <span>Failed to load AR aging data. Please try again.</span>
                      </div>
                    )}

                    {/* Data Display */}
                    {!isLoadingARAging && !arAgingError && arAgingData && (
                      <>
                        {/* Aging Bucket Cards */}
                        <div className="grid grid-cols-5 gap-4 mb-6">
                          <div className="p-4 bg-green-50 rounded-lg">
                            <p className="text-sm text-gray-600">Current (0-30)</p>
                            <p className="text-2xl font-bold text-green-600">
                              ${arAgingData.summary.current.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-600 mt-1">{arAgingData.bucketCounts.current} invoices</p>
                          </div>
                          <div className="p-4 bg-blue-50 rounded-lg">
                            <p className="text-sm text-gray-600">31-60 Days</p>
                            <p className="text-2xl font-bold text-blue-600">
                              ${arAgingData.summary.days30.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-600 mt-1">{arAgingData.bucketCounts.days30} invoices</p>
                          </div>
                          <div className="p-4 bg-yellow-50 rounded-lg">
                            <p className="text-sm text-gray-600">61-90 Days</p>
                            <p className="text-2xl font-bold text-yellow-600">
                              ${arAgingData.summary.days60.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-600 mt-1">{arAgingData.bucketCounts.days60} invoices</p>
                          </div>
                          <div className="p-4 bg-orange-50 rounded-lg">
                            <p className="text-sm text-gray-600">91-120 Days</p>
                            <p className="text-2xl font-bold text-orange-600">
                              ${arAgingData.summary.days120.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-600 mt-1">{arAgingData.bucketCounts.days120} invoices</p>
                          </div>
                          <div className="p-4 bg-red-50 rounded-lg">
                            <p className="text-sm text-gray-600">120+ Days</p>
                            <p className="text-2xl font-bold text-red-600">
                              ${arAgingData.summary.days120Plus.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-600 mt-1">{arAgingData.bucketCounts.days120Plus} invoices</p>
                          </div>
                        </div>

                        {/* Aging Distribution Chart */}
                        <div className="mb-6">
                          <ReportBarChart
                            data={[
                              { name: 'Current (0-30)', value: arAgingData.summary.current },
                              { name: '31-60 Days', value: arAgingData.summary.days30 },
                              { name: '61-90 Days', value: arAgingData.summary.days60 },
                              { name: '91-120 Days', value: arAgingData.summary.days120 },
                              { name: '120+ Days', value: arAgingData.summary.days120Plus }
                            ]}
                            xKey="name"
                            yKey="value"
                            title="AR Aging Distribution"
                            height={300}
                          />
                        </div>

                        {/* Detailed Invoice Table */}
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client</TableHead>
                                <TableHead>Invoice</TableHead>
                                <TableHead className="text-right">Amount</TableHead>
                                <TableHead className="text-right">Days Outstanding</TableHead>
                                <TableHead>Aging Category</TableHead>
                                <TableHead>Actions</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {arAgingData.invoices && arAgingData.invoices.length > 0 ? (
                                arAgingData.invoices.map((invoice: any) => (
                                  <TableRow key={invoice.invoiceId}>
                                    <TableCell className="font-medium">{invoice.clientName}</TableCell>
                                    <TableCell className="font-mono text-sm">{invoice.invoiceNumber}</TableCell>
                                    <TableCell className="text-right font-bold">
                                      ${invoice.balanceDue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className="text-right">{invoice.daysOutstanding} days</TableCell>
                                    <TableCell>
                                      <Badge variant={
                                        invoice.agingBucket === '0-30' ? 'default' :
                                          invoice.agingBucket === '31-60' ? 'secondary' :
                                            invoice.agingBucket === '61-90' ? 'default' :
                                              'destructive'
                                      }>
                                        {invoice.agingCategory}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={() => {
                                          toast({
                                            title: "Feature Coming Soon",
                                            description: "Payment reminder functionality will be available with email integration.",
                                          });
                                        }}
                                        data-testid={`button-remind-${invoice.invoiceId}`}
                                      >
                                        <Send className="w-3 h-3 mr-1" />
                                        Remind
                                      </Button>
                                    </TableCell>
                                  </TableRow>
                                ))
                              ) : (
                                <TableRow>
                                  <TableCell colSpan={6} className="text-center py-8 text-gray-500">
                                    No outstanding invoices found
                                  </TableCell>
                                </TableRow>
                              )}
                            </TableBody>
                          </Table>
                        </div>
                      </>
                    )}
                  </CardContent>
                </Card>
              </div>
            )}

            {reportTab === 'time-billing' && (
              <div className="space-y-6">
                <Card>
                  <CardHeader>
                    <CardTitle>Time & Billing Analytics</CardTitle>
                    <CardDescription>Utilization rates and billable hours breakdown</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                      <div className="p-4 bg-blue-50 rounded-lg">
                        <p className="text-sm text-gray-600">Total Hours Logged</p>
                        <p className="text-2xl font-bold text-blue-600">3,240</p>
                        <p className="text-xs text-blue-600 mt-1">This month</p>
                      </div>
                      <div className="p-4 bg-green-50 rounded-lg">
                        <p className="text-sm text-gray-600">Billable Hours</p>
                        <p className="text-2xl font-bold text-green-600">2,840</p>
                        <p className="text-xs text-green-600 mt-1">87.7% utilization</p>
                      </div>
                      <div className="p-4 bg-purple-50 rounded-lg">
                        <p className="text-sm text-gray-600">Billable Amount</p>
                        <p className="text-2xl font-bold text-purple-600">$426,000</p>
                        <p className="text-xs text-purple-600 mt-1">Avg $150/hour</p>
                      </div>
                    </div>
                    <div className="text-center py-12 text-gray-500 border-2 border-dashed rounded-lg">
                      <Clock className="w-16 h-16 mx-auto mb-3 text-gray-300" />
                      <p className="font-medium">Time Utilization Charts</p>
                      <p className="text-sm">Staff utilization and billing breakdowns will be shown here</p>
                    </div>
                  </CardContent>
                </Card>
              </div>
            )}

            {reportTab === 'client-profitability' && (
              <div className="space-y-6">
                {/* Header with Date Range and Export Buttons */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Client Profitability Analysis</CardTitle>
                        <CardDescription>Revenue, expenses, and profitability by client</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={clientProfitabilityStartDate}
                            onChange={(e) => setClientProfitabilityStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-client-profitability-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={clientProfitabilityEndDate}
                            onChange={(e) => setClientProfitabilityEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-client-profitability-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!clientProfitabilityData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: clientProfitabilityStartDate,
                              endDate: clientProfitabilityEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Top 5 Clients by Revenue",
                                headers: ["Client", "Revenue", "Expenses", "Net Profit", "Profit Margin %"],
                                rows: clientProfitabilityData.topClients.map((client: any) => [
                                  client.clientName,
                                  `$${client.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `$${client.totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `$${client.netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `${client.profitMargin.toFixed(2)}%`
                                ])
                              },
                              {
                                title: "All Clients",
                                headers: ["Client", "Revenue", "Expenses", "Profit", "Margin %", "Projects", "Hours", "Avg Rate"],
                                rows: clientProfitabilityData.clients.map((client: any) => [
                                  client.clientName,
                                  `$${client.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `$${client.totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `$${client.netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  `${client.profitMargin.toFixed(2)}%`,
                                  client.projectCount.toString(),
                                  client.billableHours.toFixed(1),
                                  `$${client.averageHourlyRate.toFixed(2)}`
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Client Profitability Analysis",
                              dateRange,
                              tables,
                              summary: [
                                { label: "Total Clients", value: clientProfitabilityData.summary.totalClients },
                                { label: "Total Revenue", value: `$${clientProfitabilityData.summary.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` },
                                { label: "Total Profit", value: `$${clientProfitabilityData.summary.totalProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` },
                                { label: "Average Profit Margin", value: `${clientProfitabilityData.summary.averageProfitMargin.toFixed(2)}%` }
                              ]
                            }, firmInfo, "Client_Profitability_Report.pdf");

                            toast({
                              title: "Export Complete",
                              description: "PDF report has been downloaded"
                            });
                          }}
                          disabled={isLoadingClientProfitability || !clientProfitabilityData}
                          data-testid="button-export-client-profitability-pdf"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!clientProfitabilityData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm"
                            };

                            const dateRange: DateRange = {
                              startDate: clientProfitabilityStartDate,
                              endDate: clientProfitabilityEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Summary",
                                headers: ["Metric", "Value"],
                                rows: [
                                  ["Total Clients", clientProfitabilityData.summary.totalClients],
                                  ["Total Revenue", clientProfitabilityData.summary.totalRevenue],
                                  ["Total Expenses", clientProfitabilityData.summary.totalExpenses],
                                  ["Total Profit", clientProfitabilityData.summary.totalProfit],
                                  ["Average Profit Margin %", clientProfitabilityData.summary.averageProfitMargin]
                                ]
                              },
                              {
                                title: "Client Details",
                                headers: ["Client", "Revenue", "Expenses", "Profit", "Margin %", "Projects", "Hours", "Avg Rate"],
                                rows: clientProfitabilityData.clients.map((client: any) => [
                                  client.clientName,
                                  client.totalRevenue,
                                  client.totalExpenses,
                                  client.netProfit,
                                  client.profitMargin,
                                  client.projectCount,
                                  client.billableHours,
                                  client.averageHourlyRate
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Client Profitability Analysis",
                              dateRange,
                              tables
                            }, firmInfo, "Client_Profitability_Report.xlsx");

                            toast({
                              title: "Export Complete",
                              description: "Excel report has been downloaded"
                            });
                          }}
                          disabled={isLoadingClientProfitability || !clientProfitabilityData}
                          data-testid="button-export-client-profitability-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Error State */}
                {clientProfitabilityError && (
                  <Card className="border-red-200 bg-red-50">
                    <CardContent className="pt-6">
                      <div className="flex items-center gap-2 text-red-600">
                        <AlertCircle className="w-5 h-5" />
                        <p>Failed to load client profitability data. Please try again.</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Loading State */}
                {isLoadingClientProfitability && (
                  <Card>
                    <CardContent className="pt-6">
                      <div className="flex items-center justify-center py-12">
                        <RefreshCw className="w-8 h-8 animate-spin text-gray-400" />
                        <p className="ml-3 text-gray-500">Loading client profitability data...</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Summary Metrics */}
                {clientProfitabilityData && !isLoadingClientProfitability && (
                  <>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Clients</p>
                            <p className="text-2xl font-bold text-blue-600" data-testid="text-total-clients">
                              {clientProfitabilityData.summary.totalClients}
                            </p>
                            <p className="text-xs text-gray-500">Active clients in period</p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Total Revenue</p>
                            <p className="text-2xl font-bold text-green-600" data-testid="text-client-revenue">
                              ${clientProfitabilityData.summary.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-500">Across all clients</p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Net Profit</p>
                            <p className={`text-2xl font-bold ${clientProfitabilityData.summary.totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}`} data-testid="text-client-profit">
                              ${clientProfitabilityData.summary.totalProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-gray-500">Revenue minus expenses</p>
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="pt-6">
                          <div className="space-y-2">
                            <p className="text-sm font-medium text-gray-600">Avg. Profit Margin</p>
                            <p className="text-2xl font-bold text-purple-600" data-testid="text-avg-margin">
                              {clientProfitabilityData.summary.averageProfitMargin.toFixed(2)}%
                            </p>
                            <p className="text-xs text-gray-500">Mean across all clients</p>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <ReportBarChart
                        title="Top 10 Clients by Revenue"
                        data={clientProfitabilityData.clients.slice(0, 10).map((client: any) => ({
                          name: client.clientName.length > 20 ? client.clientName.substring(0, 20) + '...' : client.clientName,
                          revenue: client.totalRevenue
                        }))}
                        xKey="name"
                        yKey="revenue"
                        color="#10b981"
                        isLoading={false}
                        height={300}
                      />

                      <ReportBarChart
                        title="Profit Margin Distribution"
                        data={clientProfitabilityData.clients.slice(0, 10).map((client: any) => ({
                          name: client.clientName.length > 20 ? client.clientName.substring(0, 20) + '...' : client.clientName,
                          margin: client.profitMargin
                        }))}
                        xKey="name"
                        yKey="margin"
                        color="#8b5cf6"
                        isLoading={false}
                        height={300}
                      />
                    </div>

                    {/* Enhanced Client Profitability Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Detailed Client Profitability Breakdown</CardTitle>
                        <CardDescription>
                          All clients sorted by revenue (descending)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Client</TableHead>
                                <TableHead className="text-right">Total Revenue</TableHead>
                                <TableHead className="text-right">Total Expenses</TableHead>
                                <TableHead className="text-right">Net Profit</TableHead>
                                <TableHead className="text-right">Profit Margin %</TableHead>
                                <TableHead className="text-center">Active Projects</TableHead>
                                <TableHead className="text-right">Billable Hours</TableHead>
                                <TableHead className="text-right">Avg Hourly Rate</TableHead>
                                <TableHead>Value Tier</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {clientProfitabilityData.clients.length > 0 ? (
                                clientProfitabilityData.clients.map((client: any) => {
                                  const getValueTier = (revenue: number) => {
                                    if (revenue >= 100000) return { label: 'High Value', variant: 'default' as const };
                                    if (revenue >= 50000) return { label: 'Medium', variant: 'secondary' as const };
                                    return { label: 'Low', variant: 'outline' as const };
                                  };

                                  const tier = getValueTier(client.totalRevenue);

                                  return (
                                    <TableRow key={client.clientId} className="hover:bg-gray-50">
                                      <TableCell className="font-medium">{client.clientName}</TableCell>
                                      <TableCell className="text-right font-semibold text-green-600">
                                        ${client.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                      </TableCell>
                                      <TableCell className="text-right text-gray-600">
                                        ${client.totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                      </TableCell>
                                      <TableCell className={`text-right font-semibold ${client.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        ${client.netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                      </TableCell>
                                      <TableCell className={`text-right ${client.profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {client.profitMargin.toFixed(2)}%
                                      </TableCell>
                                      <TableCell className="text-center">{client.projectCount}</TableCell>
                                      <TableCell className="text-right">{client.billableHours.toFixed(1)}</TableCell>
                                      <TableCell className="text-right">
                                        ${client.averageHourlyRate.toFixed(2)}
                                      </TableCell>
                                      <TableCell>
                                        <Badge variant={tier.variant}>{tier.label}</Badge>
                                      </TableCell>
                                    </TableRow>
                                  );
                                })
                              ) : (
                                <TableRow>
                                  <TableCell colSpan={9} className="text-center py-8 text-gray-500">
                                    No client profitability data available for this period
                                  </TableCell>
                                </TableRow>
                              )}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}

            {reportTab === 'revenue-by-service' && (
              <div className="space-y-6">
                {/* Header with Date Range and Export Buttons */}
                <Card>
                  <CardHeader>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                      <div>
                        <CardTitle>Revenue by Service Type</CardTitle>
                        <CardDescription>Breakdown of income sources by service category</CardDescription>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <div className="flex gap-2 items-center">
                          <Input
                            type="date"
                            value={revenueByServiceStartDate}
                            onChange={(e) => setRevenueByServiceStartDate(e.target.value)}
                            className="w-40"
                            data-testid="input-revenue-by-service-start-date"
                          />
                          <span className="text-sm text-gray-500">to</span>
                          <Input
                            type="date"
                            value={revenueByServiceEndDate}
                            onChange={(e) => setRevenueByServiceEndDate(e.target.value)}
                            className="w-40"
                            data-testid="input-revenue-by-service-end-date"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={async () => {
                            if (!revenueByServiceData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: revenueByServiceStartDate,
                              endDate: revenueByServiceEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Revenue by Service Type",
                                headers: ["Service Type", "Revenue", "# Invoices", "% of Total", "YoY Change"],
                                rows: revenueByServiceData.serviceTypes.map((service: any) => [
                                  service.serviceType,
                                  `$${service.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                                  service.invoiceCount.toString(),
                                  `${service.percentageOfTotal.toFixed(2)}%`,
                                  `${service.yoyChange >= 0 ? '+' : ''}${service.yoyChange.toFixed(2)}%`
                                ])
                              }
                            ];

                            await exportReportToPDF({
                              title: "Revenue by Service Type Report",
                              dateRange,
                              tables,
                              summary: [
                                { label: "Total Revenue", value: `$${revenueByServiceData.summary.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` },
                                { label: "Number of Service Types", value: revenueByServiceData.summary.numberOfServiceTypes },
                                { label: "Top Service Type", value: revenueByServiceData.summary.topServiceType },
                                { label: "Top Service Revenue", value: `$${revenueByServiceData.summary.topServiceRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` }
                              ]
                            }, firmInfo, "Revenue_By_Service_Report.pdf");

                            toast({
                              title: "Export Complete",
                              description: "PDF report has been downloaded"
                            });
                          }}
                          data-testid="button-export-pdf"
                        >
                          <FileTextIcon className="w-4 h-4 mr-2" />
                          Export PDF
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            if (!revenueByServiceData) return;

                            const firmInfo: FirmInfo = {
                              name: "Your Accounting Firm",
                              address: "123 Main St, City, State",
                              phone: "(555) 123-4567",
                              email: "info@yourfirm.com"
                            };

                            const dateRange: DateRange = {
                              startDate: revenueByServiceStartDate,
                              endDate: revenueByServiceEndDate
                            };

                            const tables: TableData[] = [
                              {
                                title: "Revenue by Service Type",
                                headers: ["Service Type", "Revenue", "# Invoices", "% of Total", "YoY Change"],
                                rows: revenueByServiceData.serviceTypes.map((service: any) => [
                                  service.serviceType,
                                  service.revenue.toFixed(2),
                                  service.invoiceCount.toString(),
                                  service.percentageOfTotal.toFixed(2),
                                  service.yoyChange.toFixed(2)
                                ])
                              }
                            ];

                            exportReportToExcel({
                              title: "Revenue by Service Type Report",
                              dateRange,
                              tables
                            }, firmInfo, "Revenue_By_Service_Report.xlsx");

                            toast({
                              title: "Export Complete",
                              description: "Excel file has been downloaded"
                            });
                          }}
                          data-testid="button-export-excel"
                        >
                          <FileSpreadsheet className="w-4 h-4 mr-2" />
                          Export Excel
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>

                {/* Loading State */}
                {isLoadingRevenueByService && (
                  <Card>
                    <CardContent className="p-8 text-center">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                      <p className="mt-4 text-gray-600">Loading revenue by service data...</p>
                    </CardContent>
                  </Card>
                )}

                {/* Error State */}
                {revenueByServiceError && (
                  <Card>
                    <CardContent className="p-8 text-center">
                      <AlertTriangle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                      <p className="text-red-600 font-medium">Failed to load revenue by service data</p>
                      <p className="text-sm text-gray-500 mt-2">{(revenueByServiceError as Error).message}</p>
                    </CardContent>
                  </Card>
                )}

                {/* Report Data */}
                {revenueByServiceData && !isLoadingRevenueByService && (
                  <>
                    {/* Summary Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Total Revenue</p>
                              <p className="text-2xl font-bold text-green-600">
                                ${revenueByServiceData.summary.totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </p>
                            </div>
                            <DollarSign className="w-10 h-10 text-green-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Service Categories</p>
                              <p className="text-2xl font-bold text-blue-600">
                                {revenueByServiceData.summary.numberOfServiceTypes}
                              </p>
                            </div>
                            <Building2 className="w-10 h-10 text-blue-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Top Service Type</p>
                              <p className="text-lg font-bold text-purple-600 truncate">
                                {revenueByServiceData.summary.topServiceType}
                              </p>
                            </div>
                            <Star className="w-10 h-10 text-purple-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>

                      <Card>
                        <CardContent className="p-6">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="text-sm font-medium text-gray-600">Top Service Revenue</p>
                              <p className="text-2xl font-bold text-orange-600">
                                ${revenueByServiceData.summary.topServiceRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </p>
                            </div>
                            <TrendingUp className="w-10 h-10 text-orange-500 opacity-20" />
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    {/* Charts */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Bar Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Revenue by Service Type (Bar Chart)</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportBarChart
                            data={revenueByServiceData.serviceTypes.map((service: any) => ({
                              name: service.serviceType,
                              value: service.revenue
                            }))}
                            xKey="name"
                            yKey="value"
                            title="Revenue Distribution"
                            height={300}
                          />
                        </CardContent>
                      </Card>

                      {/* Pie Chart */}
                      <Card>
                        <CardHeader>
                          <CardTitle>Revenue Distribution (Pie Chart)</CardTitle>
                        </CardHeader>
                        <CardContent>
                          <ReportPieChart
                            data={revenueByServiceData.serviceTypes.map((service: any) => ({
                              name: service.serviceType,
                              value: service.revenue
                            }))}
                            title="Service Type Distribution"
                            height={300}
                          />
                        </CardContent>
                      </Card>
                    </div>

                    {/* Detailed Table */}
                    <Card>
                      <CardHeader>
                        <CardTitle>Detailed Service Type Breakdown</CardTitle>
                        <CardDescription>
                          All service types sorted by revenue (descending)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>Service Type</TableHead>
                                <TableHead className="text-right">Revenue</TableHead>
                                <TableHead className="text-center"># Invoices</TableHead>
                                <TableHead className="text-right">% of Total</TableHead>
                                <TableHead className="text-right">YoY Change</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {revenueByServiceData.serviceTypes.length > 0 ? (
                                revenueByServiceData.serviceTypes.map((service: any, index: number) => (
                                  <TableRow key={index} className="hover:bg-gray-50">
                                    <TableCell className="font-medium">{service.serviceType}</TableCell>
                                    <TableCell className="text-right font-semibold text-green-600">
                                      ${service.revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </TableCell>
                                    <TableCell className="text-center">{service.invoiceCount}</TableCell>
                                    <TableCell className="text-right text-blue-600 font-medium">
                                      {service.percentageOfTotal.toFixed(2)}%
                                    </TableCell>
                                    <TableCell className={`text-right font-semibold ${service.yoyChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      {service.yoyChange >= 0 ? '+' : ''}{service.yoyChange.toFixed(2)}%
                                    </TableCell>
                                  </TableRow>
                                ))
                              ) : (
                                <TableRow>
                                  <TableCell colSpan={5} className="text-center py-8 text-gray-500">
                                    No revenue data available for this period
                                  </TableCell>
                                </TableRow>
                              )}
                            </TableBody>
                          </Table>
                        </div>
                      </CardContent>
                    </Card>
                  </>
                )}
              </div>
            )}
          </div>
        );

      case 'team':
        return <TeamManagement />;

      case 'contact-management':
        return <ContactPersonManagement />;

      case 'notifications':
        return (
          <div className="w-full max-w-full">
            <Tabs defaultValue="notifications" className="w-full max-w-full">
              <TabsList className="grid w-full grid-cols-2">
                <TabsTrigger value="notifications">Notifications</TabsTrigger>
                <TabsTrigger value="pending-approvals">Pending Approvals</TabsTrigger>
              </TabsList>

              <TabsContent value="notifications" className="mt-6 w-full max-w-full">
                <NotificationHistory />
              </TabsContent>

              <TabsContent value="pending-approvals" className="mt-6">
                <div className="space-y-8">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-2xl font-bold">Pending Approvals</h2>
                      <p className="text-gray-600">Review and approve client submissions and time entries</p>
                    </div>
                  </div>

                  {/* Pending Client Approvals Section */}
                  <div className="space-y-4">
                    <h3 className="text-xl font-semibold">Client Approvals</h3>
                    {pendingApprovals?.clientApprovals && pendingApprovals.clientApprovals.length > 0 ? (
                      <div className="space-y-6">
                        {pendingApprovals.clientApprovals.map((approval: any) => (
                          <PendingApprovalDetailCard
                            key={approval.id}
                            approval={approval}
                            onApprove={(approvalId, updatedData) =>
                              approveClientMutation.mutate({ approvalId, action: 'approve', updatedData })
                            }
                            onReject={(approvalId) =>
                              approveClientMutation.mutate({ approvalId, action: 'reject' })
                            }
                            isProcessing={approveClientMutation.isPending}
                          />
                        ))}
                      </div>
                    ) : (
                      <Card>
                        <CardContent className="p-8 text-center">
                          <CheckCircle className="h-10 w-10 text-gray-400 mx-auto mb-3" />
                          <p className="text-gray-500">No pending client approvals</p>
                        </CardContent>
                      </Card>
                    )}
                  </div>

                  {/* Time Entry Approvals Section */}
                  <div className="space-y-4">
                    <h3 className="text-xl font-semibold">Time Entry Approvals</h3>
                    {pendingApprovals?.timeEntryApprovals && pendingApprovals.timeEntryApprovals.length > 0 ? (
                      <div className="space-y-4">
                        {pendingApprovals.timeEntryApprovals.map((entry: any) => (
                          <Card key={entry.id}>
                            <CardContent className="p-6">
                              <div className="flex justify-between items-start">
                                <div className="space-y-2 flex-1">
                                  <div className="flex items-center gap-3">
                                    <h4 className="font-semibold text-lg">{entry.userName}</h4>
                                    {entry.isBillable && (
                                      <Badge variant="default">Billable</Badge>
                                    )}
                                  </div>
                                  <div className="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                                    <div>
                                      <span className="text-gray-600">Project:</span>{" "}
                                      <span className="font-medium">{entry.projectName || "No Project"}</span>
                                    </div>
                                    <div>
                                      <span className="text-gray-600">Task:</span>{" "}
                                      <span className="font-medium">{entry.taskName || "No Task"}</span>
                                    </div>
                                    <div>
                                      <span className="text-gray-600">Duration:</span>{" "}
                                      <span className="font-medium">{(Number(entry.duration) / 3600).toFixed(2)}h</span>
                                    </div>
                                    <div>
                                      <span className="text-gray-600">Date:</span>{" "}
                                      <span className="font-medium">
                                        {entry.date ? new Date(entry.date).toLocaleDateString() : "No date"}
                                      </span>
                                    </div>
                                  </div>
                                  {entry.description && (
                                    <p className="text-sm text-gray-600 mt-2">
                                      <span className="font-medium">Description:</span> {entry.description}
                                    </p>
                                  )}
                                </div>
                                <div className="flex gap-2 ml-4">
                                  <Button
                                    size="sm"
                                    onClick={() => handleApproveTimeEntry(entry.id)}
                                    className="flex items-center gap-1"
                                  >
                                    <Check className="h-3 w-3" />
                                    Approve
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => handleRejectTimeEntry(entry.id)}
                                    className="flex items-center gap-1"
                                  >
                                    <X className="h-3 w-3" />
                                    Reject
                                  </Button>
                                </div>
                              </div>
                            </CardContent>
                          </Card>
                        ))}
                      </div>
                    ) : (
                      <Card>
                        <CardContent className="p-8 text-center">
                          <CheckCircle className="h-10 w-10 text-gray-400 mx-auto mb-3" />
                          <p className="text-gray-500">No pending time entry approvals</p>
                        </CardContent>
                      </Card>
                    )}
                  </div>
                </div>
              </TabsContent>
            </Tabs>
          </div>
        );

      case 'settings':
        return (
          <div className="space-y-6" data-testid="content-settings">
            {/* Settings Navigation Tabs */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Settings className="w-5 h-5 text-blue-500" />
                  Practice Settings & Configuration
                </CardTitle>
                <CardDescription>Manage firm settings, user permissions, and system configuration</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-2 mb-6">
                  <Button
                    variant={settingsTab === 'general' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('general')}
                    data-testid="tab-general"
                  >
                    ‚öôÔ∏è General
                  </Button>
                  <Button
                    variant={settingsTab === 'users' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('users')}
                    data-testid="tab-users"
                  >
                    üë• User Management
                  </Button>
                  <Button
                    variant={settingsTab === 'billing' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('billing')}
                    data-testid="tab-billing"
                  >
                    üí≥ Billing Settings
                  </Button>
                  <Button
                    variant={settingsTab === 'integrations' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('integrations')}
                    data-testid="tab-integrations"
                  >
                    üîó Integrations
                  </Button>
                  <Button
                    variant={settingsTab === 'security' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('security')}
                    data-testid="tab-security"
                  >
                    üîí Security
                  </Button>
                  <Button
                    variant={settingsTab === 'perfex-import' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('perfex-import')}
                    data-testid="tab-perfex-import"
                  >
                    üì• PerfexCRM Import
                  </Button>
                  <Button
                    variant={settingsTab === 'notifications' ? "default" : "outline"}
                    size="sm"
                    className="text-xs"
                    onClick={() => setSettingsTab('notifications')}
                    data-testid="tab-notifications"
                  >
                    üîî Notifications
                    <Button
                      variant={settingsTab === 'task-statuses' ? "default" : "outline"}
                      size="sm"
                      className="text-xs"
                      onClick={() => setSettingsTab('task-statuses')}
                      data-testid="tab-task-statuses"
                    >
                      üìã Task Statuses
                    </Button>
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* Settings Content Based on Selected Tab */}
            <div className="space-y-6">
              {settingsTab === 'perfex-import' ? (
                <PerfexImport />
              ) : settingsTab === 'integrations' ? (
                <IntegrationSettings />
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Firm Profile Settings - Show for General tab */}
                  {settingsTab === 'general' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Building className="w-5 h-5 text-green-500" />
                          Firm Profile
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="space-y-3">
                          <div>
                            <label className="text-sm font-medium mb-1 block">Firm Name</label>
                            <input
                              type="text"
                              defaultValue="Wilson & Associates CPA"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                              data-testid="input-firm-name"
                            />
                          </div>
                          <div>
                            <label className="text-sm font-medium mb-1 block">Business Address</label>
                            <textarea
                              defaultValue="123 Business District
Toronto, ON M5H 2N2
Canada"
                              className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm h-20"
                              data-testid="input-firm-address"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className="text-sm font-medium mb-1 block">Phone</label>
                              <input
                                type="tel"
                                defaultValue="(416) 555-0123"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                data-testid="input-firm-phone"
                              />
                            </div>
                            <div>
                              <label className="text-sm font-medium mb-1 block">Email</label>
                              <input
                                type="email"
                                defaultValue="contact@wilsonaccounting.ca"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                data-testid="input-firm-email"
                              />
                            </div>
                          </div>
                        </div>
                        <Button className="w-full" data-testid="button-save-profile">
                          <Settings className="w-4 h-4 mr-2" />
                          Save Profile Changes
                        </Button>
                      </CardContent>
                    </Card>
                  )}

                  {/* System Management - Show for General tab */}
                  {settingsTab === 'general' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Database className="w-5 h-5 text-blue-500" />
                          System Management
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        {/* System Status */}
                        <div className="space-y-4">
                          <div>
                            <h4 className="font-medium mb-3">System Status</h4>
                            <div className="space-y-2 text-sm">
                              {[
                                { metric: 'Database Status', status: 'Healthy', color: 'bg-green-500' },
                                { metric: 'API Performance', status: 'Good', color: 'bg-green-500' },
                                { metric: 'Storage Usage', status: '78% Used', color: 'bg-yellow-500' },
                                { metric: 'Last Backup', status: '2 hours ago', color: 'bg-green-500' }
                              ].map((item, index) => (
                                <div key={index} className="flex items-center justify-between" data-testid={`status-${index}`}>
                                  <span>{item.metric}</span>
                                  <div className="flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${item.color}`}></div>
                                    <span className="text-xs">{item.status}</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Quick Actions */}
                          <div>
                            <h4 className="font-medium mb-3">Quick Actions</h4>
                            <div className="space-y-2">
                              <Button className="w-full" variant="outline" data-testid="button-backup-now">
                                <Database className="w-4 h-4 mr-2" />
                                Backup Now
                              </Button>
                              <Button className="w-full" variant="outline" data-testid="button-system-logs">
                                <FileText className="w-4 h-4 mr-2" />
                                View System Logs
                              </Button>
                              <Button className="w-full" variant="destructive" data-testid="button-reset-warning">
                                <AlertTriangle className="w-4 h-4 mr-2" />
                                System Reset
                              </Button>
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Placeholder cards for other tabs */}
                  {settingsTab === 'users' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Users className="w-5 h-5 text-purple-500" />
                          User Management
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-gray-600">User management settings will be implemented here.</p>
                      </CardContent>
                    </Card>
                  )}

                  {settingsTab === 'billing' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <CreditCard className="w-5 h-5 text-green-500" />
                          Billing Settings
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={(e) => {
                          e.preventDefault();
                          const formData = new FormData(e.target as HTMLFormElement);

                          saveBillingSettingsMutation.mutate({
                            firmName: formData.get('firmName'),
                            firmAddress: formData.get('firmAddress'),
                            businessNumber: formData.get('businessNumber'),
                            hstNumber: formData.get('hstNumber'),
                            invoicePrefix: formData.get('invoicePrefix'),
                            invoiceStartNumber: parseInt(formData.get('invoiceStartNumber') as string),
                            invoicePadding: parseInt(formData.get('invoicePadding') as string),
                            defaultTaxRate: parseFloat(formData.get('defaultTaxRate') as string),
                            defaultPaymentTerms: formData.get('defaultPaymentTerms'),
                            defaultDueDateOffset: parseInt(formData.get('defaultDueDateOffset') as string),
                          });
                        }}>
                          <div className="space-y-6">
                            {/* Firm Branding Section */}
                            <div>
                              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                <Building className="w-5 h-5 text-blue-500" />
                                Firm Branding
                              </h3>
                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium mb-2">Firm Name</label>
                                  <input
                                    type="text"
                                    name="firmName"
                                    defaultValue={billingSettings?.firmName || ''}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    placeholder="Your Firm Name"
                                  />
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">Business Number</label>
                                  <input
                                    type="text"
                                    name="businessNumber"
                                    defaultValue={billingSettings?.businessNumber || ''}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    placeholder="123456789RC0001"
                                  />
                                </div>

                                <div className="col-span-2">
                                  <label className="block text-sm font-medium mb-2">Firm Address</label>
                                  <textarea
                                    name="firmAddress"
                                    defaultValue={billingSettings?.firmAddress || ''}
                                    rows={2}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    placeholder="123 Main Street&#10;Toronto, ON M5H 2N2"
                                  />
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">HST/GST Number</label>
                                  <input
                                    type="text"
                                    name="hstNumber"
                                    defaultValue={billingSettings?.hstNumber || ''}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    placeholder="123456789RT0001"
                                  />
                                </div>
                              </div>
                            </div>

                            {/* Invoice Numbering Section */}
                            <div className="pt-6 border-t">
                              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                <FileText className="w-5 h-5 text-green-500" />
                                Invoice Numbering
                              </h3>
                              <div className="grid grid-cols-3 gap-4">
                                <div>
                                  <label className="block text-sm font-medium mb-2">Prefix</label>
                                  <input
                                    type="text"
                                    name="invoicePrefix"
                                    defaultValue={billingSettings?.invoicePrefix || 'INV'}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    placeholder="INV"
                                  />
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">Starting Number</label>
                                  <input
                                    type="number"
                                    name="invoiceStartNumber"
                                    defaultValue={billingSettings?.invoiceStartNumber || 1}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    min="1"
                                  />
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">Padding (Digits)</label>
                                  <input
                                    type="number"
                                    name="invoicePadding"
                                    defaultValue={billingSettings?.invoicePadding || 6}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    min="1"
                                    max="10"
                                  />
                                </div>
                              </div>

                              {/* Live Preview */}
                              <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <p className="text-sm text-gray-600 mb-1">Preview of next invoice number:</p>
                                <p className="text-lg font-mono font-bold text-blue-600">
                                  {billingSettings?.invoicePrefix || 'INV'}-{String(billingSettings?.invoiceStartNumber || 1).padStart(billingSettings?.invoicePadding || 6, '0')}
                                </p>
                              </div>
                            </div>

                            {/* Default Settings Section */}
                            <div className="pt-6 border-t">
                              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                <Settings className="w-5 h-5 text-purple-500" />
                                Default Settings
                              </h3>
                              <div className="grid grid-cols-3 gap-4">
                                <div>
                                  <label className="block text-sm font-medium mb-2">Default HST/GST Rate (%)</label>
                                  <input
                                    type="number"
                                    name="defaultTaxRate"
                                    defaultValue={billingSettings?.defaultTaxRate || 13}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                  />
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">Payment Terms</label>
                                  <select
                                    name="defaultPaymentTerms"
                                    defaultValue={billingSettings?.defaultPaymentTerms || 'Net 30'}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                  >
                                    <option value="Due on Receipt">Due on Receipt</option>
                                    <option value="Net 15">Net 15</option>
                                    <option value="Net 30">Net 30</option>
                                    <option value="Net 60">Net 60</option>
                                    <option value="Net 90">Net 90</option>
                                  </select>
                                </div>

                                <div>
                                  <label className="block text-sm font-medium mb-2">Due Date Offset (Days)</label>
                                  <input
                                    type="number"
                                    name="defaultDueDateOffset"
                                    defaultValue={billingSettings?.defaultDueDateOffset || 30}
                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                    min="0"
                                  />
                                </div>
                              </div>
                            </div>

                            {/* Save Button */}
                            <div className="pt-6 border-t flex justify-end">
                              <Button
                                type="submit"
                                className="bg-green-600 hover:bg-green-700"
                                disabled={saveBillingSettingsMutation.isPending}
                                data-testid="button-save-billing-settings"
                              >
                                {saveBillingSettingsMutation.isPending ? (
                                  "Saving..."
                                ) : (
                                  <>
                                    <Save className="w-4 h-4 mr-2" />
                                    Save Settings
                                  </>
                                )}
                              </Button>
                            </div>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {settingsTab === 'integrations' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Zap className="w-5 h-5 text-yellow-500" />
                          Integrations
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-gray-600">Third-party integrations will be managed here.</p>
                      </CardContent>
                    </Card>
                  )}

                  {settingsTab === 'security' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Users className="w-5 h-5 text-red-500" />
                          Security Settings
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-gray-600">Security and access control settings will be implemented here.</p>
                      </CardContent>
                    </Card>
                  )}

                  {settingsTab === 'notifications' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Bell className="w-5 h-5 text-blue-500" />
                          Notification Settings
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-gray-600">Notification preferences will be configured here.</p>

                        {settingsTab === 'task-statuses' && (
                          <Card className="lg:col-span-2">
                            <CardHeader>
                              <div className="flex items-center justify-between">
                                <CardTitle className="flex items-center gap-2">
                                  <CheckSquare className="w-5 h-5 text-purple-500" />
                                  Task Status Management
                                </CardTitle>
                                <Button
                                  size="sm"
                                  onClick={() => {
                                    const name = prompt('Enter new status name:');
                                    if (!name) return;
                                    const color = prompt('Enter hex color (e.g., #6B7280):', '#6B7280');
                                    if (!color) return;

                                    createTaskStatusConfigMutation.mutate({ name, color });
                                  }}
                                  data-testid="button-add-task-status"
                                >
                                  <Plus className="w-4 h-4 mr-2" />
                                  Add Status
                                </Button>
                              </div>
                              <CardDescription>Customize task statuses for your workflow</CardDescription>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-2">
                                {safeArray(taskStatuses).map((status: any) => (
                                  <div
                                    key={status.id}
                                    className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50"
                                    data-testid={`status-item-${status.id}`}
                                  >
                                    <div className="flex items-center gap-3">
                                      <div
                                        className="w-4 h-4 rounded-full"
                                        style={{ backgroundColor: status.color }}
                                      />
                                      <div>
                                        <p className="font-medium">{status.name}</p>
                                        {status.isSystemStatus && (
                                          <span className="text-xs text-gray-500">System Status</span>
                                        )}
                                      </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => {
                                          const newName = prompt('Enter new name:', status.name);
                                          if (!newName || newName === status.name) {
                                            const newColor = prompt('Enter new hex color:', status.color);
                                            if (!newColor || newColor === status.color) return;
                                            updateTaskStatusConfigMutation.mutate({ id: status.id, color: newColor });
                                            return;
                                          }
                                          const newColor = prompt('Enter new hex color:', status.color);
                                          updateTaskStatusMutation.mutate({
                                            id: status.id,
                                            name: newName,
                                            color: newColor || status.color
                                          });
                                        }}
                                        data-testid={`button-edit-status-${status.id}`}
                                      >
                                        Edit
                                      </Button>
                                      {!status.isSystemStatus && (
                                        <Button
                                          variant="ghost"
                                          size="sm"
                                          onClick={() => {
                                            if (confirm(`Are you sure you want to delete "${status.name}"?`)) {
                                              deleteTaskStatusConfigMutation.mutate(status.id);
                                            }
                                          }}
                                          data-testid={`button-delete-status-${status.id}`}
                                        >
                                          <Trash2 className="w-4 h-4 text-red-500" />
                                        </Button>
                                      )}
                                    </div>
                                  </div>
                                ))}
                              </div>
                              {safeArray(taskStatuses).length === 0 && (
                                <p className="text-center text-gray-500 py-8">
                                  No task statuses found. Click "Add Status" to create one.
                                </p>
                              )}
                            </CardContent>
                          </Card>
                        )}
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
            </div>
          </div>
        );

      case 'practice':
        return (
          <div className="space-y-6" data-testid="content-practice">
            {/* Practice Management Overview Dashboard */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Total Revenue</CardTitle>
                  <DollarSign className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">$425,680</div>
                  <p className="text-xs text-muted-foreground">+15% from last quarter</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Active Clients</CardTitle>
                  <Users className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">67</div>
                  <p className="text-xs text-muted-foreground">+3 new this month</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Team Utilization</CardTitle>
                  <Activity className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">84%</div>
                  <p className="text-xs text-muted-foreground">+2% from last month</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Profit Margin</CardTitle>
                  <TrendingUp className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">32.5%</div>
                  <p className="text-xs text-muted-foreground">+1.8% from last month</p>
                </CardContent>
              </Card>
            </div>

            {/* Practice Analytics & Resource Management */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Financial Performance */}
              <Card className="lg:col-span-2">
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle className="flex items-center gap-2">
                      <BarChart3 className="w-5 h-5 text-blue-500" />
                      Financial Performance
                    </CardTitle>
                    <div className="flex items-center gap-2">
                      <select className="px-3 py-1 border border-gray-300 rounded-md text-sm" data-testid="select-performance-period">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                      </select>
                      <Button variant="outline" size="sm" data-testid="button-export-financials">
                        <Download className="w-4 h-4 mr-2" />
                        Export
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-6">
                    {/* Revenue Breakdown */}
                    <div>
                      <h4 className="font-medium mb-3">Revenue by Service Line</h4>
                      <div className="space-y-3">
                        {[
                          { service: 'Tax Preparation', revenue: '$185,400', percentage: 44, color: 'bg-blue-600' },
                          { service: 'Bookkeeping Services', revenue: '$128,200', percentage: 30, color: 'bg-green-600' },
                          { service: 'Business Consulting', revenue: '$76,800', percentage: 18, color: 'bg-purple-600' },
                          { service: 'Audit & Assurance', revenue: '$35,280', percentage: 8, color: 'bg-orange-600' }
                        ].map((item, index) => (
                          <div key={index} className="space-y-1" data-testid={`revenue-service-${index}`}>
                            <div className="flex justify-between text-sm">
                              <span className="font-medium">{item.service}</span>
                              <span>{item.revenue} ({item.percentage}%)</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div
                                className={`h-2 rounded-full ${item.color}`}
                                style={{ width: `${item.percentage}%` }}
                              ></div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Monthly Trends */}
                    <div>
                      <h4 className="font-medium mb-3">Monthly Performance Trends</h4>
                      <div className="grid grid-cols-3 gap-4 text-center">
                        {[
                          { month: 'Last Month', value: '$38,200', change: '+12%', color: 'text-green-600' },
                          { month: 'This Month', value: '$42,800', change: '+18%', color: 'text-green-600' },
                          { month: 'Projected', value: '$45,500', change: '+6%', color: 'text-blue-600' }
                        ].map((trend, index) => (
                          <div key={index} className="p-3 bg-gray-50 rounded-lg" data-testid={`trend-${index}`}>
                            <p className="text-xs text-gray-600">{trend.month}</p>
                            <p className="font-bold text-lg">{trend.value}</p>
                            <p className={`text-xs ${trend.color}`}>{trend.change}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Resource Management */}
              <Card>
                <CardHeader>
                  <CardTitle>Resource Management</CardTitle>
                  <CardDescription>Team capacity and utilization</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {/* Staff Capacity */}
                    <div>
                      <h4 className="font-medium mb-3">Staff Capacity</h4>
                      <div className="space-y-2">
                        {[
                          { name: 'John Smith (Partner)', utilization: 92, capacity: '40h/week', color: 'bg-red-500' },
                          { name: 'Sarah Wilson (Senior)', utilization: 87, capacity: '40h/week', color: 'bg-orange-500' },
                          { name: 'Mike Chen (Staff)', utilization: 78, capacity: '40h/week', color: 'bg-green-500' },
                          { name: 'Lisa Park (Junior)', utilization: 65, capacity: '35h/week', color: 'bg-blue-500' }
                        ].map((staff, index) => (
                          <div key={index} className="p-2 border rounded" data-testid={`staff-capacity-${index}`}>
                            <div className="flex justify-between text-sm mb-1">
                              <span className="font-medium" data-testid={`text-staff-name-${index}`}>{staff.name}</span>
                              <span>{staff.utilization}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div
                                className={`h-2 rounded-full ${staff.color}`}
                                style={{ width: `${staff.utilization}%` }}
                              ></div>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">{staff.capacity}</p>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Practice Goals */}
                    <div>
                      <h4 className="font-medium mb-3">Practice Goals</h4>
                      <div className="space-y-2">
                        {[
                          { goal: 'Annual Revenue Target', progress: 68, target: '$500K' },
                          { goal: 'New Client Acquisition', progress: 45, target: '15 clients' },
                          { goal: 'Team Expansion', progress: 75, target: '2 new hires' }
                        ].map((goal, index) => (
                          <div key={index} className="p-2 bg-gray-50 rounded" data-testid={`practice-goal-${index}`}>
                            <div className="flex justify-between text-sm mb-1">
                              <span className="font-medium" data-testid={`text-goal-${index}`}>{goal.goal}</span>
                              <span>{goal.progress}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-1.5">
                              <div
                                className="bg-blue-600 h-1.5 rounded-full"
                                style={{ width: `${goal.progress}%` }}
                              ></div>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">Target: {goal.target}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        );

      default: // practice-management
        return (
          <div className="space-y-6">
            {/* Key Metrics */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
                  <Users className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{safeMetrics.totalClients}</div>
                  <p className="text-xs text-muted-foreground">Active client base</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Active Workflows</CardTitle>
                  <Briefcase className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{safeMetrics.activeWorkflows}</div>
                  <p className="text-xs text-muted-foreground">In progress</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Total Revenue</CardTitle>
                  <DollarSign className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">${safeMetrics.totalRevenue.toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">Year to date</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Billable Hours</CardTitle>
                  <Clock className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{safeMetrics.billableHours}</div>
                  <p className="text-xs text-muted-foreground">This month</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Team Utilization</CardTitle>
                  <TrendingUp className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{safeMetrics.teamUtilization}%</div>
                  <p className="text-xs text-muted-foreground">Average across team</p>
                </CardContent>
              </Card>

              <Card>
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">Pipeline Value</CardTitle>
                  <Target className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">${safeMetrics.pipelineValue.toLocaleString()}</div>
                  <p className="text-xs text-muted-foreground">Potential revenue</p>
                </CardContent>
              </Card>
            </div>

            {/* Content Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Recent Activity */}
              <Card>
                <CardHeader>
                  <CardTitle>Recent Activity</CardTitle>
                  <CardDescription>Latest updates across your practice</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="flex items-center gap-4">
                      <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                      <div className="flex-1">
                        <p className="text-sm font-medium">New client onboarding completed</p>
                        <p className="text-xs text-gray-600">Sarah's Business - 2 hours ago</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                      <div className="flex-1">
                        <p className="text-sm font-medium">Tax return filed</p>
                        <p className="text-xs text-gray-600">Johnson Corp - 4 hours ago</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="w-2 h-2 bg-orange-500 rounded-full"></div>
                      <div className="flex-1">
                        <p className="text-sm font-medium">Follow-up email sent</p>
                        <p className="text-xs text-gray-600">Mike's Startup - Yesterday</p>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Upcoming Tasks */}
              <Card>
                <CardHeader>
                  <CardTitle>Upcoming Tasks</CardTitle>
                  <CardDescription>Tasks due soon</CardDescription>
                </CardHeader>
                <CardContent>
                  {Array.isArray(tasks) && tasks.length > 0 ? (
                    tasks.slice(0, 5).map((task: any) => (
                      <div key={task.id} className="flex items-center justify-between py-2">
                        <div className="flex-1">
                          <p className="font-medium">{task.title}</p>
                          <p className="text-sm text-gray-600">
                            {(() => {
                              try {
                                const date = new Date(task.dueDate || new Date());
                                if (isNaN(date.getTime())) return "No due date";
                                return isToday(date) ? "Today" :
                                  isTomorrow(date) ? "Tomorrow" :
                                    format(date, "MMM d");
                              } catch (error) {
                                return "Invalid date";
                              }
                            })()}
                          </p>
                        </div>
                        <div className="flex items-center space-x-2">
                          <Badge variant={
                            task.priority === "high" ? "destructive" :
                              task.priority === "medium" ? "default" : "secondary"
                          }>
                            {task.priority}
                          </Badge>
                        </div>
                      </div>
                    ))
                  ) : (
                    <p className="text-gray-500">No upcoming tasks</p>
                  )}
                </CardContent>
              </Card>
            </div>

            {/* Tars AI Chat */}
            <TarsAIChat />
          </div>
        );
    }
  };
  return (
    <>
      <div data-testid="comprehensive-pages-component" className="min-h-screen bg-gray-50 flex">
        {/* Sidebar */}
        <PagesSidebar
          activeTab={activeTab}
          setActiveTab={setActiveTab}
          allowedModules={allowedModules}
        />

        {/* Main Content */}
        <div className="flex-1 overflow-auto min-w-0">
          <div className="px-6 py-4 w-full max-w-full">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center space-x-3">
                <span className="text-xl font-semibold text-gray-900">
                  {activeTab === 'practice-management' && 'DASHBOARD'}
                  {activeTab === 'clients' && 'CLIENTS'}
                  {activeTab === 'projects' && 'PROJECTS'}
                  {activeTab === 'tasks' && 'TASKS'}
                  {activeTab === 'calendar' && 'CALENDAR'}
                  {activeTab === 'billing' && 'BILLING'}
                  {activeTab === 'reports' && 'REPORTS'}
                  {activeTab === 'team' && 'TEAM'}
                  {activeTab === 'communication' && 'COMMUNICATION'}
                  {activeTab === 'notifications' && 'NOTIFICATIONS'}
                  {activeTab === 'practice' && 'PRACTICE'}
                  {activeTab === 'settings' && 'SETTINGS'}
                </span>
              </div>
              <div className="flex items-center gap-3">
                <Button
                  variant="ghost"
                  size="sm"
                  className={`relative ${isTimerRunning ? 'text-green-600' : 'text-gray-500'}`}
                  onClick={() => setIsTimerOpen(true)}
                >
                  <Clock className="h-5 w-5" />
                  {isTimerRunning && (
                    <div className="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                  )}
                </Button>
                <NotificationCenter />
                <Button variant="ghost" size="sm">
                  <Settings className="h-5 w-5" />
                </Button>
              </div>
            </div>

            <div className="overflow-x-hidden">
              {/* Render tab content */}
              {renderTabContent()}
            </div>



          </div>
        </div>

        {/* New Task Dialog */}
        <Dialog open={showNewTaskDialog} onOpenChange={setShowNewTaskDialog}>
          <DialogContent className="sm:max-w-[525px]">
            <DialogHeader>
              <DialogTitle>Create New Task</DialogTitle>
              <DialogDescription>
                Add a new task to your practice management system
              </DialogDescription>
            </DialogHeader>
            <Form {...taskForm}>
              <form onSubmit={taskForm.handleSubmit(handleCreateTask)} className="space-y-4">
                <FormField
                  control={taskForm.control}
                  name="title"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Task Title</FormLabel>
                      <FormControl>
                        <Input placeholder="Enter task title..." {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={taskForm.control}
                  name="description"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Description</FormLabel>
                      <FormControl>
                        <Textarea placeholder="Task description..." {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={taskForm.control}
                  name="projectId"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Project</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select project" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {projects.map((project: any) => (
                            <SelectItem key={project.id} value={project.id.toString()}>
                              {project.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={taskForm.control}
                    name="startDate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Start Date</FormLabel>
                        <FormControl>
                          <Input type="date" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <FormField
                    control={taskForm.control}
                    name="dueDate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Due Date</FormLabel>
                        <FormControl>
                          <Input type="date" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <FormField
                    control={taskForm.control}
                    name="estimatedHours"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Estimated Hours</FormLabel>
                        <FormControl>
                          <Input type="number" step="0.25" placeholder="0" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <FormField
                    control={taskForm.control}
                    name="parentTaskId"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Parent Task (Optional)</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Select parent task" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            {availableParentTasks.map((task: any) => (
                              <SelectItem key={task.id} value={task.id.toString()}>
                                {task.title}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={taskForm.control}
                  name="statusId"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Status</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select status" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {taskStatuses
                            .filter((status: any) => status.isActive)
                            .sort((a: any, b: any) => a.displayOrder - b.displayOrder)
                            .map((status: any) => (
                              <SelectItem key={status.id} value={status.id.toString()}>
                                <div className="flex items-center gap-2">
                                  <div
                                    className="w-3 h-3 rounded-full"
                                    style={{ backgroundColor: status.color }}
                                  />
                                  {status.name}
                                </div>
                              </SelectItem>
                            ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={taskForm.control}
                  name="priority"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Priority</FormLabel>
                      <Select onValueChange={field.onChange} defaultValue={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select priority" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="low">Low</SelectItem>
                          <SelectItem value="medium">Medium</SelectItem>
                          <SelectItem value="high">High</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={taskForm.control}
                  name="assignedUserId"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Assign To</FormLabel>
                      <Select onValueChange={field.onChange} defaultValue={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select team member" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {Array.isArray(users) && users.map((user: any) => (
                            <SelectItem key={user.id} value={user.id}>
                              {user.email}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={taskForm.control}
                  name="isRecurring"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-3">
                      <div>
                        <FormLabel>Recurring Task</FormLabel>
                        <p className="text-xs text-gray-500">
                          Automatically repeats based on schedule
                        </p>
                      </div>
                      <FormControl>
                        <Switch checked={!!field.value} onCheckedChange={field.onChange} />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {isTaskRecurring && (
                  <div className="space-y-4 rounded-lg border p-4">
                    <FormField
                      control={taskForm.control}
                      name="recurrenceFrequency"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Frequency</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Select frequency" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="daily">Daily</SelectItem>
                              <SelectItem value="weekly">Weekly</SelectItem>
                              <SelectItem value="monthly">Monthly</SelectItem>
                              <SelectItem value="yearly">Yearly</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={taskForm.control}
                      name="recurrenceEndCondition"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Ends</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Select end condition" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="never">Never</SelectItem>
                              <SelectItem value="after">After # Occurrences</SelectItem>
                              <SelectItem value="on_date">On Date</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    {recurrenceEndCondition === "after" && (
                      <FormField
                        control={taskForm.control}
                        name="recurrenceTotalOccurrences"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Total Occurrences</FormLabel>
                            <FormControl>
                              <Input type="number" min="1" placeholder="e.g., 12" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    )}

                    {recurrenceEndCondition === "on_date" && (
                      <FormField
                        control={taskForm.control}
                        name="recurrenceEndDate"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>End Date</FormLabel>
                            <FormControl>
                              <Input type="date" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    )}
                  </div>
                )}

                <DialogFooter>
                  <Button type="button" variant="outline" onClick={() => setShowNewTaskDialog(false)}>
                    Cancel
                  </Button>
                  <Button type="submit" disabled={createTaskMutation.isPending}>
                    {createTaskMutation.isPending ? "Creating..." : "Create Task"}
                  </Button>
                </DialogFooter>
              </form>
            </Form>
          </DialogContent>
        </Dialog>

        {/* New Client Dialog - Only show when NOT editing */}
        {showNewClientDialog && !showClientEdit && (
          <EnhancedClientCreation
            isOpen={showNewClientDialog}
            onComplete={(client) => {
              queryClient.invalidateQueries({ queryKey: ["/api/clients"] });
              setShowNewClientDialog(false);
              toast({
                title: "Success",
                description: client.workflow ?
                  "Client intake workflow created successfully! CONNIE AI will send the email shortly." :
                  "Client created successfully!"
              });
            }}
            onCancel={() => setShowNewClientDialog(false)}
          />
        )}

        {/* Edit Client Dialog */}
        {showClientEdit && selectedClientId && (
          <EditClientFormDialog
            isOpen={showClientEdit}
            clientId={selectedClientId}
            onComplete={(client) => {
              queryClient.invalidateQueries({ queryKey: ["/api/clients"] });
              setShowClientEdit(false);
              setSelectedClientId(null);
              toast({
                title: "Success",
                description: "Client updated successfully!"
              });
            }}
            onCancel={() => {
              setShowClientEdit(false);
              setSelectedClientId(null);
            }}
          />
        )}

        {/* Smart Timer Dialog */}
        <Dialog open={isTimerOpen} onOpenChange={setIsTimerOpen}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Timer className="h-5 w-5" />
                Smart Timer
              </DialogTitle>
            </DialogHeader>

            <div className="space-y-4">
              <div className="text-center">
                <div className="text-3xl font-mono mb-4">
                  {Math.floor(elapsedTime / 3600).toString().padStart(2, '0')}:
                  {Math.floor((elapsedTime % 3600) / 60).toString().padStart(2, '0')}:
                  {(elapsedTime % 60).toString().padStart(2, '0')}
                </div>

                <div className="flex justify-center gap-2">
                  {!isTimerRunning ? (
                    <Button
                      onClick={() => setIsTimerRunning(true)}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      <Play className="h-4 w-4 mr-2" />
                      Start
                    </Button>
                  ) : (
                    <>
                      <Button
                        onClick={() => setIsTimerRunning(false)}
                        variant="outline"
                      >
                        <Pause className="h-4 w-4 mr-2" />
                        Pause
                      </Button>
                      <Button
                        onClick={handleStopTimer}
                        variant="destructive"
                      >
                        <Square className="h-4 w-4 mr-2" />
                        Stop
                      </Button>
                    </>
                  )}
                </div>
              </div>

              <div className="text-sm text-gray-600 text-center">
                <p>Task-based time tracking for PAGES, BOOKS, and BINDERS.</p>
                <p className="mt-2">Advanced timer features coming soon...</p>
              </div>
            </div>
          </DialogContent>
        </Dialog>

        {/* Time Entry Dialog */}
        <Dialog open={showTimeEntry} onOpenChange={setShowTimeEntry}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Clock className="h-5 w-5" />
                Log Time Entry
              </DialogTitle>
            </DialogHeader>

            {currentTimeEntry && (
              <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="font-medium mb-2">Time Logged</h3>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="text-gray-600">Duration:</span>
                      <div className="font-mono text-lg">
                        {Math.floor(parseFloat(currentTimeEntry.duration || '0') / 3600).toString().padStart(2, '0')}:
                        {Math.floor((parseFloat(currentTimeEntry.duration || '0') % 3600) / 60).toString().padStart(2, '0')}:
                        {(parseFloat(currentTimeEntry.duration || '0') % 60).toString().padStart(2, '0')}
                      </div>
                    </div>
                    <div>
                      <span className="text-gray-600">Period:</span>
                      <div>
                        {new Date(currentTimeEntry.startTime).toLocaleTimeString()} -
                        {new Date(currentTimeEntry.endTime).toLocaleTimeString()}
                      </div>
                    </div>
                  </div>
                </div>

                <form onSubmit={(e) => {
                  e.preventDefault();
                  const formData = new FormData(e.target as HTMLFormElement);
                  createTimeEntryMutation.mutate({
                    ...currentTimeEntry,
                    projectId: formData.get('projectId'),
                    taskId: formData.get('taskId'),
                    description: formData.get('description'),
                    billable: formData.get('billable') === 'true',
                  });
                }}>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">Project</label>
                      <select
                        name="projectId"
                        className="w-full border rounded px-3 py-2"
                        required
                        onChange={(e) => setSelectedProjectId(e.target.value)}
                        value={selectedProjectId}
                      >
                        <option value="">Select Project</option>
                        {projects.map((project: any) => (
                          <option key={project.id} value={project.id}>
                            {project.name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium mb-2">Task</label>
                      <select name="taskId" className="w-full border rounded px-3 py-2">
                        <option value="">Select Task (Optional)</option>
                        {safeArray(tasks)
                          .filter((task: any) => !selectedProjectId || task.projectId === parseInt(selectedProjectId))
                          .map((task: any) => (
                            <option key={task.id} value={task.id}>
                              {task.title}
                            </option>
                          ))}
                      </select>
                    </div>

                    <div className="col-span-2">
                      <label className="flex items-center gap-2 text-sm font-medium">
                        <input type="checkbox" name="billable" value="true" defaultChecked />
                        Billable
                      </label>
                    </div>
                  </div>

                  <div className="mt-4">
                    <label className="block text-sm font-medium mb-2">Description</label>
                    <textarea
                      name="description"
                      rows={3}
                      className="w-full border rounded px-3 py-2"
                      placeholder="What did you work on?"
                      required
                    />
                  </div>

                  <div className="flex justify-end gap-2 mt-6">
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => setShowTimeEntry(false)}
                    >
                      Cancel
                    </Button>
                    <Button
                      type="submit"
                      disabled={createTimeEntryMutation.isPending}
                      className="bg-blue-600 hover:bg-blue-700"
                    >
                      {createTimeEntryMutation.isPending ? "Saving..." : "Save Time Entry"}
                    </Button>
                  </div>
                </form>
              </div>
            )}
          </DialogContent>
        </Dialog>

        {/* Create Invoice Dialog */}
        <Dialog open={showNewInvoiceDialog} onOpenChange={setShowNewInvoiceDialog}>
          <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <FileText className="h-5 w-5 text-green-500" />
                Create New Invoice
              </DialogTitle>
            </DialogHeader>

            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target as HTMLFormElement);
              const clientId = formData.get('clientId');
              const projectId = formData.get('projectId');
              const invoiceDate = formData.get('invoiceDate');
              const dueDate = formData.get('dueDate');
              const notes = formData.get('notes');
              const taxRate = formData.get('taxRate');
              const discount = formData.get('discount');

              if (!projectId) {
                alert('Please select a project - every invoice must be linked to a project');
                return;
              }

              // Get all line items
              const lineItems: any[] = [];
              const descriptions = formData.getAll('description[]');
              const quantities = formData.getAll('quantity[]');
              const unitPrices = formData.getAll('unitPrice[]');

              for (let i = 0; i < descriptions.length; i++) {
                if (descriptions[i]) {
                  lineItems.push({
                    description: descriptions[i],
                    quantity: parseFloat(quantities[i] as string) || 1,
                    unitPrice: parseFloat(unitPrices[i] as string) || 0
                  });
                }
              }

              if (lineItems.length === 0) {
                alert('Please add at least one line item');
                return;
              }

              const token = localStorage.getItem('authToken');
              if (!token) {
                alert('Please login to create an invoice');
                return;
              }

              apiRequest("POST", "/api/billing/invoices", {
                clientId: parseInt(clientId as string),
                projectId: parseInt(projectId as string),
                invoiceDate,
                dueDate,
                notes,
                lineItems,
                taxRate: parseFloat(taxRate as string) || 13,
                discount: parseFloat(discount as string) || 0
              })
                .then(res => res.json())
                .then(data => {
                  if (data.error) {
                    alert('Error: ' + data.error);
                  } else {
                    setShowNewInvoiceDialog(false);
                    queryClient.invalidateQueries({ queryKey: ['/api/billing/invoices'] });
                  }
                })
                .catch(err => {
                  alert('Error creating invoice: ' + err.message);
                });
            }}>
              <div className="space-y-6">
                {/* Client & Project Selection */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Client *</label>
                    <select
                      name="clientId"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      required
                      onChange={(e) => setSelectedClientId(e.target.value)}
                    >
                      <option value="">Select Client</option>
                      {safeArray(clients).map((client: any) => (
                        <option key={client.id} value={client.id}>
                          {client.name}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Project *</label>
                    <select
                      name="projectId"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      required
                    >
                      <option value="">Select Project</option>
                      {safeArray(projects)
                        .filter((project: any) => !selectedClientId || project.clientId === parseInt(selectedClientId))
                        .map((project: any) => (
                          <option key={project.id} value={project.id}>
                            {project.name}
                          </option>
                        ))}
                    </select>
                  </div>
                </div>

                {/* Dates */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Invoice Date *</label>
                    <input
                      type="date"
                      name="invoiceDate"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      defaultValue={new Date().toISOString().split('T')[0]}
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Due Date *</label>
                    <input
                      type="date"
                      name="dueDate"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      defaultValue={new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}
                      required
                    />
                  </div>
                </div>

                {/* Tax & Discount */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">HST Rate (%) *</label>
                    <input
                      type="number"
                      name="taxRate"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      defaultValue="13"
                      step="0.01"
                      min="0"
                      max="100"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Discount Amount ($)</label>
                    <input
                      type="number"
                      name="discount"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      defaultValue="0"
                      step="0.01"
                      min="0"
                    />
                  </div>
                </div>

                {/* Line Items */}
                <div>
                  <label className="block text-sm font-medium mb-2">Line Items *</label>
                  <div className="border rounded-lg overflow-hidden">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-2 text-left text-xs font-medium text-gray-700">Description</th>
                          <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 w-24">Qty</th>
                          <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 w-32">Rate</th>
                          <th className="px-4 py-2 text-left text-xs font-medium text-gray-700 w-32">Amount</th>
                        </tr>
                      </thead>
                      <tbody id="invoice-line-items">
                        <tr>
                          <td className="px-4 py-2">
                            <input
                              type="text"
                              name="description[]"
                              className="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                              placeholder="Item description"
                            />
                          </td>
                          <td className="px-4 py-2">
                            <input
                              type="number"
                              name="quantity[]"
                              className="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                              defaultValue="1"
                              step="0.01"
                              min="0"
                            />
                          </td>
                          <td className="px-4 py-2">
                            <input
                              type="number"
                              name="unitPrice[]"
                              className="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                              defaultValue="0"
                              step="0.01"
                              min="0"
                            />
                          </td>
                          <td className="px-4 py-2 text-sm text-gray-600">
                            $0.00
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    className="mt-2"
                    onClick={() => {
                      const tbody = document.getElementById('invoice-line-items');
                      if (tbody) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                        <td class="px-4 py-2">
                          <input type="text" name="description[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="Item description" />
                        </td>
                        <td class="px-4 py-2">
                          <input type="number" name="quantity[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" value="1" step="0.01" min="0" />
                        </td>
                        <td class="px-4 py-2">
                          <input type="number" name="unitPrice[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" value="0" step="0.01" min="0" />
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-600">$0.00</td>
                      `;
                        tbody.appendChild(newRow);
                      }
                    }}
                  >
                    <Plus className="w-4 h-4 mr-2" />
                    Add Line Item
                  </Button>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium mb-2">Notes</label>
                  <textarea
                    name="notes"
                    rows={3}
                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                    placeholder="Additional notes or terms..."
                  />
                </div>

                {/* Actions */}
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setShowNewInvoiceDialog(false)}
                  >
                    Cancel
                  </Button>
                  <Button
                    type="submit"
                    className="bg-green-600 hover:bg-green-700"
                    data-testid="button-submit-invoice"
                  >
                    <FileText className="w-4 h-4 mr-2" />
                    Create Invoice
                  </Button>
                </div>
              </div>
            </form>
          </DialogContent>
        </Dialog>

        {/* Record Payment Dialog */}
        <Dialog open={showPaymentDialog} onOpenChange={setShowPaymentDialog}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <DollarSign className="h-5 w-5 text-green-500" />
                Record Payment
              </DialogTitle>
            </DialogHeader>

            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.target as HTMLFormElement);

              if (!selectedInvoiceForPayment) {
                toast({ title: "Error", description: "No invoice selected", variant: "destructive" });
                return;
              }

              const amount = parseFloat(formData.get('amount') as string);
              const balanceDue = parseFloat(selectedInvoiceForPayment.balanceDue || selectedInvoiceForPayment.totalAmount);

              if (amount <= 0 || amount > balanceDue) {
                toast({ title: "Error", description: `Payment amount must be between $0 and $${balanceDue.toFixed(2)}`, variant: "destructive" });
                return;
              }

              recordPaymentMutation.mutate({
                clientId: selectedInvoiceForPayment.clientId,
                amount,
                paymentDate: formData.get('paymentDate'),
                paymentMethod: formData.get('paymentMethod'),
                transactionId: formData.get('transactionId') || undefined,
                referenceNumber: formData.get('referenceNumber') || undefined,
                notes: formData.get('notes') || undefined,
                allocations: [{
                  invoiceId: selectedInvoiceForPayment.id,
                  amount
                }]
              });
            }}>
              <div className="space-y-4">
                {/* Invoice Info */}
                {selectedInvoiceForPayment && (
                  <div className="p-3 bg-gray-50 rounded-lg border">
                    <div className="flex justify-between items-start">
                      <div>
                        <p className="font-medium">{selectedInvoiceForPayment.invoiceNumber || `INV-${selectedInvoiceForPayment.id}`}</p>
                        <p className="text-sm text-gray-600">
                          {safeArray(clients).find((c: any) => c.id === selectedInvoiceForPayment.clientId)?.name}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-gray-600">Balance Due</p>
                        <p className="text-lg font-bold text-green-600">
                          ${(selectedInvoiceForPayment.balanceDue || selectedInvoiceForPayment.totalAmount || 0).toLocaleString()}
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Payment Details */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Payment Amount *</label>
                    <input
                      type="number"
                      name="amount"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      step="0.01"
                      min="0.01"
                      defaultValue={selectedInvoiceForPayment?.balanceDue || selectedInvoiceForPayment?.totalAmount || 0}
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Payment Date *</label>
                    <input
                      type="date"
                      name="paymentDate"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      defaultValue={new Date().toISOString().split('T')[0]}
                      required
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Payment Method *</label>
                    <select
                      name="paymentMethod"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      required
                      defaultValue="credit_card"
                    >
                      <option value="credit_card">Credit Card</option>
                      <option value="cash">Cash</option>
                      <option value="check">Check</option>
                      <option value="debit_card">Debit Card</option>
                      <option value="bank_transfer">Bank Transfer</option>
                      <option value="ach">ACH</option>
                      <option value="wire">Wire</option>
                      <option value="other">Other</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Reference Number</label>
                    <input
                      type="text"
                      name="referenceNumber"
                      className="w-full border border-gray-300 rounded-md px-3 py-2"
                      placeholder="Optional"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">Transaction ID</label>
                  <input
                    type="text"
                    name="transactionId"
                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                    placeholder="Transaction or confirmation ID from payment processor"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">Notes</label>
                  <textarea
                    name="notes"
                    rows={3}
                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                    placeholder="Additional notes about this payment..."
                  />
                </div>

                {/* Actions */}
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setShowPaymentDialog(false)}
                    disabled={recordPaymentMutation.isPending}
                  >
                    Cancel
                  </Button>
                  <Button
                    type="submit"
                    className="bg-green-600 hover:bg-green-700"
                    disabled={recordPaymentMutation.isPending}
                    data-testid="button-submit-payment"
                  >
                    {recordPaymentMutation.isPending ? (
                      "Recording..."
                    ) : (
                      <>
                        <DollarSign className="w-4 h-4 mr-2" />
                        Record Payment
                      </>
                    )}
                  </Button>
                </div>
              </div>
            </form>
          </DialogContent>
        </Dialog>

        {/* Comprehensive Record Payment Dialog */}
        <Dialog open={showRecordPaymentDialog} onOpenChange={(open) => {
          setShowRecordPaymentDialog(open);
          if (!open) {
            // Reset form on close
            setSelectedPaymentClient(null);
            setPaymentAmount('');
            setPaymentDate(new Date().toISOString().split('T')[0]);
            setPaymentMethod('credit_card');
            setPaymentReference('');
            setPaymentNotes('');
            setPaymentAllocations([]);
          }
        }}>
          <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <DollarSign className="h-5 w-5 text-green-500" />
                Record Payment
              </DialogTitle>
              <DialogDescription>
                Record a payment and allocate it across one or more invoices
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-6">
              {/* Client Selection */}
              <div className="space-y-2">
                <label className="text-sm font-medium">Client *</label>
                <Select
                  value={selectedPaymentClient?.toString() || ''}
                  onValueChange={(value) => {
                    setSelectedPaymentClient(Number(value));
                    // Reset allocations when client changes
                    setPaymentAllocations([]);
                  }}
                >
                  <SelectTrigger data-testid="select-payment-client">
                    <SelectValue placeholder="Select a client" />
                  </SelectTrigger>
                  <SelectContent>
                    {safeArray(clients).map((client: any) => (
                      <SelectItem key={client.id} value={client.id.toString()}>
                        {client.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Payment Details */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm font-medium">Payment Amount *</label>
                  <Input
                    type="number"
                    step="0.01"
                    min="0.01"
                    value={paymentAmount}
                    onChange={(e) => setPaymentAmount(e.target.value)}
                    placeholder="0.00"
                    data-testid="input-payment-amount"
                  />
                </div>

                <div className="space-y-2">
                  <label className="text-sm font-medium">Payment Date *</label>
                  <Input
                    type="date"
                    value={paymentDate}
                    onChange={(e) => setPaymentDate(e.target.value)}
                    data-testid="input-payment-date"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm font-medium">Payment Method *</label>
                  <Select
                    value={paymentMethod}
                    onValueChange={setPaymentMethod}
                  >
                    <SelectTrigger data-testid="select-payment-method">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="credit_card">Credit Card</SelectItem>
                      <SelectItem value="cash">Cash</SelectItem>
                      <SelectItem value="check">Check</SelectItem>
                      <SelectItem value="debit_card">Debit Card</SelectItem>
                      <SelectItem value="bank_transfer">Bank Transfer</SelectItem>
                      <SelectItem value="ach">ACH</SelectItem>
                      <SelectItem value="wire">Wire</SelectItem>
                      <SelectItem value="other">Other</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <label className="text-sm font-medium">Reference Number</label>
                  <Input
                    type="text"
                    value={paymentReference}
                    onChange={(e) => setPaymentReference(e.target.value)}
                    placeholder="Optional"
                    data-testid="input-payment-reference"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <label className="text-sm font-medium">Notes</label>
                <Textarea
                  value={paymentNotes}
                  onChange={(e) => setPaymentNotes(e.target.value)}
                  placeholder="Additional notes about this payment..."
                  rows={3}
                  data-testid="textarea-payment-notes"
                />
              </div>

              {/* Invoice Allocation Section */}
              {selectedPaymentClient && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <h4 className="text-sm font-semibold">Invoice Allocation</h4>
                    {paymentAmount && (
                      <div className="text-sm">
                        <span className="text-gray-600">Remaining: </span>
                        <span className={`font-semibold ${(parseFloat(paymentAmount) - paymentAllocations.reduce((sum, a) => sum + parseFloat(a.amount || '0'), 0)) < 0
                          ? 'text-red-600'
                          : 'text-green-600'
                          }`}>
                          ${(parseFloat(paymentAmount || '0') - paymentAllocations.reduce((sum, a) => sum + parseFloat(a.amount || '0'), 0)).toFixed(2)}
                        </span>
                      </div>
                    )}
                  </div>

                  <div className="border rounded-lg overflow-hidden">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead className="w-12"></TableHead>
                          <TableHead>Invoice</TableHead>
                          <TableHead>Date</TableHead>
                          <TableHead className="text-right">Amount Due</TableHead>
                          <TableHead className="text-right">Payment Amount</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {(() => {
                          const clientInvoices = (invoicesData?.data || []).filter((inv: any) =>
                            inv.clientId === selectedPaymentClient &&
                            (inv.status === 'unpaid' || inv.status === 'partial')
                          );

                          if (clientInvoices.length === 0) {
                            return (
                              <TableRow>
                                <TableCell colSpan={5} className="text-center text-gray-500 py-8">
                                  No unpaid invoices for this client
                                </TableCell>
                              </TableRow>
                            );
                          }

                          return clientInvoices.map((invoice: any) => {
                            const allocation = paymentAllocations.find(a => a.invoiceId === invoice.id);
                            const isSelected = !!allocation;
                            const balanceDue = parseFloat(invoice.balanceDue || invoice.totalAmount || 0);
                            const remainingPayment = parseFloat(paymentAmount || '0') -
                              paymentAllocations.filter(a => a.invoiceId !== invoice.id).reduce((sum, a) => sum + parseFloat(a.amount || '0'), 0);

                            return (
                              <TableRow key={invoice.id}>
                                <TableCell>
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={(e) => {
                                      if (e.target.checked) {
                                        // Add allocation with suggested amount (min of balance due and remaining payment)
                                        const suggestedAmount = Math.min(balanceDue, remainingPayment);
                                        setPaymentAllocations([...paymentAllocations, {
                                          invoiceId: invoice.id,
                                          amount: suggestedAmount
                                        }]);
                                      } else {
                                        // Remove allocation
                                        setPaymentAllocations(paymentAllocations.filter(a => a.invoiceId !== invoice.id));
                                      }
                                    }}
                                    className="h-4 w-4"
                                    data-testid={`checkbox-invoice-${invoice.id}`}
                                  />
                                </TableCell>
                                <TableCell className="font-medium">
                                  {invoice.invoiceNumber || `INV-${invoice.id}`}
                                </TableCell>
                                <TableCell className="text-sm text-gray-600">
                                  {invoice.invoiceDate ? format(new Date(invoice.invoiceDate), 'MMM d, yyyy') : '-'}
                                </TableCell>
                                <TableCell className="text-right font-medium">
                                  ${balanceDue.toFixed(2)}
                                </TableCell>
                                <TableCell className="text-right">
                                  {isSelected ? (
                                    <Input
                                      type="number"
                                      step="0.01"
                                      min="0.01"
                                      max={balanceDue}
                                      value={allocation.amount}
                                      onChange={(e) => {
                                        const newAmount = parseFloat(e.target.value) || 0;
                                        setPaymentAllocations(paymentAllocations.map(a =>
                                          a.invoiceId === invoice.id
                                            ? { ...a, amount: Math.min(newAmount, balanceDue) }
                                            : a
                                        ));
                                      }}
                                      className="w-32 text-right"
                                      data-testid={`input-allocation-${invoice.id}`}
                                    />
                                  ) : (
                                    <span className="text-gray-400">-</span>
                                  )}
                                </TableCell>
                              </TableRow>
                            );
                          });
                        })()}
                      </TableBody>
                    </Table>
                  </div>

                  {paymentAllocations.length > 0 && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                      <div className="flex items-start gap-2">
                        <AlertCircle className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-blue-900">
                          <p className="font-medium">
                            {paymentAllocations.length} invoice{paymentAllocations.length !== 1 ? 's' : ''} selected
                          </p>
                          <p className="text-blue-700">
                            Total allocated: ${paymentAllocations.reduce((sum, a) => sum + parseFloat(a.amount || '0'), 0).toFixed(2)}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Actions */}
              <DialogFooter className="gap-2">
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => setShowRecordPaymentDialog(false)}
                  disabled={recordPaymentMutation.isPending}
                  data-testid="button-cancel-payment"
                >
                  Cancel
                </Button>
                <Button
                  type="button"
                  onClick={() => {
                    // Validation
                    if (!selectedPaymentClient) {
                      toast({
                        title: "Error",
                        description: "Please select a client",
                        variant: "destructive"
                      });
                      return;
                    }

                    if (!paymentAmount || parseFloat(paymentAmount) <= 0) {
                      toast({
                        title: "Error",
                        description: "Please enter a valid payment amount",
                        variant: "destructive"
                      });
                      return;
                    }

                    const totalAllocated = paymentAllocations.reduce((sum, a) => sum + parseFloat(a.amount || '0'), 0);
                    if (totalAllocated > parseFloat(paymentAmount)) {
                      toast({
                        title: "Error",
                        description: "Total allocated amount cannot exceed payment amount",
                        variant: "destructive"
                      });
                      return;
                    }

                    // Submit payment
                    recordPaymentMutation.mutate({
                      clientId: selectedPaymentClient,
                      amount: parseFloat(paymentAmount),
                      paymentDate: paymentDate,
                      paymentMethod: paymentMethod,
                      referenceNumber: paymentReference || undefined,
                      notes: paymentNotes || undefined,
                      allocations: paymentAllocations.length > 0 ? paymentAllocations : undefined
                    });
                  }}
                  disabled={!selectedPaymentClient || !paymentAmount || recordPaymentMutation.isPending}
                  className="bg-green-600 hover:bg-green-700"
                  data-testid="button-submit-payment"
                >
                  {recordPaymentMutation.isPending ? (
                    <>
                      <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                      Recording...
                    </>
                  ) : (
                    <>
                      <DollarSign className="w-4 h-4 mr-2" />
                      Record Payment
                    </>
                  )}
                </Button>
              </DialogFooter>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Recurring Invoice Create/Edit Dialog */}
      <Dialog open={showRecurringInvoiceDialog} onOpenChange={(open) => {
        setShowRecurringInvoiceDialog(open);
        if (!open) {
          setEditingRecurringInvoice(null);
        }
      }}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingRecurringInvoice ? 'Edit Recurring Invoice Template' : 'Create Recurring Invoice Template'}
            </DialogTitle>
            <DialogDescription>
              Set up automated invoice generation for recurring billing
            </DialogDescription>
          </DialogHeader>

          <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.currentTarget);
            const data: any = {
              clientId: Number(formData.get('clientId')),
              templateName: formData.get('templateName'),
              amount: formData.get('amount'),
              description: formData.get('description') || null,
              frequency: formData.get('frequency'),
              startDate: formData.get('startDate'),
              endDate: formData.get('endDate') || null,
              autoSend: formData.get('autoSend') === 'on',
              terms: formData.get('terms') || null,
              notes: formData.get('notes') || null,
            };

            if (editingRecurringInvoice) {
              data.id = editingRecurringInvoice.id;
            }

            saveRecurringInvoiceMutation.mutate(data);
          }}>
            <div className="grid gap-4 py-4">
              {/* Client Selection */}
              <div className="grid gap-2">
                <label htmlFor="clientId" className="text-sm font-medium">
                  Client <span className="text-red-500">*</span>
                </label>
                <Select
                  name="clientId"
                  defaultValue={editingRecurringInvoice?.clientId?.toString() || ''}
                  required
                >
                  <SelectTrigger data-testid="select-client">
                    <SelectValue placeholder="Select a client" />
                  </SelectTrigger>
                  <SelectContent>
                    {clients?.clients?.map((client: any) => (
                      <SelectItem key={client.id} value={client.id.toString()}>
                        {client.clientName}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Template Name */}
              <div className="grid gap-2">
                <label htmlFor="templateName" className="text-sm font-medium">
                  Template Name <span className="text-red-500">*</span>
                </label>
                <Input
                  id="templateName"
                  name="templateName"
                  placeholder="e.g., Monthly Bookkeeping Service"
                  defaultValue={editingRecurringInvoice?.templateName || ''}
                  required
                  data-testid="input-template-name"
                />
              </div>

              {/* Amount */}
              <div className="grid gap-2">
                <label htmlFor="amount" className="text-sm font-medium">
                  Amount <span className="text-red-500">*</span>
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                  <Input
                    id="amount"
                    name="amount"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    className="pl-7"
                    defaultValue={editingRecurringInvoice?.amount || ''}
                    required
                    data-testid="input-amount"
                  />
                </div>
              </div>

              {/* Description */}
              <div className="grid gap-2">
                <label htmlFor="description" className="text-sm font-medium">
                  Description
                </label>
                <Textarea
                  id="description"
                  name="description"
                  placeholder="Describe the recurring service or product"
                  rows={3}
                  defaultValue={editingRecurringInvoice?.description || ''}
                  data-testid="textarea-description"
                />
              </div>

              {/* Frequency */}
              <div className="grid gap-2">
                <label htmlFor="frequency" className="text-sm font-medium">
                  Frequency <span className="text-red-500">*</span>
                </label>
                <Select
                  name="frequency"
                  defaultValue={editingRecurringInvoice?.frequency || 'monthly'}
                  required
                >
                  <SelectTrigger data-testid="select-frequency">
                    <SelectValue placeholder="Select frequency" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="daily">Daily</SelectItem>
                    <SelectItem value="weekly">Weekly</SelectItem>
                    <SelectItem value="biweekly">Bi-weekly</SelectItem>
                    <SelectItem value="monthly">Monthly</SelectItem>
                    <SelectItem value="quarterly">Quarterly</SelectItem>
                    <SelectItem value="semi_annual">Semi-Annual</SelectItem>
                    <SelectItem value="annual">Annual</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Start Date */}
              <div className="grid gap-2">
                <label htmlFor="startDate" className="text-sm font-medium">
                  Start Date <span className="text-red-500">*</span>
                </label>
                <Input
                  id="startDate"
                  name="startDate"
                  type="date"
                  defaultValue={
                    editingRecurringInvoice?.startDate
                      ? new Date(editingRecurringInvoice.startDate).toISOString().split('T')[0]
                      : new Date().toISOString().split('T')[0]
                  }
                  required
                  data-testid="input-start-date"
                />
              </div>

              {/* End Date (Optional) */}
              <div className="grid gap-2">
                <label htmlFor="endDate" className="text-sm font-medium">
                  End Date (Optional)
                </label>
                <Input
                  id="endDate"
                  name="endDate"
                  type="date"
                  defaultValue={
                    editingRecurringInvoice?.endDate
                      ? new Date(editingRecurringInvoice.endDate).toISOString().split('T')[0]
                      : ''
                  }
                  data-testid="input-end-date"
                />
                <p className="text-xs text-gray-500">Leave empty for indefinite recurring billing</p>
              </div>

              {/* Auto-Send Toggle */}
              <div className="flex items-center justify-between p-3 border rounded-lg">
                <div>
                  <label htmlFor="autoSend" className="text-sm font-medium cursor-pointer">
                    Automatically Send Invoices
                  </label>
                  <p className="text-xs text-gray-500">
                    Invoices will be sent to clients automatically when generated
                  </p>
                </div>
                <input
                  type="checkbox"
                  id="autoSend"
                  name="autoSend"
                  className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  defaultChecked={editingRecurringInvoice?.autoSend || false}
                  data-testid="checkbox-auto-send"
                />
              </div>

              {/* Terms */}
              <div className="grid gap-2">
                <label htmlFor="terms" className="text-sm font-medium">
                  Payment Terms
                </label>
                <Textarea
                  id="terms"
                  name="terms"
                  placeholder="e.g., Payment due within 30 days"
                  rows={3}
                  defaultValue={editingRecurringInvoice?.terms || billingSettings?.defaultTerms || ''}
                  data-testid="textarea-terms"
                />
              </div>

              {/* Notes */}
              <div className="grid gap-2">
                <label htmlFor="notes" className="text-sm font-medium">
                  Invoice Notes
                </label>
                <Textarea
                  id="notes"
                  name="notes"
                  placeholder="Additional notes to include on generated invoices"
                  rows={3}
                  defaultValue={editingRecurringInvoice?.notes || ''}
                  data-testid="textarea-notes"
                />
              </div>
            </div>

            <DialogFooter className="gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={() => setShowRecurringInvoiceDialog(false)}
                disabled={saveRecurringInvoiceMutation.isPending}
                data-testid="button-cancel"
              >
                Cancel
              </Button>
              <Button
                type="submit"
                disabled={saveRecurringInvoiceMutation.isPending}
                data-testid="button-save"
              >
                {saveRecurringInvoiceMutation.isPending ? (
                  <>
                    <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Check className="w-4 h-4 mr-2" />
                    {editingRecurringInvoice ? 'Update Template' : 'Create Template'}
                  </>
                )}
              </Button>
            </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>

      {/* Client Detail Dialog (Modal) */}
      <Dialog open={showClientDetail} onOpenChange={setShowClientDetail}>
        <DialogContent className="w-[90vw] max-w-[1400px] h-[90vh] overflow-y-auto p-0">
          {selectedClientId && (
            <ClientDetailView
              clientId={selectedClientId}
              onBack={() => {
                setShowClientDetail(false);
                setSelectedClientId(null);
              }}
              hideBackButton={true}
            />
          )}
        </DialogContent>
      </Dialog>

      {/* Logo Upload Dialog */}
      <Dialog open={showLogoUploadDialog} onOpenChange={setShowLogoUploadDialog}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Image className="h-5 w-5" />
              Upload Client Logo
            </DialogTitle>
            <DialogDescription>
              Upload a logo image for this client. Supported formats: JPEG, PNG, GIF, WebP, SVG (max 5MB)
            </DialogDescription>
          </DialogHeader>

          <LogoUploadForm
            clientId={logoUploadClientId}
            onUpload={(file) => {
              if (logoUploadClientId) {
                uploadLogoMutation.mutate({ clientId: logoUploadClientId, file });
              }
            }}
            onCancel={() => {
              setShowLogoUploadDialog(false);
              setLogoUploadClientId(null);
            }}
            isUploading={uploadLogoMutation.isPending}
          />
        </DialogContent>
      </Dialog>
    </>
  );
}
// Logo Upload Form Component
function LogoUploadForm({
  clientId,
  onUpload,
  onCancel,
  isUploading
}: {
  clientId: number | null;
  onUpload: (file: File) => void;
  onCancel: () => void;
  isUploading: boolean;
}) {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [preview, setPreview] = useState<string | null>(null);

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
      if (!allowedTypes.includes(file.type)) {
        toast({
          title: "Invalid File Type",
          description: "Please select an image file (JPEG, PNG, GIF, WebP, or SVG)",
          variant: "destructive"
        });
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        toast({
          title: "File Too Large",
          description: "File size must be less than 5MB",
          variant: "destructive"
        });
        return;
      }

      setSelectedFile(file);

      // Create preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleUpload = () => {
    if (selectedFile && clientId) {
      onUpload(selectedFile);
    }
  };

  const handleRemove = () => {
    setSelectedFile(null);
    setPreview(null);
  };

  return (
    <div className="space-y-4 py-4">
      <div className="space-y-2">
        <label className="text-sm font-medium">Select Logo Image</label>
        <div className="flex items-center gap-4">
          <input
            type="file"
            accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml"
            onChange={handleFileSelect}
            className="hidden"
            id="logo-upload-input"
            disabled={isUploading}
          />
          <label
            htmlFor="logo-upload-input"
            className="flex items-center justify-center px-4 py-2 border border-dashed border-gray-300 rounded-md cursor-pointer hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <Upload className="w-4 h-4 mr-2" />
            <span className="text-sm">Choose File</span>
          </label>
          {selectedFile && (
            <span className="text-sm text-gray-600">
              {selectedFile.name} ({(selectedFile.size / 1024).toFixed(1)} KB)
            </span>
          )}
        </div>
      </div>

      {preview && (
        <div className="space-y-2">
          <label className="text-sm font-medium">Preview</label>
          <div className="relative border border-gray-200 rounded-md p-4 bg-gray-50 flex items-center justify-center min-h-[200px]">
            <img
              src={preview}
              alt="Logo preview"
              className="max-w-full max-h-[200px] object-contain"
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={handleRemove}
              className="absolute top-2 right-2"
              disabled={isUploading}
            >
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>
      )}

      <DialogFooter>
        <Button
          type="button"
          variant="outline"
          onClick={onCancel}
          disabled={isUploading}
        >
          Cancel
        </Button>
        <Button
          type="button"
          onClick={handleUpload}
          disabled={!selectedFile || isUploading}
        >
          {isUploading ? "Uploading..." : "Upload Logo"}
        </Button>
      </DialogFooter>
    </div>
  );
}
